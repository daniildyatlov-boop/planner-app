<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-buster" content="<?php echo time(); ?>">
<meta name="version" content="v6.28.0-STRIKETHROUGH-DELETE-FIX">
<title>Планер v6.28 STRIKETHROUGH DELETE FIX</title>
<script src="https://telegram.org/js/telegram-web-app.js?v=7"></script>
<style>
/* RESET & BASE */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;position:fixed;width:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  color:var(--text-primary);
  line-height:1.4;
  overflow:hidden;
}

/* SMOOTH ANIMATIONS SYSTEM */
* {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ENHANCED ANIMATIONS SYSTEM - УЛУЧШЕННАЯ СИСТЕМА АНИМАЦИЙ */
@keyframes slideInFromBottom {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes slideOutToBottom {
  from {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  to {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3) rotate(-5deg);
  }
  50% {
    opacity: 1;
    transform: scale(1.05) rotate(2deg);
  }
  70% {
    transform: scale(0.95) rotate(-1deg);
  }
  100% {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }
}

@keyframes floatIn {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200px 0;
  }
  100% {
    background-position: calc(200px + 100%) 0;
  }
}

@keyframes slideInFromRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInFromLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Улучшенные анимации для элементов */
.animate-in {
  animation: floatIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.animate-bounce {
  animation: bounceIn 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55) both;
}

.animate-slide-right {
  animation: slideInFromRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.animate-slide-left {
  animation: slideInFromLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.animate-scale {
  animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

/* Классы для плавных переходов */
.ease-bounce { transition-timing-function: cubic-bezier(0.68, -0.55, 0.265, 1.55); }
.ease-smooth { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
.ease-swift { transition-timing-function: cubic-bezier(0.55, 0, 0.1, 1); }
.ease-gentle { transition-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94); }

/* Микро-анимации для интерактивности */
@keyframes gentle-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

@keyframes soft-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.3); }
  50% { box-shadow: 0 0 30px rgba(74, 222, 128, 0.5); }
}

@keyframes fade-in-up {
  from { 
    opacity: 0; 
    transform: translateY(20px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

@keyframes scale-in {
  from { 
    opacity: 0; 
    transform: scale(0.9); 
  }
  to { 
    opacity: 1; 
    transform: scale(1); 
  }
}

/* DESIGN SYSTEM - ADAPTIVE THEME SYSTEM */
:root {
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 20px;
  --spacing-2xl: 24px;
  --spacing-3xl: 32px;
  --border-radius: 16px;
  --border-radius-sm: 12px;
  --border-radius-lg: 20px;
  
  /* Акцентные цвета - одинаковые для обеих тем */
  --accent-primary: #4ade80;
  --accent-secondary: #22c55e;
  --accent-soft: #16a34a;
  --accent-water: #06b6d4;
  --accent-warm: #f59e0b;
  --accent-danger: #ef4444;
}

/* СВЕТЛАЯ ТЕМА (по умолчанию) */
:root {
  --bg-primary: #f8faf8;
  --bg-secondary: #f1f5f1;
  --bg-tertiary: #e8f0e8;
  --bg-card: rgba(255, 255, 255, 0.9);
  --bg-card-hover: rgba(255, 255, 255, 0.95);
  --bg-modal: rgba(255, 255, 255, 0.95);
  
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --text-inverse: #ffffff;
  
  --border-primary: rgba(34, 197, 94, 0.2);
  --border-secondary: rgba(34, 197, 94, 0.1);
  --border-soft: rgba(107, 114, 128, 0.15);
  
  --shadow-soft: 0 4px 20px rgba(34, 197, 94, 0.1);
  --shadow-medium: 0 8px 32px rgba(34, 197, 94, 0.15);
  --shadow-strong: 0 12px 48px rgba(34, 197, 94, 0.2);
  --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.08);
  
  --overlay-bg: rgba(0, 0, 0, 0.4);
}

/* ТЕМНАЯ ТЕМА - автоматическое переключение */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #0f1419;
    --bg-secondary: #1a1f2e;
    --bg-tertiary: #252a3a;
    --bg-card: rgba(26, 31, 46, 0.9);
    --bg-card-hover: rgba(37, 42, 58, 0.95);
    --bg-modal: rgba(15, 20, 25, 0.95);
    
    --text-primary: #f8fafc;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --text-inverse: #1f2937;
    
    --border-primary: rgba(74, 222, 128, 0.3);
    --border-secondary: rgba(74, 222, 128, 0.15);
    --border-soft: rgba(148, 163, 184, 0.2);
    
    --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
    --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.4);
    --shadow-strong: 0 12px 48px rgba(0, 0, 0, 0.5);
    --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.2);
    
    --overlay-bg: rgba(0, 0, 0, 0.7);
  }
}

/* APP LAYOUT */
.app{
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  animation: fade-in-up 0.6s ease-smooth;
  padding-bottom: 80px; /* Отступ для нижней навигации */
}
.header{
  padding:var(--spacing-lg) var(--spacing-xl);
  background: var(--bg-modal);
  backdrop-filter: blur(20px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:relative;
  height:72px;
  flex-shrink:0;
  border-bottom:1px solid var(--border-soft);
  box-shadow: var(--shadow-soft);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.content{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* HEADER ELEMENTS */
.profile-btn{
  width:44px;
  height:44px;
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  border:none;
  border-radius:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:var(--spacing-lg);
  font-weight:600;
  cursor:pointer;
  flex-shrink:0;
  box-shadow:var(--shadow-soft);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0); /* GPU acceleration */
}
.profile-btn:hover{
  animation: gentle-pulse 2s infinite;
}
.profile-btn:active{
  opacity:0.8;
  transform:scale(0.92);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.date-nav{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  align-items:center;
  background:var(--bg-card);
  backdrop-filter: blur(20px);
  border-radius:var(--spacing-lg);
  padding:var(--spacing-xs);
  box-shadow:var(--shadow-soft);
  height:var(--spacing-3xl);
  gap:var(--spacing-xs);
  border:1px solid var(--border-soft);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.date-nav:hover{
  transform:translateX(-50%) translateY(-1px);
  box-shadow:var(--shadow-medium);
}
.nav-arrow{
  background:none;
  border:none;
  font-size:14px;
  color:var(--accent-primary);
  cursor:pointer;
  width:var(--spacing-2xl);
  height:var(--spacing-2xl);
  border-radius:var(--spacing-md);
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.nav-arrow:active{
  opacity:0.6;
  background:rgba(74, 222, 128, 0.2);
  transform:scale(0.9);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.date-content{
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
  padding:0 var(--spacing-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.date-content:active{
  transform: scale(0.95);
}
.date-title{
  font-size: 15px; /* Увеличено с var(--spacing-md) */
  font-weight: 700; /* Увеличен вес шрифта */
  color: var(--text-primary);
  line-height: 1.2; /* Улучшена высота строки */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.3px; /* Добавлено расстояние между буквами */
}
.date-subtitle{
  font-size: 11px; /* Увеличено с 10px */
  color: var(--text-secondary);
  line-height: 1.2; /* Улучшена высота строки */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  font-weight: 500; /* Добавлен вес шрифта */
  letter-spacing: 0.2px; /* Добавлено расстояние между буквами */
}

.rooms-btn{
  width:44px;
  height:44px;
  background:var(--bg-card);
  backdrop-filter: blur(20px);
  border:1px solid var(--border-soft);
  border-radius:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:var(--shadow-soft);
  font-size:var(--spacing-lg);
  flex-shrink:0;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.rooms-btn:hover{
  transform: translateY(-1px);
  box-shadow:var(--shadow-medium);
}
.rooms-btn:active{
  opacity:0.8;
  transform:scale(0.92);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* PROGRESS BAR */
.progress-container{
  margin:var(--spacing-xl) var(--spacing-xl) var(--spacing-2xl);
  flex-shrink:0;
  animation: fade-in-up 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
  background: linear-gradient(135deg, 
    rgba(74, 222, 128, 0.1) 0%, 
    rgba(34, 197, 94, 0.1) 50%,
    rgba(22, 163, 74, 0.1) 100%);
  backdrop-filter: blur(30px);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-2xl);
  border: 1px solid var(--border-primary);
  box-shadow: var(--shadow-medium);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.progress-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(99, 102, 241, 0.1), 
    transparent);
  animation: progress-shimmer 4s infinite;
}
@keyframes progress-shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.progress-info{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:var(--spacing-xl);
  position: relative;
  z-index: 1;
  width: 100%;
}
.progress-label{
  font-size: 18px; /* Увеличено с 16px */
  color: var(--text-primary);
  font-weight: 800; /* Увеличен вес шрифта */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
  letter-spacing: 0.5px;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
}
.progress-stats{
  font-size: 20px; /* Увеличено с 18px */
  color: var(--accent-primary);
  font-weight: 900; /* Увеличен вес шрифта */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 0 16px rgba(34, 197, 94, 0.3);
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.3px; /* Добавлено расстояние между буквами */
}

/* КРУГЛЫЙ ПРОГРЕСС-БАР */
.progress-circle-container {
  position: relative;
  width: 90px;
  height: 90px;
  z-index: 1;
}
.progress-circle {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    rgba(0, 0, 0, 0.2) 0deg
  );
  padding: 5px;
  box-shadow: 
    0 6px 24px rgba(99, 102, 241, 0.3),
    0 0 0 2px rgba(99, 102, 241, 0.2) inset;
  position: relative;
  overflow: hidden;
}
.progress-circle-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  z-index: 2;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5) inset;
}
.progress-percentage {
  font-size: 20px; /* Уменьшено с 28px */
  font-weight: 900; /* Увеличен вес шрифта */
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.5px; /* Добавлено расстояние между буквами */
}

/* АНИМАЦИЯ ЗАВЕРШЕНИЯ */
.progress-container.completed {
  animation: celebration-pulse 2s infinite ease-in-out;
}
.progress-circle.completed {
  background: conic-gradient(
    from 0deg,
    var(--accent-primary) 0deg,
    var(--accent-secondary) 120deg,
    var(--accent-soft) 240deg,
    var(--accent-primary) 360deg
  ) !important;
  box-shadow: 
    0 16px 48px rgba(99, 102, 241, 0.5),
    0 0 0 4px rgba(99, 102, 241, 0.3) inset,
    0 0 32px rgba(99, 102, 241, 0.4);
  animation: completion-glow 3s infinite ease-in-out;
}
.progress-circle.completed::before {
  transform: scale(1);
  opacity: 0.3;
  animation: completion-shimmer 2s infinite ease-in-out;
}
.progress-percentage.completed {
  color: var(--accent-primary);
  text-shadow: 0 0 16px rgba(99, 102, 241, 0.6);
  animation: completion-text 2s infinite ease-in-out;
}

@keyframes celebration-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}
@keyframes completion-glow {
  0%, 100% { 
    box-shadow: 
      0 12px 36px rgba(99, 102, 241, 0.5),
      0 0 0 3px rgba(99, 102, 241, 0.3) inset,
      0 0 24px rgba(99, 102, 241, 0.4);
  }
  50% { 
    box-shadow: 
      0 16px 48px rgba(99, 102, 241, 0.7),
      0 0 0 4px rgba(99, 102, 241, 0.5) inset,
      0 0 36px rgba(99, 102, 241, 0.6);
  }
}
@keyframes completion-shimmer {
  0%, 100% { 
    transform: scale(0.8);
    opacity: 0.1;
  }
  50% { 
    transform: scale(1.1);
    opacity: 0.4;
  }
}
@keyframes completion-text {
  0%, 100% { 
    transform: scale(1);
    text-shadow: 0 0 16px rgba(99, 102, 241, 0.6);
  }
  50% { 
    transform: scale(1.05);
    text-shadow: 0 0 24px rgba(99, 102, 241, 0.8);
  }
}

/* EMPTY STATE */
.empty{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:40px var(--spacing-xl);
  flex:1;
  animation: fade-in-up 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
}
.empty h2{
  font-size:18px;
  font-weight:600;
  margin-bottom:var(--spacing-sm);
  color:#ffffff;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 2px 8px rgba(255,255,255,0.1);
}
.empty p{
  font-size:15px;
  color:#8e8e93;
  margin-bottom:var(--spacing-2xl);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ЕДИНАЯ ДИЗАЙН-СИСТЕМА КНОПОК - iOS СТИЛЬ */

/* БАЗОВЫЕ ПЕРЕМЕННЫЕ ДЛЯ КНОПОК */
:root {
  --btn-height-primary: 52px;
  --btn-height-secondary: 44px;
  --btn-height-tertiary: 36px;
  --btn-radius: 12px;
  --btn-radius-small: 8px;
  --btn-spacing: 16px;
  --btn-font-weight-primary: 600;
  --btn-font-weight-secondary: 500;
  --btn-font-weight-tertiary: 500;
  --btn-shadow-primary: 0 4px 16px rgba(99, 102, 241, 0.25);
  --btn-shadow-secondary: 0 2px 8px rgba(0, 0, 0, 0.1);
  --btn-shadow-hover: 0 8px 24px rgba(99, 102, 241, 0.35);
}

/* БАЗОВЫЙ КЛАСС ДЛЯ ВСЕХ КНОПОК */
.btn-base {
  border: none;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  font-size: 16px;
  line-height: 1.2;
  text-align: center;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  white-space: nowrap;
}

.btn-base:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-base:active:not(:disabled) {
  transform: scale(0.96);
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 1. PRIMARY КНОПКИ - главное действие экрана */
.btn-primary {
  border: none;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  font-size: 17px;
  line-height: 1.2;
  text-align: center;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  white-space: nowrap;
  height: var(--btn-height-primary);
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: white;
  border-radius: var(--btn-radius);
  font-weight: var(--btn-font-weight-primary);
  box-shadow: var(--btn-shadow-primary);
  padding: 0 24px;
  min-width: 120px;
}

.btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: var(--btn-shadow-hover);
}

.btn-primary:hover:not(:disabled)::before {
  left: 100%;
}

.btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-primary:active:not(:disabled) {
  transform: scale(0.96);
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 2. SECONDARY КНОПКИ - дополнительные действия */
.btn-secondary {
  border: none;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  font-size: 16px;
  line-height: 1.2;
  text-align: center;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  white-space: nowrap;
  height: var(--btn-height-secondary);
  background: var(--bg-card);
  color: var(--text-primary);
  border: 1px solid var(--border-primary);
  border-radius: var(--btn-radius);
  font-weight: var(--btn-font-weight-secondary);
  box-shadow: var(--btn-shadow-secondary);
  padding: 0 20px;
  min-width: 100px;
  backdrop-filter: blur(20px);
}

.btn-secondary:hover:not(:disabled) {
  background: var(--bg-card-hover);
  border-color: var(--accent-primary);
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.btn-secondary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-secondary:active:not(:disabled) {
  transform: scale(0.96);
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 3. TERTIARY КНОПКИ - навигационные и вспомогательные */
.btn-tertiary {
  border: none;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  font-size: 15px;
  line-height: 1.2;
  text-align: center;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  white-space: nowrap;
  height: var(--btn-height-tertiary);
  background: transparent;
  color: var(--accent-primary);
  border-radius: var(--btn-radius-small);
  font-weight: var(--btn-font-weight-tertiary);
  padding: 0 16px;
  min-width: 80px;
}

.btn-tertiary:hover:not(:disabled) {
  background: rgba(99, 102, 241, 0.1);
  color: var(--accent-secondary);
}

.btn-tertiary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-tertiary:active:not(:disabled) {
  transform: scale(0.96);
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 4. DESTRUCTIVE КНОПКИ - удаление и опасные действия */
.btn-destructive {
  border: none;
  cursor: pointer;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  font-size: 16px;
  line-height: 1.2;
  text-align: center;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  white-space: nowrap;
  height: var(--btn-height-secondary);
  background: rgba(239, 68, 68, 0.1);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.2);
  border-radius: var(--btn-radius);
  font-weight: var(--btn-font-weight-secondary);
  padding: 0 20px;
  min-width: 100px;
  backdrop-filter: blur(20px);
}

.btn-destructive:hover:not(:disabled) {
  background: rgba(239, 68, 68, 0.15);
  border-color: rgba(239, 68, 68, 0.4);
  color: #dc2626;
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
}

.btn-destructive:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.btn-destructive:active:not(:disabled) {
  transform: scale(0.96);
  transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
}

/* СПЕЦИАЛЬНЫЕ ВАРИАНТЫ КНОПОК */

/* Круглые кнопки для навигации */
.btn-round {
  width: 44px;
  height: 44px;
  border-radius: 22px;
  padding: 0;
  min-width: unset;
}

.btn-round-small {
  width: 36px;
  height: 36px;
  border-radius: 18px;
  padding: 0;
  min-width: unset;
}

/* FAB кнопки */
.btn-fab {
  width: 56px;
  height: 56px;
  border-radius: 28px;
  padding: 0;
  min-width: unset;
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 50;
  font-size: 24px;
  box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
}

.btn-fab:hover:not(:disabled) {
  transform: scale(1.05) translateY(-2px);
  box-shadow: 0 12px 40px rgba(99, 102, 241, 0.5);
}

/* Полноширинные кнопки */
.btn-full-width {
  width: 100%;
}

/* Группы кнопок */
.btn-group {
  display: flex;
  gap: 12px;
  align-items: center;
}

.btn-group-vertical {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* СПЕЦИАЛЬНЫЕ СОСТОЯНИЯ */
.btn-loading::after {
  content: '';
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-left: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ПОЗИЦИОНИРОВАНИЕ КНОПОК */

/* Шапка экрана */
.screen-header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Подвал экрана */
.screen-footer-actions {
  display: flex;
  gap: 12px;
  padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
  background: var(--bg-modal);
  border-top: 1px solid var(--border-soft);
}

/* Модальные окна */
.modal-header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* АДАПТИВНОСТЬ */
@media (max-width: 375px) {
  .btn-primary {
    font-size: 16px;
    padding: 0 20px;
  }
  
  .btn-secondary {
    font-size: 15px;
    padding: 0 16px;
  }
}

/* ТЕМНАЯ ТЕМА */
@media (prefers-color-scheme: dark) {
  .btn-secondary {
    background: var(--bg-tertiary);
    border-color: var(--border-secondary);
  }
  
  .btn-secondary:hover:not(:disabled) {
    background: var(--bg-card);
    border-color: var(--accent-primary);
  }
}

/* PLANS LIST */
.plans-container{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.plans{
  flex:1;
  overflow-y:auto;
  padding:0 var(--spacing-xl) var(--spacing-xl);
}
.plans::-webkit-scrollbar{display:none}

/* СТАРЫЕ КЛАССЫ КНОПОК - УДАЛЕНЫ И ЗАМЕНЕНЫ НА ЕДИНУЮ СИСТЕМУ */

.plan{
  background: var(--bg-card);
  backdrop-filter: blur(30px);
  border: 1px solid var(--border-soft);
  border-radius: var(--border-radius);
  padding: var(--spacing-xl);
  margin: 0 var(--spacing-xl) var(--spacing-lg);
  display: flex;
  align-items: center;
  cursor: pointer;
  box-shadow: var(--shadow-soft);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  min-height: 72px;
  transform: translateZ(0);
  animation: floatIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) both;
  position: relative;
  overflow: hidden;
}
.plan::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
  opacity: 0;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.plan:nth-child(1) { animation-delay: 0.1s; }
.plan:nth-child(2) { animation-delay: 0.2s; }
.plan:nth-child(3) { animation-delay: 0.3s; }
.plan:nth-child(4) { animation-delay: 0.4s; }
.plan:nth-child(5) { animation-delay: 0.5s; }

.plan:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.3),
    0 4px 0 rgba(255, 255, 255, 0.1) inset;
  border-color: rgba(99, 102, 241, 0.4);
}
.plan:hover::before {
  opacity: 1;
}
.plan:active {
  opacity: 0.9;
  transform: scale(0.98) translateY(-3px);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.plan.completed {
  opacity: 0.7;
  transform: scale(0.98);
  background: var(--bg-secondary);
  /* Добавляем плавную анимацию при изменении позиции */
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
              transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Анимация для перемещения задач */
.plan {
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1),
              transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Специальная анимация для задач, которые меняют статус */
.plan.status-changing {
  animation: task-reorder 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes task-reorder {
  0% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  50% {
    opacity: 0.5;
    transform: translateY(-10px) scale(0.95);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
.plan.completed .plan-title {
  color: var(--text-muted);
  position: relative;
  text-decoration: line-through;
  text-decoration-color: var(--text-muted);
  text-decoration-thickness: 2px;
}

.checkbox{
  width: 24px;
  height: 24px;
  border: 2px solid var(--accent-primary);
  border-radius: 12px;
  margin-right: var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  transform: translateZ(0);
  background: var(--bg-tertiary);
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.3) inset,
    0 1px 0 rgba(255, 255, 255, 0.1);
}
.checkbox:hover {
  transform: scale(1.1);
  box-shadow: 
    0 0 20px rgba(99, 102, 241, 0.4),
    0 2px 8px rgba(0, 0, 0, 0.3) inset;
  border-color: var(--accent-secondary);
}
.checkbox.checked {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  border-color: var(--accent-primary);
  box-shadow: 
    0 0 20px rgba(99, 102, 241, 0.5),
    0 1px 0 rgba(255, 255, 255, 0.3) inset;
  transform: scale(1.05);
}
.checkbox.checked::after {
  content: '✓';
  color: white;
  font-size: 14px;
  font-weight: bold;
  animation: checkmark-appear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* Анимация появления галочки */
@keyframes checkmark-appear {
  0% {
    transform: scale(0) rotate(-45deg);
    opacity: 0;
  }
  50% {
    transform: scale(1.2) rotate(-22deg);
    opacity: 1;
  }
  100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

.plan-content{
  flex:1;
  display:flex;
  flex-direction:column;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.plan-title{
  font-size: 18px; /* Увеличено с 17px */
  color: var(--text-primary);
  font-weight: 600; /* Увеличен вес шрифта */
  line-height: 1.5; /* Улучшена высота строки */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* Уменьшена тень */
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.2px; /* Добавлено расстояние между буквами */
}
.plan-time{
  font-size: 13px; /* Увеличено с 11px */
  color: var(--accent-primary);
  background: rgba(99, 102, 241, 0.12);
  backdrop-filter: blur(10px);
  padding: 4px 10px; /* Увеличен padding */
  border-radius: 8px; /* Увеличен радиус */
  display: inline-block;
  margin-top: 6px;
  margin-right: var(--spacing-sm);
  line-height: 1.2; /* Улучшена высота строки */
  font-weight: 700; /* Увеличен вес шрифта */
  border: 1px solid rgba(99, 102, 241, 0.25);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 4px rgba(99, 102, 241, 0.15);
  transform: translateZ(0);
  letter-spacing: 0.5px; /* Увеличено расстояние между буквами */
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
}
.plan-time:hover {
  background: rgba(99, 102, 241, 0.2);
  border-color: rgba(99, 102, 241, 0.4);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  transform: translateY(-1px);
}

.plan-time-inline{
  font-size: 16px; /* Увеличено с 14px */
  color: var(--accent-primary);
  background: rgba(99, 102, 241, 0.12);
  backdrop-filter: blur(10px);
  padding: 3px 8px;
  border-radius: 6px;
  display: inline-block;
  margin-right: 10px; /* Увеличен отступ */
  line-height: 1.3; /* Улучшена высота строки */
  font-weight: 700; /* Увеличен вес шрифта */
  border: 1px solid rgba(99, 102, 241, 0.25);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(99, 102, 241, 0.15);
  transform: translateZ(0);
  letter-spacing: 0.4px; /* Увеличено расстояние между буквами */
  vertical-align: baseline;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
}
.plan:hover .plan-time-inline {
  background: rgba(99, 102, 241, 0.18);
  border-color: rgba(99, 102, 241, 0.35);
  box-shadow: 0 2px 6px rgba(99, 102, 241, 0.2);
}
.room{
  font-size: 14px; /* Увеличено с 13px */
  color: var(--accent-soft);
  background: rgba(168, 85, 247, 0.15);
  backdrop-filter: blur(10px);
  padding: var(--spacing-xs) var(--spacing-md);
  border-radius: 10px; /* Увеличен радиус */
  display: inline-block;
  margin-top: var(--spacing-xs);
  line-height: 1.2; /* Улучшена высота строки */
  font-weight: 700; /* Увеличен вес шрифта */
  border: 1px solid rgba(168, 85, 247, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.2);
  transform: translateZ(0);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.3px; /* Добавлено расстояние между буквами */
}
.room:hover {
  background: rgba(168, 85, 247, 0.25);
  border-color: rgba(168, 85, 247, 0.5);
  box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
  transform: translateY(-1px);
}

/* MODALS */
.modal{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:var(--overlay-bg);
  backdrop-filter: blur(30px);
  z-index:100;
  display:none;
  flex-direction:column;
  transform:translateY(100%);
  transition:all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  height:100vh;
  overflow:hidden;
}
.modal.show{
  display:flex;
  transform:translateY(0);
  animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}
.modal.show .modal-content{
  animation: floatIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

.modal-header{
  padding:var(--spacing-lg) var(--spacing-xl);
  background:var(--bg-modal);
  backdrop-filter: blur(30px);
  border-bottom:1px solid var(--border-soft);
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-shrink:0;
  box-shadow: var(--shadow-soft);
  position: relative;
  overflow: hidden;
}
.modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -200px;
  width: 200px;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(99,102,241,0.1), transparent);
  animation: shimmer 3s infinite;
}
.modal-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:var(--text-primary);
  text-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-content{
  flex:1;
  overflow-y:auto;
  padding:var(--spacing-xl);
  background: var(--bg-primary);
}
.modal-content::-webkit-scrollbar{display:none}

/* FORMS */
.form-group{
  margin-bottom:var(--spacing-xl);
  animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}
.form-group:nth-child(1) { animation-delay: 0.1s; }
.form-group:nth-child(2) { animation-delay: 0.15s; }
.form-group:nth-child(3) { animation-delay: 0.2s; }

.label{
  font-size:var(--spacing-md);
  color:#8e8e93;
  text-transform:uppercase;
  letter-spacing:0.5px;
  font-weight:600;
  margin-bottom:var(--spacing-xs);
  display:block;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* УЛУЧШЕННЫЕ ПОЛЯ ВВОДА - ИСПРАВЛЯЕМ ПРОБЛЕМЫ С КУРСОРОМ */
.input,.select{
  width:100%;
  background:var(--bg-card);
  backdrop-filter: blur(20px);
  border:1px solid var(--border-soft);
  border-radius:12px;
  padding:16px;
  font-size:16px;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  color:var(--text-primary);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-card);
  /* КРИТИЧЕСКИ ВАЖНО ДЛЯ СТАБИЛЬНОСТИ КУРСОРА */
  line-height: 1.4;
  height: 52px;
  box-sizing: border-box;
  vertical-align: baseline;
  text-align: left;
  caret-color: var(--accent-primary);
  /* Убираем любые трансформации в покое */
  transform: none;
  /* Стабилизируем позиционирование */
  position: relative;
  z-index: 1;
}

/* СПЕЦИАЛЬНЫЕ СТИЛИ ДЛЯ РАЗНЫХ ТИПОВ ПОЛЕЙ */
.input[type="text"], .input[type="email"], .input[type="password"] {
  /* Стандартные текстовые поля */
  -webkit-appearance: none;
  appearance: none;
}

.input[type="date"]{
  /* Поле даты - убираем браузерные стили */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  cursor: pointer;
  /* Принудительно задаем высоту */
  height: 52px !important;
  line-height: 1.4 !important;
  padding: 16px !important;
  /* Убираем стандартные иконки */
  background-image: none;
}
.input[type="date"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  position: absolute;
  right: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}
.input[type="date"]::-webkit-inner-spin-button,
.input[type="date"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.input[type="time"]{
  /* Поле времени */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  cursor: pointer;
  height: 52px !important;
  line-height: 1.4 !important;
  padding: 16px !important;
}
.input[type="time"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  position: absolute;
  right: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.input[type="number"]{
  /* Числовые поля */
  -webkit-appearance: none;
  -moz-appearance: textfield;
  appearance: none;
  text-align: left;
}
.input[type="number"]::-webkit-outer-spin-button,
.input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* СОСТОЯНИЯ ПОЛЕЙ - УБИРАЕМ АГРЕССИВНЫЕ ТРАНСФОРМАЦИИ */
.input:focus,.select:focus{
  outline:none;
  border-color:var(--accent-primary);
  box-shadow:0 0 0 3px rgba(74, 222, 128, 0.2), var(--shadow-medium);
  background:var(--bg-card-hover);
  /* Убираем трансформации при фокусе - они вызывают дерганье курсора */
  transform: none;
}
.input:hover:not(:focus),.select:hover:not(:focus){
  border-color:rgba(99,102,241,0.4);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  /* Минимальная трансформация только при ховере без фокуса */
  transform: translateY(-1px);
}
.input::placeholder{
  color:var(--text-muted);
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.input:focus::placeholder{
  opacity: 0.5;
}

/* TEXTAREA - СПЕЦИАЛЬНЫЕ СТИЛИ */
textarea.input {
  height: auto;
  min-height: 80px;
  resize: vertical;
  line-height: 1.5;
  padding: 16px;
}

.select-wrapper{
  position:relative;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.select{
  appearance:none;
  cursor:pointer;
}
.select-wrapper::after{
  content:'›';
  position:absolute;
  right:var(--spacing-md);
  top:50%;
  transform:translateY(-50%) rotate(90deg);
  color:#6b7280;
  font-size:var(--spacing-lg);
  pointer-events:none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.select:focus + .select-wrapper::after,
.select-wrapper:hover::after {
  color: #6366f1;
  transform:translateY(-50%) rotate(90deg) scale(1.1);
}

/* CALENDAR */
.calendar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  z-index:200;
  display:none;
  align-items:center;
  justify-content:center;
  opacity:0;
  transition:opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar.show{
  display:flex;
  opacity:1;
}
.calendar-content{
  background:rgba(28,28,30,0.95);
  backdrop-filter: blur(40px);
  border:1px solid rgba(44,44,46,0.6);
  border-radius:var(--border-radius);
  padding:var(--spacing-xl);
  margin:var(--spacing-xl);
  max-width:300px;
  width:100%;
  box-shadow:0 16px 64px rgba(0,0,0,0.4);
  transform: scale(0.9);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar.show .calendar-content{
  transform: scale(1);
  animation: scale-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.calendar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:var(--spacing-lg);
}
.calendar-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:#ffffff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar-nav{
  background:rgba(99,102,241,0.1);
  backdrop-filter: blur(10px);
  border:1px solid rgba(99,102,241,0.2);
  font-size:18px;
  color:#6366f1;
  cursor:pointer;
  width:var(--spacing-3xl);
  height:var(--spacing-3xl);
  border-radius:var(--spacing-lg);
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.calendar-nav:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(99,102,241,0.3);
}
.calendar-nav:active{
  opacity:0.7;
  transform:scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.weekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:var(--spacing-xs);
  margin-bottom:var(--spacing-sm);
}
.weekday{
  font-size:var(--spacing-md);
  color:#8e8e93;
  text-align:center;
  padding:var(--spacing-xs);
  font-weight:500;
}

.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:var(--spacing-xs);
}
.calendar-day{
  background:rgba(44,44,46,0.3);
  backdrop-filter: blur(10px);
  border:1px solid rgba(44,44,46,0.4);
  padding:var(--spacing-sm);
  font-size:14px;
  cursor:pointer;
  border-radius:var(--spacing-xs);
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:var(--spacing-3xl);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color:#ffffff;
  transform: translateZ(0);
  font-weight: 500;
}
.calendar-day:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(99,102,241,0.2);
}
.calendar-day:active{
  transform:scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar-day.today{
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  color:white;
  box-shadow:0 4px 16px rgba(99,102,241,0.4);
  border-color: transparent;
  font-weight: 600;
  animation: soft-glow 3s infinite;
}
.calendar-day.selected{
  background:linear-gradient(135deg, #8b5cf6, #a855f7);
  color:white;
  box-shadow:0 4px 16px rgba(139,92,246,0.4);
  border-color: transparent;
  font-weight: 600;
}
.calendar-day.other-month{
  color:#6b7280;
  opacity: 0.5;
}

/* EDIT PLAN SCREEN */
.edit-plan-input{
  font-size:18px;
  font-weight:500;
  background:#2c2c2e;
  border:none;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  color:#ffffff;
  margin-bottom:var(--spacing-xl);
}
.edit-plan-input:focus{
  outline:none;
  background:#3c3c3e;
}

.form-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#2c2c2e;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  cursor:pointer;
  transition:all 0.2s ease;
}
.form-row:active{
  background:#3c3c3e;
}
.form-row span{
  color:#ffffff;
  font-size:var(--spacing-lg);
}

.toggle{
  width:50px;
  height:30px;
  background:#3c3c3e;
  border-radius:15px;
  position:relative;
  cursor:pointer;
  transition:all 0.3s ease;
}
.toggle.active{
  background:#6366f1;
}
.toggle-slider{
  width:26px;
  height:26px;
  background:#ffffff;
  border-radius:13px;
  position:absolute;
  top:2px;
  left:2px;
  transition:all 0.3s ease;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.toggle.active .toggle-slider{
  transform:translateX(20px);
}

.premium-notice{
  display:flex;
  align-items:center;
  background:#2c2c2e;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  margin:var(--spacing-xl) 0;
  font-size:var(--spacing-md);
  color:#8e8e93;
  line-height:1.4;
}
.premium-icon{
  font-size:var(--spacing-lg);
  margin-right:var(--spacing-sm);
  flex-shrink:0;
}
.premium-link{
  color:#6366f1;
  font-weight:500;
}

/* СТАРЫЕ КЛАССЫ delete-btn И save-btn - УДАЛЕНЫ И ЗАМЕНЕНЫ НА ЕДИНУЮ СИСТЕМУ */

/* SIMPLE MENU */
.overlay{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  z-index:150;
  display:none;
  opacity:0;
  transition:opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  align-items:center;
  justify-content:center;
}
.overlay.show{
  display:flex;
  opacity:1;
}
.menu{
  background:rgba(28,28,30,0.95);
  backdrop-filter: blur(40px);
  border:1px solid rgba(44,44,46,0.6);
  border-radius:var(--border-radius);
  min-width:250px;
  box-shadow:0 16px 64px rgba(0,0,0,0.4);
  overflow:hidden;
  transform: scale(0.9);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.overlay.show .menu{
  transform: scale(1);
  animation: scale-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
/* СТАРЫЕ КЛАССЫ menu-btn - УДАЛЕНЫ И ЗАМЕНЕНЫ НА ЕДИНУЮ СИСТЕМУ */



/* NUTRITION CONTAINER - НОВАЯ СТРУКТУРА ДЛЯ ПРАВИЛЬНОГО СКРОЛЛА */
.nutrition-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

.meals-scroll-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding-top: var(--spacing-xl); /* Добавляем отступ сверху */
}

.meals-scroll-container::-webkit-scrollbar {
  display: none;
}

/* NUTRITION STYLES - УЛУЧШЕННЫЕ СТИЛИ ПИТАНИЯ */
.water-tracker{
  background: linear-gradient(135deg, 
    rgba(6, 182, 212, 0.1) 0%, 
    rgba(14, 165, 233, 0.1) 50%,
    rgba(59, 130, 246, 0.1) 100%);
  backdrop-filter: blur(30px);
  border: 1px solid rgba(6, 182, 212, 0.2);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xl);
  margin: var(--spacing-xl);
  margin-bottom: var(--spacing-xl); /* Восстанавливаем нижний отступ для разделения */
  box-shadow: var(--shadow-medium);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  animation: slideInFromRight 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
  flex-shrink: 0; /* Не сжимается при нехватке места */
}
.water-tracker::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(6, 182, 212, 0.1), 
    transparent);
  animation: water-shimmer-bg 4s infinite;
}
@keyframes water-shimmer-bg {
  0% { left: -100%; }
  100% { left: 100%; }
}
.water-tracker.completed{
  border-color: rgba(34, 197, 94, 0.4);
  background: linear-gradient(135deg, 
    rgba(34, 197, 94, 0.1) 0%, 
    rgba(16, 185, 129, 0.1) 50%,
    rgba(5, 150, 105, 0.1) 100%);
  box-shadow: 
    0 12px 40px rgba(34, 197, 94, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.05) inset;
  animation: water-completion-glow 2s infinite ease-in-out;
}
@keyframes water-completion-glow {
  0%, 100% { 
    box-shadow: 
      0 12px 40px rgba(34, 197, 94, 0.2),
      0 1px 0 rgba(255, 255, 255, 0.05) inset;
  }
  50% { 
    box-shadow: 
      0 16px 50px rgba(34, 197, 94, 0.3),
      0 1px 0 rgba(255, 255, 255, 0.1) inset;
  }
}

.water-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-xl);
  position: relative;
  z-index: 2;
}
.water-info{
  flex: 1;
}
.water-label{
  font-size: 18px;
  color: var(--text-primary);
  font-weight: 700;
  margin-bottom: 6px;
  text-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  letter-spacing: 0.3px;
}
.water-stats{
  font-size: 15px;
  color: var(--text-secondary);
  font-weight: 500;
}
.water-settings-btn{
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  font-size: 18px;
  color: var(--text-secondary);
  cursor: pointer;
  padding: var(--spacing-md);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.water-settings-btn:hover{
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.water-progress{
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
  position: relative;
  z-index: 2;
}
.water-progress-bar{
  flex: 1;
  height: 12px;
  background: rgba(59, 130, 246, 0.15);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) inset;
  border: 1px solid rgba(59, 130, 246, 0.2);
}
.water-progress-fill{
  height: 100%;
  background: linear-gradient(90deg, 
    #3b82f6 0%, 
    #0ea5e9 50%, 
    #06b6d4 100%);
  border-radius: 6px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
}
.water-progress-fill::after{
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255,255,255,0.4), 
    transparent);
  animation: water-shimmer 2.5s infinite;
}
@keyframes water-shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* SECTIONS MANAGER ANIMATIONS - АНИМАЦИИ ДЛЯ УПРАВЛЕНИЯ РАЗДЕЛАМИ */
@keyframes sections-shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

@keyframes sections-icon-pulse {
  0%, 100% { 
    transform: scale(1);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5);
  }
}

/* Hover эффекты для кнопки разделов */
.sections-manager-card:hover {
  transform: translateY(-4px) scale(1.02) !important;
  box-shadow: 
    0 16px 48px rgba(99, 102, 241, 0.25),
    0 1px 0 rgba(255, 255, 255, 0.15) inset !important;
  border-color: rgba(99, 102, 241, 0.4) !important;
}

.sections-manager-card:hover .sections-arrow {
  transform: translateX(4px) !important;
  color: var(--accent-secondary) !important;
}

.sections-manager-card:active {
  transform: translateY(-2px) scale(1.01) !important;
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.water-controls{
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
}

/* ИСПРАВЛЯЕМ КНОПКИ ВОДЫ - ДЕЛАЕМ ИХ ВИДИМЫМИ И ОДИНАКОВЫМИ */
.water-btn{
  width: 40px;
  height: 40px;
  background: var(--bg-tertiary);
  border: 2px solid rgba(6, 182, 212, 0.3);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-water);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-soft);
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.water-btn:hover{
  background: var(--accent-water);
  color: white;
  transform: scale(1.15);
  box-shadow: var(--shadow-medium);
  border-color: var(--accent-water);
}
.water-btn:active{
  transform: scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* УБЕЖДАЕМСЯ ЧТО КНОПКА ПЛЮС ВИДНА */
.water-btn.plus{
  background: var(--bg-tertiary);
  border: 2px solid rgba(6, 182, 212, 0.3);
  color: var(--accent-water);
}
.water-btn.minus{
  background: var(--bg-tertiary);
  border: 2px solid rgba(6, 182, 212, 0.3);
  color: var(--accent-water);
}

.water-current{
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  min-width: 40px;
  text-align: center;
  cursor: pointer;
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--spacing-sm);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid transparent;
  background: rgba(6, 182, 212, 0.05);
  text-shadow: 0 1px 3px rgba(6, 182, 212, 0.3);
}
.water-current:hover{
  background: rgba(6, 182, 212, 0.15);
  border-color: rgba(6, 182, 212, 0.3);
  color: var(--accent-water);
  transform: scale(1.1);
  box-shadow: var(--shadow-soft);
}
.water-current:active{
  transform: scale(1.05);
}

/* DAY NAVIGATION - УЛУЧШЕННАЯ НАВИГАЦИЯ ПО ДНЯМ */
.day-nav{
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-lg) var(--spacing-xl);
  gap: var(--spacing-2xl);
  animation: slideInFromLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
  flex-shrink: 0; /* Не сжимается */
}
.day-arrow{
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-primary);
  border-radius: 14px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: var(--accent-primary);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.day-arrow:hover{
  background: var(--accent-primary);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
  border-color: var(--accent-primary);
}
.day-arrow:active{
  transform: scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.day-title{
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  letter-spacing: 0.3px;
}

/* SINGLE DAY CONTAINER - КОНТЕЙНЕР ДНЯ */
.single-day-container{
  padding: 0 var(--spacing-xl) var(--spacing-xl); /* Убираем верхний отступ, так как он уже есть в meals-scroll-container */
  animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

/* ADD MEAL CONTAINER - КОНТЕЙНЕР КНОПКИ ДОБАВЛЕНИЯ */
.add-meal-container {
  padding: var(--spacing-lg) 0;
  margin-top: var(--spacing-lg);
}
.single-day-container .day-card{
  max-width: 600px;
  margin: 0 auto;
}

/* DAY CARD - КАРТОЧКА ДНЯ */
.day-card{
  background: var(--bg-card);
  backdrop-filter: blur(30px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xl);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.15),
    0 1px 0 rgba(255, 255, 255, 0.05) inset;
  position: relative;
  overflow: hidden;
}
.day-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.02) 0%, 
    rgba(139, 92, 246, 0.02) 100%);
  pointer-events: none;
}
.day-card.today{
  border-color: rgba(99, 102, 241, 0.3);
  box-shadow: 
    0 16px 50px rgba(99, 102, 241, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
}

/* MEALS CONTAINER - КОНТЕЙНЕР ПРИЕМОВ ПИЩИ */
.meals{
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
  position: relative;
  z-index: 2;
}

/* MEAL CARDS - КАРТОЧКИ ПРИЕМОВ ПИЩИ */
.meal{
  background: var(--bg-tertiary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-secondary);
  border-radius: var(--border-radius);
  padding: var(--spacing-xl);
  cursor: pointer;
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
  position: relative;
  overflow: hidden;
  animation: floatIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
  box-shadow: 
    0 4px 16px rgba(0, 0, 0, 0.08),
    0 1px 0 rgba(255, 255, 255, 0.03) inset;
}
.meal::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.03), 
    rgba(139, 92, 246, 0.03));
  opacity: 0;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(99, 102, 241, 0.1), 
    transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Анимационные задержки для приемов пищи */
.meal:nth-child(1) { animation-delay: 0.1s; }
.meal:nth-child(2) { animation-delay: 0.15s; }
.meal:nth-child(3) { animation-delay: 0.2s; }
.meal:nth-child(4) { animation-delay: 0.25s; }
.meal:nth-child(5) { animation-delay: 0.3s; }

.meal:hover{
  background: var(--bg-card-hover);
  border-color: var(--border-primary);
  transform: translateY(-4px) scale(1.02);
  box-shadow: var(--shadow-medium);
}
.meal:hover::before {
  opacity: 1;
}
.meal:hover::after {
  left: 100%;
}
.meal:active {
  transform: translateY(-2px) scale(1.01);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* COMPLETED MEAL STYLES - СТИЛИ ДЛЯ ВЫПОЛНЕННЫХ ПРИЕМОВ ПИЩИ */
.meal.completed {
  opacity: 0.8;
  background: var(--bg-secondary);
  border-color: rgba(34, 197, 94, 0.3);
}
.meal.completed .meal-label {
  color: var(--text-muted);
  position: relative;
  display: inline-block; /* Важно для точного зачеркивания */
}
.meal.completed .meal-label::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 0;
  max-width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--text-muted), var(--text-secondary));
  border-radius: 1px;
  transform: translateY(-50%);
  animation: meal-label-strikethrough 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s forwards;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}
.meal.completed .meal-content {
  color: var(--text-muted);
  position: relative;
  display: inline-block; /* Важно для точного зачеркивания */
  width: 100%; /* Занимает всю ширину, но зачеркивание только по тексту */
}
.meal.completed .meal-content::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 0;
  max-width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--text-muted), var(--text-secondary));
  border-radius: 1px;
  transform: translateY(-50%);
  animation: meal-content-strikethrough 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Анимации зачеркивания для разных частей приема пищи */
@keyframes meal-label-strikethrough {
  0% {
    width: 0;
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    width: var(--text-width, 100%);
    opacity: 1;
  }
}

@keyframes meal-content-strikethrough {
  0% {
    width: 0;
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    width: var(--text-width, 100%);
    opacity: 1;
  }
}

/* Улучшенные стили для зачеркнутого текста */
.meal.completed .meal-label,
.meal.completed .meal-content {
  transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Стили для значков времени в выполненных приемах */
.meal.completed .meal-time-badge {
  background: rgba(34, 197, 94, 0.15);
  border-color: rgba(34, 197, 94, 0.3);
  color: #22c55e;
}

/* ADD MEAL BUTTON */
.meal.add-meal{
  background: linear-gradient(135deg, 
    rgba(74, 222, 128, 0.08) 0%, 
    rgba(34, 197, 94, 0.08) 100%);
  border: 2px dashed var(--border-primary);
  color: var(--accent-primary);
  text-align: center;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.meal.add-meal:hover{
  background: linear-gradient(135deg, 
    rgba(74, 222, 128, 0.15) 0%, 
    rgba(34, 197, 94, 0.15) 100%);
  border-style: solid;
  border-color: var(--accent-primary);
  transform: translateY(-2px) scale(1.01);
}

/* MEAL CONTENT */
.meal-header{
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  position: relative;
  z-index: 2;
}

/* MEAL CHECKBOX - ЧЕКБОКС ДЛЯ ПРИЕМОВ ПИЩИ */
.meal-checkbox{
  width: 24px;
  height: 24px;
  border: 2px solid rgba(34, 197, 94, 0.3);
  border-radius: 12px;
  margin-right: var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  transform: translateZ(0);
  background: var(--bg-tertiary);
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.2) inset,
    0 1px 0 rgba(255, 255, 255, 0.1);
  position: relative;
  z-index: 10;
}
.meal-checkbox:hover {
  transform: scale(1.1);
  box-shadow: 
    0 0 20px rgba(34, 197, 94, 0.4),
    0 2px 8px rgba(0, 0, 0, 0.2) inset;
  border-color: rgba(34, 197, 94, 0.5);
}
.meal-checkbox.checked {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-color: #22c55e;
  box-shadow: 
    0 0 20px rgba(34, 197, 94, 0.6),
    0 1px 0 rgba(255, 255, 255, 0.3) inset;
  transform: scale(1.05);
}
.meal-checkbox.checked::after {
  content: '✓';
  color: white;
  font-size: 14px;
  font-weight: bold;
  animation: meal-checkmark-appear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* Анимация появления галочки для приемов пищи */
@keyframes meal-checkmark-appear {
  0% {
    transform: scale(0) rotate(-45deg);
    opacity: 0;
  }
  50% {
    transform: scale(1.2) rotate(-22deg);
    opacity: 1;
  }
  100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

/* MEAL WITH CHECKBOX LAYOUT */
.meal-with-checkbox {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-lg);
}

.meal-main-content {
  flex: 1;
  cursor: pointer;
}
.meal-label{
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}
.meal.add-meal .meal-label{
  color: var(--accent-primary);
  font-size: 15px;
  font-weight: 600;
}
.meal-content{
  font-size: 15px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.4;
  position: relative;
  z-index: 2;
}
.meal.add-meal .meal-content{
  color: var(--accent-secondary);
  font-size: 14px;
}

/* DELETE MEAL BUTTON - УЛУЧШЕННАЯ КНОПКА УДАЛЕНИЯ */
.delete-meal-btn{
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border-radius: 8px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
  backdrop-filter: blur(10px);
  opacity: 0.7;
  transform: scale(0.9);
}
.delete-meal-btn:hover{
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
  opacity: 1;
}
.delete-meal-btn:active{
  transform: scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Показываем кнопку удаления только при ховере на прием пищи */
.meal .delete-meal-btn {
  opacity: 0;
  transform: scale(0.8);
  pointer-events: none;
}
.meal:hover .delete-meal-btn {
  opacity: 0.7;
  transform: scale(0.9);
  pointer-events: auto;
}
.meal:hover .delete-meal-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* MEAL TIME BADGE */
.meal-time-badge{
  font-size: 11px;
  color: var(--accent-primary);
  background: rgba(99, 102, 241, 0.15);
  backdrop-filter: blur(10px);
  padding: 3px 8px;
  border-radius: 6px;
  margin-left: var(--spacing-sm);
  font-weight: 700;
  border: 1px solid rgba(99, 102, 241, 0.3);
  letter-spacing: 0.3px;
  text-shadow: 0 1px 2px rgba(99, 102, 241, 0.2);
}

/* MEAL TYPE SELECTOR MODAL - УЛУЧШЕННЫЙ СЕЛЕКТОР ТИПОВ ПРИЕМОВ ПИЩИ */
.meal-type-modal{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(30px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-modal.show{
  opacity: 1;
}
.meal-type-modal-content{
  background: var(--bg-secondary);
  backdrop-filter: blur(40px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius-lg);
  margin: var(--spacing-xl);
  max-width: 420px;
  width: 100%;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.4),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
  transform: scale(0.9) translateY(20px);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  position: relative;
}
.meal-type-modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.05) 0%, 
    rgba(139, 92, 246, 0.05) 100%);
  pointer-events: none;
}
.meal-type-modal.show .meal-type-modal-content{
  transform: scale(1) translateY(0);
}
.meal-type-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-2xl);
  border-bottom: 1px solid var(--border-secondary);
  position: relative;
  z-index: 2;
}
.meal-type-header h3{
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.meal-type-close{
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  font-size: 20px;
  color: #ef4444;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.meal-type-close:hover{
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}
.meal-type-options{
  padding: var(--spacing-2xl);
  display: grid;
  gap: var(--spacing-lg);
  position: relative;
  z-index: 2;
}

.meal-type-option{
  display: flex;
  align-items: center;
  padding: var(--spacing-xl);
  background: var(--bg-tertiary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-secondary);
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.meal-type-option::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.05), 
    rgba(139, 92, 246, 0.05));
  opacity: 0;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-option::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(99, 102, 241, 0.1), 
    transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-option:hover{
  background: var(--bg-card-hover);
  border-color: rgba(99, 102, 241, 0.4);
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}
.meal-type-option:hover::before {
  opacity: 1;
}
.meal-type-option:hover::after {
  left: 100%;
}
.meal-type-option:active{
  transform: translateY(-1px) scale(1.01);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-icon{
  font-size: 24px;
  margin-right: var(--spacing-lg);
  position: relative;
  z-index: 2;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}
.meal-type-name{
  font-size: 17px;
  font-weight: 600;
  color: var(--text-primary);
  position: relative;
  z-index: 2;
}

/* MEAL INPUT MODAL - УЛУЧШЕННОЕ МОДАЛЬНОЕ ОКНО ВВОДА */
.meal-input-modal{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(30px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-input-modal.show{
  opacity: 1;
}
.meal-input-modal-content{
  background: var(--bg-secondary);
  backdrop-filter: blur(40px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius-lg);
  margin: var(--spacing-xl);
  max-width: 520px;
  width: 100%;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.4),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
  transform: scale(0.9) translateY(20px);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  position: relative;
}
.meal-input-modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.05) 0%, 
    rgba(139, 92, 246, 0.05) 100%);
  pointer-events: none;
}
.meal-input-modal.show .meal-input-modal-content{
  transform: scale(1) translateY(0);
}
.meal-input-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-2xl);
  border-bottom: 1px solid var(--border-secondary);
  position: relative;
  z-index: 2;
}
.meal-input-header h3{
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.meal-input-close{
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  font-size: 20px;
  color: #ef4444;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.meal-input-close:hover{
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}
.meal-input-form{
  padding: var(--spacing-2xl);
  position: relative;
  z-index: 2;
}
.meal-content-input{
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
  line-height: 1.5;
}
.meal-input-buttons{
  display: flex;
  gap: var(--spacing-lg);
  padding: var(--spacing-2xl);
  border-top: 1px solid var(--border-secondary);
  position: relative;
  z-index: 2;
}
.btn-secondary{
  flex: 1;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius);
  padding: var(--spacing-lg) var(--spacing-xl);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(20px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.btn-secondary:hover{
  background: var(--bg-card-hover);
  border-color: var(--border-primary);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}
.btn-primary{
  flex: 1;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: var(--spacing-lg) var(--spacing-xl);
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
  position: relative;
  overflow: hidden;
}
.btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255,255,255,0.3), 
    transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.btn-primary:hover{
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
}
.btn-primary:hover::before {
  left: 100%;
}
.btn-primary:active{
  transform: translateY(-1px) scale(1.01);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* BOTTOM NAVIGATION */
.bottom-nav{
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-modal);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-soft);
  display: flex;
  padding: var(--spacing-sm) 0 calc(var(--spacing-sm) + env(safe-area-inset-bottom));
  z-index: 50;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
}
.nav-item{
  flex: 1;
  background: none;
  border: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-sm);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}
.nav-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--accent-primary);
  opacity: 0.1;
  border-radius: var(--spacing-md);
  margin: var(--spacing-xs);
  transform: scale(0);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.nav-item:hover::before {
  transform: scale(1);
}
.nav-item.active::before {
  transform: scale(1);
  background: var(--accent-primary);
  opacity: 0.15;
}
.nav-icon{
  font-size: 20px;
  margin-bottom: 2px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 1;
}
.nav-label{
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 1;
  letter-spacing: 0.2px;
}
.nav-item.active .nav-label{
  color: var(--accent-primary);
  font-weight: 600;
}
.nav-item:hover .nav-icon{
  transform: scale(1.1);
}
.nav-item:active{
  transform: scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* SCREENS */
.screen{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:var(--bg-primary);
  z-index:100;
  display:none;
  flex-direction:column;
  height:100vh;
  overflow:hidden;
  transform:translateX(100%);
  transition:all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  opacity:0;
}
.screen.show{
  display:flex;
  transform:translateX(0);
  opacity:1;
}
.screen.show .screen-content{
  animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

/* Улучшенные переходы для экранов */
.screen-header{
  padding:var(--spacing-md) var(--spacing-xl);
  background:var(--bg-modal);
  backdrop-filter: blur(30px);
  border-bottom:1px solid var(--border-soft);
  display:flex;
  align-items:center;
  justify-content:space-between;
  height:68px;
  flex-shrink:0;
  box-shadow: var(--shadow-soft);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.screen-content{
  flex:1;
  overflow-y:auto;
  padding:var(--spacing-xl);
  background: var(--bg-primary);
}
.screen-content::-webkit-scrollbar{display:none}

/* ROOM ITEMS */
.room-item{
  background:rgba(28,28,30,0.8);
  backdrop-filter: blur(20px);
  border:1px solid rgba(44,44,46,0.6);
  border-radius:var(--border-radius);
  padding:var(--spacing-lg);
  margin-bottom:var(--spacing-md);
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
  animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}
.room-item:nth-child(1) { animation-delay: 0.1s; }
.room-item:nth-child(2) { animation-delay: 0.15s; }
.room-item:nth-child(3) { animation-delay: 0.2s; }

.room-item:hover{
  transform: translateY(-2px);
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
  border-color: rgba(99,102,241,0.3);
}
.room-item:active{
  opacity:0.9;
  transform:scale(0.98);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.room-name{
  font-size:var(--spacing-lg);
  font-weight:500;
  color:#ffffff;
  flex:1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.room-icon{
  font-size:18px;
  margin-right:var(--spacing-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
}
/* СТАРЫЕ КЛАССЫ delete-room И edit-room - УДАЛЕНЫ И ЗАМЕНЕНЫ НА ЕДИНУЮ СИСТЕМУ */

.add-room-fab{
  position:fixed;
  bottom:var(--spacing-2xl);
  right:var(--spacing-2xl);
  width:56px;
  height:56px;
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border:none;
  border-radius:28px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:50;
  font-size:var(--spacing-xl);
  color:white;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 8px 32px rgba(99,102,241,0.4);
  transform: translateZ(0);
  backdrop-filter: blur(20px);
}
.add-room-fab:hover{
  transform: scale(1.1) translateY(-2px);
  box-shadow:0 16px 48px rgba(99,102,241,0.5);
  animation: gentle-pulse 2s infinite;
}
.add-room-fab:active{
  opacity:0.9;
  transform:scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* PROFILE */
.profile-section{
  background:#1c1c1e;
  border:1px solid #2c2c2e;
  margin-bottom:var(--spacing-lg);
  border-radius:var(--border-radius);
  padding:var(--spacing-xl);
  box-shadow:0 2px var(--spacing-sm) rgba(0,0,0,0.4);
}
.profile-avatar{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}
.avatar-circle{
  width:64px;
  height:64px;
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border-radius:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:var(--spacing-2xl);
  font-weight:600;
  margin-bottom:var(--spacing-md);
  box-shadow:0 var(--spacing-xs) var(--spacing-md) rgba(99,102,241,0.3);
}
.profile-name{
  font-size:18px;
  font-weight:600;
  color:#ffffff;
  margin-bottom:var(--spacing-sm);
}
.edit-name-btn{
  background:none;
  border:none;
  color:#6366f1;
  font-size:14px;
  cursor:pointer;
  padding:var(--spacing-xs) var(--spacing-md);
  border-radius:var(--spacing-xs);
  font-weight:500;
  transition:all 0.2s ease;
}
.edit-name-btn:active{opacity:0.6;background:rgba(99,102,241,0.2)}

.profile-menu{
  display:flex;
  flex-direction:column;
  gap:var(--spacing-md);
}
.profile-menu-btn{
  width:100%;
  background:#1c1c1e;
  border:1px solid #2c2c2e;
  border-radius:var(--border-radius);
  padding:var(--spacing-lg);
  display:flex;
  align-items:center;
  cursor:pointer;
  box-shadow:0 2px var(--spacing-sm) rgba(0,0,0,0.4);
  transition:all 0.2s ease;
  text-align:left;
}
.profile-menu-btn:active{opacity:0.8;transform:scale(0.98)}
.menu-btn-icon{
  font-size:var(--spacing-xl);
  margin-right:var(--spacing-md);
  width:28px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.menu-btn-text{flex:1}
.menu-btn-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:#ffffff;
  margin-bottom:2px;
}
.menu-btn-desc{
  font-size:var(--spacing-md);
  color:#8e8e93;
}
.menu-btn-arrow{
  font-size:var(--spacing-lg);
  color:#6b7280;
}

/* POPUP */
.popup{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  z-index:300;
  display:none;
  align-items:center;
  justify-content:center;
  opacity:0;
  transition:opacity 0.3s ease;
}
.popup.show{
  display:flex;
  opacity:1;
}
.popup-content{
  background:#1c1c1e;
  border:1px solid #2c2c2e;
  border-radius:var(--border-radius);
  padding:var(--spacing-xl);
  margin:var(--spacing-xl);
  max-width:280px;
  width:100%;
  box-shadow:0 var(--spacing-sm) var(--spacing-3xl) rgba(0,0,0,0.6);
  text-align:center;
}
.popup-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:#ffffff;
  margin-bottom:var(--spacing-sm);
}
.popup-message{
  font-size:14px;
  color:#8e8e93;
  margin-bottom:var(--spacing-lg);
  line-height:1.4;
}
.popup-buttons{
  display:flex;
  gap:var(--spacing-sm);
}
/* СТАРЫЕ КЛАССЫ popup-btn - УДАЛЕНЫ И ЗАМЕНЕНЫ НА ЕДИНУЮ СИСТЕМУ */

/* ICON SELECTOR */
.icon-selector{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:var(--spacing-sm);
  margin:var(--spacing-lg) 0;
  max-height:200px;
  overflow-y:auto;
}
.icon-option{
  width:44px;
  height:44px;
  background:rgba(44,44,46,0.6);
  border:2px solid transparent;
  border-radius:var(--spacing-md);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.icon-option:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  transform:scale(1.05);
}
.icon-option.selected{
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border-color:#6366f1;
  box-shadow:0 4px 16px rgba(99,102,241,0.4);
  transform:scale(1.1);
}
.icon-option:active{
  transform:scale(0.95);
}

/* SPLASH SCREEN - ПРИВЕТСТВЕННЫЙ ЭКРАН */
.splash-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background: linear-gradient(135deg, 
    #fefefe 0%, 
    #f8faf8 50%, 
    #f1f5f1 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  opacity: 1;
  transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(20px);
}

/* Темная тема для splash */
@media (prefers-color-scheme: dark) {
  .splash-screen {
    background: linear-gradient(135deg, 
      #0f1419 0%, 
      #1a1f2e 50%, 
      #252a3a 100%);
  }
}

.splash-screen.fade-out {
  opacity: 0;
  transform: scale(1.05);
  pointer-events: none;
}

.splash-content {
  text-align: center;
  padding: 40px 20px;
  animation: splash-fade-in 0.8s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.splash-greeting {
  font-size: 24px;
  font-weight: 300;
  color: var(--text-primary);
  line-height: 1.4;
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  letter-spacing: 0.3px;
  opacity: 0;
  animation: splash-text-appear 1s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

.splash-subtitle {
  font-size: 16px;
  font-weight: 400;
  color: var(--text-secondary);
  margin: 12px 0 0 0;
  opacity: 0;
  animation: splash-text-appear 1s cubic-bezier(0.4, 0, 0.2, 1) 0.4s both;
}

/* Мягкие анимации для splash экрана */
@keyframes splash-fade-in {
  0% {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
    filter: blur(10px);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0px);
  }
}

@keyframes splash-text-appear {
  0% {
    opacity: 0;
    transform: translateY(15px);
    filter: blur(5px);
  }
  100% {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0px);
  }
}

/* Скрываем основное приложение пока показывается splash */
.app.splash-loading {
  opacity: 0;
  pointer-events: none;
}
</style>
</head>
<body>
<!-- SPLASH SCREEN - ПРИВЕТСТВЕННЫЙ ЭКРАН -->
<div class="splash-screen" id="splashScreen">
  <div class="splash-content">
    <h1 class="splash-greeting" id="splashGreeting">Добро пожаловать</h1>
    <p class="splash-subtitle" id="splashSubtitle">Готовим ваш день</p>
  </div>
</div>

<div class="app splash-loading" id="mainApp">
  <div class="header">
    <button class="btn-tertiary btn-round" onclick="showProfile()">П</button>
    <div class="date-nav">
      <button class="btn-tertiary btn-round-small" onclick="changeDay(-1)">‹</button>
      <div class="date-content" onclick="showDatePicker()">
        <div class="date-title" id="dayTitle">Сегодня</div>
        <div class="date-subtitle" id="daySubtitle">Пн, 27 янв.</div>
      </div>
      <button class="btn-tertiary btn-round-small" onclick="changeDay(1)">›</button>
    </div>
    <button class="btn-tertiary btn-round" onclick="showRooms()" id="roomsBtn">🏠</button>
  </div>
  
  <div class="content">
    <div class="progress-container" id="progressContainer">
      <div class="progress-info">
        <div class="progress-label" id="progressLabel">Прогресс дня</div>
        <div class="progress-stats" id="progressStats">0/0</div>
      </div>
      <div class="progress-circle-container">
        <div class="progress-circle" id="progressCircle">
          <div class="progress-circle-inner">
            <div class="progress-percentage" id="progressPercentage">0%</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="empty" id="empty">
      <h2>Планов нет</h2>
      <p>Добавьте первую задачу</p>
      <button class="btn-primary" onclick="showAdd()">Добавить задачу</button>
    </div>
    
    <div class="plans-container" id="plansContainer" style="display:none">
      <div class="plans" id="plans"></div>
    </div>
  </div>
</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav" id="bottomNav">
  <button class="nav-item active" onclick="switchTab('tasks')" data-tab="tasks">
    <div class="nav-icon" id="tasksIcon">📝</div>
    <div class="nav-label">Задачи</div>
  </button>
  <button class="nav-item" onclick="switchTab('nutrition')" data-tab="nutrition">
    <div class="nav-icon" id="nutritionIcon">🍽️</div>
    <div class="nav-label">Питание</div>
  </button>
  <button class="nav-item" onclick="switchTab('habits')" data-tab="habits">
    <div class="nav-icon" id="habitsIcon">🎯</div>
    <div class="nav-label">Привычки</div>
  </button>
</div>

<!-- ADD PLAN MODAL -->
<div class="modal" id="addModal">
  <div class="modal-header">
    <div class="modal-header-actions">
      <button class="btn-tertiary" onclick="hideAdd()">Отмена</button>
    </div>
    <div class="modal-title">Новая задача</div>
    <div class="modal-header-actions">
      <button class="btn-primary" onclick="savePlan()">Готово</button>
    </div>
  </div>
  <div class="modal-content">
    <div class="form-group">
      <label class="label">Что планируете</label>
      <input class="input" id="planTitle" placeholder="Что вы планируете сделать?" autofocus>
    </div>
    <div class="form-group">
      <label class="label">Дата</label>
      <input type="date" class="input" id="planDate">
    </div>
    <div class="form-group">
      <label class="label">Время (необязательно)</label>
      <input type="time" class="input" id="planTime" placeholder="Выберите время">
    </div>
    <div class="form-group">
      <label class="label">Раздел</label>
      <div class="select-wrapper">
        <select class="select" id="planRoom">
          <option value="">Без раздела</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- CALENDAR -->
<div class="calendar" id="calendar" onclick="hideCalendar()">
  <div class="calendar-content" onclick="event.stopPropagation()">
    <div class="calendar-header">
      <button class="btn-tertiary btn-round-small" onclick="changeCalendarMonth(-1)">‹</button>
      <div class="calendar-title" id="calendarTitle">Январь 2025</div>
      <button class="btn-tertiary btn-round-small" onclick="changeCalendarMonth(1)">›</button>
    </div>
    <div class="weekdays">
      <div class="weekday">Пн</div>
      <div class="weekday">Вт</div>
      <div class="weekday">Ср</div>
      <div class="weekday">Чт</div>
      <div class="weekday">Пт</div>
      <div class="weekday">Сб</div>
      <div class="weekday">Вс</div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

<!-- EDIT PLAN SCREEN -->
<div class="screen" id="editPlanScreen">
  <div class="screen-header">
    <div class="screen-header-actions">
      <button class="btn-tertiary" onclick="hideEditPlan()">Назад</button>
    </div>
    <div class="modal-title">Изменить задачу</div>
    <div></div>
  </div>
  <div class="screen-content">
    <div class="form-group">
      <input class="input edit-plan-input" id="editPlanTitle" placeholder="Название задачи">
    </div>
    
    <div class="form-group">
      <label class="label">Дата</label>
      <div class="form-row" onclick="showEditDatePicker()">
        <span id="editPlanDate">26 янв. 2026г.</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">Уведомление</label>
      <div class="form-row">
        <span>Уведомление</span>
        <div class="toggle" id="notificationToggle" onclick="toggleNotification()">
          <div class="toggle-slider"></div>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">Важная</label>
      <div class="form-row">
        <span>Важная</span>
        <div class="toggle" id="importantToggle" onclick="toggleImportant()">
          <div class="toggle-slider"></div>
        </div>
      </div>
    </div>
    
    <div class="premium-notice">
      <div class="premium-icon" id="premiumIcon">⭐</div>
      <span>Уведомления и пометка «Важная» доступны только с подпиской </span>
      <span class="premium-link">Премиум Трекер</span>
    </div>
    
    <button class="btn-destructive btn-full-width" onclick="deletePlanFromEdit()">
      Удалить задачу
    </button>
  </div>
  
  <div class="screen-footer-actions">
    <button class="btn-primary btn-full-width" onclick="savePlanEdit()">Сохранить</button>
  </div>
</div>

<!-- MENU OVERLAY (simplified) -->
<div class="overlay" id="overlay" onclick="hideMenu()">
  <div class="menu" id="menu" onclick="event.stopPropagation()">
    <button class="btn-secondary btn-full-width" onclick="editPlan()">Редактировать</button>
    <button class="btn-destructive btn-full-width" onclick="deletePlan()">Удалить</button>
  </div>
</div>


<!-- ROOMS SCREEN -->
<div class="screen" id="roomsScreen">
  <div class="screen-header">
    <div class="screen-header-actions">
      <button class="btn-tertiary" onclick="hideRooms()">Назад</button>
    </div>
    <div class="modal-title">Разделы</div>
    <div class="screen-header-actions">
      <button class="btn-primary" onclick="hideRooms()">Готово</button>
    </div>
  </div>
  <div class="screen-content">
    <!-- Красивая кнопка управления рутинными разделами -->
    <div class="sections-manager-card" onclick="showSectionsManager()" style="
      background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.1) 0%, 
        rgba(139, 92, 246, 0.1) 50%,
        rgba(168, 85, 247, 0.1) 100%);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-2xl);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.15),
        0 1px 0 rgba(255, 255, 255, 0.1) inset;
    ">
      <!-- Анимированный фон -->
      <div style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
          transparent, 
          rgba(99, 102, 241, 0.1), 
          transparent);
        animation: sections-shimmer 4s infinite;
        pointer-events: none;
      "></div>
      
      <!-- Основной контент -->
      <div style="position: relative; z-index: 2;">
        <div style="display: flex; align-items: center; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
          <div style="
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
            animation: sections-icon-pulse 3s infinite ease-in-out;
          " id="sectionsIcon">⚙️</div>
          
          <div style="flex: 1;">
            <h3 style="
              margin: 0 0 4px 0;
              font-size: 18px;
              font-weight: 700;
              color: var(--text-primary);
              text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            ">Рутинные разделы</h3>
            <p style="
              margin: 0;
              font-size: 14px;
              color: var(--text-secondary);
              line-height: 1.4;
            ">Автоматические задачи по расписанию</p>
          </div>
          
          <div style="
            color: var(--accent-primary);
            font-size: 20px;
            font-weight: 300;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
          " class="sections-arrow">›</div>
        </div>
        
        <!-- Статистика разделов -->
        <div style="
          display: flex;
          gap: var(--spacing-lg);
          padding-top: var(--spacing-md);
          border-top: 1px solid rgba(99, 102, 241, 0.15);
        ">
          <div style="flex: 1; text-align: center;">
            <div style="
              font-size: 20px;
              font-weight: 700;
              color: var(--accent-primary);
              margin-bottom: 2px;
            " id="sectionsCount">0</div>
            <div style="
              font-size: 11px;
              color: var(--text-muted);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Разделов</div>
          </div>
          
          <div style="flex: 1; text-align: center;">
            <div style="
              font-size: 20px;
              font-weight: 700;
              color: var(--accent-secondary);
              margin-bottom: 2px;
            " id="activeSectionsToday">0</div>
            <div style="
              font-size: 11px;
              color: var(--text-muted);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Активно сегодня</div>
          </div>
          
          <div style="flex: 1; text-align: center;">
            <div style="
              font-size: 20px;
              font-weight: 700;
              color: var(--accent-soft);
              margin-bottom: 2px;
            " id="autoTasksToday">0</div>
            <div style="
              font-size: 11px;
              color: var(--text-muted);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Задач создано</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Обычные разделы -->
    <div style="margin-bottom: var(--spacing-lg);">
      <h3 style="
        color: var(--text-secondary); 
        font-size: 14px; 
        margin-bottom: var(--spacing-md); 
        text-transform: uppercase; 
        letter-spacing: 0.5px;
        font-weight: 600;
      ">Обычные разделы</h3>
      <div id="roomsList"></div>
      <button onclick="showAddRoom()" class="btn-secondary btn-full-width" style="margin-top: 16px;">
        + Добавить обычный раздел
      </button>
    </div>
  </div>
</div>

<!-- PROFILE SCREEN -->
<div class="screen" id="profileScreen">
  <div class="screen-header">
    <div class="screen-header-actions">
      <button class="btn-tertiary" onclick="hideProfile()">Назад</button>
    </div>
    <div class="modal-title">Профиль</div>
    <div class="screen-header-actions">
      <button class="btn-primary" onclick="hideProfile()">Готово</button>
    </div>
  </div>
  <div class="screen-content">
    <div class="profile-section">
      <div class="profile-avatar">
        <div class="avatar-circle">П</div>
        <div class="profile-name" id="profileName">Пользователь</div>
        <button class="btn-tertiary" onclick="editName()">Изменить имя</button>
      </div>
    </div>
    
    <div class="profile-menu">
      <button class="profile-menu-btn" onclick="showAccount()">
        <div class="menu-btn-icon" id="profileIcon">👤</div>
        <div class="menu-btn-text">
          <div class="menu-btn-title">Аккаунт</div>
          <div class="menu-btn-desc">Личные данные и подписка</div>
        </div>
        <div class="menu-btn-arrow">›</div>
      </button>
      
      <button class="profile-menu-btn" onclick="showSettings()">
        <div class="menu-btn-icon" id="settingsIcon">⚙️</div>
        <div class="menu-btn-text">
          <div class="menu-btn-title">Настройки</div>
          <div class="menu-btn-desc">Уведомления и предпочтения</div>
        </div>
        <div class="menu-btn-arrow">›</div>
      </button>
      
      <button class="profile-menu-btn" onclick="showSupport()">
        <div class="menu-btn-icon" id="supportIcon">💬</div>
        <div class="menu-btn-text">
          <div class="menu-btn-title">Поддержка</div>
          <div class="menu-btn-desc">Помощь и обратная связь</div>
        </div>
        <div class="menu-btn-arrow">›</div>
      </button>
    </div>
  </div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content">
    <div class="popup-title" id="popupTitle">Заголовок</div>
    <div class="popup-message" id="popupMessage">Сообщение</div>
    <div class="popup-buttons" id="popupButtons"></div>
  </div>
</div>

<script>
'use strict';

// TELEGRAM WEB APP INIT
const tg = window.Telegram?.WebApp;
let currentModal = null;

if (tg) {
  tg.ready();
  tg.expand();
  tg.enableClosingConfirmation();
  
  // Настройка темы
  if (tg.themeParams) {
    document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#f2f2f7');
    document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
    document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#8e8e93');
    document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#007aff');
    document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#007aff');
    document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
  }
  
  // Обработка кнопки "Назад"
  tg.BackButton.onClick(() => {
    if (currentModal) {
      hideCurrentModal();
    } else {
      tg.close();
    }
  });
  
} else {
}

// ЕДИНАЯ СИСТЕМА ИКОНОК - ИСПОЛЬЗУЕТСЯ ВЕЗДЕ В ПРИЛОЖЕНИИ
const ICONS = {
  // Основные разделы и комнаты
  rooms: ['🏠', '🛏️', '🍳', '🛁', '💼', '🏃', '📚', '🎮', '🌿', '🔧'],
  
  // Дополнительные иконки для разделов
  activities: ['🎯', '🎨', '🎵', '🏋️', '🧘', '🍕', '☕', '🌟', '💡', '🔥'],
  
  // Специальные иконки
  special: ['🎪', '🎭', '🎬', '📱', '💻', '🎸', '🎹', '🎤', '�', '📷'],
  
  // Путешествия и природа
  travel: ['✈️', '🚗', '🏖️', '🏔️', '🌊', '🌙', '☀️', '🌈', '⚡', '❄️'],
  
  // Навигация и интерфейс
  navigation: {
    tasks: '📝',
    nutrition: '🍽️', 
    habits: '🎯',
    home: '🏠',
    profile: '👤',
    settings: '⚙️',
    support: '💬',
    premium: '⭐',
    sections: '⚙️'
  },
  
  // Приемы пищи
  meals: {
    breakfast: '🌅',
    lunch: '🍽️',
    dinner: '🌙',
    snack: '🍎'
  },
  
  // Получить все иконки для выбора
  getAllForSelection() {
    return [
      ...this.rooms,
      ...this.activities, 
      ...this.special,
      ...this.travel
    ];
  },
  
  // Получить иконки для разделов
  getSectionIcons() {
    return [
      '🏃', '🧘', '📚', '🍳', '🧹', '💼', '🎯', '🌱', 
      '💪', '🎨', '🎵', '🛁', '🚿', '🛏️', '🏠'
    ];
  }
};

// STATE
let currentDate = new Date();
let plans = [];
let rooms = []; // Теперь будет массив объектов {name: string, icon: string}
let sections = []; // НОВАЯ СИСТЕМА: разделы с правилами активности и шаблонными задачами
let deletedTasks = {}; // РЕФАКТОРИНГ: контекстное удаление {date: {sourceKey: true}}
let selectedPlanId = null;
let calendarDate = new Date();
let selectedRoomIcon = ICONS.navigation.home; // Используем единую систему иконок
let currentTab = 'tasks'; // Текущая активная вкладка

// ИНИЦИАЛИЗАЦИЯ ИКОНОК - УСТАНАВЛИВАЕМ ИКОНКИ ЧЕРЕЗ JAVASCRIPT
function initializeIcons() {
  try {
    // Навигационные иконки
    const roomsBtn = document.getElementById('roomsBtn');
    if (roomsBtn) roomsBtn.textContent = ICONS.navigation.home;
    
    const tasksIcon = document.getElementById('tasksIcon');
    if (tasksIcon) tasksIcon.textContent = ICONS.navigation.tasks;
    
    const habitsIcon = document.getElementById('habitsIcon');
    if (habitsIcon) habitsIcon.textContent = ICONS.navigation.habits;
    
    const nutritionIcon = document.getElementById('nutritionIcon');
    if (nutritionIcon) nutritionIcon.textContent = ICONS.navigation.nutrition;
    
    const premiumIcon = document.getElementById('premiumIcon');
    if (premiumIcon) premiumIcon.textContent = ICONS.navigation.premium;
    
    const sectionsIcon = document.getElementById('sectionsIcon');
    if (sectionsIcon) sectionsIcon.textContent = ICONS.navigation.sections;
    
    // Иконки профиля
    const profileIcon = document.getElementById('profileIcon');
    if (profileIcon) profileIcon.textContent = ICONS.navigation.profile;
    
    const settingsIcon = document.getElementById('settingsIcon');
    if (settingsIcon) settingsIcon.textContent = ICONS.navigation.settings;
    
    const supportIcon = document.getElementById('supportIcon');
    if (supportIcon) supportIcon.textContent = ICONS.navigation.support;
    
  } catch (e) {
    console.error('❌ Ошибка при инициализации иконок:', e);
  }
}

// TASK SOURCE SYSTEM - УНИФИЦИРОВАННАЯ СИСТЕМА ИСТОЧНИКОВ ЗАДАЧ
function createTaskSource(type, options = {}) {
  const source = { type };
  
  switch (type) {
    case 'manual':
      // Обычные задачи, созданные пользователем
      break;
    case 'section':
      source.sectionId = options.sectionId;
      source.templateId = options.templateId;
      break;
    case 'meal':
      source.mealId = options.mealId;
      break;
    default:
      console.warn('Неизвестный тип источника задачи:', type);
      source.type = 'manual';
  }
  
  return source;
}

function getSourceKey(source) {
  switch (source.type) {
    case 'manual':
      return 'manual';
    case 'section':
      return `section_${source.sectionId}_${source.templateId}`;
    case 'meal':
      return `meal_${source.mealId}`;
    default:
      return 'manual';
  }
}

function isTaskDeleted(date, source) {
  const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
  const sourceKey = getSourceKey(source);
  return deletedTasks[dateStr] && deletedTasks[dateStr][sourceKey];
}

function markTaskAsDeleted(date, source) {
  const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
  const sourceKey = getSourceKey(source);
  
  if (!deletedTasks[dateStr]) {
    deletedTasks[dateStr] = {};
  }
  
  deletedTasks[dateStr][sourceKey] = true;
  saveDeletedTasks();
}

function restoreTask(date, source) {
  const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
  const sourceKey = getSourceKey(source);
  
  if (deletedTasks[dateStr] && deletedTasks[dateStr][sourceKey]) {
    delete deletedTasks[dateStr][sourceKey];
    
    // Очищаем пустые объекты
    if (Object.keys(deletedTasks[dateStr]).length === 0) {
      delete deletedTasks[dateStr];
    }
    
    saveDeletedTasks();
  }
}

// MIGRATION HELPERS - ПОМОЩНИКИ ДЛЯ МИГРАЦИИ СТАРЫХ ДАННЫХ
function migrateTaskToNewSource(task) {
  // Если уже есть source, не мигрируем
  if (task.source) {
    return task;
  }
  
  // Мигрируем из старых флагов
  if (task.createdFromSection && task.sectionId && task.templateId) {
    task.source = createTaskSource('section', {
      sectionId: task.sectionId,
      templateId: task.templateId
    });
  } else if (task.createdFromMeal && task.mealId) {
    task.source = createTaskSource('meal', {
      mealId: task.mealId
    });
  } else {
    task.source = createTaskSource('manual');
  }
  
  // Удаляем старые флаги для чистоты (но сохраняем для обратной совместимости)
  // delete task.createdFromSection;
  // delete task.sectionId;
  // delete task.templateId;
  // delete task.createdFromMeal;
  // delete task.mealId;
  
  return task;
}

function migrateDeletedTasks() {
  // Мигрируем из старой системы deletedTaskIds и deletedSectionTasks
  const oldDeletedTaskIds = localStorage.getItem('planner_deleted_task_ids');
  const oldDeletedSectionTasks = localStorage.getItem('planner_deleted_section_tasks');
  
  if (oldDeletedTaskIds) {
    try {
      const deletedIds = JSON.parse(oldDeletedTaskIds);
      console.log('Мигрируем deletedTaskIds:', deletedIds.length, 'записей');
      
      // Находим задачи с этими ID и помечаем их как удаленные
      deletedIds.forEach(taskId => {
        const task = plans.find(p => p.id === taskId);
        if (task) {
          markTaskAsDeleted(task.date, task.source || createTaskSource('manual'));
        }
      });
      
      // Удаляем старые данные после миграции
      localStorage.removeItem('planner_deleted_task_ids');
    } catch (e) {
      console.error('Ошибка миграции deletedTaskIds:', e);
    }
  }
  
  if (oldDeletedSectionTasks) {
    try {
      const oldDeleted = JSON.parse(oldDeletedSectionTasks);
      console.log('Мигрируем deletedSectionTasks');
      
      Object.keys(oldDeleted).forEach(dateStr => {
        const dayDeleted = oldDeleted[dateStr];
        Object.keys(dayDeleted).forEach(sectionId => {
          const templateIds = dayDeleted[sectionId];
          templateIds.forEach(templateId => {
            const source = createTaskSource('section', { sectionId, templateId });
            markTaskAsDeleted(dateStr, source);
          });
        });
      });
      
      // Удаляем старые данные после миграции
      localStorage.removeItem('planner_deleted_section_tasks');
    } catch (e) {
      console.error('Ошибка миграции deletedSectionTasks:', e);
    }
  }
}

// UTILS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(date) {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  if (date.toDateString() === today.toDateString()) return 'Сегодня';
  if (date.toDateString() === tomorrow.toDateString()) return 'Завтра';
  if (date.toDateString() === yesterday.toDateString()) return 'Вчера';
  
  return date.toLocaleDateString('ru-RU', { weekday: 'long' });
}

function formatDateSubtitle(date) {
  const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}.`;
}

function getRoomIcon(roomName) {
  const room = rooms.find(room => {
    const name = typeof room === 'string' ? room : room.name;
    return name === roomName;
  });
  
  if (room && typeof room === 'object') {
    return room.icon;
  }
  
  // Если раздел не найден или в старом формате, возвращаем дефолтную иконку
  return ICONS.navigation.home;
}

function getPlansForDate(date) {
  // Преобразуем Date в строку YYYY-MM-DD
  const dateStr = date instanceof Date ? date.toISOString().split('T')[0] : date;
  
  const dayPlans = plans.filter(p => {
    // Сравниваем строки напрямую, без создания Date объектов
    const planDate = p.date; // Уже должна быть строка YYYY-MM-DD
    return planDate === dateStr;
  });
  
  // Сортируем по времени: сначала задачи с временем (по времени), потом без времени
  const sortedPlans = dayPlans.sort((a, b) => {
    // Если у обеих задач есть время - сортируем по времени
    if (a.time && b.time) {
      return a.time.localeCompare(b.time);
    }
    // Задачи с временем идут первыми
    if (a.time && !b.time) return -1;
    if (!a.time && b.time) return 1;
    // Если у обеих нет времени - оставляем исходный порядок
    return 0;
  });
  
  return sortedPlans;
}

// STORAGE
function loadData() {
  try {
    // Проверяем, что есть в localStorage
    const savedPlans = localStorage.getItem('planner_plans');
    const savedRooms = localStorage.getItem('planner_teams');
    
    // Миграция старых данных
    const oldPlans = localStorage.getItem('plans');
    const oldTeams = localStorage.getItem('teams');
    const oldRooms = localStorage.getItem('planner_rooms');
    
    if (oldPlans && !localStorage.getItem('planner_plans')) {
      localStorage.setItem('planner_plans', oldPlans);
      localStorage.removeItem('plans');
    }
    if (oldTeams && !localStorage.getItem('planner_teams')) {
      localStorage.setItem('planner_teams', oldTeams);
      localStorage.removeItem('teams');
    }
    if (oldRooms && !localStorage.getItem('planner_teams')) {
      localStorage.setItem('planner_teams', oldRooms);
      localStorage.removeItem('planner_rooms');
    }

    plans = JSON.parse(localStorage.getItem('planner_plans') || '[]');
    rooms = JSON.parse(localStorage.getItem('planner_teams') || '[]');
    
    // КРИТИЧЕСКИ ВАЖНО: Миграция дат в правильный формат YYYY-MM-DD
    let needsSave = false;
    plans = plans.map(plan => {
      if (plan.date && typeof plan.date === 'string') {
        // Проверяем, не в формате ли уже YYYY-MM-DD
        if (!/^\d{4}-\d{2}-\d{2}$/.test(plan.date)) {
          // Конвертируем в правильный формат
          try {
            const dateObj = new Date(plan.date);
            const newDate = dateObj.toISOString().split('T')[0];
            plan.date = newDate;
            needsSave = true;
          } catch (e) {
            console.error('Ошибка миграции даты для плана:', plan.title, e);
          }
        }
      }
      
      // РЕФАКТОРИНГ: Мигрируем к новой системе источников
      plan = migrateTaskToNewSource(plan);
      if (!plan.source) {
        needsSave = true;
      }
      
      return plan;
    });
    
    // Сохраняем если были изменения
    if (needsSave) {
      savePlans();
    }
    
    // Миграция старых разделов (строки) в новый формат (объекты)
    if (rooms.length > 0 && typeof rooms[0] === 'string') {
      const defaultIcons = ICONS.rooms;
      rooms = rooms.map((roomName, index) => ({
        name: roomName,
        icon: defaultIcons[index % defaultIcons.length]
      }));
      saveRooms(); // Сохраняем в новом формате
    }
    
    // 🍽️ АВТОМАТИЧЕСКИ ДОБАВЛЯЕМ РАЗДЕЛ "ПИТАНИЕ" ЕСЛИ ЕГО НЕТ
    const nutritionRoomExists = rooms.some(room => {
      const roomName = typeof room === 'string' ? room : room.name;
      return roomName === 'Питание';
    });
    
    if (!nutritionRoomExists) {
      rooms.push({
        name: 'Питание',
        icon: '🍽️'
      });
      saveRooms();
    }
  } catch (e) {
    console.error('Ошибка при загрузке данных:', e);
    // Инициализируем пустыми данными в случае ошибки
    plans = [];
    rooms = [];
    
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка загрузки', 'Не удалось загрузить сохраненные данные. Приложение запущено с пустыми данными.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

function savePlans() {
  try {
    const dataToSave = JSON.stringify(plans);
    localStorage.setItem('planner_plans', dataToSave);
    
    // Проверяем, что данные действительно сохранились
    const saved = localStorage.getItem('planner_plans');
    const parsedBack = JSON.parse(saved || '[]');
    
    if (parsedBack.length !== plans.length) {
      console.error('КРИТИЧЕСКАЯ ОШИБКА: Количество сохраненных планов не совпадает!');
      console.error('Ожидалось:', plans.length, 'Сохранено:', parsedBack.length);
    }
  } catch (e) {
    console.error('Ошибка при сохранении планов:', e);
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка сохранения', 'Не удалось сохранить данные. Проверьте свободное место на устройстве.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

function saveRooms() {
  try {
    localStorage.setItem('planner_teams', JSON.stringify(rooms));
  } catch (e) {
    console.error('Ошибка при сохранении разделов:', e);
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка сохранения', 'Не удалось сохранить разделы. Проверьте свободное место на устройстве.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

// SECTIONS SYSTEM - СИСТЕМА РАЗДЕЛОВ С АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИЕЙ
function saveSections() {
  try {
    localStorage.setItem('planner_sections', JSON.stringify(sections));
  } catch (e) {
    console.error('Ошибка при сохранении разделов:', e);
  }
}

function loadSections() {
  try {
    const savedSections = localStorage.getItem('planner_sections');
    sections = savedSections ? JSON.parse(savedSections) : [];
  } catch (e) {
    console.error('Ошибка при загрузке разделов:', e);
    sections = [];
  }
}

// РЕФАКТОРИНГ: Упрощенная система удаления задач
function saveDeletedTasks() {
  try {
    localStorage.setItem('planner_deleted_tasks', JSON.stringify(deletedTasks));
  } catch (e) {
    console.error('Ошибка при сохранении удаленных задач:', e);
  }
}

function loadDeletedTasks() {
  try {
    const saved = localStorage.getItem('planner_deleted_tasks');
    deletedTasks = saved ? JSON.parse(saved) : {};
  } catch (e) {
    console.error('Ошибка при загрузке удаленных задач:', e);
    deletedTasks = {};
  }
}

function cleanupOldDeletedTasks() {
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const cutoffDateStr = thirtyDaysAgo.toISOString().split('T')[0];
  
  let hasChanges = false;
  
  // Очищаем удаленные задачи старше 30 дней
  Object.keys(deletedTasks).forEach(dateStr => {
    if (dateStr < cutoffDateStr) {
      delete deletedTasks[dateStr];
      hasChanges = true;
    }
  });
  
  if (hasChanges) {
    saveDeletedTasks();
    console.log('🧹 Очищены старые записи об удаленных задачах');
  }
}

// РЕФАКТОРИНГ: Функция очистки старых ключей localStorage после миграции
function cleanupOldStorageKeys() {
  const oldKeys = [
    'planner_deleted_task_ids',
    'planner_deleted_section_tasks',
    'plans', // Старый ключ для планов
    'teams', // Старый ключ для команд
    'planner_rooms' // Старый ключ для комнат
  ];
  
  let cleanedCount = 0;
  oldKeys.forEach(key => {
    if (localStorage.getItem(key)) {
      localStorage.removeItem(key);
      cleanedCount++;
      console.log(`🧹 Удален старый ключ localStorage: ${key}`);
    }
  });
  
  if (cleanedCount > 0) {
    console.log(`🧹 Очищено ${cleanedCount} старых ключей localStorage`);
  }
}

// Проверяет, активен ли раздел в указанную дату
function isSectionActiveOnDate(section, date) {
  if (!section.activityRule) return false;
  
  const { type, value } = section.activityRule;
  const dayOfWeek = date.getDay(); // 0 = воскресенье, 1 = понедельник, ...
  
  switch (type) {
    case 'daily':
      return true;
    
    case 'every_other_day':
      // Используем количество дней с эпохи для определения четности
      const daysSinceEpoch = Math.floor(date.getTime() / (1000 * 60 * 60 * 24));
      return daysSinceEpoch % 2 === (value || 0);
    
    case 'weekdays':
      // value - массив дней недели [1,2,3,4,5] для пн-пт
      return Array.isArray(value) && value.includes(dayOfWeek);
    
    default:
      return false;
  }
}

// РЕФАКТОРИНГ: Стабильная синхронизация разделов
function syncSectionsToPlans(date, force = false) {
  const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
  
  console.log(`🔄 Синхронизация разделов для ${dateStr}${force ? ' (принудительно)' : ''}`);
  
  let hasChanges = false;
  
  sections.forEach(section => {
    if (isSectionActiveOnDate(section, date)) {
      
      // Убеждаемся что раздел существует в rooms с правильной иконкой
      const existingRoom = rooms.find(room => {
        const roomName = typeof room === 'string' ? room : room.name;
        return roomName === section.name;
      });
      
      if (!existingRoom) {
        // Создаем раздел в rooms с иконкой из рутинного раздела
        rooms.push({
          name: section.name,
          icon: section.icon
        });
        saveRooms();
      } else if (typeof existingRoom === 'object' && existingRoom.icon !== section.icon) {
        // Синхронизируем иконку если она отличается
        existingRoom.icon = section.icon;
        saveRooms();
      }
      
      // Проверяем каждую шаблонную задачу из раздела
      section.templateTasks.forEach(template => {
        const source = createTaskSource('section', {
          sectionId: section.id,
          templateId: template.id
        });
        
        // РЕФАКТОРИНГ: Проверяем через новую систему удаления
        if (isTaskDeleted(dateStr, source)) {
          console.log(`⏭️ Пропускаем удаленную задачу: ${template.title}`);
          return; // Пропускаем удаленные пользователем задачи
        }
        
        // Проверяем, не существует ли уже такая задача
        const existingTask = plans.find(plan => 
          plan.date === dateStr && 
          plan.source && 
          plan.source.type === 'section' &&
          plan.source.sectionId == section.id && 
          plan.source.templateId == template.id
        );
        
        if (!existingTask) {
          // Создаем новую задачу из шаблона
          const newTask = {
            id: (Date.now() + Math.random()).toString(), // Уникальный ID как строка
            title: template.title,
            time: template.time || '',
            room: section.name, // Связываем с разделом
            date: dateStr,
            completed: false,
            source: source
          };
          
          plans.push(newTask);
          hasChanges = true;
          console.log(`➕ Создана задача из раздела: ${template.title}`);
        }
      });
    } else {
      
      // Удаляем задачи этого раздела на эту дату (если они были созданы автоматически)
      const initialCount = plans.length;
      plans = plans.filter(plan => !(
        plan.date === dateStr && 
        plan.source &&
        plan.source.type === 'section' &&
        plan.source.sectionId == section.id
      ));
      
      const removedCount = initialCount - plans.length;
      if (removedCount > 0) {
        console.log(`🗑️ Удалено ${removedCount} задач неактивного раздела "${section.name}"`);
        hasChanges = true;
      }
    }
  });
  
  // Сохраняем изменения только если они были
  if (hasChanges) {
    savePlans();
    console.log('💾 Изменения синхронизации сохранены');
  }
  
  // Обновляем интерфейс если нужно
  if (typeof updateRoomsSelect === 'function') {
    updateRoomsSelect();
  }
}

// РЕФАКТОРИНГ: Упрощенная инициализация разделов
function initSectionsSync() {
  console.log('🔧 Инициализация системы разделов');
  
  // Загружаем разделы
  loadSections();
  
  // Создаем демонстрационные разделы если их нет
  if (sections.length === 0) {
    console.log('📝 Создаем демонстрационные разделы');
    
    // Утренняя зарядка - каждый день
    sections.push({
      id: Date.now() + 1,
      name: 'Утренняя зарядка',
      icon: ICONS.rooms[5], // 🏃
      activityRule: { type: 'daily' },
      templateTasks: [
        { id: 1, title: 'Разминка', time: '07:00' },
        { id: 2, title: 'Упражнения', time: '07:15' },
        { id: 3, title: 'Растяжка', time: '07:30' }
      ],
      createdAt: new Date().toISOString()
    });
    
    // Уборка - через день
    sections.push({
      id: Date.now() + 2,
      name: 'Уборка дома',
      icon: '🧹', // Можно оставить специальную иконку для уборки
      activityRule: { type: 'every_other_day', value: 0 },
      templateTasks: [
        { id: 4, title: 'Пропылесосить', time: '10:00' },
        { id: 5, title: 'Протереть пыль', time: '10:30' }
      ],
      createdAt: new Date().toISOString()
    });
    
    // Работа - только в будни
    sections.push({
      id: Date.now() + 3,
      name: 'Рабочие задачи',
      icon: ICONS.rooms[4], // 💼
      activityRule: { type: 'weekdays', value: [1, 2, 3, 4, 5] }, // Пн-Пт
      templateTasks: [
        { id: 6, title: 'Проверить почту', time: '09:00' },
        { id: 7, title: 'Планерка', time: '10:00' },
        { id: 8, title: 'Отчет за день', time: '18:00' }
      ],
      createdAt: new Date().toISOString()
    });
    
    saveSections();
  }
  
  // Очищаем старые записи об удаленных задачах
  cleanupOldDeletedTasks();
  
  console.log(`✅ Система разделов инициализирована: ${sections.length} разделов`);
}

// RENDER
function render() {
  try {
    // Проверяем, что мы на вкладке задач
    if (currentTab !== 'tasks') {
      return;
    }
    
    const todayPlans = getPlansForDate(currentDate);
    
    // Сортируем задачи: невыполненные вверху, выполненные внизу
    todayPlans.sort((a, b) => {
      // Если одна задача выполнена, а другая нет
      if (a.completed !== b.completed) {
        return a.completed ? 1 : -1; // Выполненные идут вниз
      }
      // Если обе задачи имеют одинаковый статус, сортируем по времени
      if (a.time && b.time) {
        return a.time.localeCompare(b.time);
      }
      // Задачи с временем идут выше задач без времени
      if (a.time && !b.time) return -1;
      if (!a.time && b.time) return 1;
      // Если нет времени у обеих, сортируем по порядку создания (по ID)
      return a.id.localeCompare(b.id);
    });
    
    // Update date display
    const dayTitle = document.getElementById('dayTitle');
    const daySubtitle = document.getElementById('daySubtitle');
    if (dayTitle) dayTitle.textContent = formatDate(currentDate);
    if (daySubtitle) daySubtitle.textContent = formatDateSubtitle(currentDate);
    
    // Update progress
    updateProgress();
    
    // Show/hide elements
    const empty = document.getElementById('empty');
    const plansContainer = document.getElementById('plansContainer');
    
    if (!empty || !plansContainer) {
      return;
    }
    
    if (todayPlans.length === 0) {
      empty.style.display = 'flex';
      plansContainer.style.display = 'none';
    } else {
      empty.style.display = 'none';
      plansContainer.style.display = 'flex';
      
      // Render plans
      const plansEl = document.getElementById('plans');
      if (!plansEl) {
        return;
      }
      
      let html = '';
      todayPlans.forEach(plan => {
        try {
          html += `
            <div class="plan ${plan.completed ? 'completed' : ''}" onclick="showPlanMenu('${plan.id}', event)">
              <div class="checkbox ${plan.completed ? 'checked' : ''}" onclick="toggleComplete('${plan.id}', event)"></div>
              <div class="plan-content">
                <div class="plan-title">
                  ${plan.time ? `<span class="plan-time-inline">${plan.time}</span>` : ''}${escapeHtml(plan.title)}
                </div>
                ${plan.room ? `<div class="room">${getRoomIcon(plan.room)} ${escapeHtml(plan.room)}</div>` : ''}
              </div>
            </div>
          `;
        } catch (e) {
          console.error('Ошибка при рендеринге плана:', e);
        }
      });
      
      // Добавляем кнопку "Добавить задачу" в конец списка
      html += `
        <button class="btn-secondary btn-full-width" onclick="showAdd()" style="margin-top: 16px;">
          <span class="add-icon">+</span>
          Добавить задачу
        </button>
      `;
      
      plansEl.innerHTML = html;
    }
  } catch (e) {
    console.error('Ошибка в функции render:', e);
  }
}

function updateRoomsSelect() {
  try {
    const select = document.getElementById('planRoom');
    if (!select) {
      return;
    }
    
    select.innerHTML = '<option value="">Без раздела</option>';
    rooms.forEach(room => {
      try {
        // Поддерживаем старый формат (строки) и новый (объекты)
        const roomName = typeof room === 'string' ? room : room.name;
        const roomIcon = typeof room === 'string' ? ICONS.navigation.home : room.icon;
        
        const option = document.createElement('option');
        option.value = roomName;
        option.textContent = `${roomIcon} ${roomName}`;
        select.appendChild(option);
      } catch (e) {
        console.error('Ошибка при добавлении раздела в селект:', e);
      }
    });
  } catch (e) {
    console.error('Ошибка в updateRoomsSelect:', e);
  }
}

function renderRooms() {
  try {
    const roomsList = document.getElementById('roomsList');
    if (!roomsList) {
      return;
    }
    
    let html = '';
    rooms.forEach((room) => {
      try {
        // Поддерживаем старый формат (строки) и новый (объекты)
        const roomName = typeof room === 'string' ? room : room.name;
        const roomIcon = typeof room === 'string' ? ICONS.navigation.home : room.icon;
        
        html += `
          <div class="room-item">
            <div class="room-icon">${roomIcon}</div>
            <div class="room-name">${escapeHtml(roomName)}</div>
            <div class="btn-group">
              <button class="btn-tertiary" onclick="editRoom('${escapeHtml(roomName)}')">Редактировать</button>
              <button class="btn-destructive" onclick="deleteRoom('${escapeHtml(roomName)}')">Удалить</button>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Ошибка при рендеринге раздела:', e);
      }
    });
    roomsList.innerHTML = html;
  } catch (e) {
    console.error('Ошибка в renderRooms:', e);
  }
}

// УЛУЧШЕННАЯ НАВИГАЦИЯ ПО ДНЯМ С ПРОВЕРКАМИ СОСТОЯНИЯ
function changeDay(direction) {
  if (currentTab === 'nutrition') {
    // Для вкладки питания используем отдельную дату
    const newDate = new Date(currentNutritionDate);
    newDate.setDate(newDate.getDate() + direction);
    
    // Проверяем разумные границы (не более года назад/вперед)
    const today = new Date();
    const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
    const yearAhead = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
    
    if (newDate < yearAgo || newDate > yearAhead) {
      console.log('Дата выходит за разумные границы, игнорируем');
      return;
    }
    
    currentNutritionDate = newDate;
    
    // Анимация смены дня
    const dayCard = document.getElementById('nutritionDayCard');
    if (dayCard) {
      dayCard.style.opacity = '0.7';
      dayCard.style.transform = 'scale(0.98)';
    }
    
    setTimeout(() => {
      renderNutritionDay();
      updateWaterTracker();
      updateHeaderForTab('nutrition');
      
      if (dayCard) {
        dayCard.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        dayCard.style.opacity = '1';
        dayCard.style.transform = 'scale(1)';
      }
    }, 150);
    
  } else {
    // Для вкладки задач
    const newDate = new Date(currentDate);
    newDate.setDate(newDate.getDate() + direction);
    
    // Проверяем разумные границы
    const today = new Date();
    const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
    const yearAhead = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
    
    if (newDate < yearAgo || newDate > yearAhead) {
      return;
    }
    
    currentDate = newDate;
    
    // РЕФАКТОРИНГ: Контролируемая синхронизация разделов при смене даты
    console.log(`📅 Смена даты на ${currentDate.toISOString().split('T')[0]}`);
    syncSectionsToPlans(currentDate);
    
    // Анимация смены дня для задач
    const plansContainer = document.getElementById('plansContainer');
    const progressContainer = document.getElementById('progressContainer');
    
    if (plansContainer) {
      plansContainer.style.opacity = '0.7';
      plansContainer.style.transform = 'translateY(10px)';
    }
    if (progressContainer) {
      progressContainer.style.opacity = '0.7';
      progressContainer.style.transform = 'scale(0.98)';
    }
    
    setTimeout(() => {
      render();
      updateHeaderForTab('tasks');
      
      if (plansContainer) {
        plansContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        plansContainer.style.opacity = '1';
        plansContainer.style.transform = 'translateY(0)';
      }
      if (progressContainer) {
        progressContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        progressContainer.style.opacity = '1';
        progressContainer.style.transform = 'scale(1)';
      }
    }, 150);
  }
}

// MODALS & SCREENS
// УЛУЧШЕННАЯ ФУНКЦИЯ ПОКАЗА ДОБАВЛЕНИЯ ЗАДАЧИ
function showAdd() {
  // Закрываем любые открытые модальные окна
  hideCurrentModal();
  
  const addModal = document.getElementById('addModal');
  
  if (!addModal) {
    console.error('Элемент addModal не найден!');
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка', 'Не удалось открыть форму добавления задачи. Попробуйте перезагрузить приложение.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
    return;
  }
  
  // Очищаем форму перед показом
  clearForm();
  
  // Показываем модальное окно с анимацией
  addModal.style.display = 'flex';
  addModal.style.opacity = '0';
  addModal.style.transform = 'translateY(20px)';
  
  setTimeout(() => {
    addModal.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    addModal.classList.add('show');
    addModal.style.opacity = '1';
    addModal.style.transform = 'translateY(0)';
  }, 10);
  
  currentModal = 'add';
  if (tg) tg.BackButton.show();
  
  // Устанавливаем текущую дату
  const planDate = document.getElementById('planDate');
  if (planDate) {
    planDate.value = currentDate.toISOString().split('T')[0];
  } else {
    console.error('Элемент planDate не найден');
  }
  
  // Обновляем список разделов
  updateRoomsSelect();
  
  // Фокусируемся на поле ввода с задержкой для плавности анимации
  setTimeout(() => {
    const planTitle = document.getElementById('planTitle');
    if (planTitle) {
      planTitle.focus();
    }
  }, 400);
}

// УЛУЧШЕННАЯ ФУНКЦИЯ СКРЫТИЯ ДОБАВЛЕНИЯ ЗАДАЧИ
function hideAdd() {
  const addModal = document.getElementById('addModal');
  if (!addModal) {
    console.error('Элемент addModal не найден');
    currentModal = null;
    if (tg) tg.BackButton.hide();
    return;
  }
  
  // Анимация скрытия
  addModal.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  addModal.style.opacity = '0';
  addModal.style.transform = 'translateY(20px)';
  
  setTimeout(() => {
    addModal.classList.remove('show');
    addModal.style.display = 'none';
    // Сбрасываем стили
    addModal.style.opacity = '';
    addModal.style.transform = '';
    addModal.style.transition = '';
  }, 300);
  
  currentModal = null;
  if (tg) tg.BackButton.hide();
  
  // Очищаем форму и сбрасываем состояние
  clearForm();
  selectedPlanId = null;
}

function showRooms() {
  const roomsScreen = document.getElementById('roomsScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!roomsScreen) {
    console.error('❌ Элемент roomsScreen не найден');
    return;
  }
  
  // Подготавливаем экран для показа
  roomsScreen.style.display = 'flex';
  roomsScreen.style.transform = 'translateX(100%)';
  roomsScreen.style.opacity = '0';
  
  // Плавно скрываем основные элементы
  if (header) {
    header.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    header.style.transform = 'translateY(-100%)';
    header.style.opacity = '0';
  }
  if (bottomNav) {
    bottomNav.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    bottomNav.style.transform = 'translateY(100%)';
    bottomNav.style.opacity = '0';
  }
  if (content) {
    content.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    content.style.transform = 'translateX(-30px)';
    content.style.opacity = '0';
  }
  
  // Анимированное появление экрана разделов
  setTimeout(() => {
    roomsScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    roomsScreen.style.transform = 'translateX(0)';
    roomsScreen.style.opacity = '1';
    roomsScreen.classList.add('show');
  }, 50);
  
  // Скрываем элементы после анимации
  setTimeout(() => {
    if (header) header.style.display = 'none';
    if (bottomNav) bottomNav.style.display = 'none';
  }, 400);
  
  currentModal = 'rooms';
  if (tg) tg.BackButton.show();
  
  // Рендерим содержимое и обновляем статистику
  setTimeout(() => {
    renderRooms();
    updateSectionsStats();
  }, 200);
}

// Обновляет статистику разделов в интерфейсе
function updateSectionsStats() {
  try {
    const sectionsCountEl = document.getElementById('sectionsCount');
    const activeSectionsTodayEl = document.getElementById('activeSectionsToday');
    const autoTasksTodayEl = document.getElementById('autoTasksToday');
    
    if (!sectionsCountEl || !activeSectionsTodayEl || !autoTasksTodayEl) {
      return; // Элементы еще не созданы
    }
    
    // Общее количество разделов
    const totalSections = sections.length;
    
    // Активные разделы сегодня
    const activeSectionsToday = sections.filter(section => 
      isSectionActiveOnDate(section, currentDate)
    ).length;
    
    // Автоматически созданные задачи сегодня через новую систему источников
    const dateStr = currentDate.toISOString().split('T')[0];
    const autoTasksToday = plans.filter(plan => 
      plan.date === dateStr && 
      plan.source && 
      plan.source.type === 'section'
    ).length;
    
    // Анимированное обновление чисел
    animateNumber(sectionsCountEl, totalSections);
    animateNumber(activeSectionsTodayEl, activeSectionsToday);
    animateNumber(autoTasksTodayEl, autoTasksToday);
    
  } catch (e) {
    console.error('Ошибка при обновлении статистики разделов:', e);
  }
}

// Анимированное изменение числа
function animateNumber(element, targetNumber) {
  const currentNumber = parseInt(element.textContent) || 0;
  const duration = 800;
  const steps = 20;
  const stepValue = (targetNumber - currentNumber) / steps;
  let currentStep = 0;
  
  const interval = setInterval(() => {
    currentStep++;
    const newValue = Math.round(currentNumber + (stepValue * currentStep));
    element.textContent = newValue;
    
    if (currentStep >= steps) {
      element.textContent = targetNumber;
      clearInterval(interval);
    }
  }, duration / steps);
}

function hideRooms() {
  const roomsScreen = document.getElementById('roomsScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!roomsScreen) {
    console.error('❌ Элемент roomsScreen не найден');
    return;
  }
  
  // Плавное скрытие экрана разделов
  roomsScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
  roomsScreen.style.transform = 'translateX(100%)';
  roomsScreen.style.opacity = '0';
  roomsScreen.classList.remove('show');
  
  // Показываем основные элементы с анимацией
  if (header) {
    header.style.display = 'flex';
    header.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      header.style.transform = 'translateY(0)';
      header.style.opacity = '1';
    }, 100);
  }
  
  if (bottomNav) {
    bottomNav.style.display = 'flex';
    bottomNav.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      bottomNav.style.transform = 'translateY(0)';
      bottomNav.style.opacity = '1';
    }, 150);
  }
  
  if (content) {
    content.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      content.style.transform = 'translateX(0)';
      content.style.opacity = '1';
    }, 200);
  }
  
  // Полностью скрываем экран после анимации
  setTimeout(() => {
    roomsScreen.style.display = 'none';
    // Сбрасываем трансформации
    roomsScreen.style.transform = '';
    roomsScreen.style.transition = '';
  }, 600);
  
  currentModal = null;
  if (tg) tg.BackButton.hide();
}

function showProfile() {
  const profileScreen = document.getElementById('profileScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!profileScreen) {
    console.error('❌ Элемент profileScreen не найден');
    return;
  }
  
  // Подготавливаем экран для показа
  profileScreen.style.display = 'flex';
  profileScreen.style.transform = 'translateX(-100%)';
  profileScreen.style.opacity = '0';
  
  // Плавно скрываем основные элементы
  if (header) {
    header.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    header.style.transform = 'translateY(-100%)';
    header.style.opacity = '0';
  }
  if (bottomNav) {
    bottomNav.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    bottomNav.style.transform = 'translateY(100%)';
    bottomNav.style.opacity = '0';
  }
  if (content) {
    content.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    content.style.transform = 'translateX(30px)';
    content.style.opacity = '0';
  }
  
  // Анимированное появление экрана профиля
  setTimeout(() => {
    profileScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    profileScreen.style.transform = 'translateX(0)';
    profileScreen.style.opacity = '1';
    profileScreen.classList.add('show');
  }, 50);
  
  // Скрываем элементы после анимации
  setTimeout(() => {
    if (header) header.style.display = 'none';
    if (bottomNav) bottomNav.style.display = 'none';
  }, 400);
  
  currentModal = 'profile';
  if (tg) tg.BackButton.show();
  
  // Загружаем данные профиля
  setTimeout(() => {
    loadProfileData();
  }, 200);
}

function hideProfile() {
  const profileScreen = document.getElementById('profileScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!profileScreen) {
    console.error('❌ Элемент profileScreen не найден');
    return;
  }
  
  // Плавное скрытие экрана профиля
  profileScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
  profileScreen.style.transform = 'translateX(-100%)';
  profileScreen.style.opacity = '0';
  profileScreen.classList.remove('show');
  
  // Показываем основные элементы с анимацией
  if (header) {
    header.style.display = 'flex';
    header.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      header.style.transform = 'translateY(0)';
      header.style.opacity = '1';
    }, 100);
  }
  
  if (bottomNav) {
    bottomNav.style.display = 'flex';
    bottomNav.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      bottomNav.style.transform = 'translateY(0)';
      bottomNav.style.opacity = '1';
    }, 150);
  }
  
  if (content) {
    content.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      content.style.transform = 'translateX(0)';
      content.style.opacity = '1';
    }, 200);
  }
  
  // Полностью скрываем экран после анимации
  setTimeout(() => {
    profileScreen.style.display = 'none';
    // Сбрасываем трансформации
    profileScreen.style.transform = '';
    profileScreen.style.transition = '';
  }, 600);
  
  currentModal = null;
  if (tg) tg.BackButton.hide();
}

// MODAL MANAGEMENT - УЛУЧШЕННАЯ СИСТЕМА УПРАВЛЕНИЯ МОДАЛЬНЫМИ ОКНАМИ
function hideCurrentModal() {
  // Проверяем все возможные открытые модальные окна
  const editPlanScreen = document.getElementById('editPlanScreen');
  const roomsScreen = document.getElementById('roomsScreen');
  const profileScreen = document.getElementById('profileScreen');
  const addModal = document.getElementById('addModal');
  const overlay = document.getElementById('overlay');
  const calendar = document.getElementById('calendar');
  const popup = document.getElementById('popup');
  const mealTypeModal = document.querySelector('.meal-type-modal');
  const mealInputModal = document.querySelector('.meal-input-modal');
  const sectionsModal = document.getElementById('sectionsModal');
  const editSectionModal = document.getElementById('editSectionModal');
  const addSectionModal = document.getElementById('addSectionModal');
  
  // Закрываем в порядке приоритета (от самых верхних к базовым)
  if (popup && popup.classList.contains('show')) {
    hidePopup();
  } else if (mealInputModal && mealInputModal.classList.contains('show')) {
    closeMealInputModal();
  } else if (mealTypeModal && mealTypeModal.classList.contains('show')) {
    closeMealTypeSelector();
  } else if (editSectionModal) {
    hideEditSection();
  } else if (addSectionModal) {
    hideAddSection();
  } else if (sectionsModal) {
    hideSectionsManager();
  } else if (calendar && calendar.classList.contains('show')) {
    hideCalendar();
  } else if (overlay && overlay.classList.contains('show')) {
    hideMenu();
  } else if (editPlanScreen && editPlanScreen.classList.contains('show')) {
    hideEditPlan();
  } else if (addModal && addModal.classList.contains('show')) {
    hideAdd();
  } else if (roomsScreen && roomsScreen.classList.contains('show')) {
    hideRooms();
  } else if (profileScreen && profileScreen.classList.contains('show')) {
    hideProfile();
  } else {
    // Если ничего не открыто, сбрасываем состояние
    currentModal = null;
    if (tg) tg.BackButton.hide();
  }
}

// PLANS
// УЛУЧШЕННАЯ ФУНКЦИЯ СОХРАНЕНИЯ ЗАДАЧИ С ВАЛИДАЦИЕЙ
function savePlan() {
  const planTitleEl = document.getElementById('planTitle');
  if (!planTitleEl) {
    console.error('Элемент planTitle не найден');
    showPopup('Ошибка', 'Не удалось найти поле ввода задачи. Попробуйте перезагрузить приложение.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  const title = planTitleEl.value.trim();
  
  if (!title) {
    // Подсвечиваем поле и показываем ошибку
    planTitleEl.style.borderColor = '#ef4444';
    planTitleEl.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.2)';
    planTitleEl.focus();
    
    // Убираем подсветку через 3 секунды
    setTimeout(() => {
      planTitleEl.style.borderColor = '';
      planTitleEl.style.boxShadow = '';
    }, 3000);
    
    showPopup('Введите название', 'Пожалуйста, введите название задачи', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  const planRoomEl = document.getElementById('planRoom');
  const planDateEl = document.getElementById('planDate');
  const planTimeEl = document.getElementById('planTime');
  
  const room = planRoomEl ? planRoomEl.value : '';
  const date = (planDateEl ? planDateEl.value : '') || currentDate.toISOString().split('T')[0];
  const time = planTimeEl ? planTimeEl.value : '';
  
  // Валидация даты
  const selectedDate = new Date(date);
  const today = new Date();
  const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
  const yearAhead = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
  
  if (selectedDate < yearAgo || selectedDate > yearAhead) {
    showPopup('Неверная дата', 'Выберите дату в пределах года от сегодняшнего дня', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  
  const plan = {
    id: selectedPlanId || Date.now().toString(),
    title: title,
    date: date,
    time: time || null,
    room: room || null,
    completed: false,
    source: createTaskSource('manual') // РЕФАКТОРИНГ: Используем новую систему источников
  };
  
  try {
    if (selectedPlanId) {
      // Обновляем существующую задачу
      const index = plans.findIndex(p => p.id === selectedPlanId);
      if (index !== -1) {
        // Сохраняем источник при обновлении
        plan.source = plans[index].source || createTaskSource('manual');
        plans[index] = plan;
      } else {
        console.error('Задача для обновления не найдена');
        showPopup('Ошибка', 'Не удалось найти задачу для обновления', [
          { text: 'OK', type: 'confirm', action: hidePopup }
        ]);
        return;
      }
    } else {
      // Добавляем новую задачу
      plans.push(plan);
    }
    
    savePlans();
    hideAdd();
    
    // Обновляем текущую дату если задача на другой день
    if (date !== currentDate.toISOString().split('T')[0]) {
      currentDate = new Date(date);
    }
    
    // Рендерим с анимацией
    const plansContainer = document.getElementById('plansContainer');
    if (plansContainer) {
      plansContainer.style.opacity = '0.7';
      setTimeout(() => {
        render();
        plansContainer.style.transition = 'opacity 0.3s ease';
        plansContainer.style.opacity = '1';
      }, 100);
    } else {
      render();
    }
    
  } catch (error) {
    console.error('Ошибка при сохранении задачи:', error);
    showPopup('Ошибка сохранения', 'Не удалось сохранить задачу. Попробуйте еще раз.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
  }
}

// УЛУЧШЕННАЯ ФУНКЦИЯ ОЧИСТКИ ФОРМЫ
function clearForm() {
  try {
    const planTitle = document.getElementById('planTitle');
    const planDate = document.getElementById('planDate');
    const planTime = document.getElementById('planTime');
    const planRoom = document.getElementById('planRoom');
    
    if (planTitle) {
      planTitle.value = '';
      // Убираем любые стили ошибок
      planTitle.style.borderColor = '';
      planTitle.style.boxShadow = '';
    }
    if (planDate) planDate.value = '';
    if (planTime) planTime.value = '';
    if (planRoom) planRoom.value = '';
    
  } catch (error) {
    console.error('Ошибка при очистке формы:', error);
  }
}

// УЛУЧШЕННАЯ ФУНКЦИЯ ПОКАЗА МЕНЮ ЗАДАЧИ
function showPlanMenu(id, event) {
  // Останавливаем всплытие события
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  // Проверяем существование задачи
  const plan = plans.find(p => p.id === id);
  if (!plan) {
    console.error('Задача не найдена:', id);
    showPopup('Ошибка', 'Задача не найдена. Возможно, она была удалена.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  selectedPlanId = id;
  const overlay = document.getElementById('overlay');
  
  if (!overlay) {
    console.error('Элемент overlay не найден');
    showPopup('Ошибка', 'Не удалось открыть меню задачи. Попробуйте перезагрузить приложение.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  // Анимация появления меню
  overlay.style.display = 'flex';
  overlay.style.opacity = '0';
  
  setTimeout(() => {
    overlay.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    overlay.classList.add('show');
    overlay.style.opacity = '1';
  }, 10);
}

function editPlan() {
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) return;
  
  // Fill edit form
  const editPlanTitle = document.getElementById('editPlanTitle');
  if (editPlanTitle) {
    editPlanTitle.value = plan.title;
  } else {
    console.error('Элемент editPlanTitle не найден');
  }
  
  // Format date
  const date = new Date(plan.date);
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  const formattedDate = `${date.getDate()} ${months[date.getMonth()]}. ${date.getFullYear()}г.`;
  
  const editPlanDate = document.getElementById('editPlanDate');
  if (editPlanDate) {
    editPlanDate.textContent = formattedDate;
  } else {
    console.error('Элемент editPlanDate не найден');
  }
  
  // Reset toggles (premium features disabled)
  const notificationToggle = document.getElementById('notificationToggle');
  const importantToggle = document.getElementById('importantToggle');
  
  if (notificationToggle) notificationToggle.classList.remove('active');
  if (importantToggle) importantToggle.classList.remove('active');
  
  hideMenu();
  showEditPlan();
}

function showEditPlan() {
  // Очищаем временную переменную даты
  window.editPlanNewDate = null;
  
  const editPlanScreen = document.getElementById('editPlanScreen');
  const header = document.querySelector('.header');
  
  if (editPlanScreen) {
    editPlanScreen.classList.add('show');
  } else {
    console.error('Элемент editPlanScreen не найден');
  }
  
  if (header) {
    header.style.display = 'none';
  }
}

function hideEditPlan() {
  const editPlanScreen = document.getElementById('editPlanScreen');
  const header = document.querySelector('.header');
  
  if (editPlanScreen) {
    editPlanScreen.classList.remove('show');
  } else {
    console.error('Элемент editPlanScreen не найден');
  }
  
  if (header) {
    header.style.display = 'flex';
  }
}

function toggleNotification() {
  // Premium feature - show popup
  showPopup(
    'Премиум функция',
    'Уведомления доступны только с подпиской Премиум Трекер',
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function toggleImportant() {
  // Premium feature - show popup
  showPopup(
    'Премиум функция', 
    'Пометка «Важная» доступна только с подпиской Премиум Трекер',
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function showEditDatePicker() {
  showPopup(
    'Изменить дату',
    'Выберите новую дату для задачи',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сегодня', type: 'confirm', action: () => setEditDate(0) },
      { text: 'Завтра', type: 'confirm', action: () => setEditDate(1) }
    ]
  );
}

function setEditDate(daysOffset) {
  const newDate = new Date();
  newDate.setDate(newDate.getDate() + daysOffset);
  
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  const formattedDate = `${newDate.getDate()} ${months[newDate.getMonth()]}. ${newDate.getFullYear()}г.`;
  
  const editPlanDate = document.getElementById('editPlanDate');
  if (editPlanDate) {
    editPlanDate.textContent = formattedDate;
  } else {
    console.error('Элемент editPlanDate не найден');
  }
  
  // Сохраняем новую дату в временную переменную
  window.editPlanNewDate = newDate.toISOString().split('T')[0];
  
  hidePopup();
}

function savePlanEdit() {
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) return;
  
  const editPlanTitle = document.getElementById('editPlanTitle');
  if (!editPlanTitle) {
    console.error('Элемент editPlanTitle не найден');
    return;
  }
  
  const newTitle = editPlanTitle.value.trim();
  if (!newTitle) return;
  
  // Обновляем только название, дату изменяем только если была выбрана новая
  plan.title = newTitle;
  
  // Если была выбрана новая дата через setEditDate
  if (window.editPlanNewDate) {
    plan.date = window.editPlanNewDate;
    window.editPlanNewDate = null; // Очищаем временную переменную
  }
  
  savePlans();
  render();
  hideEditPlan();
}

function deletePlanFromEdit() {
  if (!selectedPlanId) {
    console.error('Нет выбранной задачи для удаления');
    return;
  }
  
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) {
    console.error('Задача не найдена:', selectedPlanId);
    return;
  }
  
  showPopup(
    'Удалить задачу?',
    `Вы уверены, что хотите удалить задачу "${plan.title}"?`,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: confirmDeleteFromEdit }
    ]
  );
}

function confirmDeleteFromEdit() {
  if (!selectedPlanId) {
    console.error('Нет ID задачи для удаления');
    return;
  }
  
  // РЕФАКТОРИНГ: Находим задачу и используем новую систему удаления
  const planToDelete = plans.find(p => p.id === selectedPlanId);
  
  if (planToDelete) {
    // Помечаем задачу как удаленную через новую систему
    const source = planToDelete.source || createTaskSource('manual');
    markTaskAsDeleted(planToDelete.date, source);
    
    console.log(`🗑️ Задача помечена как удаленная: ${planToDelete.title}`);
  }
  
  const initialLength = plans.length;
  plans = plans.filter(p => p.id !== selectedPlanId);
  
  if (plans.length === initialLength) {
    console.error('Задача не была удалена - не найдена в массиве');
    return;
  }
  
  savePlans();
  hidePopup();
  hideEditPlan();
  render();
}

// УЛУЧШЕННАЯ ФУНКЦИЯ СКРЫТИЯ МЕНЮ
function hideMenu() {
  const overlay = document.getElementById('overlay');
  if (!overlay) {
    console.error('Элемент overlay не найден');
    selectedPlanId = null;
    return;
  }
  
  // Анимация скрытия
  overlay.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
  overlay.style.opacity = '0';
  
  setTimeout(() => {
    overlay.classList.remove('show');
    overlay.style.display = 'none';
    // Сбрасываем стили
    overlay.style.opacity = '';
    overlay.style.transition = '';
  }, 300);
  
  selectedPlanId = null;
}

function deletePlan() {
  if (!selectedPlanId) {
    console.error('Нет выбранной задачи для удаления');
    return;
  }
  
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) {
    console.error('Задача не найдена:', selectedPlanId);
    return;
  }
  
  showPopup(
    'Удалить задачу?',
    `Вы уверены, что хотите удалить задачу "${plan.title}"?`,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: confirmDeletePlan }
    ]
  );
}

function confirmDeletePlan() {
  if (!selectedPlanId) {
    console.error('Нет ID задачи для удаления');
    return;
  }
  
  // РЕФАКТОРИНГ: Находим задачу и используем новую систему удаления
  const planToDelete = plans.find(p => p.id === selectedPlanId);
  
  if (planToDelete) {
    // Помечаем задачу как удаленную через новую систему
    const source = planToDelete.source || createTaskSource('manual');
    markTaskAsDeleted(planToDelete.date, source);
    
    console.log(`🗑️ Задача помечена как удаленная: ${planToDelete.title}`);
  }
  
  const initialLength = plans.length;
  plans = plans.filter(p => p.id !== selectedPlanId);
  
  if (plans.length === initialLength) {
    console.error('Задача не была удалена - не найдена в массиве');
    return;
  }
  
  savePlans();
  hidePopup();
  hideMenu();
  render();
}

// УЛУЧШЕННАЯ ФУНКЦИЯ ПЕРЕКЛЮЧЕНИЯ ВЫПОЛНЕНИЯ ЗАДАЧИ
function toggleComplete(id, event) {
  // Останавливаем всплытие события
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  const plan = plans.find(p => p.id == id || p.id === id.toString() || p.id === parseInt(id));
  
  if (!plan) {
    console.error('План не найден для ID:', id);
    showPopup('Ошибка', 'Задача не найдена. Возможно, она была удалена.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  const planElement = event ? event.target.closest('.plan') : null;
  const checkbox = event ? event.target : null;
  
  try {
    if (plan.completed) {
      // Убираем выполнение
      plan.completed = false;
      if (planElement) planElement.classList.remove('completed');
      if (checkbox) checkbox.classList.remove('checked');
      
      // РЕФАКТОРИНГ: Синхронизация с питанием через источники
      if (plan.source && plan.source.type === 'meal' && plan.source.mealId && plan.date) {
        if (!nutritionData.meals[plan.date]) {
          nutritionData.meals[plan.date] = {};
        }
        if (!nutritionData.meals[plan.date][plan.source.mealId]) {
          nutritionData.meals[plan.date][plan.source.mealId] = {};
        }
        nutritionData.meals[plan.date][plan.source.mealId].completed = false;
        saveNutritionData();
        
        // Обновляем отображение питания если мы на этой вкладке
        if (currentTab === 'nutrition') {
          renderNutritionDay();
        }
      }
    } else {
      // Отмечаем как выполненное
      plan.completed = true;
      
      // Сначала анимируем чекбокс
      if (checkbox) checkbox.classList.add('checked');
      
      // РЕФАКТОРИНГ: Синхронизация с питанием через источники
      if (plan.source && plan.source.type === 'meal' && plan.source.mealId && plan.date) {
        if (!nutritionData.meals[plan.date]) {
          nutritionData.meals[plan.date] = {};
        }
        if (!nutritionData.meals[plan.date][plan.source.mealId]) {
          nutritionData.meals[plan.date][plan.source.mealId] = {};
        }
        nutritionData.meals[plan.date][plan.source.mealId].completed = true;
        saveNutritionData();
        
        // Обновляем отображение питания если мы на этой вкладке
        if (currentTab === 'nutrition') {
          renderNutritionDay();
        }
      }
      
      // Затем через небольшую задержку добавляем класс completed
      setTimeout(() => {
        if (planElement) planElement.classList.add('completed');
        
        // Добавляем небольшую вибрацию для тактильной обратной связи
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      }, 150);
    }
    
    savePlans();
    updateProgress();
    
    // Перерендериваем список с задержкой для плавного перемещения задач
    setTimeout(() => {
      render();
    }, 300);
    
  } catch (error) {
    console.error('Ошибка при переключении состояния задачи:', error);
    showPopup('Ошибка', 'Не удалось изменить состояние задачи. Попробуйте еще раз.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
  }
}

function updateProgress() {
  try {
    // Проверяем, что мы на вкладке задач
    if (currentTab !== 'tasks') return;
    
    const todayPlans = getPlansForDate(currentDate);
    const completedCount = todayPlans.filter(p => p.completed).length;
    const totalCount = todayPlans.length;
    const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
    
    // Обновляем круглый прогресс-бар
    const progressCircle = document.getElementById('progressCircle');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressContainer = document.getElementById('progressContainer');
    const progressLabel = document.getElementById('progressLabel');
    const progressStats = document.getElementById('progressStats');
    
    // Проверяем наличие элементов
    if (!progressCircle || !progressPercentage || !progressContainer || !progressLabel || !progressStats) {
      return;
    }
    
    // Анимируем заполнение круга
    animateCircleProgress(progressCircle, progressPercent);
    
    // Плавно обновляем процент только при изменении
    const currentPercent = parseInt(progressPercentage.textContent) || 0;
    const targetPercent = Math.round(progressPercent);
    
    if (currentPercent !== targetPercent) {
      animatePercentage(progressPercentage, currentPercent, targetPercent);
    }
    
    progressStats.textContent = `${completedCount}/${totalCount}`;
    
    // Update progress label and animations based on completion
    if (totalCount === 0) {
      progressLabel.textContent = 'Планов нет';
      removeCompletionAnimations();
    } else if (completedCount === totalCount && totalCount > 0) {
      progressLabel.textContent = 'День завершён! 🎉';
      addCompletionAnimations();
    } else {
      progressLabel.textContent = 'Прогресс дня';
      removeCompletionAnimations();
    }
  } catch (e) {
    console.error('Ошибка в функции updateProgress:', e);
  }
}

function animateCircleProgress(circleElement, targetPercent) {
  // Убираем класс анимации завершения если есть
  circleElement.classList.remove('completed');
  
  // Получаем текущий прогресс из элемента
  const currentAngle = parseFloat(circleElement.dataset.currentAngle || '0');
  const targetAngle = (targetPercent / 100) * 360;
  
  // Если значения одинаковые, не анимируем
  if (Math.abs(currentAngle - targetAngle) < 1) {
    return;
  }
  
  // Сохраняем целевой угол
  circleElement.dataset.currentAngle = targetAngle;
  
  // Анимируем плавно через JavaScript
  const duration = 1500; // 1.5 секунды
  const startTime = performance.now();
  const startAngle = currentAngle;
  const angleChange = targetAngle - startAngle;
  
  function updateProgress(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Используем easing функцию cubic-bezier(0.4, 0, 0.2, 1)
    const easedProgress = progress < 0.5 
      ? 2 * progress * progress 
      : 1 - Math.pow(-2 * progress + 2, 2) / 2;
    
    const currentProgressAngle = startAngle + (angleChange * easedProgress);
    
    // Обновляем фон круга
    if (currentProgressAngle <= 0) {
      circleElement.style.background = `conic-gradient(
        from 0deg,
        rgba(0, 0, 0, 0.2) 0deg
      )`;
    } else {
      circleElement.style.background = `conic-gradient(
        from 0deg,
        var(--accent-primary) 0deg,
        var(--accent-secondary) ${currentProgressAngle * 0.33}deg,
        var(--accent-soft) ${currentProgressAngle * 0.66}deg,
        var(--accent-primary) ${currentProgressAngle}deg,
        rgba(0, 0, 0, 0.2) ${currentProgressAngle}deg
      )`;
    }
    
    // Продолжаем анимацию если не закончена
    if (progress < 1) {
      requestAnimationFrame(updateProgress);
    }
  }
  
  requestAnimationFrame(updateProgress);
}

function animatePercentage(element, from, to) {
  const duration = 1200; // Синхронизируем с анимацией круга
  const steps = Math.abs(to - from);
  if (steps === 0) return;
  
  const stepDuration = duration / steps;
  const increment = to > from ? 1 : -1;
  let current = from;
  
  // Добавляем небольшую задержку для синхронизации
  setTimeout(() => {
    const timer = setInterval(() => {
      current += increment;
      element.textContent = current + '%';
      
      if (current === to) {
        clearInterval(timer);
      }
    }, stepDuration);
  }, 200);
}

function addCompletionAnimations() {
  const progressContainer = document.getElementById('progressContainer');
  const progressCircle = document.getElementById('progressCircle');
  const progressPercentage = document.getElementById('progressPercentage');
  
  // Добавляем задержку для красивого эффекта
  setTimeout(() => {
    progressContainer.classList.add('completed');
    progressCircle.classList.add('completed');
    progressPercentage.classList.add('completed');
    
    // Добавляем конфетти эффект
    createConfetti();
  }, 500);
}

function removeCompletionAnimations() {
  const progressContainer = document.getElementById('progressContainer');
  const progressCircle = document.getElementById('progressCircle');
  const progressPercentage = document.getElementById('progressPercentage');
  
  progressContainer.classList.remove('completed');
  progressCircle.classList.remove('completed');
  progressPercentage.classList.remove('completed');
}

function createConfetti() {
  // Простой конфетти эффект
  const progressContainer = document.getElementById('progressContainer');
  
  for (let i = 0; i < 20; i++) {
    const confetti = document.createElement('div');
    confetti.style.cssText = `
      position: absolute;
      width: 6px;
      height: 6px;
      background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      animation: confetti-fall ${1 + Math.random()}s ease-out forwards;
    `;
    
    confetti.style.setProperty('--random-x', (Math.random() - 0.5) * 200 + 'px');
    confetti.style.setProperty('--random-y', (Math.random() - 0.5) * 200 + 'px');
    
    progressContainer.appendChild(confetti);
    
    // Удаляем конфетти через 2 секунды
    setTimeout(() => {
      if (confetti.parentNode) {
        confetti.parentNode.removeChild(confetti);
      }
    }, 2000);
  }
}


// CALENDAR
function showDatePicker() {
  calendarDate = new Date(currentDate);
  renderCalendar();
  const calendar = document.getElementById('calendar');
  if (calendar) {
    calendar.classList.add('show');
  } else {
    console.error('Элемент calendar не найден');
  }
}

function hideCalendar() {
  const calendar = document.getElementById('calendar');
  if (calendar) {
    calendar.classList.remove('show');
  } else {
    console.error('Элемент calendar не найден');
  }
}

function changeCalendarMonth(direction) {
  calendarDate.setMonth(calendarDate.getMonth() + direction);
  renderCalendar();
}

function selectDate(selectedDate) {
  currentDate = new Date(selectedDate);
  
  // РЕФАКТОРИНГ: Контролируемая синхронизация разделов при выборе даты
  console.log(`📅 Выбор даты ${currentDate.toISOString().split('T')[0]} из календаря`);
  syncSectionsToPlans(currentDate);
  
  render();
  hideCalendar();
}

function renderCalendar() {
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth();
  
  const monthNames = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
  ];
  
  const calendarTitle = document.getElementById('calendarTitle');
  if (calendarTitle) {
    calendarTitle.textContent = `${monthNames[month]} ${year}`;
  } else {
    console.error('Элемент calendarTitle не найден');
  }
  
  const firstDay = new Date(year, month, 1);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - (firstDay.getDay() || 7) + 1);
  
  const grid = document.getElementById('calendarGrid');
  if (!grid) {
    console.error('Элемент calendarGrid не найден');
    return;
  }
  
  grid.innerHTML = '';
  
  const today = new Date();
  const selectedDate = new Date(currentDate);
  
  for (let i = 0; i < 42; i++) {
    const currentCalendarDate = new Date(startDate);
    currentCalendarDate.setDate(startDate.getDate() + i);
    
    const button = document.createElement('button');
    button.className = 'calendar-day';
    button.textContent = currentCalendarDate.getDate();
    button.onclick = () => selectDate(currentCalendarDate);
    
    if (currentCalendarDate.getMonth() !== month) {
      button.classList.add('other-month');
    }
    if (currentCalendarDate.toDateString() === today.toDateString()) {
      button.classList.add('today');
    }
    if (currentCalendarDate.toDateString() === selectedDate.toDateString()) {
      button.classList.add('selected');
    }
    
    grid.appendChild(button);
  }
}

// ROOMS
function showAddRoom() {
  selectedRoomIcon = ICONS.navigation.home; // Используем единую систему иконок
  showRoomIconSelector();
}

function showRoomIconSelector() {
  const roomIcons = ICONS.getAllForSelection();
  
  // Создаем HTML для селектора иконок
  let iconSelectorHTML = '<div class="icon-selector">';
  roomIcons.forEach(icon => {
    const selectedClass = icon === selectedRoomIcon ? 'selected' : '';
    iconSelectorHTML += `
      <div class="icon-option ${selectedClass}" onclick="selectRoomIcon('${icon}')">
        ${icon}
      </div>
    `;
  });
  iconSelectorHTML += '</div>';
  
  // Показываем попап с селектором иконок
  document.getElementById('popupTitle').textContent = 'Выберите иконку';
  document.getElementById('popupMessage').innerHTML = iconSelectorHTML;
  
  const buttonsContainer = document.getElementById('popupButtons');
  buttonsContainer.innerHTML = `
    <button class="btn-secondary" onclick="hidePopup()">Отмена</button>
    <button class="btn-primary" onclick="showRoomNameInput()">Далее</button>
  `;
  
  document.getElementById('popup').classList.add('show');
}

function selectRoomIcon(icon) {
  selectedRoomIcon = icon;
  
  // Обновляем визуальное выделение
  document.querySelectorAll('.icon-option').forEach(el => {
    el.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function showRoomNameInput() {
  hidePopup();
  
  // Показываем попап с вводом названия
  setTimeout(() => {
    showPopup(
      `${selectedRoomIcon} Новый раздел`,
      '',
      [
        { text: 'Отмена', type: 'cancel', action: hidePopup },
        { text: 'Добавить', type: 'confirm', action: addRoom }
      ],
      true
    );
  }, 100);
}

function addRoom() {
  const input = document.querySelector('.popup-input');
  const roomName = input.value.trim();
  
  if (!roomName) return;
  
  // Проверяем существование раздела по имени
  const existingRoom = rooms.find(room => {
    const name = typeof room === 'string' ? room : room.name;
    return name === roomName;
  });
  
  if (existingRoom) {
    showPopup('Ошибка', 'Раздел с таким названием уже существует.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  // Добавляем раздел как объект с иконкой
  rooms.push({
    name: roomName,
    icon: selectedRoomIcon
  });
  
  saveRooms();
  renderRooms();
  updateRoomsSelect();
  hidePopup();
}

function editRoom(roomName) {
  // Находим раздел
  const room = rooms.find(r => {
    const name = typeof r === 'string' ? r : r.name;
    return name === roomName;
  });
  
  if (!room) {
    console.error('Раздел не найден:', roomName);
    return;
  }
  
  const currentName = typeof room === 'string' ? room : room.name;
  const currentIcon = typeof room === 'string' ? ICONS.navigation.home : room.icon;
  
  // Устанавливаем текущую иконку для редактирования
  selectedRoomIcon = currentIcon;
  
  // Показываем селектор иконок с текущей иконкой
  const roomIcons = ICONS.getAllForSelection();
  
  // Создаем HTML для селектора иконок
  let iconSelectorHTML = '<div class="icon-selector">';
  roomIcons.forEach(icon => {
    const selectedClass = icon === selectedRoomIcon ? 'selected' : '';
    iconSelectorHTML += `
      <div class="icon-option ${selectedClass}" onclick="selectRoomIcon('${icon}')">
        ${icon}
      </div>
    `;
  });
  iconSelectorHTML += '</div>';
  
  // Показываем попап с редактированием
  document.getElementById('popupTitle').textContent = 'Редактировать раздел';
  document.getElementById('popupMessage').innerHTML = `
    <div style="margin-bottom: 16px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary);">Название:</label>
      <input type="text" id="editRoomName" value="${escapeHtml(currentName)}" 
             style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 8px; background: var(--bg-card);">
    </div>
    <div>
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary);">Иконка:</label>
      ${iconSelectorHTML}
    </div>
  `;
  
  const buttonsContainer = document.getElementById('popupButtons');
  buttonsContainer.innerHTML = `
    <button class="btn-secondary" onclick="hidePopup()">Отмена</button>
    <button class="btn-primary" onclick="saveEditedRoom('${escapeHtml(currentName)}')">Сохранить</button>
  `;
  
  document.getElementById('popup').classList.add('show');
}

function saveEditedRoom(oldName) {
  const newName = document.getElementById('editRoomName').value.trim();
  
  if (!newName) {
    alert('Введите название раздела');
    return;
  }
  
  // Проверяем, не существует ли уже раздел с таким именем (кроме текущего)
  const existingRoom = rooms.find(r => {
    const name = typeof r === 'string' ? r : r.name;
    return name === newName && name !== oldName;
  });
  
  if (existingRoom) {
    alert('Раздел с таким названием уже существует');
    return;
  }
  
  // Находим и обновляем раздел
  const roomIndex = rooms.findIndex(r => {
    const name = typeof r === 'string' ? r : r.name;
    return name === oldName;
  });
  
  if (roomIndex !== -1) {
    // Обновляем раздел
    rooms[roomIndex] = {
      name: newName,
      icon: selectedRoomIcon
    };
    
    // Обновляем все планы, которые используют этот раздел
    plans.forEach(plan => {
      if (plan.room === oldName) {
        plan.room = newName;
      }
    });
    
    // Сохраняем изменения
    saveRooms();
    savePlans();
    
    // Обновляем интерфейс
    renderRooms();
    updateRoomsSelect();
    renderPlans();
  }
  
  hidePopup();
}

function deleteRoom(roomName) {
  showPopup(
    'Удалить раздел?',
    `Раздел "${roomName}" будет удален.`,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: () => confirmDeleteRoom(roomName) }
    ]
  );
}

function confirmDeleteRoom(roomName) {
  rooms = rooms.filter(room => {
    const name = typeof room === 'string' ? room : room.name;
    return name !== roomName;
  });
  saveRooms();
  renderRooms();
  updateRoomsSelect();
  hidePopup();
}

// SECTIONS MANAGEMENT - УПРАВЛЕНИЕ РАЗДЕЛАМИ С ПРАВИЛАМИ
function showSectionsManager() {
  // Создаем модальное окно для управления разделами
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'sectionsModal';
  
  modal.innerHTML = `
    <div class="modal-header">
      <div class="modal-header-actions">
        <button class="btn-tertiary" onclick="hideSectionsManager()">Закрыть</button>
      </div>
      <h2 class="modal-title">Управление разделами</h2>
      <div></div>
    </div>
    <div class="modal-content">
      <div class="sections-list" id="sectionsList">
        <!-- Список разделов будет здесь -->
      </div>
      <button class="btn-primary btn-full-width" onclick="showAddSection()" style="margin-top: 20px;">
        + Добавить раздел
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  renderSectionsList();
}

function hideSectionsManager() {
  const modal = document.getElementById('sectionsModal');
  if (modal) {
    modal.remove();
  }
}

function renderSectionsList() {
  const container = document.getElementById('sectionsList');
  if (!container) return;
  
  let html = '';
  
  sections.forEach(section => {
    const activityText = getActivityRuleText(section.activityRule);
    const tasksCount = section.templateTasks ? section.templateTasks.length : 0;
    
    html += `
      <div class="section-item" style="
        background: var(--bg-card);
        border: 1px solid var(--border-soft);
        border-radius: var(--border-radius);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        cursor: pointer;
      " onclick="editSection('${section.id}')">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <h3 style="margin: 0 0 8px 0; color: var(--text-primary);">${section.icon} ${section.name}</h3>
            <p style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 14px;">${activityText}</p>
            <p style="margin: 0; color: var(--text-muted); font-size: 12px;">${tasksCount} задач(и)</p>
          </div>
          <button class="delete-meal-btn" onclick="deleteSection('${section.id}', event)" style="margin-left: 12px;">×</button>
        </div>
      </div>
    `;
  });
  
  if (sections.length === 0) {
    html = `
      <div style="text-align: center; padding: 40px; color: var(--text-muted);">
        <p>Пока нет разделов</p>
        <p style="font-size: 14px; margin-top: 8px;">Создайте раздел с рутинными задачами</p>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function getActivityRuleText(rule) {
  if (!rule) return 'Не активен';
  
  switch (rule.type) {
    case 'daily':
      return 'Каждый день';
    case 'every_other_day':
      return 'Через день';
    case 'weekdays':
      if (Array.isArray(rule.value)) {
        const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
        const selectedDays = rule.value.map(d => days[d]).join(', ');
        return `По дням: ${selectedDays}`;
      }
      return 'По дням недели';
    default:
      return 'Не активен';
  }
}

function editSection(sectionId) {
  const section = sections.find(s => s.id == sectionId);
  if (!section) {
    console.error('Раздел не найден:', sectionId);
    return;
  }
  
  hideSectionsManager();
  
  // Заполняем форму данными раздела
  const modal = document.createElement('div');
  modal.id = 'editSectionModal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-header">
      <h2 class="modal-title">Редактировать раздел</h2>
      <button class="header-btn" onclick="hideEditSection()">Закрыть</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="label">Название раздела</label>
        <input type="text" class="input" id="editSectionName" value="${escapeHtml(section.name)}">
      </div>
      
      <div class="form-group">
        <label class="label">Иконка</label>
        <div id="editSectionIconSelector" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;">
          <!-- Иконки будут здесь -->
        </div>
      </div>
      
      <div class="form-group">
        <label class="label">Правило активности</label>
        <select class="select" id="editActivityType">
          <option value="daily" ${section.activityRule.type === 'daily' ? 'selected' : ''}>Каждый день</option>
          <option value="every_other_day" ${section.activityRule.type === 'every_other_day' ? 'selected' : ''}>Через день</option>
          <option value="weekdays" ${section.activityRule.type === 'weekdays' ? 'selected' : ''}>По дням недели</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="label">Шаблонные задачи</label>
        <div id="editTemplateTasks">
          ${section.templateTasks.map(task => `
            <div class="template-task" style="display: flex; gap: 8px; margin-bottom: 8px;">
              <input type="text" class="input" value="${escapeHtml(task.title)}" style="flex: 1;">
              <input type="time" class="input" value="${task.time || ''}" style="width: 120px;">
              <button type="button" onclick="this.parentElement.remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px;">×</button>
            </div>
          `).join('')}
        </div>
        <button type="button" onclick="addEditTemplateTask()" class="btn-secondary" style="margin-top: 8px;">Добавить задачу</button>
      </div>
      
      <button onclick="saveEditedSection(${section.id})" class="btn-primary btn-full-width" style="margin-top: 20px;">Сохранить изменения</button>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.classList.add('show');
  
  // Рендерим иконки с выбранной
  renderEditSectionIcons(section.icon);
}

function renderEditSectionIcons(selectedIcon) {
  const container = document.getElementById('editSectionIconSelector');
  if (!container) return;
  
  const icons = ICONS.getSectionIcons();
  let html = '';
  
  icons.forEach((icon) => {
    const isSelected = icon === selectedIcon;
    html += `
      <button type="button" onclick="selectEditSectionIcon('${icon}', this)" 
              class="section-icon-btn ${isSelected ? 'selected' : ''}"
              style="
                background: ${isSelected ? 'var(--accent-primary)' : 'var(--bg-tertiary)'};
                color: ${isSelected ? 'white' : 'var(--text-primary)'};
                border: 1px solid ${isSelected ? 'var(--accent-primary)' : 'var(--border-soft)'};
                border-radius: 8px;
                padding: 8px;
                font-size: 18px;
                cursor: pointer;
                transition: all 0.3s ease;
              ">
        ${icon}
      </button>
    `;
  });
  
  container.innerHTML = html;
  window.selectedEditSectionIcon = selectedIcon;
}

function selectEditSectionIcon(icon, button) {
  document.querySelectorAll('#editSectionIconSelector .section-icon-btn').forEach(btn => {
    btn.style.background = 'var(--bg-tertiary)';
    btn.style.color = 'var(--text-primary)';
    btn.style.borderColor = 'var(--border-soft)';
    btn.classList.remove('selected');
  });
  
  button.style.background = 'var(--accent-primary)';
  button.style.color = 'white';
  button.style.borderColor = 'var(--accent-primary)';
  button.classList.add('selected');
  
  window.selectedEditSectionIcon = icon;
}

function addEditTemplateTask() {
  const container = document.getElementById('editTemplateTasks');
  const taskDiv = document.createElement('div');
  taskDiv.className = 'template-task';
  taskDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  taskDiv.innerHTML = `
    <input type="text" class="input" placeholder="Название задачи" style="flex: 1;">
    <input type="time" class="input" style="width: 120px;">
    <button type="button" onclick="this.parentElement.remove()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px;">×</button>
  `;
  container.appendChild(taskDiv);
}

function saveEditedSection(sectionId) {
  const name = document.getElementById('editSectionName').value.trim();
  const activityType = document.getElementById('editActivityType').value;
  
  if (!name) {
    alert('Введите название раздела');
    return;
  }
  
  // Собираем шаблонные задачи
  const templateTasks = [];
  document.querySelectorAll('#editTemplateTasks .template-task').forEach((taskDiv, index) => {
    const titleInput = taskDiv.querySelector('input[type="text"]');
    const timeInput = taskDiv.querySelector('input[type="time"]');
    const title = titleInput.value.trim();
    if (title) {
      templateTasks.push({
        id: Date.now() + index,
        title: title,
        time: timeInput.value || ''
      });
    }
  });
  
  if (templateTasks.length === 0) {
    alert('Добавьте хотя бы одну задачу');
    return;
  }
  
  // Находим и обновляем раздел
  const sectionIndex = sections.findIndex(s => s.id == sectionId);
  if (sectionIndex !== -1) {
    const oldName = sections[sectionIndex].name;
    
    sections[sectionIndex] = {
      ...sections[sectionIndex],
      name: name,
      icon: window.selectedEditSectionIcon || sections[sectionIndex].icon,
      activityRule: { type: activityType },
      templateTasks: templateTasks
    };
    
    // Обновляем связанные разделы в rooms
    const roomIndex = rooms.findIndex(r => {
      const roomName = typeof r === 'string' ? r : r.name;
      return roomName === oldName;
    });
    
    if (roomIndex !== -1) {
      rooms[roomIndex] = {
        name: name,
        icon: window.selectedEditSectionIcon || sections[sectionIndex].icon
      };
      saveRooms();
    }
    
    // Обновляем планы
    plans.forEach(plan => {
      if (plan.room === oldName) {
        plan.room = name;
      }
    });
    
    saveSections();
    savePlans();
    syncSectionsToPlans(currentDate);
  }
  
  hideEditSection();
  showSectionsManager();
}

function hideEditSection() {
  const modal = document.getElementById('editSectionModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => modal.remove(), 300);
  }
}

function deleteSection(sectionId, event) {
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  const section = sections.find(s => s.id == sectionId);
  if (!section) return;
  
  if (confirm(`Удалить раздел "${section.name}"? Все связанные задачи будут удалены.`)) {
    // РЕФАКТОРИНГ: Удаляем все задачи, созданные из этого раздела через новую систему
    const initialCount = plans.length;
    plans = plans.filter(plan => !(
      plan.source && 
      plan.source.type === 'section' && 
      plan.source.sectionId == sectionId
    ));
    const removedTasksCount = initialCount - plans.length;
    
    // Удаляем сам раздел
    sections = sections.filter(s => s.id != sectionId);
    
    // Удаляем из rooms
    rooms = rooms.filter(room => {
      const roomName = typeof room === 'string' ? room : room.name;
      return roomName !== section.name;
    });
    
    console.log(`🗑️ Удален раздел "${section.name}" и ${removedTasksCount} связанных задач`);
    
    saveSections();
    savePlans();
    saveRooms();
    
    // Обновляем интерфейс
    renderSectionsList();
    renderRooms();
    updateRoomsSelect();
    renderPlans();
  }
}

function showAddSection() {
  hideSectionsManager();
  
  // Создаем форму для добавления раздела
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'addSectionModal';
  
  modal.innerHTML = `
    <div class="modal-header">
      <h2 class="modal-title">Новый раздел</h2>
      <button class="header-btn" onclick="hideAddSection(); showSectionsManager();">Отмена</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="label">Название раздела</label>
        <input type="text" class="input" id="sectionName" placeholder="Например: Утренняя зарядка">
      </div>
      
      <div class="form-group">
        <label class="label">Иконка</label>
        <div id="sectionIconSelector" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;">
          <!-- Иконки будут здесь -->
        </div>
      </div>
      
      <div class="form-group">
        <label class="label">Правило активности</label>
        <select class="select" id="activityType" onchange="updateActivityOptions()">
          <option value="daily">Каждый день</option>
          <option value="every_other_day">Через день</option>
          <option value="weekdays">По дням недели</option>
        </select>
      </div>
      
      <div class="form-group" id="weekdaysSelector" style="display: none;">
        <label class="label">Выберите дни недели</label>
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px;">
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="1"> Пн</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="2"> Вт</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="3"> Ср</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="4"> Чт</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="5"> Пт</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="6"> Сб</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="0"> Вс</label>
        </div>
      </div>
      
      <div class="form-group">
        <label class="label">Шаблонные задачи</label>
        <div id="templateTasks">
          <div class="template-task" style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" class="input" placeholder="Название задачи" style="flex: 1;">
            <input type="time" class="input" style="width: 100px;">
            <button type="button" onclick="removeTemplateTask(this)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px;">×</button>
          </div>
        </div>
        <button type="button" onclick="addTemplateTask()" class="btn-secondary" style="margin-top: 8px;">+ Добавить задачу</button>
      </div>
      
      <button class="btn-primary btn-full-width" onclick="saveNewSection()" style="margin-top: 20px;">
        Создать раздел
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  renderSectionIcons();
}

function hideAddSection() {
  const modal = document.getElementById('addSectionModal');
  if (modal) {
    modal.remove();
  }
}

function renderSectionIcons() {
  const container = document.getElementById('sectionIconSelector');
  if (!container) return;
  
  const icons = ICONS.getSectionIcons();
  let selectedIcon = icons[0];
  
  let html = '';
  icons.forEach((icon, index) => {
    html += `
      <button type="button" onclick="selectSectionIcon('${icon}', this)" 
              class="section-icon-btn ${index === 0 ? 'selected' : ''}"
              style="
                background: ${index === 0 ? 'var(--accent-primary)' : 'var(--bg-tertiary)'};
                color: ${index === 0 ? 'white' : 'var(--text-primary)'};
                border: 1px solid var(--border-soft);
                border-radius: 8px;
                padding: 12px;
                font-size: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
              ">${icon}</button>
    `;
  });
  
  container.innerHTML = html;
  window.selectedSectionIcon = selectedIcon;
}

function selectSectionIcon(icon, button) {
  // Убираем выделение с других кнопок
  document.querySelectorAll('.section-icon-btn').forEach(btn => {
    btn.style.background = 'var(--bg-tertiary)';
    btn.style.color = 'var(--text-primary)';
    btn.classList.remove('selected');
  });
  
  // Выделяем выбранную кнопку
  button.style.background = 'var(--accent-primary)';
  button.style.color = 'white';
  button.classList.add('selected');
  
  window.selectedSectionIcon = icon;
}

function updateActivityOptions() {
  const activityType = document.getElementById('activityType').value;
  const weekdaysSelector = document.getElementById('weekdaysSelector');
  
  if (activityType === 'weekdays') {
    weekdaysSelector.style.display = 'block';
  } else {
    weekdaysSelector.style.display = 'none';
  }
}

function addTemplateTask() {
  const container = document.getElementById('templateTasks');
  const taskDiv = document.createElement('div');
  taskDiv.className = 'template-task';
  taskDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  
  taskDiv.innerHTML = `
    <input type="text" class="input" placeholder="Название задачи" style="flex: 1;">
    <input type="time" class="input" style="width: 100px;">
    <button type="button" onclick="removeTemplateTask(this)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px;">×</button>
  `;
  
  container.appendChild(taskDiv);
}

function removeTemplateTask(button) {
  button.parentElement.remove();
}

function saveNewSection() {
  const name = document.getElementById('sectionName').value.trim();
  if (!name) {
    alert('Введите название раздела');
    return;
  }
  
  const activityType = document.getElementById('activityType').value;
  let activityRule = { type: activityType };
  
  if (activityType === 'weekdays') {
    const selectedDays = Array.from(document.querySelectorAll('#weekdaysSelector input:checked'))
      .map(cb => parseInt(cb.value));
    
    if (selectedDays.length === 0) {
      alert('Выберите хотя бы один день недели');
      return;
    }
    
    activityRule.value = selectedDays;
  }
  
  // Собираем шаблонные задачи
  const templateTasks = [];
  document.querySelectorAll('.template-task').forEach((taskDiv, index) => {
    const titleInput = taskDiv.querySelector('input[type="text"]');
    const timeInput = taskDiv.querySelector('input[type="time"]');
    
    const title = titleInput.value.trim();
    if (title) {
      templateTasks.push({
        id: Date.now() + index,
        title: title,
        time: timeInput.value || ''
      });
    }
  });
  
  if (templateTasks.length === 0) {
    alert('Добавьте хотя бы одну задачу');
    return;
  }
  
  // Создаем новый раздел
  const newSection = {
    id: Date.now(),
    name: name,
    icon: window.selectedSectionIcon || '🏃',
    activityRule: activityRule,
    templateTasks: templateTasks,
    createdAt: new Date().toISOString()
  };
  
  sections.push(newSection);
  saveSections();
  
  // Синхронизируем с планами
  syncSectionsToPlans(currentDate);
  
  // Обновляем отображение
  render();
  updateSectionsStats(); // Обновляем статистику
  
  hideAddSection();
  showSectionsManager(); // Возвращаемся в управление разделами
}

function deleteSection(sectionId, event) {
  if (event) {
    event.stopPropagation();
  }
  
  const section = sections.find(s => s.id == sectionId);
  if (!section) return;
  
  if (confirm(`Удалить раздел "${section.name}"?\n\nВсе связанные задачи также будут удалены.`)) {
    // РЕФАКТОРИНГ: Удаляем все задачи, созданные из этого раздела через новую систему
    const initialCount = plans.length;
    plans = plans.filter(plan => !(
      plan.source && 
      plan.source.type === 'section' && 
      plan.source.sectionId == sectionId
    ));
    const removedTasksCount = initialCount - plans.length;
    
    // Удаляем сам раздел
    sections = sections.filter(s => s.id != sectionId);
    
    console.log(`🗑️ Удален раздел "${section.name}" и ${removedTasksCount} связанных задач`);
    
    saveSections();
    savePlans();
    
    renderSectionsList();
    render();
    updateSectionsStats(); // Обновляем статистику
  }
}

// PROFILE
function loadProfileData() {
  const userName = localStorage.getItem('planner_userName') || 'Пользователь';
  const firstLetter = userName.charAt(0).toUpperCase();
  
  // Безопасно обновляем элементы профиля
  const profileNameEl = document.getElementById('profileName');
  if (profileNameEl) {
    profileNameEl.textContent = userName;
  }
  
  const avatarCircle = document.querySelector('.avatar-circle');
  if (avatarCircle) {
    avatarCircle.textContent = firstLetter;
  }
  
  const profileBtn = document.querySelector('.profile-btn');
  if (profileBtn) {
    profileBtn.textContent = firstLetter;
  }
}

function editName() {
  const profileName = document.getElementById('profileName');
  const currentName = profileName ? profileName.textContent : 'Пользователь';
  
  showPopup(
    'Изменить имя',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: saveName }
    ],
    true,
    currentName
  );
}

function saveName() {
  const input = document.querySelector('.popup-input');
  if (!input) {
    console.error('Элемент popup-input не найден');
    return;
  }
  
  const newName = input.value.trim();
  
  if (newName) {
    localStorage.setItem('planner_userName', newName);
    loadProfileData();
  }
  
  hidePopup();
}

function showAccount() {
  showPopup(
    'Аккаунт',
    `Планов создано: ${plans.length}\nРазделов создано: ${rooms.length}\nДата регистрации: 27 января 2025\nПодписка: Бесплатный план`,
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function showSettings() {
  showPopup(
    'Настройки',
    'Уведомления: Включены\nЧасовой пояс: GMT+3 (Москва)\nЯзык: Русский\nТема: Системная',
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function showSupport() {
  showPopup(
    'Поддержка',
    'Вы будете перенаправлены в Telegram для отправки сообщения.',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Написать', type: 'confirm', action: openSupport }
    ]
  );
}

function openSupport() {
  const message = 'Здравствуйте! У меня есть вопрос по приложению Планер v6.0.';
  const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(message)}`;
  window.open(telegramUrl, '_blank');
  hidePopup();
}

// POPUP SYSTEM
function showPopup(title, message, buttons, hasInput = false, inputValue = '') {
  const popupTitle = document.getElementById('popupTitle');
  const popupMessage = document.getElementById('popupMessage');
  const buttonsContainer = document.getElementById('popupButtons');
  const popup = document.getElementById('popup');
  
  if (!popupTitle || !popupMessage || !buttonsContainer || !popup) {
    console.error('Не найдены элементы попапа');
    return;
  }
  
  popupTitle.textContent = title;
  popupMessage.textContent = message;
  buttonsContainer.innerHTML = '';
  
  if (hasInput) {
    const input = document.createElement('input');
    input.className = 'input popup-input';
    input.placeholder = 'Введите текст...';
    input.value = inputValue;
    input.style.marginBottom = '16px';
    
    const popupContent = document.querySelector('.popup-content');
    if (popupContent) {
      popupContent.insertBefore(input, buttonsContainer);
      setTimeout(() => input.focus(), 100);
    }
  }
  
  buttons.forEach(btn => {
    const button = document.createElement('button');
    let buttonClass = 'btn-secondary'; // По умолчанию secondary
    if (btn.type === 'confirm') buttonClass = 'btn-primary';
    if (btn.type === 'danger') buttonClass = 'btn-destructive';
    button.className = buttonClass;
    button.textContent = btn.text;
    button.onclick = btn.action;
    buttonsContainer.appendChild(button);
  });
  
  popup.classList.add('show');
}

function hidePopup() {
  const popup = document.getElementById('popup');
  if (popup) {
    popup.classList.remove('show');
  } else {
    console.error('Элемент popup не найден');
  }
  
  // Remove input if exists
  const existingInput = document.querySelector('.popup-input');
  if (existingInput) {
    existingInput.remove();
  }
}

// УЛУЧШЕННАЯ СИСТЕМА УПРАВЛЕНИЯ СОСТОЯНИЯМИ КНОПОК
function setButtonState(buttonElement, state) {
  if (!buttonElement) return;
  
  // Убираем все классы состояний
  buttonElement.classList.remove('loading', 'disabled', 'error', 'success');
  
  switch(state) {
    case 'loading':
      buttonElement.classList.add('loading');
      buttonElement.disabled = true;
      buttonElement.style.opacity = '0.7';
      buttonElement.style.cursor = 'not-allowed';
      break;
    case 'disabled':
      buttonElement.classList.add('disabled');
      buttonElement.disabled = true;
      buttonElement.style.opacity = '0.5';
      buttonElement.style.cursor = 'not-allowed';
      break;
    case 'error':
      buttonElement.classList.add('error');
      buttonElement.style.borderColor = '#ef4444';
      buttonElement.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
      setTimeout(() => setButtonState(buttonElement, 'normal'), 2000);
      break;
    case 'success':
      buttonElement.classList.add('success');
      buttonElement.style.borderColor = '#22c55e';
      buttonElement.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
      setTimeout(() => setButtonState(buttonElement, 'normal'), 1000);
      break;
    case 'normal':
    default:
      buttonElement.disabled = false;
      buttonElement.style.opacity = '';
      buttonElement.style.cursor = '';
      buttonElement.style.borderColor = '';
      buttonElement.style.backgroundColor = '';
      break;
  }
}

// ПРОВЕРКА ДОСТУПНОСТИ ДЕЙСТВИЙ
function canPerformAction(actionType, data = {}) {
  switch(actionType) {
    case 'addTask':
      return true; // Всегда можно добавить задачу
    
    case 'editTask':
      return data.taskId && plans.find(p => p.id === data.taskId);
    
    case 'deleteTask':
      return data.taskId && plans.find(p => p.id === data.taskId);
    
    case 'addRoom':
      return data.roomName && data.roomName.trim().length > 0;
    
    case 'editRoom':
      return data.roomName && rooms.find(r => {
        const name = typeof r === 'string' ? r : r.name;
        return name === data.roomName;
      });
    
    case 'deleteRoom':
      return data.roomName && rooms.find(r => {
        const name = typeof r === 'string' ? r : r.name;
        return name === data.roomName;
      });
    
    case 'changeDate':
      if (!data.newDate) return false;
      const date = new Date(data.newDate);
      const today = new Date();
      const yearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate());
      const yearAhead = new Date(today.getFullYear() + 1, today.getMonth(), today.getDate());
      return date >= yearAgo && date <= yearAhead;
    
    default:
      return true;
  }
}

// БЕЗОПАСНОЕ ВЫПОЛНЕНИЕ ДЕЙСТВИЙ С ПРОВЕРКАМИ
function safeExecuteAction(actionType, actionFunction, data = {}, buttonElement = null) {
  try {
    // Проверяем возможность выполнения действия
    if (!canPerformAction(actionType, data)) {
      console.warn(`Действие ${actionType} недоступно:`, data);
      if (buttonElement) setButtonState(buttonElement, 'disabled');
      return false;
    }
    
    // Устанавливаем состояние загрузки
    if (buttonElement) setButtonState(buttonElement, 'loading');
    
    // Выполняем действие
    const result = actionFunction(data);
    
    // Если действие асинхронное
    if (result instanceof Promise) {
      result
        .then(() => {
          if (buttonElement) setButtonState(buttonElement, 'success');
        })
        .catch((error) => {
          console.error(`Ошибка при выполнении ${actionType}:`, error);
          if (buttonElement) setButtonState(buttonElement, 'error');
        });
    } else {
      // Синхронное действие
      if (buttonElement) setButtonState(buttonElement, 'success');
    }
    
    return true;
    
  } catch (error) {
    console.error(`Ошибка при выполнении ${actionType}:`, error);
    if (buttonElement) setButtonState(buttonElement, 'error');
    
    // Показываем пользователю уведомление об ошибке
    showPopup('Ошибка', `Не удалось выполнить действие. Попробуйте еще раз.`, [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    
    return false;
  }
}
// УЛУЧШЕННАЯ TELEGRAM INTEGRATION
if (tg) {
  // Обработка кнопки "Назад" с улучшенной логикой
  tg.onEvent('backButtonClicked', () => {
    // Используем улучшенную систему управления модальными окнами
    hideCurrentModal();
  });
  
  // Обработка события закрытия приложения
  tg.onEvent('mainButtonClicked', () => {
    // Можно добавить логику для главной кнопки если нужно
  });
  
  // Обработка изменения темы
  tg.onEvent('themeChanged', () => {
    // Обновляем CSS переменные при изменении темы
    if (tg.themeParams) {
      document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#f2f2f7');
      document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
      document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#8e8e93');
      document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#007aff');
      document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#007aff');
      document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
    }
  });
  
  // Обработка изменения размера окна
  tg.onEvent('viewportChanged', () => {
    // Можно добавить логику адаптации интерфейса
  });
}

// УЛУЧШЕННАЯ ОБРАБОТКА КЛАВИАТУРЫ
document.addEventListener('keydown', (e) => {
  // Обработка Enter
  if (e.key === 'Enter') {
    const activeElement = document.activeElement;
    
    // В попапах
    if (activeElement && activeElement.classList.contains('popup-input')) {
      e.preventDefault();
      const confirmBtn = document.querySelector('.btn-primary');
      if (confirmBtn && !confirmBtn.disabled) {
        confirmBtn.click();
      }
    }
    
    // В форме добавления задачи
    if (activeElement && activeElement.id === 'planTitle') {
      e.preventDefault();
      const saveBtn = document.querySelector('#addModal .btn');
      if (saveBtn && !saveBtn.disabled) {
        savePlan();
      }
    }
  }
  
  // Обработка Escape
  if (e.key === 'Escape') {
    e.preventDefault();
    hideCurrentModal();
  }
  
  // Обработка стрелок для навигации по дням (только если нет активных полей ввода)
  if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && 
      !document.activeElement.matches('input, textarea, select')) {
    e.preventDefault();
    const direction = e.key === 'ArrowLeft' ? -1 : 1;
    changeDay(direction);
  }
  
  // Быстрые клавиши
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 'n': // Ctrl/Cmd + N - новая задача
        e.preventDefault();
        if (currentTab === 'tasks' && !currentModal) {
          showAdd();
        }
        break;
      case '1': // Ctrl/Cmd + 1 - вкладка задач
        e.preventDefault();
        switchTab('tasks');
        break;
      case '2': // Ctrl/Cmd + 2 - вкладка питания
        e.preventDefault();
        switchTab('nutrition');
        break;
      case '3': // Ctrl/Cmd + 3 - вкладка привычек
        e.preventDefault();
        switchTab('habits');
        break;
    }
  }
});

// УЛУЧШЕННАЯ СИСТЕМА ПЕРЕКЛЮЧЕНИЯ ВКЛАДОК
function switchTab(tabName) {
  // Проверяем валидность вкладки
  const validTabs = ['tasks', 'nutrition', 'habits'];
  if (!validTabs.includes(tabName)) {
    console.error(`Неизвестная вкладка: ${tabName}`);
    return;
  }
  
  // Закрываем все открытые модальные окна перед переключением
  hideCurrentModal();
  
  // Убираем активный класс со всех кнопок
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.classList.remove('active');
  });
  
  // Добавляем активный класс к выбранной кнопке
  const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
  if (selectedTab) {
    selectedTab.classList.add('active');
  } else {
    console.error(`Вкладка с data-tab="${tabName}" не найдена`);
    return;
  }
  
  // Сохраняем предыдущую вкладку для анимаций
  const previousTab = currentTab;
  currentTab = tabName;
  
  // Показываем соответствующий контент с анимацией
  showTabContent(tabName, previousTab);
  
  // Обновляем заголовок в зависимости от вкладки
  updateHeaderForTab(tabName);
}

// ОБНОВЛЕНИЕ ЗАГОЛОВКА ДЛЯ РАЗНЫХ ВКЛАДОК
function updateHeaderForTab(tabName) {
  const dayTitle = document.getElementById('dayTitle');
  const daySubtitle = document.getElementById('daySubtitle');
  
  if (!dayTitle || !daySubtitle) return;
  
  switch(tabName) {
    case 'tasks':
      dayTitle.textContent = formatDate(currentDate);
      daySubtitle.textContent = formatDateSubtitle(currentDate);
      break;
    case 'nutrition':
      dayTitle.textContent = formatDate(currentNutritionDate);
      daySubtitle.textContent = formatDateSubtitle(currentNutritionDate);
      break;
    case 'habits':
      dayTitle.textContent = 'Привычки';
      daySubtitle.textContent = 'Трекинг целей';
      break;
  }
}

// УЛУЧШЕННАЯ СИСТЕМА ОТОБРАЖЕНИЯ КОНТЕНТА ВКЛАДОК
function showTabContent(tabName, previousTab = null) {
  const content = document.querySelector('.content');
  
  if (!content) {
    console.error('Элемент .content не найден');
    return;
  }
  
  // Добавляем анимацию перехода
  content.style.opacity = '0.7';
  content.style.transform = 'translateY(10px)';
  
  setTimeout(() => {
    switch(tabName) {
      case 'tasks':
        showTasksTab();
        break;
      case 'nutrition':
        showNutritionTab();
        break;
      case 'habits':
        showHabitsTab();
        break;
      default:
        console.error(`Неизвестная вкладка: ${tabName}`);
        return;
    }
    
    // Анимация появления нового контента
    content.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    content.style.opacity = '1';
    content.style.transform = 'translateY(0)';
    
    // Обновляем заголовок
    updateHeaderForTab(tabName);
    
  }, 150);
}

// ОТДЕЛЬНАЯ ФУНКЦИЯ ДЛЯ ВКЛАДКИ ЗАДАЧ
function showTasksTab() {
  const content = document.querySelector('.content');
  
  // Восстанавливаем оригинальную структуру задач
  content.innerHTML = `
    <div class="progress-container" id="progressContainer">
      <div class="progress-info">
        <div class="progress-label" id="progressLabel">Прогресс дня</div>
        <div class="progress-stats" id="progressStats">0/0</div>
      </div>
      <div class="progress-circle-container">
        <div class="progress-circle" id="progressCircle">
          <div class="progress-circle-inner">
            <div class="progress-percentage" id="progressPercentage">0%</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="empty" id="empty">
      <h2>Планов нет</h2>
      <p>Добавьте первую задачу</p>
      <button class="btn-primary" onclick="showAdd()">Добавить задачу</button>
    </div>
    
    <div class="plans-container" id="plansContainer" style="display:none">
      <div class="plans" id="plans"></div>
    </div>
  `;
  
  // Восстанавливаем правильные стили для content
  content.style.overflow = 'hidden';
  content.style.height = '';
  content.style.display = 'flex';
  content.style.flexDirection = 'column';
  
  // Инициализируем прогресс-бар заново
  const progressCircle = document.getElementById('progressCircle');
  if (progressCircle) {
    progressCircle.dataset.currentAngle = '0';
  }
  
  // Рендерим задачи с небольшой задержкой для плавности
  setTimeout(() => {
    render();
  }, 50);
}

function showNutritionTab() {
  const content = document.querySelector('.content');
  content.innerHTML = `
    <!-- NUTRITION CONTAINER WITH PROPER SCROLL -->
    <div class="nutrition-container">
      <!-- WATER TRACKER - FIXED AT TOP -->
      <div class="water-tracker">
        <div class="water-header">
          <div class="water-info">
            <div class="water-label">💧 Вода сегодня</div>
            <div class="water-stats" id="waterStats">0/8 стаканов</div>
          </div>
          <button class="water-settings-btn" onclick="showWaterSettings()">⚙️</button>
        </div>
        <div class="water-progress">
          <div class="water-progress-bar">
            <div class="water-progress-fill" id="waterProgressFill" style="width: 0%"></div>
          </div>
          <div class="water-controls">
            <button class="water-btn minus" onclick="changeWater(-1)">−</button>
            <span class="water-current" id="waterCurrent" onclick="editWaterAmount()">0</span>
            <button class="water-btn plus" onclick="changeWater(1)">+</button>
          </div>
        </div>
      </div>

      <!-- SCROLLABLE MEALS SECTION -->
      <div class="meals-scroll-container">
        <!-- SINGLE DAY MEALS -->
        <div class="single-day-container">
          <div class="day-card today" id="nutritionDayCard">
            <div class="meals" id="nutritionMeals">
              <!-- Приемы пищи будут добавлены динамически -->
            </div>
          </div>
          
          <!-- ADD MEAL BUTTON - ВЫНЕСЕНА ИЗ КАРТОЧКИ -->
          <div class="add-meal-container">
            <div class="meal add-meal" onclick="addNewMealType()">
              <div class="meal-label">➕ Добавить прием пищи</div>
              <div class="meal-content">Создать новый прием пищи</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Убеждаемся что контент имеет правильную структуру
  content.style.overflow = 'hidden';
  content.style.height = '100%';
  content.style.display = 'flex';
  content.style.flexDirection = 'column';
  
  // Добавляем анимации появления с задержками
  setTimeout(() => {
    const waterTracker = document.querySelector('.water-tracker');
    const dayContainer = document.querySelector('.single-day-container');
    
    if (waterTracker) waterTracker.classList.add('animate-slide-right');
    if (dayContainer) dayContainer.classList.add('animate-in');
  }, 50);
  
  // Инициализируем питание
  initNutrition();
}

function initNutrition() {
  // Загружаем данные питания
  loadNutritionData();
  
  // Рендерим текущий день
  renderNutritionDay();
  
  // Обновляем трекер воды
  updateWaterTracker();
  
  // Обновляем заголовок дня
  updateHeaderForTab('nutrition');
}

// Данные питания
let nutritionData = {
  water: {
    target: 8,
    daily: {} // Изменяем структуру: {date: amount}
  },
  meals: {}, // {date: {mealId: {content: '', time: ''}}}
  mealTypes: { // Типы приемов пищи по дням
    // date: [{id: 'breakfast', name: '🌅 Завтрак', icon: '🌅', time: '08:00'}]
  }
};

let currentNutritionDate = new Date(); // Текущий день для питания

function loadNutritionData() {
  try {
    const saved = localStorage.getItem('planner_nutrition');
    if (saved) {
      const loadedData = JSON.parse(saved);
      
      // Миграция старой структуры воды
      if (loadedData.water && typeof loadedData.water.current !== 'undefined') {
        console.log('Мигрируем старую структуру воды...');
        // Старая структура - мигрируем
        const oldDate = loadedData.water.date || new Date().toDateString();
        const oldAmount = loadedData.water.current || 0;
        
        nutritionData.water.target = loadedData.water.target || 8;
        nutritionData.water.daily = {};
        nutritionData.water.daily[oldDate] = oldAmount;
        console.log('Миграция воды завершена');
      } else if (loadedData.water && loadedData.water.daily) {
        // Новая структура
        nutritionData.water = loadedData.water;
      }
      
      // Миграция старых данных приемов пищи
      if (loadedData.meals) {
        for (const dateStr in loadedData.meals) {
          const dayMeals = loadedData.meals[dateStr];
          if (typeof dayMeals === 'object' && dayMeals !== null) {
            // Проверяем, есть ли старые ключи (breakfast, lunch, etc.)
            if (dayMeals.breakfast !== undefined || dayMeals.lunch !== undefined) {
              // Это старый формат, оставляем как есть
              continue;
            }
          }
        }
        nutritionData.meals = loadedData.meals;
      }
      
      // Инициализируем mealTypes если его нет
      if (loadedData.mealTypes) {
        nutritionData.mealTypes = loadedData.mealTypes;
      }
      
      console.log('Данные питания успешно загружены');
    } else {
      console.log('Сохраненных данных питания не найдено, используем значения по умолчанию');
    }
    
    // Инициализируем daily если его нет
    if (!nutritionData.water.daily) {
      nutritionData.water.daily = {};
    }
  } catch (e) {
    console.error('Ошибка при загрузке данных питания:', e);
    
    // Инициализируем значениями по умолчанию в случае ошибки
    nutritionData = {
      water: {
        target: 8,
        daily: {}
      },
      meals: {},
      mealTypes: {}
    };
    
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка загрузки', 'Не удалось загрузить данные питания. Используются настройки по умолчанию.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

function saveNutritionData() {
  try {
    localStorage.setItem('planner_nutrition', JSON.stringify(nutritionData));
    console.log('Данные питания успешно сохранены');
  } catch (e) {
    console.error('Ошибка при сохранении данных питания:', e);
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка сохранения', 'Не удалось сохранить данные питания. Проверьте свободное место на устройстве.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

// Навигация по дням питания теперь использует общую функцию changeDay

function renderNutritionDay() {
  try {
    const mealsContainer = document.getElementById('nutritionMeals');
    
    if (!mealsContainer) {
      console.log('Контейнер приемов пищи не найден');
      return;
    }
    
    // ИСПРАВЛЕНО: используем правильный формат даты YYYY-MM-DD
    const dateStr = currentNutritionDate.toISOString().split('T')[0];
    console.log('renderNutritionDay dateStr:', dateStr);
    
    // Получаем приемы пищи для этого дня
    const dayMealTypes = nutritionData.mealTypes[dateStr] || [];
    const dayMeals = nutritionData.meals[dateStr] || {};
    
    // Анимация исчезновения старого контента
    mealsContainer.style.opacity = '0';
    mealsContainer.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      try {
        let html = '';
        
        // Рендерим существующие приемы пищи
        dayMealTypes.forEach((mealType, index) => {
          try {
            const mealData = dayMeals[mealType.id] || {};
            const mealContent = mealData.content || 'Не запланировано';
            const mealTime = mealData.time || mealType.time || '';
            const isCompleted = mealData.completed || false;
            
            html += `
              <div class="meal animate-in ${isCompleted ? 'completed' : ''}" style="animation-delay: ${index * 0.1}s">
                <div class="meal-with-checkbox">
                  <div class="meal-checkbox ${isCompleted ? 'checked' : ''}" onclick="toggleMealComplete('${dateStr}', '${mealType.id}', event)"></div>
                  <div class="meal-main-content" onclick="editMeal('${dateStr}', '${mealType.id}')">
                    <div class="meal-header">
                      <div class="meal-label">
                        ${mealType.icon} ${mealType.name}
                        ${mealTime ? `<span class="meal-time-badge">${mealTime}</span>` : ''}
                      </div>
                      <button class="delete-meal-btn" onclick="event.stopPropagation(); deleteMealType('${dateStr}', '${mealType.id}')">×</button>
                    </div>
              <div class="meal-content">${mealContent}</div>
            </div>
          </div>
        </div>
      `;
          } catch (e) {
            console.error('Ошибка при рендеринге приема пищи:', e);
          }
        });
    
        mealsContainer.innerHTML = html;
        // Анимация появления нового контента
        mealsContainer.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        mealsContainer.style.opacity = '1';
        mealsContainer.style.transform = 'translateY(0)';
        
        // Добавляем анимации для новых элементов
        setTimeout(() => {
          const meals = mealsContainer.querySelectorAll('.meal');
          meals.forEach((meal, index) => {
            meal.style.animationDelay = `${index * 0.1}s`;
            meal.classList.add('animate-in');
            
            // Устанавливаем ширину текста для уже выполненных приемов пищи
            if (meal.classList.contains('completed')) {
              const mealLabel = meal.querySelector('.meal-label');
              const mealContent = meal.querySelector('.meal-content');
              
              if (mealLabel) {
                try {
                  // Создаем временный элемент для измерения только текста
                  const tempLabel = document.createElement('span');
                  tempLabel.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    white-space: nowrap;
                    font-family: ${window.getComputedStyle(mealLabel).fontFamily};
                    font-size: ${window.getComputedStyle(mealLabel).fontSize};
                    font-weight: ${window.getComputedStyle(mealLabel).fontWeight};
                  `;
                  
                  // Получаем только текст без HTML тегов и значков времени
                  const labelTextOnly = mealLabel.textContent.replace(/\s*\d{2}:\d{2}\s*$/, '').trim();
                  tempLabel.textContent = labelTextOnly;
                  
                  document.body.appendChild(tempLabel);
                  const labelWidth = tempLabel.offsetWidth;
                  document.body.removeChild(tempLabel);
                  
                  mealLabel.style.setProperty('--text-width', labelWidth + 'px');
                } catch (e) {
                  console.log('Ошибка при измерении ширины текста метки:', e);
                }
              }
              
              if (mealContent) {
                try {
                  // Создаем временный элемент для измерения текста контента
                  const tempContent = document.createElement('span');
                  tempContent.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    white-space: nowrap;
                    font-family: ${window.getComputedStyle(mealContent).fontFamily};
                    font-size: ${window.getComputedStyle(mealContent).fontSize};
                    font-weight: ${window.getComputedStyle(mealContent).fontWeight};
                  `;
                  tempContent.textContent = mealContent.textContent;
                  
                  document.body.appendChild(tempContent);
                  const contentWidth = tempContent.offsetWidth;
                  document.body.removeChild(tempContent);
                  
                  mealContent.style.setProperty('--text-width', contentWidth + 'px');
                } catch (e) {
                  console.log('Ошибка при измерении ширины текста контента:', e);
                }
              }
            }
          });
        }, 100);
        
      } catch (e) {
        console.error('Ошибка при рендеринге дня питания в setTimeout:', e);
      }
    }, 200);
  } catch (e) {
    console.error('Ошибка в функции renderNutritionDay:', e);
  }
}





// Трекер воды
function changeWater(delta) {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  
  // Получаем текущее количество воды для этого дня
  const currentAmount = nutritionData.water.daily[dateStr] || 0;
  
  // Обновляем количество
  nutritionData.water.daily[dateStr] = Math.max(0, currentAmount + delta);
  
  saveNutritionData();
  updateWaterTracker();
}

function editWaterAmount() {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  const currentAmount = nutritionData.water.daily[dateStr] || 0;
  
  showPopup(
    '💧 Количество воды',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: saveWaterAmount }
    ],
    true,
    currentAmount.toString()
  );
  
  setTimeout(() => {
    const input = document.querySelector('.popup-input');
    if (input) {
      input.type = 'number';
      input.min = '0';
      input.placeholder = 'Сколько стаканов выпили?';
      input.select(); // Выделяем текст для быстрого редактирования
    }
  }, 100);
}

function saveWaterAmount() {
  const input = document.querySelector('.popup-input');
  const newAmount = parseInt(input.value.trim());
  
  if (isNaN(newAmount) || newAmount < 0) {
    showPopup('Ошибка', 'Введите корректное количество стаканов (0 или больше)', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  nutritionData.water.daily[dateStr] = newAmount;
  
  saveNutritionData();
  updateWaterTracker();
  hidePopup();
}

function updateWaterTracker() {
  try {
    const waterStats = document.getElementById('waterStats');
    const waterProgressFill = document.getElementById('waterProgressFill');
    const waterCurrent = document.getElementById('waterCurrent');
    
    if (!waterStats || !waterProgressFill || !waterCurrent) {
      console.log('Элементы трекера воды не найдены, пропускаем обновление');
      return;
    }
    
    // Получаем воду для текущего дня питания
    const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
    const current = nutritionData.water.daily[dateStr] || 0;
    const target = nutritionData.water.target;
    const percentage = (current / target) * 100;
    
    // Плавное обновление статистики
    const currentStats = waterStats.textContent;
    const newStats = `${current}/${target} стаканов`;
    
    if (currentStats !== newStats) {
      waterStats.style.opacity = '0.7';
      waterStats.style.transform = 'scale(0.95)';
      
      setTimeout(() => {
        waterStats.textContent = newStats;
        waterStats.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        waterStats.style.opacity = '1';
        waterStats.style.transform = 'scale(1)';
      }, 150);
    }
    
    // Плавное обновление прогресс-бара
    waterProgressFill.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    waterProgressFill.style.width = `${Math.min(100, percentage)}%`;
    
    // Плавное обновление текущего значения
    const currentValue = parseInt(waterCurrent.textContent) || 0;
    if (currentValue !== current) {
      animateWaterValue(waterCurrent, currentValue, current);
    }
    
    // Добавляем класс completed если цель достигнута
    const waterTracker = document.querySelector('.water-tracker');
    if (waterTracker) {
      if (current >= target) {
        if (!waterTracker.classList.contains('completed')) {
          waterTracker.classList.add('completed');
          // Добавляем небольшую вибрацию при достижении цели
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
          }
          // Показываем уведомление о достижении цели
          showWaterCompletionEffect();
        }
      } else {
        waterTracker.classList.remove('completed');
      }
    }
  } catch (e) {
    console.error('Ошибка в функции updateWaterTracker:', e);
  }
}

function animateWaterValue(element, from, to) {
  const duration = 600;
  const steps = Math.abs(to - from);
  if (steps === 0) return;
  
  const stepDuration = duration / steps;
  const increment = to > from ? 1 : -1;
  let current = from;
  
  element.style.transform = 'scale(1.1)';
  element.style.color = '#3b82f6';
  
  const timer = setInterval(() => {
    current += increment;
    element.textContent = current;
    
    if (current === to) {
      clearInterval(timer);
      // Возвращаем к нормальному состоянию
      setTimeout(() => {
        element.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        element.style.transform = 'scale(1)';
        element.style.color = '';
      }, 100);
    }
  }, stepDuration);
}

function showWaterCompletionEffect() {
  // Создаем эффект капель воды при достижении цели
  const waterTracker = document.querySelector('.water-tracker');
  if (!waterTracker) return;
  
  for (let i = 0; i < 8; i++) {
    const drop = document.createElement('div');
    drop.style.cssText = `
      position: absolute;
      width: 8px;
      height: 8px;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      left: ${50 + (Math.random() - 0.5) * 60}%;
      top: ${30 + (Math.random() - 0.5) * 40}%;
      animation: water-drop-fall ${1 + Math.random() * 0.5}s ease-out forwards;
    `;
    
    drop.style.setProperty('--random-x', (Math.random() - 0.5) * 100 + 'px');
    drop.style.setProperty('--random-y', (Math.random() + 1) * 50 + 'px');
    
    waterTracker.appendChild(drop);
    
    // Удаляем каплю через 2 секунды
    setTimeout(() => {
      if (drop.parentNode) {
        drop.parentNode.removeChild(drop);
      }
    }, 2000);
  }
}

function showWaterSettings() {
  showPopup(
    '💧 Настройки воды',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: saveWaterSettings }
    ],
    true,
    nutritionData.water.target.toString()
  );
  
  // Меняем placeholder для ввода числа
  setTimeout(() => {
    const input = document.querySelector('.popup-input');
    if (input) {
      input.type = 'number';
      input.min = '1';
      input.placeholder = 'Сколько стаканов в день?';
    }
  }, 100);
}

function saveWaterSettings() {
  const input = document.querySelector('.popup-input');
  const newTarget = parseInt(input.value.trim());
  
  if (!newTarget || newTarget < 1) {
    showPopup('Ошибка', 'Введите число больше 0', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  nutritionData.water.target = newTarget;
  saveNutritionData();
  updateWaterTracker();
  hidePopup();
}

// Добавление нового типа приема пищи
function addNewMealType() {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  
  // Показываем специальный селектор типов приемов пищи
  showMealTypeSelector(dateStr);
}

function showMealTypeSelector(dateStr) {
  // Создаем модальное окно для выбора типа приема пищи
  const modal = document.createElement('div');
  modal.className = 'meal-type-modal';
  modal.innerHTML = `
    <div class="meal-type-modal-content">
      <div class="meal-type-header">
        <h3>🍽️ Выберите тип приема пищи</h3>
        <button class="meal-type-close" onclick="closeMealTypeSelector()">×</button>
      </div>
      <div class="meal-type-options">
        <div class="meal-type-option" onclick="selectMealType('breakfast', 'Завтрак', '🌅', '08:00')">
          <span class="meal-type-icon">🌅</span>
          <span class="meal-type-name">Завтрак</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('lunch', 'Обед', '☀️', '13:00')">
          <span class="meal-type-icon">☀️</span>
          <span class="meal-type-name">Обед</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('dinner', 'Ужин', '🌙', '19:00')">
          <span class="meal-type-icon">🌙</span>
          <span class="meal-type-name">Ужин</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('snack', 'Перекус', '🍎', '')">
          <span class="meal-type-icon">🍎</span>
          <span class="meal-type-name">Перекус</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('custom', 'Свой вариант', '🍽️', '')">
          <span class="meal-type-icon">🍽️</span>
          <span class="meal-type-name">Свой вариант</span>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Показываем модальное окно с анимацией
  setTimeout(() => {
    modal.classList.add('show');
  }, 10);
}

function closeMealTypeSelector() {
  const modal = document.querySelector('.meal-type-modal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(modal);
    }, 300);
  }
}

function selectMealType(typeId, typeName, typeIcon, defaultTime) {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  
  // Закрываем селектор типов
  closeMealTypeSelector();
  
  if (typeId === 'custom') {
    // Для кастомного типа показываем ввод названия
    setTimeout(() => {
      showCustomMealTypeInput(dateStr);
    }, 300);
  } else {
    // Для предустановленных типов генерируем уникальный ID
    const uniqueId = typeId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    setTimeout(() => {
      showMealTimeInput(dateStr, uniqueId, typeName, typeIcon, defaultTime);
    }, 300);
  }
}

function showCustomMealTypeInput(dateStr) {
  showPopup(
    '🍽️ Свой прием пищи',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Далее', type: 'confirm', action: () => saveCustomMealType(dateStr) }
    ],
    true,
    ''
  );
  
  setTimeout(() => {
    const input = document.querySelector('.popup-input');
    if (input) {
      input.placeholder = 'Название приема пищи';
    }
  }, 100);
}

function saveCustomMealType(dateStr) {
  const input = document.querySelector('.popup-input');
  const mealName = input.value.trim();
  
  if (!mealName) {
    showPopup('Ошибка', 'Введите название приема пищи', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  hidePopup();
  
  // Генерируем уникальный ID для кастомного приема пищи
  const uniqueId = 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  setTimeout(() => {
    showMealTimeInput(dateStr, uniqueId, mealName, '🍽️', '');
  }, 100);
}

function showMealTimeInput(dateStr, mealId, mealName, mealIcon, defaultTime) {
  // Создаем специальное модальное окно для полного ввода данных о приеме пищи
  const modal = document.createElement('div');
  modal.className = 'meal-input-modal';
  modal.innerHTML = `
    <div class="meal-input-modal-content">
      <div class="meal-input-header">
        <h3>${mealIcon} ${mealName}</h3>
        <button class="meal-input-close" onclick="closeMealInputModal()">×</button>
      </div>
      <div class="meal-input-form">
        <div class="form-group">
          <label class="label">Время (необязательно)</label>
          <input type="time" class="input" id="mealTimeInput" value="${defaultTime}" placeholder="Время приема пищи">
        </div>
        <div class="form-group">
          <label class="label">Что планируете съесть</label>
          <textarea class="input meal-content-input" id="mealContentInput" placeholder="Опишите прием пищи (например: овсянка с фруктами, кофе)" rows="3"></textarea>
        </div>
      </div>
      <div class="meal-input-buttons">
        <button class="btn-secondary" onclick="closeMealInputModal()">Отмена</button>
        <button class="btn-primary" onclick="saveMealWithAllData('${dateStr}', '${mealId}', '${mealName}', '${mealIcon}')">Добавить</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Показываем модальное окно с анимацией
  setTimeout(() => {
    modal.classList.add('show');
    // Фокусируемся на поле содержимого
    const contentInput = document.getElementById('mealContentInput');
    if (contentInput) {
      contentInput.focus();
    }
  }, 10);
}

function closeMealInputModal() {
  const modal = document.querySelector('.meal-input-modal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(modal);
    }, 300);
  }
}

function saveMealWithAllData(dateStr, mealId, mealName, mealIcon) {
  const timeInput = document.getElementById('mealTimeInput');
  const contentInput = document.getElementById('mealContentInput');
  
  const mealTime = timeInput.value.trim();
  const mealContent = contentInput.value.trim();
  
  if (!mealContent) {
    // Подсвечиваем поле, если оно пустое
    contentInput.style.borderColor = '#ef4444';
    contentInput.focus();
    return;
  }
  
  console.log('Сохраняем прием пищи:', { dateStr, mealId, mealName, mealIcon, mealTime, mealContent });
  
  // Создаем новый тип приема пищи
  const newMealType = {
    id: mealId,
    name: mealName,
    icon: mealIcon,
    time: mealTime
  };
  
  // Добавляем к типам приемов пищи для этого дня
  if (!nutritionData.mealTypes[dateStr]) {
    nutritionData.mealTypes[dateStr] = [];
  }
  nutritionData.mealTypes[dateStr].push(newMealType);
  
  // Сортируем по времени
  nutritionData.mealTypes[dateStr].sort((a, b) => {
    if (!a.time && !b.time) return 0;
    if (!a.time) return 1;
    if (!b.time) return -1;
    return a.time.localeCompare(b.time);
  });
  
  // Сохраняем содержимое приема пищи
  if (!nutritionData.meals[dateStr]) {
    nutritionData.meals[dateStr] = {};
  }
  nutritionData.meals[dateStr][mealId] = {
    content: mealContent,
    time: mealTime,
    completed: false // Новые приемы пищи по умолчанию не выполнены
  };
  
  // РЕФАКТОРИНГ: Автоматически создаем задачу через новую систему источников
  const taskTitle = `${mealIcon} ${mealName}: ${mealContent}`;
  const taskTime = mealTime || null;
  
  // Создаем новую задачу с источником
  const newTask = {
    id: Date.now().toString() + '_meal_' + mealId,
    title: taskTitle,
    date: dateStr,
    time: taskTime,
    room: 'Питание',
    completed: false,
    source: createTaskSource('meal', { mealId: mealId })
  };
  
  // Добавляем задачу в планы
  plans.push(newTask);
  savePlans();
  
  console.log('Автоматически создана задача из приема пищи:', newTask);
  
  console.log('Текущие типы приемов пищи для дня:', nutritionData.mealTypes[dateStr]);
  console.log('Текущие данные приемов пищи для дня:', nutritionData.meals[dateStr]);
  
  saveNutritionData();
  renderNutritionDay();
  
  // Если мы на вкладке задач, обновляем их отображение
  if (currentTab === 'tasks') {
    render();
  }
  
  closeMealInputModal();
}

// Удаление типа приема пищи
function deleteMealType(dateStr, mealTypeId) {
  // Получаем название приема пищи для подтверждения
  const dayMealTypes = nutritionData.mealTypes[dateStr] || [];
  const mealType = dayMealTypes.find(m => m.id === mealTypeId);
  const mealName = mealType ? mealType.name : 'Прием пищи';
  const mealTime = mealType && mealType.time ? ` в ${mealType.time}` : '';
  
  // Получаем содержимое приема пищи
  const mealData = nutritionData.meals[dateStr] && nutritionData.meals[dateStr][mealTypeId];
  const mealContent = mealData && mealData.content ? mealData.content : '';
  const contentPreview = mealContent.length > 30 ? mealContent.substring(0, 30) + '...' : mealContent;
  
  const confirmMessage = contentPreview 
    ? `Прием пищи "${mealName}${mealTime}" с содержимым "${contentPreview}" будет удален.`
    : `Прием пищи "${mealName}${mealTime}" будет удален.`;
  
  showPopup(
    'Удалить прием пищи?',
    confirmMessage,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: () => confirmDeleteMealType(dateStr, mealTypeId) }
    ]
  );
}

function confirmDeleteMealType(dateStr, mealTypeId) {
  console.log('Удаляем прием пищи:', { dateStr, mealTypeId });
  console.log('Типы приемов пищи до удаления:', nutritionData.mealTypes[dateStr]);
  console.log('Данные приемов пищи до удаления:', nutritionData.meals[dateStr]);
  
  // РЕФАКТОРИНГ: Удаляем связанную задачу через новую систему источников
  const initialPlansCount = plans.length;
  plans = plans.filter(plan => !(
    plan.source && 
    plan.source.type === 'meal' && 
    plan.source.mealId === mealTypeId && 
    plan.date === dateStr
  ));
  const deletedTasksCount = initialPlansCount - plans.length;
  
  if (deletedTasksCount > 0) {
    console.log(`Удалено связанных задач: ${deletedTasksCount}`);
    savePlans();
  }
  
  // Удаляем тип приема пищи
  if (nutritionData.mealTypes[dateStr]) {
    const beforeCount = nutritionData.mealTypes[dateStr].length;
    nutritionData.mealTypes[dateStr] = nutritionData.mealTypes[dateStr].filter(m => m.id !== mealTypeId);
    const afterCount = nutritionData.mealTypes[dateStr].length;
    console.log(`Удалено типов приемов пищи: ${beforeCount - afterCount}`);
  }
  
  // Удаляем данные о еде для этого типа
  if (nutritionData.meals[dateStr] && nutritionData.meals[dateStr][mealTypeId]) {
    delete nutritionData.meals[dateStr][mealTypeId];
    console.log('Удалены данные приема пищи с ID:', mealTypeId);
  }
  
  console.log('Типы приемов пищи после удаления:', nutritionData.mealTypes[dateStr]);
  console.log('Данные приемов пищи после удаления:', nutritionData.meals[dateStr]);
  
  saveNutritionData();
  renderNutritionDay();
  
  // Если мы на вкладке задач, обновляем их отображение
  if (currentTab === 'tasks') {
    render();
  }
  
  hidePopup();
}

// Редактирование приемов пищи
function editMeal(dateStr, mealType) {
  // Получаем название приема пищи
  const dayMealTypes = nutritionData.mealTypes[dateStr] || [];
  const mealTypeObj = dayMealTypes.find(m => m.id === mealType);
  const mealName = mealTypeObj ? mealTypeObj.name : 'Прием пищи';
  
  const currentMealData = nutritionData.meals[dateStr]?.[mealType] || {};
  const currentMeal = currentMealData.content || '';
  
  showPopup(
    `🍽️ ${mealName}`,
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: () => saveMeal(dateStr, mealType) }
    ],
    true,
    currentMeal
  );
}

function saveMeal(dateStr, mealType) {
  console.log('=== НАЧАЛО saveMeal ===');
  console.log('dateStr:', dateStr);
  console.log('mealType:', mealType);
  
  const input = document.querySelector('.popup-input');
  const mealContent = input.value.trim();
  
  console.log('mealContent:', mealContent);
  console.log('plans до изменений:', plans.length);
  
  if (!nutritionData.meals[dateStr]) {
    nutritionData.meals[dateStr] = {};
  }
  
  if (mealContent) {
    // Сохраняем как объект с контентом
    if (!nutritionData.meals[dateStr][mealType]) {
      nutritionData.meals[dateStr][mealType] = {};
    }
    nutritionData.meals[dateStr][mealType].content = mealContent;
    
    console.log('Сохранили прием пищи, теперь создаем задачу...');
    
    // 🍽️ АВТОМАТИЧЕСКИ СОЗДАЕМ ЗАДАЧУ В ПЛАНАХ
    // Получаем информацию о типе приема пищи
    const mealTypes = {
      'breakfast': { name: 'Завтрак', icon: '�' },
      'lunch': { name: 'Обед', icon: '🍽️' },
      'dinner': { name: 'Ужин', icon: '🌙' },
      'snack': { name: 'Перекус', icon: '🍎' }
    };
    
    const mealInfo = mealTypes[mealType] || { name: 'Прием пищи', icon: '🍽️' };
    const taskTitle = `${mealInfo.icon} ${mealInfo.name}: ${mealContent}`;
    
    console.log('mealInfo:', mealInfo);
    console.log('taskTitle:', taskTitle);
    
    // РЕФАКТОРИНГ: Создаем источник задачи через новую систему
    const taskSource = createTaskSource('meal', { mealId: mealType });
    
    // Проверяем, не существует ли уже такая задача через новую систему
    const existingTask = plans.find(plan => 
      plan.source && 
      plan.source.type === 'meal' && 
      plan.source.mealId === mealType && 
      plan.date === dateStr
    );
    if (existingTask) {
      // Обновляем существующую задачу
      existingTask.title = taskTitle;
      console.log('Обновлена существующая задача из приема пищи:', existingTask);
    } else {
      // РЕФАКТОРИНГ: Создаем новую задачу с новой системой источников
      const newTask = {
        id: Date.now().toString() + '_meal_' + mealType,
        title: taskTitle,
        date: dateStr,
        time: null, // Стандартные приемы пищи без времени
        room: 'Питание',
        completed: false,
        source: taskSource // РЕФАКТОРИНГ: Используем новую систему источников
      };
      
      // Добавляем задачу только если она не была удалена
      if (!isTaskDeleted(dateStr, taskSource)) {
        plans.push(newTask);
        console.log('Добавили новую задачу в plans. Теперь plans.length:', plans.length);
        console.log('Автоматически создана задача из приема пищи:', newTask);
      } else {
        console.log('Задача была удалена ранее, не создаем повторно');
      }
    }
    
    console.log('Сохраняем планы...');
    savePlans();
    console.log('Планы сохранены');
  } else {
    // РЕФАКТОРИНГ: Если содержимое пустое, удаляем прием пищи и связанную задачу через новую систему
    delete nutritionData.meals[dateStr][mealType];
    
    // Удаляем связанную задачу через новую систему источников
    const taskSource = createTaskSource('meal', { mealId: mealType });
    const initialPlansCount = plans.length;
    plans = plans.filter(plan => !(
      plan.source && 
      plan.source.type === 'meal' && 
      plan.source.mealId === mealType && 
      plan.date === dateStr
    ));
    const deletedTasksCount = initialPlansCount - plans.length;
    
    if (deletedTasksCount > 0) {
      console.log(`Удалено связанных задач: ${deletedTasksCount}`);
      savePlans();
    }
  }
  
  saveNutritionData();
  renderNutritionDay();
  
  console.log('currentTab:', currentTab);
  // Если мы на вкладке задач, обновляем их отображение
  if (currentTab === 'tasks') {
    console.log('Обновляем отображение задач...');
    render();
  }
  
  hidePopup();
  console.log('=== КОНЕЦ saveMeal ===');
}

// Переключение состояния выполнения приема пищи
function toggleMealComplete(dateStr, mealTypeId, event) {
  event.stopPropagation();
  
  try {
    if (!nutritionData.meals[dateStr]) {
      nutritionData.meals[dateStr] = {};
    }
    
    if (!nutritionData.meals[dateStr][mealTypeId]) {
      nutritionData.meals[dateStr][mealTypeId] = {};
    }
    
    const mealData = nutritionData.meals[dateStr][mealTypeId];
    const wasCompleted = mealData.completed || false;
    
    // Переключаем состояние
    mealData.completed = !wasCompleted;
    
    // Находим элементы для анимации
    const checkbox = event.target;
    const mealElement = checkbox.closest('.meal');
    const mealLabel = mealElement.querySelector('.meal-label');
    const mealContent = mealElement.querySelector('.meal-content');
    
    if (mealData.completed) {
      // Отмечаем как выполненное - с анимацией
      checkbox.classList.add('checked');
      
      // 📋 РЕФАКТОРИНГ: СИНХРОНИЗАЦИЯ С ЗАДАЧАМИ через новую систему источников
      const relatedTask = plans.find(plan => 
        plan.source && 
        plan.source.type === 'meal' && 
        plan.source.mealId === mealTypeId && 
        plan.date === dateStr
      );
      
      if (relatedTask) {
        console.log('Отмечаем связанную задачу как выполненную:', relatedTask.title);
        relatedTask.completed = true;
        savePlans();
        
        // Обновляем отображение задач если мы на этой вкладке
        if (currentTab === 'tasks') {
          render();
        }
      }
      
      // Измеряем точную ширину текста для красивого зачеркивания
      if (mealLabel) {
        try {
          // Создаем временный элемент для измерения только текста (без значков времени)
          const tempLabel = document.createElement('span');
          tempLabel.style.cssText = `
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: ${window.getComputedStyle(mealLabel).fontFamily};
            font-size: ${window.getComputedStyle(mealLabel).fontSize};
            font-weight: ${window.getComputedStyle(mealLabel).fontWeight};
          `;
          
          // Получаем только текст без HTML тегов
          const labelTextOnly = mealLabel.textContent.replace(/\s*\d{2}:\d{2}\s*$/, '').trim();
          tempLabel.textContent = labelTextOnly;
          
          document.body.appendChild(tempLabel);
          const labelWidth = tempLabel.offsetWidth;
          document.body.removeChild(tempLabel);
          
          mealLabel.style.setProperty('--text-width', labelWidth + 'px');
        } catch (e) {
          console.log('Ошибка при измерении ширины метки:', e);
        }
      }
      
      if (mealContent) {
        try {
          // Создаем временный элемент для измерения текста контента
          const tempContent = document.createElement('span');
          tempContent.style.cssText = `
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: ${window.getComputedStyle(mealContent).fontFamily};
            font-size: ${window.getComputedStyle(mealContent).fontSize};
            font-weight: ${window.getComputedStyle(mealContent).fontWeight};
          `;
          tempContent.textContent = mealContent.textContent;
          
          document.body.appendChild(tempContent);
          const contentWidth = tempContent.offsetWidth;
          document.body.removeChild(tempContent);
          
          mealContent.style.setProperty('--text-width', contentWidth + 'px');
        } catch (e) {
          console.log('Ошибка при измерении ширины контента:', e);
        }
      }
      
      // Через небольшую задержку добавляем анимацию зачеркивания
      setTimeout(() => {
        mealElement.classList.add('completed');
        
        // Добавляем небольшую вибрацию для тактильной обратной связи
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      }, 150);
    } else {
      // Убираем выполнение - мгновенно
      mealData.completed = false;
      mealElement.classList.remove('completed');
      checkbox.classList.remove('checked');
      
      // 📋 РЕФАКТОРИНГ: СИНХРОНИЗАЦИЯ С ЗАДАЧАМИ через новую систему источников
      const relatedTask = plans.find(plan => 
        plan.source && 
        plan.source.type === 'meal' && 
        plan.source.mealId === mealTypeId && 
        plan.date === dateStr
      );
      
      if (relatedTask) {
        console.log('Убираем выполнение связанной задачи:', relatedTask.title);
        relatedTask.completed = false;
        savePlans();
        
        // Обновляем отображение задач если мы на этой вкладке
        if (currentTab === 'tasks') {
          render();
        }
      }
    }
    
    saveNutritionData();
  } catch (e) {
    console.error('Ошибка при переключении состояния приема пищи:', e);
  }
}

function showHabitsTab() {
  const content = document.querySelector('.content');
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px 20px; text-align: center;">
      <div style="font-size: 48px; margin-bottom: 20px;">🎯</div>
      <h2 style="color: var(--text-primary); margin-bottom: 12px; font-size: 24px;">Привычки</h2>
      <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5;">Трекинг привычек и целей скоро будет доступен</p>
      <div style="background: var(--bg-card); padding: 16px; border-radius: 12px; border: 1px solid var(--border-primary);">
        <p style="color: var(--text-muted); font-size: 14px;">🚀 В разработке</p>
      </div>
    </div>
  `;
}

// INIT

// INIT

// SPLASH SCREEN - ПРИВЕТСТВЕННЫЙ ЭКРАН
function initSplashScreen() {
  const splashScreen = document.getElementById('splashScreen');
  const splashGreeting = document.getElementById('splashGreeting');
  const splashSubtitle = document.getElementById('splashSubtitle');
  const mainApp = document.getElementById('mainApp');
  
  if (!splashScreen || !splashGreeting || !splashSubtitle || !mainApp) {
    console.warn('⚠️ Элементы splash экрана не найдены');
    return;
  }
  
  // Получаем персонализированное приветствие
  const greeting = getPersonalizedGreeting();
  splashGreeting.textContent = greeting.main;
  splashSubtitle.textContent = greeting.subtitle;
  
  // Показываем splash экран
  splashScreen.style.display = 'flex';
  mainApp.classList.add('splash-loading');
}

function getPersonalizedGreeting() {
  const now = new Date();
  const dayOfWeek = now.getDay(); // 0 = воскресенье, 1 = понедельник, и т.д.
  const hour = now.getHours();
  
  // Получаем имя пользователя из профиля (если есть)
  const userName = localStorage.getItem('planner_userName') || '';
  const namePrefix = userName ? `${userName}, ` : '';
  
  // Массивы спокойных фраз для разных ситуаций
  const sundayGreetings = [
    'Воскресенье — день для планирования',
    'Сегодня готовим планы на неделю',
    'Время подумать о предстоящих днях'
  ];
  
  const weekdayGreetings = [
    'Сегодня просто идём по течению',
    'План готов. Можно жить',
    'Хороший день, чтобы не спешить',
    'Всё уже разложено',
    'Спокойно движемся по списку',
    'День за днём, шаг за шагом'
  ];
  
  const morningSubtitles = [
    'Доброе утро',
    'Новый день начинается',
    'Утро — время возможностей'
  ];
  
  const daySubtitles = [
    'Продолжаем день',
    'Всё идёт по плану',
    'Движемся дальше'
  ];
  
  const eveningSubtitles = [
    'Завершаем день',
    'Подводим итоги',
    'Готовимся к отдыху'
  ];
  
  // Выбираем основное приветствие
  let mainGreeting;
  if (dayOfWeek === 0) { // Воскресенье
    mainGreeting = sundayGreetings[Math.floor(Math.random() * sundayGreetings.length)];
  } else {
    mainGreeting = weekdayGreetings[Math.floor(Math.random() * weekdayGreetings.length)];
  }
  
  // Выбираем подзаголовок в зависимости от времени
  let subtitle;
  if (hour < 12) {
    subtitle = morningSubtitles[Math.floor(Math.random() * morningSubtitles.length)];
  } else if (hour < 18) {
    subtitle = daySubtitles[Math.floor(Math.random() * daySubtitles.length)];
  } else {
    subtitle = eveningSubtitles[Math.floor(Math.random() * eveningSubtitles.length)];
  }
  
  return {
    main: namePrefix + mainGreeting,
    subtitle: subtitle
  };
}

function hideSplashScreen() {
  const splashScreen = document.getElementById('splashScreen');
  const mainApp = document.getElementById('mainApp');
  
  if (!splashScreen || !mainApp) {
    return;
  }
  
  // Плавно скрываем splash экран
  splashScreen.classList.add('fade-out');
  mainApp.classList.remove('splash-loading');
  
  // Полностью убираем splash экран после анимации
  setTimeout(() => {
    splashScreen.style.display = 'none';
  }, 800);
}

// УЛУЧШЕННАЯ ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('🚀 Начинаем инициализацию Планера v6.28');
    
    // Показываем splash экран сразу
    initSplashScreen();
    
    // Проверяем доступность основных элементов DOM
    const requiredElements = [
      'dayTitle', 'daySubtitle', 'progressContainer', 
      'progressCircle', 'progressPercentage', 'bottomNav'
    ];
    
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
      console.error('❌ Отсутствуют критически важные элементы DOM:', missingElements);
      showPopup('Ошибка загрузки', 'Приложение загружено не полностью. Попробуйте перезагрузить страницу.', [
        { text: 'Перезагрузить', type: 'confirm', action: () => window.location.reload() }
      ]);
      return;
    }
    
    // КРИТИЧЕСКИ ВАЖНО: Сначала инициализируем иконки
    initializeIcons();
    
    // КРИТИЧЕСКИ ВАЖНО: Загружаем данные
    loadData();
    
    // РЕФАКТОРИНГ: Загружаем данные об удаленных задачах через новую систему
    loadDeletedTasks();
    
    // РЕФАКТОРИНГ: Выполняем миграцию старых данных об удаленных задачах
    migrateDeletedTasks();
    
    // РЕФАКТОРИНГ: Очищаем старые ключи localStorage после миграции
    cleanupOldStorageKeys();
    
    // РЕФАКТОРИНГ: Инициализируем систему разделов с автоматической синхронизацией
    initSectionsSync();
    
    // Загружаем данные профиля
    loadProfileData();
    
    // Устанавливаем начальное состояние
    currentTab = 'tasks';
    currentModal = null;
    
    // Устанавливаем активную вкладку в навигации
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => item.classList.remove('active'));
    
    const tasksTab = document.querySelector('[data-tab="tasks"]');
    if (tasksTab) {
      tasksTab.classList.add('active');
    } else {
      console.warn('⚠️ Вкладка задач не найдена в навигации');
    }
    
    // Инициализируем прогресс-бар
    const progressCircle = document.getElementById('progressCircle');
    if (progressCircle) {
      progressCircle.dataset.currentAngle = '0';
    }
    
    // Проверяем состояние приложения
    console.log('📊 Состояние приложения:');
    console.log(`  - Текущая дата: ${currentDate.toISOString().split('T')[0]}`);
    console.log(`  - Планов на сегодня: ${getPlansForDate(currentDate).length}`);
    console.log(`  - Всего разделов: ${rooms.length}`);
    console.log(`  - Текущая вкладка: ${currentTab}`);
    
    // Рендерим интерфейс с задержкой для стабильности
    setTimeout(() => {
      console.log('🎨 Начинаем рендеринг интерфейса');
      
      try {
        render();
        
        // Показываем приложение с плавной анимацией
        const app = document.querySelector('.app');
        if (app) {
          app.style.opacity = '0';
          app.style.transform = 'translateY(20px)';
          
          setTimeout(() => {
            app.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            app.style.opacity = '1';
            app.style.transform = 'translateY(0)';
          }, 100);
        }
        
        console.log('🎉 Инициализация завершена успешно!');
        
        // Скрываем splash экран после завершения инициализации
        setTimeout(() => {
          hideSplashScreen();
        }, 200);
        
      } catch (renderError) {
        console.error('❌ Ошибка при рендеринге:', renderError);
        showPopup('Ошибка отображения', 'Не удалось отобразить интерфейс. Попробуйте перезагрузить приложение.', [
          { text: 'Перезагрузить', type: 'confirm', action: () => window.location.reload() }
        ]);
      }
    }, 150);
    
  } catch (error) {
    console.error('❌ Критическая ошибка при инициализации:', error);
    
    // Скрываем splash экран даже при ошибке
    hideSplashScreen();
    
    // Показываем пользователю сообщение об ошибке
    const errorMessage = `
      <div style="text-align: center; padding: 40px 20px;">
        <h2 style="color: #ef4444; margin-bottom: 16px;">Ошибка загрузки</h2>
        <p style="color: #6b7280; margin-bottom: 24px;">Не удалось загрузить приложение</p>
        <button onclick="window.location.reload()" style="
          background: #ef4444; 
          color: white; 
          border: none; 
          padding: 12px 24px; 
          border-radius: 8px; 
          cursor: pointer;
        ">Перезагрузить</button>
      </div>
    `;
    
    document.body.innerHTML = errorMessage;
  }
  
  // Добавляем CSS для улучшенных анимаций
  const enhancedAnimationsStyle = document.createElement('style');
  enhancedAnimationsStyle.textContent = `
    /* Улучшенные анимации для кнопок */
    .btn.loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Плавные переходы для всех интерактивных элементов */
    button, .nav-item, .plan, .meal {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Улучшенные состояния наведения */
    button:hover:not(:disabled) {
      transform: translateY(-1px);
    }
    
    button:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
    }
    
    /* Анимации для модальных окон */
    .modal.show {
      animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(50px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
  `;
  document.head.appendChild(enhancedAnimationsStyle);
  
  console.log('🚀 Планер v6.28 - Улучшенная навигация и UX загружен');
});
</script>
</body>
</html>