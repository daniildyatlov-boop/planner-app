<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="cache-buster" content="<?php echo time(); ?>">
<meta name="version" content="v6.28.0-STRIKETHROUGH-DELETE-FIX">
<title>Планер v6.28 STRIKETHROUGH DELETE FIX</title>
<script src="https://telegram.org/js/telegram-web-app.js?v=7"></script>
<style>
/* RESET & BASE */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;position:fixed;width:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  color:var(--text-primary);
  line-height:1.4;
  overflow:hidden;
}

/* SMOOTH ANIMATIONS SYSTEM */
* {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ENHANCED ANIMATIONS SYSTEM - УЛУЧШЕННАЯ СИСТЕМА АНИМАЦИЙ */
@keyframes slideInFromBottom {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes slideOutToBottom {
  from {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  to {
    opacity: 0;
    transform: translateY(50px) scale(0.95);
  }
}

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3) rotate(-5deg);
  }
  50% {
    opacity: 1;
    transform: scale(1.05) rotate(2deg);
  }
  70% {
    transform: scale(0.95) rotate(-1deg);
  }
  100% {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }
}

@keyframes floatIn {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200px 0;
  }
  100% {
    background-position: calc(200px + 100%) 0;
  }
}

@keyframes slideInFromRight {
  from {
    opacity: 0;
    transform: translateX(30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInFromLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Улучшенные анимации для элементов */
.animate-in {
  animation: floatIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.animate-bounce {
  animation: bounceIn 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55) both;
}

.animate-slide-right {
  animation: slideInFromRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.animate-slide-left {
  animation: slideInFromLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.animate-scale {
  animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) both;
}

/* Классы для плавных переходов */
.ease-bounce { transition-timing-function: cubic-bezier(0.68, -0.55, 0.265, 1.55); }
.ease-smooth { transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
.ease-swift { transition-timing-function: cubic-bezier(0.55, 0, 0.1, 1); }
.ease-gentle { transition-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94); }

/* Микро-анимации для интерактивности */
@keyframes gentle-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

@keyframes soft-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(74, 222, 128, 0.3); }
  50% { box-shadow: 0 0 30px rgba(74, 222, 128, 0.5); }
}

@keyframes fade-in-up {
  from { 
    opacity: 0; 
    transform: translateY(20px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

@keyframes scale-in {
  from { 
    opacity: 0; 
    transform: scale(0.9); 
  }
  to { 
    opacity: 1; 
    transform: scale(1); 
  }
}

/* DESIGN SYSTEM - ADAPTIVE THEME SYSTEM */
:root {
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 20px;
  --spacing-2xl: 24px;
  --spacing-3xl: 32px;
  --border-radius: 16px;
  --border-radius-sm: 12px;
  --border-radius-lg: 20px;
  
  /* Акцентные цвета - одинаковые для обеих тем */
  --accent-primary: #4ade80;
  --accent-secondary: #22c55e;
  --accent-soft: #16a34a;
  --accent-water: #06b6d4;
  --accent-warm: #f59e0b;
  --accent-danger: #ef4444;
}

/* СВЕТЛАЯ ТЕМА (по умолчанию) */
:root {
  --bg-primary: #f8faf8;
  --bg-secondary: #f1f5f1;
  --bg-tertiary: #e8f0e8;
  --bg-card: rgba(255, 255, 255, 0.9);
  --bg-card-hover: rgba(255, 255, 255, 0.95);
  --bg-modal: rgba(255, 255, 255, 0.95);
  
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --text-inverse: #ffffff;
  
  --border-primary: rgba(34, 197, 94, 0.2);
  --border-secondary: rgba(34, 197, 94, 0.1);
  --border-soft: rgba(107, 114, 128, 0.15);
  
  --shadow-soft: 0 4px 20px rgba(34, 197, 94, 0.1);
  --shadow-medium: 0 8px 32px rgba(34, 197, 94, 0.15);
  --shadow-strong: 0 12px 48px rgba(34, 197, 94, 0.2);
  --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.08);
  
  --overlay-bg: rgba(0, 0, 0, 0.4);
}

/* ТЕМНАЯ ТЕМА - автоматическое переключение */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #0f1419;
    --bg-secondary: #1a1f2e;
    --bg-tertiary: #252a3a;
    --bg-card: rgba(26, 31, 46, 0.9);
    --bg-card-hover: rgba(37, 42, 58, 0.95);
    --bg-modal: rgba(15, 20, 25, 0.95);
    
    --text-primary: #f8fafc;
    --text-secondary: #cbd5e1;
    --text-muted: #94a3b8;
    --text-inverse: #1f2937;
    
    --border-primary: rgba(74, 222, 128, 0.3);
    --border-secondary: rgba(74, 222, 128, 0.15);
    --border-soft: rgba(148, 163, 184, 0.2);
    
    --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.3);
    --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.4);
    --shadow-strong: 0 12px 48px rgba(0, 0, 0, 0.5);
    --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.2);
    
    --overlay-bg: rgba(0, 0, 0, 0.7);
  }
}

/* APP LAYOUT */
.app{
  height:100vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  animation: fade-in-up 0.6s ease-smooth;
  padding-bottom: 80px; /* Отступ для нижней навигации */
}
.header{
  padding:var(--spacing-lg) var(--spacing-xl);
  background: var(--bg-modal);
  backdrop-filter: blur(20px);
  display:flex;
  align-items:center;
  justify-content:space-between;
  position:relative;
  height:72px;
  flex-shrink:0;
  border-bottom:1px solid var(--border-soft);
  box-shadow: var(--shadow-soft);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.content{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* HEADER ELEMENTS */
.profile-btn{
  width:44px;
  height:44px;
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  border:none;
  border-radius:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:var(--spacing-lg);
  font-weight:600;
  cursor:pointer;
  flex-shrink:0;
  box-shadow:var(--shadow-soft);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0); /* GPU acceleration */
}
.profile-btn:hover{
  animation: gentle-pulse 2s infinite;
}
.profile-btn:active{
  opacity:0.8;
  transform:scale(0.92);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.date-nav{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  align-items:center;
  background:var(--bg-card);
  backdrop-filter: blur(20px);
  border-radius:var(--spacing-lg);
  padding:var(--spacing-xs);
  box-shadow:var(--shadow-soft);
  height:var(--spacing-3xl);
  gap:var(--spacing-xs);
  border:1px solid var(--border-soft);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.date-nav:hover{
  transform:translateX(-50%) translateY(-1px);
  box-shadow:var(--shadow-medium);
}
.nav-arrow{
  background:none;
  border:none;
  font-size:14px;
  color:var(--accent-primary);
  cursor:pointer;
  width:var(--spacing-2xl);
  height:var(--spacing-2xl);
  border-radius:var(--spacing-md);
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.nav-arrow:active{
  opacity:0.6;
  background:rgba(74, 222, 128, 0.2);
  transform:scale(0.9);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.date-content{
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:pointer;
  padding:0 var(--spacing-sm);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.date-content:active{
  transform: scale(0.95);
}
.date-title{
  font-size: 15px; /* Увеличено с var(--spacing-md) */
  font-weight: 700; /* Увеличен вес шрифта */
  color: var(--text-primary);
  line-height: 1.2; /* Улучшена высота строки */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.3px; /* Добавлено расстояние между буквами */
}
.date-subtitle{
  font-size: 11px; /* Увеличено с 10px */
  color: var(--text-secondary);
  line-height: 1.2; /* Улучшена высота строки */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  font-weight: 500; /* Добавлен вес шрифта */
  letter-spacing: 0.2px; /* Добавлено расстояние между буквами */
}

.rooms-btn{
  width:44px;
  height:44px;
  background:var(--bg-card);
  backdrop-filter: blur(20px);
  border:1px solid var(--border-soft);
  border-radius:22px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:var(--shadow-soft);
  font-size:var(--spacing-lg);
  flex-shrink:0;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.rooms-btn:hover{
  transform: translateY(-1px);
  box-shadow:var(--shadow-medium);
}
.rooms-btn:active{
  opacity:0.8;
  transform:scale(0.92);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* PROGRESS BAR */
.progress-container{
  margin:var(--spacing-xl) var(--spacing-xl) var(--spacing-2xl);
  flex-shrink:0;
  animation: fade-in-up 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
  background: linear-gradient(135deg, 
    rgba(74, 222, 128, 0.1) 0%, 
    rgba(34, 197, 94, 0.1) 50%,
    rgba(22, 163, 74, 0.1) 100%);
  backdrop-filter: blur(30px);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-2xl);
  border: 1px solid var(--border-primary);
  box-shadow: var(--shadow-medium);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.progress-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(99, 102, 241, 0.1), 
    transparent);
  animation: progress-shimmer 4s infinite;
}
@keyframes progress-shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

.progress-info{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:var(--spacing-xl);
  position: relative;
  z-index: 1;
  width: 100%;
}
.progress-label{
  font-size: 18px; /* Увеличено с 16px */
  color: var(--text-primary);
  font-weight: 800; /* Увеличен вес шрифта */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);
  letter-spacing: 0.5px;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
}
.progress-stats{
  font-size: 20px; /* Увеличено с 18px */
  color: var(--accent-primary);
  font-weight: 900; /* Увеличен вес шрифта */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 0 16px rgba(34, 197, 94, 0.3);
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.3px; /* Добавлено расстояние между буквами */
}

/* КРУГЛЫЙ ПРОГРЕСС-БАР */
.progress-circle-container {
  position: relative;
  width: 120px;
  height: 120px;
  z-index: 1;
}
.progress-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: conic-gradient(
    from 0deg,
    rgba(0, 0, 0, 0.2) 0deg
  );
  padding: 6px;
  box-shadow: 
    0 8px 32px rgba(99, 102, 241, 0.3),
    0 0 0 2px rgba(99, 102, 241, 0.2) inset;
  position: relative;
  overflow: hidden;
}
.progress-circle-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  z-index: 2;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.5) inset;
}
.progress-percentage {
  font-size: 28px; /* Увеличено с 24px */
  font-weight: 900; /* Увеличен вес шрифта */
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
  transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.5px; /* Добавлено расстояние между буквами */
}

/* АНИМАЦИЯ ЗАВЕРШЕНИЯ */
.progress-container.completed {
  animation: celebration-pulse 2s infinite ease-in-out;
}
.progress-circle.completed {
  background: conic-gradient(
    from 0deg,
    var(--accent-primary) 0deg,
    var(--accent-secondary) 120deg,
    var(--accent-soft) 240deg,
    var(--accent-primary) 360deg
  ) !important;
  box-shadow: 
    0 16px 48px rgba(99, 102, 241, 0.5),
    0 0 0 4px rgba(99, 102, 241, 0.3) inset,
    0 0 32px rgba(99, 102, 241, 0.4);
  animation: completion-glow 3s infinite ease-in-out;
}
.progress-circle.completed::before {
  transform: scale(1);
  opacity: 0.3;
  animation: completion-shimmer 2s infinite ease-in-out;
}
.progress-percentage.completed {
  color: var(--accent-primary);
  text-shadow: 0 0 16px rgba(99, 102, 241, 0.6);
  animation: completion-text 2s infinite ease-in-out;
}

@keyframes celebration-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}
@keyframes completion-glow {
  0%, 100% { 
    box-shadow: 
      0 16px 48px rgba(99, 102, 241, 0.5),
      0 0 0 4px rgba(99, 102, 241, 0.3) inset,
      0 0 32px rgba(99, 102, 241, 0.4);
  }
  50% { 
    box-shadow: 
      0 20px 60px rgba(99, 102, 241, 0.7),
      0 0 0 6px rgba(99, 102, 241, 0.5) inset,
      0 0 48px rgba(99, 102, 241, 0.6);
  }
}
@keyframes completion-shimmer {
  0%, 100% { 
    transform: scale(0.8);
    opacity: 0.1;
  }
  50% { 
    transform: scale(1.1);
    opacity: 0.4;
  }
}
@keyframes completion-text {
  0%, 100% { 
    transform: scale(1);
    text-shadow: 0 0 16px rgba(99, 102, 241, 0.6);
  }
  50% { 
    transform: scale(1.05);
    text-shadow: 0 0 24px rgba(99, 102, 241, 0.8);
  }
}

/* EMPTY STATE */
.empty{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:40px var(--spacing-xl);
  flex:1;
  animation: fade-in-up 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
}
.empty h2{
  font-size:18px;
  font-weight:600;
  margin-bottom:var(--spacing-sm);
  color:#ffffff;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 2px 8px rgba(255,255,255,0.1);
}
.empty p{
  font-size:15px;
  color:#8e8e93;
  margin-bottom:var(--spacing-2xl);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* BUTTONS */
.btn{
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color:white;
  border:none;
  border-radius:var(--border-radius);
  padding:var(--spacing-md) var(--spacing-2xl);
  font-size:var(--spacing-lg);
  font-weight:600;
  cursor:pointer;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:var(--shadow-medium);
  transform: translateZ(0);
  position: relative;
  overflow: hidden;
}
.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.btn:hover::before {
  left: 100%;
}
.btn:hover{
  transform: translateY(-4px) scale(1.02);
  box-shadow:0 16px 48px rgba(99,102,241,0.4);
  animation: gentle-pulse 2s infinite;
}
.btn:active{
  opacity:0.9;
  transform:scale(0.96) translateY(-2px);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.header-btn{
  background:none;
  border:none;
  font-size:var(--spacing-lg);
  color:#6366f1;
  cursor:pointer;
  padding:var(--spacing-sm) var(--spacing-md);
  border-radius:var(--spacing-sm);
  font-weight:500;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
  position: relative;
  overflow: hidden;
}
.header-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(99,102,241,0.1);
  border-radius: var(--spacing-sm);
  transform: scale(0);
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.header-btn:hover::before {
  transform: scale(1);
}
.header-btn:hover {
  color: #8b5cf6;
  transform: translateY(-2px) scale(1.05);
  text-shadow: 0 4px 12px rgba(99,102,241,0.4);
}
.header-btn:active{
  opacity:0.7;
  transform:scale(0.95);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.header-btn-primary{
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border:none;
  font-size:var(--spacing-lg);
  color:white;
  cursor:pointer;
  padding:var(--spacing-sm) var(--spacing-lg);
  border-radius:var(--spacing-sm);
  font-weight:600;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
  position: relative;
  overflow: hidden;
  box-shadow:0 4px 16px rgba(99,102,241,0.3);
}
.header-btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.header-btn-primary:hover::before {
  left: 100%;
}
.header-btn-primary:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow:0 8px 24px rgba(99,102,241,0.5);
}
.header-btn-primary:active{
  opacity:0.9;
  transform:scale(0.95);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* PLANS LIST */
.plans-container{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.plans{
  flex:1;
  overflow-y:auto;
  padding:0 var(--spacing-xl) var(--spacing-xl);
}
.plans::-webkit-scrollbar{display:none}

.add-task-btn{
  width: 100%;
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius);
  padding: var(--spacing-xl);
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  color: var(--accent-primary);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 4px 16px rgba(0, 0, 0, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.05) inset;
  transform: translateZ(0);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-md);
  position: relative;
  overflow: hidden;
  margin-top: var(--spacing-lg);
}
.add-task-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
  opacity: 0;
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.add-task-btn:hover {
  background: var(--bg-card-hover);
  border-color: rgba(99, 102, 241, 0.3);
  color: var(--accent-secondary);
  transform: translateY(-2px);
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.3),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
}
.add-task-btn:hover::before {
  opacity: 1;
}
.add-task-btn:active {
  opacity: 0.8;
  transform: scale(0.98);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.add-icon {
  font-size: 20px;
  font-weight: 300;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 0 8px rgba(99, 102, 241, 0.3);
}
.add-task-btn:hover .add-icon {
  transform: rotate(90deg) scale(1.1);
  text-shadow: 0 0 12px rgba(99, 102, 241, 0.5);
}

.plan{
  background: var(--bg-card);
  backdrop-filter: blur(30px);
  border: 1px solid var(--border-soft);
  border-radius: var(--border-radius);
  padding: var(--spacing-xl);
  margin: 0 var(--spacing-xl) var(--spacing-lg);
  display: flex;
  align-items: center;
  cursor: pointer;
  box-shadow: var(--shadow-soft);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  min-height: 72px;
  transform: translateZ(0);
  animation: floatIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) both;
  position: relative;
  overflow: hidden;
}
.plan::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
  opacity: 0;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.plan:nth-child(1) { animation-delay: 0.1s; }
.plan:nth-child(2) { animation-delay: 0.2s; }
.plan:nth-child(3) { animation-delay: 0.3s; }
.plan:nth-child(4) { animation-delay: 0.4s; }
.plan:nth-child(5) { animation-delay: 0.5s; }

.plan:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.3),
    0 4px 0 rgba(255, 255, 255, 0.1) inset;
  border-color: rgba(99, 102, 241, 0.4);
}
.plan:hover::before {
  opacity: 1;
}
.plan:active {
  opacity: 0.9;
  transform: scale(0.98) translateY(-3px);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.plan.completed {
  opacity: 0.7;
  transform: scale(0.98);
  background: var(--bg-secondary);
}
.plan.completed .plan-title {
  color: var(--text-muted);
  position: relative;
  text-decoration: line-through;
  text-decoration-color: var(--text-muted);
  text-decoration-thickness: 2px;
}

.checkbox{
  width: 24px;
  height: 24px;
  border: 2px solid var(--accent-primary);
  border-radius: 12px;
  margin-right: var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  transform: translateZ(0);
  background: var(--bg-tertiary);
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.3) inset,
    0 1px 0 rgba(255, 255, 255, 0.1);
}
.checkbox:hover {
  transform: scale(1.1);
  box-shadow: 
    0 0 20px rgba(99, 102, 241, 0.4),
    0 2px 8px rgba(0, 0, 0, 0.3) inset;
  border-color: var(--accent-secondary);
}
.checkbox.checked {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  border-color: var(--accent-primary);
  box-shadow: 
    0 0 20px rgba(99, 102, 241, 0.5),
    0 1px 0 rgba(255, 255, 255, 0.3) inset;
  transform: scale(1.05);
}
.checkbox.checked::after {
  content: '✓';
  color: white;
  font-size: 14px;
  font-weight: bold;
  animation: checkmark-appear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* Анимация появления галочки */
@keyframes checkmark-appear {
  0% {
    transform: scale(0) rotate(-45deg);
    opacity: 0;
  }
  50% {
    transform: scale(1.2) rotate(-22deg);
    opacity: 1;
  }
  100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

.plan-content{
  flex:1;
  display:flex;
  flex-direction:column;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.plan-title{
  font-size: 18px; /* Увеличено с 17px */
  color: var(--text-primary);
  font-weight: 600; /* Увеличен вес шрифта */
  line-height: 1.5; /* Улучшена высота строки */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); /* Уменьшена тень */
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.2px; /* Добавлено расстояние между буквами */
}
.plan-time{
  font-size: 13px; /* Увеличено с 11px */
  color: var(--accent-primary);
  background: rgba(99, 102, 241, 0.12);
  backdrop-filter: blur(10px);
  padding: 4px 10px; /* Увеличен padding */
  border-radius: 8px; /* Увеличен радиус */
  display: inline-block;
  margin-top: 6px;
  margin-right: var(--spacing-sm);
  line-height: 1.2; /* Улучшена высота строки */
  font-weight: 700; /* Увеличен вес шрифта */
  border: 1px solid rgba(99, 102, 241, 0.25);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 4px rgba(99, 102, 241, 0.15);
  transform: translateZ(0);
  letter-spacing: 0.5px; /* Увеличено расстояние между буквами */
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
}
.plan-time:hover {
  background: rgba(99, 102, 241, 0.2);
  border-color: rgba(99, 102, 241, 0.4);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  transform: translateY(-1px);
}

.plan-time-inline{
  font-size: 16px; /* Увеличено с 14px */
  color: var(--accent-primary);
  background: rgba(99, 102, 241, 0.12);
  backdrop-filter: blur(10px);
  padding: 3px 8px;
  border-radius: 6px;
  display: inline-block;
  margin-right: 10px; /* Увеличен отступ */
  line-height: 1.3; /* Улучшена высота строки */
  font-weight: 700; /* Увеличен вес шрифта */
  border: 1px solid rgba(99, 102, 241, 0.25);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 1px 3px rgba(99, 102, 241, 0.15);
  transform: translateZ(0);
  letter-spacing: 0.4px; /* Увеличено расстояние между буквами */
  vertical-align: baseline;
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
}
.plan:hover .plan-time-inline {
  background: rgba(99, 102, 241, 0.18);
  border-color: rgba(99, 102, 241, 0.35);
  box-shadow: 0 2px 6px rgba(99, 102, 241, 0.2);
}
.room{
  font-size: 14px; /* Увеличено с 13px */
  color: var(--accent-soft);
  background: rgba(168, 85, 247, 0.15);
  backdrop-filter: blur(10px);
  padding: var(--spacing-xs) var(--spacing-md);
  border-radius: 10px; /* Увеличен радиус */
  display: inline-block;
  margin-top: var(--spacing-xs);
  line-height: 1.2; /* Улучшена высота строки */
  font-weight: 700; /* Увеличен вес шрифта */
  border: 1px solid rgba(168, 85, 247, 0.3);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.2);
  transform: translateZ(0);
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; /* Четкий шрифт */
  letter-spacing: 0.3px; /* Добавлено расстояние между буквами */
}
.room:hover {
  background: rgba(168, 85, 247, 0.25);
  border-color: rgba(168, 85, 247, 0.5);
  box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
  transform: translateY(-1px);
}

/* MODALS */
.modal{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:var(--overlay-bg);
  backdrop-filter: blur(30px);
  z-index:100;
  display:none;
  flex-direction:column;
  transform:translateY(100%);
  transition:all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  height:100vh;
  overflow:hidden;
}
.modal.show{
  display:flex;
  transform:translateY(0);
  animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}
.modal.show .modal-content{
  animation: floatIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

.modal-header{
  padding:var(--spacing-lg) var(--spacing-xl);
  background:var(--bg-modal);
  backdrop-filter: blur(30px);
  border-bottom:1px solid var(--border-soft);
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-shrink:0;
  box-shadow: var(--shadow-soft);
  position: relative;
  overflow: hidden;
}
.modal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: -200px;
  width: 200px;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(99,102,241,0.1), transparent);
  animation: shimmer 3s infinite;
}
.modal-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:var(--text-primary);
  text-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.modal-content{
  flex:1;
  overflow-y:auto;
  padding:var(--spacing-xl);
  background: var(--bg-primary);
}
.modal-content::-webkit-scrollbar{display:none}

/* FORMS */
.form-group{
  margin-bottom:var(--spacing-xl);
  animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}
.form-group:nth-child(1) { animation-delay: 0.1s; }
.form-group:nth-child(2) { animation-delay: 0.15s; }
.form-group:nth-child(3) { animation-delay: 0.2s; }

.label{
  font-size:var(--spacing-md);
  color:#8e8e93;
  text-transform:uppercase;
  letter-spacing:0.5px;
  font-weight:600;
  margin-bottom:var(--spacing-xs);
  display:block;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* УЛУЧШЕННЫЕ ПОЛЯ ВВОДА - ИСПРАВЛЯЕМ ПРОБЛЕМЫ С КУРСОРОМ */
.input,.select{
  width:100%;
  background:var(--bg-card);
  backdrop-filter: blur(20px);
  border:1px solid var(--border-soft);
  border-radius:12px;
  padding:16px;
  font-size:16px;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  color:var(--text-primary);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: var(--shadow-card);
  /* КРИТИЧЕСКИ ВАЖНО ДЛЯ СТАБИЛЬНОСТИ КУРСОРА */
  line-height: 1.4;
  height: 52px;
  box-sizing: border-box;
  vertical-align: baseline;
  text-align: left;
  caret-color: var(--accent-primary);
  /* Убираем любые трансформации в покое */
  transform: none;
  /* Стабилизируем позиционирование */
  position: relative;
  z-index: 1;
}

/* СПЕЦИАЛЬНЫЕ СТИЛИ ДЛЯ РАЗНЫХ ТИПОВ ПОЛЕЙ */
.input[type="text"], .input[type="email"], .input[type="password"] {
  /* Стандартные текстовые поля */
  -webkit-appearance: none;
  appearance: none;
}

.input[type="date"]{
  /* Поле даты - убираем браузерные стили */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  cursor: pointer;
  /* Принудительно задаем высоту */
  height: 52px !important;
  line-height: 1.4 !important;
  padding: 16px !important;
  /* Убираем стандартные иконки */
  background-image: none;
}
.input[type="date"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  position: absolute;
  right: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}
.input[type="date"]::-webkit-inner-spin-button,
.input[type="date"]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.input[type="time"]{
  /* Поле времени */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  cursor: pointer;
  height: 52px !important;
  line-height: 1.4 !important;
  padding: 16px !important;
}
.input[type="time"]::-webkit-calendar-picker-indicator {
  opacity: 0;
  position: absolute;
  right: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.input[type="number"]{
  /* Числовые поля */
  -webkit-appearance: none;
  -moz-appearance: textfield;
  appearance: none;
  text-align: left;
}
.input[type="number"]::-webkit-outer-spin-button,
.input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* СОСТОЯНИЯ ПОЛЕЙ - УБИРАЕМ АГРЕССИВНЫЕ ТРАНСФОРМАЦИИ */
.input:focus,.select:focus{
  outline:none;
  border-color:var(--accent-primary);
  box-shadow:0 0 0 3px rgba(74, 222, 128, 0.2), var(--shadow-medium);
  background:var(--bg-card-hover);
  /* Убираем трансформации при фокусе - они вызывают дерганье курсора */
  transform: none;
}
.input:hover:not(:focus),.select:hover:not(:focus){
  border-color:rgba(99,102,241,0.4);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  /* Минимальная трансформация только при ховере без фокуса */
  transform: translateY(-1px);
}
.input::placeholder{
  color:var(--text-muted);
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.input:focus::placeholder{
  opacity: 0.5;
}

/* TEXTAREA - СПЕЦИАЛЬНЫЕ СТИЛИ */
textarea.input {
  height: auto;
  min-height: 80px;
  resize: vertical;
  line-height: 1.5;
  padding: 16px;
}

.select-wrapper{
  position:relative;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.select{
  appearance:none;
  cursor:pointer;
}
.select-wrapper::after{
  content:'›';
  position:absolute;
  right:var(--spacing-md);
  top:50%;
  transform:translateY(-50%) rotate(90deg);
  color:#6b7280;
  font-size:var(--spacing-lg);
  pointer-events:none;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.select:focus + .select-wrapper::after,
.select-wrapper:hover::after {
  color: #6366f1;
  transform:translateY(-50%) rotate(90deg) scale(1.1);
}

/* CALENDAR */
.calendar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  z-index:200;
  display:none;
  align-items:center;
  justify-content:center;
  opacity:0;
  transition:opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar.show{
  display:flex;
  opacity:1;
}
.calendar-content{
  background:rgba(28,28,30,0.95);
  backdrop-filter: blur(40px);
  border:1px solid rgba(44,44,46,0.6);
  border-radius:var(--border-radius);
  padding:var(--spacing-xl);
  margin:var(--spacing-xl);
  max-width:300px;
  width:100%;
  box-shadow:0 16px 64px rgba(0,0,0,0.4);
  transform: scale(0.9);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar.show .calendar-content{
  transform: scale(1);
  animation: scale-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.calendar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:var(--spacing-lg);
}
.calendar-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:#ffffff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar-nav{
  background:rgba(99,102,241,0.1);
  backdrop-filter: blur(10px);
  border:1px solid rgba(99,102,241,0.2);
  font-size:18px;
  color:#6366f1;
  cursor:pointer;
  width:var(--spacing-3xl);
  height:var(--spacing-3xl);
  border-radius:var(--spacing-lg);
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.calendar-nav:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(99,102,241,0.3);
}
.calendar-nav:active{
  opacity:0.7;
  transform:scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.weekdays{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:var(--spacing-xs);
  margin-bottom:var(--spacing-sm);
}
.weekday{
  font-size:var(--spacing-md);
  color:#8e8e93;
  text-align:center;
  padding:var(--spacing-xs);
  font-weight:500;
}

.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:var(--spacing-xs);
}
.calendar-day{
  background:rgba(44,44,46,0.3);
  backdrop-filter: blur(10px);
  border:1px solid rgba(44,44,46,0.4);
  padding:var(--spacing-sm);
  font-size:14px;
  cursor:pointer;
  border-radius:var(--spacing-xs);
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:var(--spacing-3xl);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color:#ffffff;
  transform: translateZ(0);
  font-weight: 500;
}
.calendar-day:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(99,102,241,0.2);
}
.calendar-day:active{
  transform:scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.calendar-day.today{
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  color:white;
  box-shadow:0 4px 16px rgba(99,102,241,0.4);
  border-color: transparent;
  font-weight: 600;
  animation: soft-glow 3s infinite;
}
.calendar-day.selected{
  background:linear-gradient(135deg, #8b5cf6, #a855f7);
  color:white;
  box-shadow:0 4px 16px rgba(139,92,246,0.4);
  border-color: transparent;
  font-weight: 600;
}
.calendar-day.other-month{
  color:#6b7280;
  opacity: 0.5;
}

/* EDIT PLAN SCREEN */
.edit-plan-input{
  font-size:18px;
  font-weight:500;
  background:#2c2c2e;
  border:none;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  color:#ffffff;
  margin-bottom:var(--spacing-xl);
}
.edit-plan-input:focus{
  outline:none;
  background:#3c3c3e;
}

.form-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#2c2c2e;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  cursor:pointer;
  transition:all 0.2s ease;
}
.form-row:active{
  background:#3c3c3e;
}
.form-row span{
  color:#ffffff;
  font-size:var(--spacing-lg);
}

.toggle{
  width:50px;
  height:30px;
  background:#3c3c3e;
  border-radius:15px;
  position:relative;
  cursor:pointer;
  transition:all 0.3s ease;
}
.toggle.active{
  background:#6366f1;
}
.toggle-slider{
  width:26px;
  height:26px;
  background:#ffffff;
  border-radius:13px;
  position:absolute;
  top:2px;
  left:2px;
  transition:all 0.3s ease;
  box-shadow:0 2px 4px rgba(0,0,0,0.2);
}
.toggle.active .toggle-slider{
  transform:translateX(20px);
}

.premium-notice{
  display:flex;
  align-items:center;
  background:#2c2c2e;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  margin:var(--spacing-xl) 0;
  font-size:var(--spacing-md);
  color:#8e8e93;
  line-height:1.4;
}
.premium-icon{
  font-size:var(--spacing-lg);
  margin-right:var(--spacing-sm);
  flex-shrink:0;
}
.premium-link{
  color:#6366f1;
  font-weight:500;
}

.delete-btn{
  width:100%;
  background:none;
  border:none;
  color:#ef4444;
  font-size:var(--spacing-lg);
  font-weight:500;
  padding:var(--spacing-lg);
  text-align:center;
  cursor:pointer;
  border-radius:var(--spacing-md);
  transition:all 0.2s ease;
  margin-top:var(--spacing-xl);
}
.delete-btn:active{
  background:rgba(239,68,68,0.1);
}

.screen-footer{
  padding:var(--spacing-lg) var(--spacing-xl) var(--spacing-3xl);
  background:#0a0a0a;
  border-top:1px solid #2c2c2e;
}
.save-btn{
  width:100%;
  background:#6366f1;
  color:white;
  border:none;
  border-radius:var(--spacing-md);
  padding:var(--spacing-lg);
  font-size:var(--spacing-lg);
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
}
.save-btn:active{
  opacity:0.8;
  transform:scale(0.98);
}

/* SIMPLE MENU */
.overlay{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter: blur(20px);
  z-index:150;
  display:none;
  opacity:0;
  transition:opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  align-items:center;
  justify-content:center;
}
.overlay.show{
  display:flex;
  opacity:1;
}
.menu{
  background:rgba(28,28,30,0.95);
  backdrop-filter: blur(40px);
  border:1px solid rgba(44,44,46,0.6);
  border-radius:var(--border-radius);
  min-width:250px;
  box-shadow:0 16px 64px rgba(0,0,0,0.4);
  overflow:hidden;
  transform: scale(0.9);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.overlay.show .menu{
  transform: scale(1);
  animation: scale-in 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.menu-btn{
  width:100%;
  background:none;
  border:none;
  padding:var(--spacing-lg) var(--spacing-xl);
  font-size:var(--spacing-lg);
  text-align:center;
  cursor:pointer;
  color:#6366f1;
  font-weight:500;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}
.menu-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: rgba(99,102,241,0.1);
  transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.menu-btn:hover::before {
  left: 0;
}
.menu-btn:not(:last-child){
  border-bottom:1px solid rgba(44,44,46,0.6);
}
.menu-btn:hover{
  color: #8b5cf6;
  text-shadow: 0 0 8px rgba(99,102,241,0.3);
}
.menu-btn:active{
  transform:scale(0.95);
  opacity: 0.7;
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.menu-btn.del{
  color:#ef4444;
}
.menu-btn.del:hover{
  color:#f87171;
  text-shadow: 0 0 8px rgba(239,68,68,0.3);
}



/* NUTRITION CONTAINER - НОВАЯ СТРУКТУРА ДЛЯ ПРАВИЛЬНОГО СКРОЛЛА */
.nutrition-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
}

.meals-scroll-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding-top: var(--spacing-xl); /* Добавляем отступ сверху */
}

.meals-scroll-container::-webkit-scrollbar {
  display: none;
}

/* NUTRITION STYLES - УЛУЧШЕННЫЕ СТИЛИ ПИТАНИЯ */
.water-tracker{
  background: linear-gradient(135deg, 
    rgba(6, 182, 212, 0.1) 0%, 
    rgba(14, 165, 233, 0.1) 50%,
    rgba(59, 130, 246, 0.1) 100%);
  backdrop-filter: blur(30px);
  border: 1px solid rgba(6, 182, 212, 0.2);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xl);
  margin: var(--spacing-xl);
  margin-bottom: var(--spacing-xl); /* Восстанавливаем нижний отступ для разделения */
  box-shadow: var(--shadow-medium);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  animation: slideInFromRight 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
  flex-shrink: 0; /* Не сжимается при нехватке места */
}
.water-tracker::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(6, 182, 212, 0.1), 
    transparent);
  animation: water-shimmer-bg 4s infinite;
}
@keyframes water-shimmer-bg {
  0% { left: -100%; }
  100% { left: 100%; }
}
.water-tracker.completed{
  border-color: rgba(34, 197, 94, 0.4);
  background: linear-gradient(135deg, 
    rgba(34, 197, 94, 0.1) 0%, 
    rgba(16, 185, 129, 0.1) 50%,
    rgba(5, 150, 105, 0.1) 100%);
  box-shadow: 
    0 12px 40px rgba(34, 197, 94, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.05) inset;
  animation: water-completion-glow 2s infinite ease-in-out;
}
@keyframes water-completion-glow {
  0%, 100% { 
    box-shadow: 
      0 12px 40px rgba(34, 197, 94, 0.2),
      0 1px 0 rgba(255, 255, 255, 0.05) inset;
  }
  50% { 
    box-shadow: 
      0 16px 50px rgba(34, 197, 94, 0.3),
      0 1px 0 rgba(255, 255, 255, 0.1) inset;
  }
}

.water-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--spacing-xl);
  position: relative;
  z-index: 2;
}
.water-info{
  flex: 1;
}
.water-label{
  font-size: 18px;
  color: var(--text-primary);
  font-weight: 700;
  margin-bottom: 6px;
  text-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
  letter-spacing: 0.3px;
}
.water-stats{
  font-size: 15px;
  color: var(--text-secondary);
  font-weight: 500;
}
.water-settings-btn{
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: 12px;
  font-size: 18px;
  color: var(--text-secondary);
  cursor: pointer;
  padding: var(--spacing-md);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.water-settings-btn:hover{
  color: #3b82f6;
  background: rgba(59, 130, 246, 0.2);
  border-color: rgba(59, 130, 246, 0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

.water-progress{
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
  position: relative;
  z-index: 2;
}
.water-progress-bar{
  flex: 1;
  height: 12px;
  background: rgba(59, 130, 246, 0.15);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) inset;
  border: 1px solid rgba(59, 130, 246, 0.2);
}
.water-progress-fill{
  height: 100%;
  background: linear-gradient(90deg, 
    #3b82f6 0%, 
    #0ea5e9 50%, 
    #06b6d4 100%);
  border-radius: 6px;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
}
.water-progress-fill::after{
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255,255,255,0.4), 
    transparent);
  animation: water-shimmer 2.5s infinite;
}
@keyframes water-shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

/* SECTIONS MANAGER ANIMATIONS - АНИМАЦИИ ДЛЯ УПРАВЛЕНИЯ РАЗДЕЛАМИ */
@keyframes sections-shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

@keyframes sections-icon-pulse {
  0%, 100% { 
    transform: scale(1);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5);
  }
}

/* Hover эффекты для кнопки разделов */
.sections-manager-card:hover {
  transform: translateY(-4px) scale(1.02) !important;
  box-shadow: 
    0 16px 48px rgba(99, 102, 241, 0.25),
    0 1px 0 rgba(255, 255, 255, 0.15) inset !important;
  border-color: rgba(99, 102, 241, 0.4) !important;
}

.sections-manager-card:hover .sections-arrow {
  transform: translateX(4px) !important;
  color: var(--accent-secondary) !important;
}

.sections-manager-card:active {
  transform: translateY(-2px) scale(1.01) !important;
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.water-controls{
  display: flex;
  align-items: center;
  gap: var(--spacing-lg);
}

/* ИСПРАВЛЯЕМ КНОПКИ ВОДЫ - ДЕЛАЕМ ИХ ВИДИМЫМИ И ОДИНАКОВЫМИ */
.water-btn{
  width: 40px;
  height: 40px;
  background: var(--bg-tertiary);
  border: 2px solid rgba(6, 182, 212, 0.3);
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-water);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-soft);
  flex-shrink: 0;
  position: relative;
  z-index: 10;
}
.water-btn:hover{
  background: var(--accent-water);
  color: white;
  transform: scale(1.15);
  box-shadow: var(--shadow-medium);
  border-color: var(--accent-water);
}
.water-btn:active{
  transform: scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* УБЕЖДАЕМСЯ ЧТО КНОПКА ПЛЮС ВИДНА */
.water-btn.plus{
  background: var(--bg-tertiary);
  border: 2px solid rgba(6, 182, 212, 0.3);
  color: var(--accent-water);
}
.water-btn.minus{
  background: var(--bg-tertiary);
  border: 2px solid rgba(6, 182, 212, 0.3);
  color: var(--accent-water);
}

.water-current{
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  min-width: 40px;
  text-align: center;
  cursor: pointer;
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--spacing-sm);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid transparent;
  background: rgba(6, 182, 212, 0.05);
  text-shadow: 0 1px 3px rgba(6, 182, 212, 0.3);
}
.water-current:hover{
  background: rgba(6, 182, 212, 0.15);
  border-color: rgba(6, 182, 212, 0.3);
  color: var(--accent-water);
  transform: scale(1.1);
  box-shadow: var(--shadow-soft);
}
.water-current:active{
  transform: scale(1.05);
}

/* DAY NAVIGATION - УЛУЧШЕННАЯ НАВИГАЦИЯ ПО ДНЯМ */
.day-nav{
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-lg) var(--spacing-xl);
  gap: var(--spacing-2xl);
  animation: slideInFromLeft 0.5s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
  flex-shrink: 0; /* Не сжимается */
}
.day-arrow{
  background: var(--bg-card);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-primary);
  border-radius: 14px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  color: var(--accent-primary);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.day-arrow:hover{
  background: var(--accent-primary);
  color: white;
  transform: scale(1.1);
  box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
  border-color: var(--accent-primary);
}
.day-arrow:active{
  transform: scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.day-title{
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  letter-spacing: 0.3px;
}

/* SINGLE DAY CONTAINER - КОНТЕЙНЕР ДНЯ */
.single-day-container{
  padding: 0 var(--spacing-xl) var(--spacing-xl); /* Убираем верхний отступ, так как он уже есть в meals-scroll-container */
  animation: slideInFromBottom 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

/* ADD MEAL CONTAINER - КОНТЕЙНЕР КНОПКИ ДОБАВЛЕНИЯ */
.add-meal-container {
  padding: var(--spacing-lg) 0;
  margin-top: var(--spacing-lg);
}
.single-day-container .day-card{
  max-width: 600px;
  margin: 0 auto;
}

/* DAY CARD - КАРТОЧКА ДНЯ */
.day-card{
  background: var(--bg-card);
  backdrop-filter: blur(30px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xl);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 
    0 12px 40px rgba(0, 0, 0, 0.15),
    0 1px 0 rgba(255, 255, 255, 0.05) inset;
  position: relative;
  overflow: hidden;
}
.day-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.02) 0%, 
    rgba(139, 92, 246, 0.02) 100%);
  pointer-events: none;
}
.day-card.today{
  border-color: rgba(99, 102, 241, 0.3);
  box-shadow: 
    0 16px 50px rgba(99, 102, 241, 0.2),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
}

/* MEALS CONTAINER - КОНТЕЙНЕР ПРИЕМОВ ПИЩИ */
.meals{
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
  position: relative;
  z-index: 2;
}

/* MEAL CARDS - КАРТОЧКИ ПРИЕМОВ ПИЩИ */
.meal{
  background: var(--bg-tertiary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-secondary);
  border-radius: var(--border-radius);
  padding: var(--spacing-xl);
  cursor: pointer;
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
  position: relative;
  overflow: hidden;
  animation: floatIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
  box-shadow: 
    0 4px 16px rgba(0, 0, 0, 0.08),
    0 1px 0 rgba(255, 255, 255, 0.03) inset;
}
.meal::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.03), 
    rgba(139, 92, 246, 0.03));
  opacity: 0;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(99, 102, 241, 0.1), 
    transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Анимационные задержки для приемов пищи */
.meal:nth-child(1) { animation-delay: 0.1s; }
.meal:nth-child(2) { animation-delay: 0.15s; }
.meal:nth-child(3) { animation-delay: 0.2s; }
.meal:nth-child(4) { animation-delay: 0.25s; }
.meal:nth-child(5) { animation-delay: 0.3s; }

.meal:hover{
  background: var(--bg-card-hover);
  border-color: var(--border-primary);
  transform: translateY(-4px) scale(1.02);
  box-shadow: var(--shadow-medium);
}
.meal:hover::before {
  opacity: 1;
}
.meal:hover::after {
  left: 100%;
}
.meal:active {
  transform: translateY(-2px) scale(1.01);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* COMPLETED MEAL STYLES - СТИЛИ ДЛЯ ВЫПОЛНЕННЫХ ПРИЕМОВ ПИЩИ */
.meal.completed {
  opacity: 0.8;
  background: var(--bg-secondary);
  border-color: rgba(34, 197, 94, 0.3);
}
.meal.completed .meal-label {
  color: var(--text-muted);
  position: relative;
  display: inline-block; /* Важно для точного зачеркивания */
}
.meal.completed .meal-label::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 0;
  max-width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--text-muted), var(--text-secondary));
  border-radius: 1px;
  transform: translateY(-50%);
  animation: meal-label-strikethrough 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s forwards;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}
.meal.completed .meal-content {
  color: var(--text-muted);
  position: relative;
  display: inline-block; /* Важно для точного зачеркивания */
  width: 100%; /* Занимает всю ширину, но зачеркивание только по тексту */
}
.meal.completed .meal-content::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  width: 0;
  max-width: 100%;
  height: 2px;
  background: linear-gradient(90deg, var(--text-muted), var(--text-secondary));
  border-radius: 1px;
  transform: translateY(-50%);
  animation: meal-content-strikethrough 0.8s cubic-bezier(0.4, 0, 0.2, 1) 0.4s forwards;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Анимации зачеркивания для разных частей приема пищи */
@keyframes meal-label-strikethrough {
  0% {
    width: 0;
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    width: var(--text-width, 100%);
    opacity: 1;
  }
}

@keyframes meal-content-strikethrough {
  0% {
    width: 0;
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  100% {
    width: var(--text-width, 100%);
    opacity: 1;
  }
}

/* Улучшенные стили для зачеркнутого текста */
.meal.completed .meal-label,
.meal.completed .meal-content {
  transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Стили для значков времени в выполненных приемах */
.meal.completed .meal-time-badge {
  background: rgba(34, 197, 94, 0.15);
  border-color: rgba(34, 197, 94, 0.3);
  color: #22c55e;
}

/* ADD MEAL BUTTON */
.meal.add-meal{
  background: linear-gradient(135deg, 
    rgba(74, 222, 128, 0.08) 0%, 
    rgba(34, 197, 94, 0.08) 100%);
  border: 2px dashed var(--border-primary);
  color: var(--accent-primary);
  text-align: center;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.meal.add-meal:hover{
  background: linear-gradient(135deg, 
    rgba(74, 222, 128, 0.15) 0%, 
    rgba(34, 197, 94, 0.15) 100%);
  border-style: solid;
  border-color: var(--accent-primary);
  transform: translateY(-2px) scale(1.01);
}

/* MEAL CONTENT */
.meal-header{
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--spacing-sm);
  position: relative;
  z-index: 2;
}

/* MEAL CHECKBOX - ЧЕКБОКС ДЛЯ ПРИЕМОВ ПИЩИ */
.meal-checkbox{
  width: 24px;
  height: 24px;
  border: 2px solid rgba(34, 197, 94, 0.3);
  border-radius: 12px;
  margin-right: var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  transform: translateZ(0);
  background: var(--bg-tertiary);
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.2) inset,
    0 1px 0 rgba(255, 255, 255, 0.1);
  position: relative;
  z-index: 10;
}
.meal-checkbox:hover {
  transform: scale(1.1);
  box-shadow: 
    0 0 20px rgba(34, 197, 94, 0.4),
    0 2px 8px rgba(0, 0, 0, 0.2) inset;
  border-color: rgba(34, 197, 94, 0.5);
}
.meal-checkbox.checked {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  border-color: #22c55e;
  box-shadow: 
    0 0 20px rgba(34, 197, 94, 0.6),
    0 1px 0 rgba(255, 255, 255, 0.3) inset;
  transform: scale(1.05);
}
.meal-checkbox.checked::after {
  content: '✓';
  color: white;
  font-size: 14px;
  font-weight: bold;
  animation: meal-checkmark-appear 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

/* Анимация появления галочки для приемов пищи */
@keyframes meal-checkmark-appear {
  0% {
    transform: scale(0) rotate(-45deg);
    opacity: 0;
  }
  50% {
    transform: scale(1.2) rotate(-22deg);
    opacity: 1;
  }
  100% {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }
}

/* MEAL WITH CHECKBOX LAYOUT */
.meal-with-checkbox {
  display: flex;
  align-items: flex-start;
  gap: var(--spacing-lg);
}

.meal-main-content {
  flex: 1;
  cursor: pointer;
}
.meal-label{
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}
.meal.add-meal .meal-label{
  color: var(--accent-primary);
  font-size: 15px;
  font-weight: 600;
}
.meal-content{
  font-size: 15px;
  color: var(--text-primary);
  font-weight: 500;
  line-height: 1.4;
  position: relative;
  z-index: 2;
}
.meal.add-meal .meal-content{
  color: var(--accent-secondary);
  font-size: 14px;
}

/* DELETE MEAL BUTTON - УЛУЧШЕННАЯ КНОПКА УДАЛЕНИЯ */
.delete-meal-btn{
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  color: #ef4444;
  border-radius: 8px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  flex-shrink: 0;
  backdrop-filter: blur(10px);
  opacity: 0.7;
  transform: scale(0.9);
}
.delete-meal-btn:hover{
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
  opacity: 1;
}
.delete-meal-btn:active{
  transform: scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Показываем кнопку удаления только при ховере на прием пищи */
.meal .delete-meal-btn {
  opacity: 0;
  transform: scale(0.8);
  pointer-events: none;
}
.meal:hover .delete-meal-btn {
  opacity: 0.7;
  transform: scale(0.9);
  pointer-events: auto;
}
.meal:hover .delete-meal-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* MEAL TIME BADGE */
.meal-time-badge{
  font-size: 11px;
  color: var(--accent-primary);
  background: rgba(99, 102, 241, 0.15);
  backdrop-filter: blur(10px);
  padding: 3px 8px;
  border-radius: 6px;
  margin-left: var(--spacing-sm);
  font-weight: 700;
  border: 1px solid rgba(99, 102, 241, 0.3);
  letter-spacing: 0.3px;
  text-shadow: 0 1px 2px rgba(99, 102, 241, 0.2);
}

/* MEAL TYPE SELECTOR MODAL - УЛУЧШЕННЫЙ СЕЛЕКТОР ТИПОВ ПРИЕМОВ ПИЩИ */
.meal-type-modal{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(30px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-modal.show{
  opacity: 1;
}
.meal-type-modal-content{
  background: var(--bg-secondary);
  backdrop-filter: blur(40px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius-lg);
  margin: var(--spacing-xl);
  max-width: 420px;
  width: 100%;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.4),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
  transform: scale(0.9) translateY(20px);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  position: relative;
}
.meal-type-modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.05) 0%, 
    rgba(139, 92, 246, 0.05) 100%);
  pointer-events: none;
}
.meal-type-modal.show .meal-type-modal-content{
  transform: scale(1) translateY(0);
}
.meal-type-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-2xl);
  border-bottom: 1px solid var(--border-secondary);
  position: relative;
  z-index: 2;
}
.meal-type-header h3{
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.meal-type-close{
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  font-size: 20px;
  color: #ef4444;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.meal-type-close:hover{
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}
.meal-type-options{
  padding: var(--spacing-2xl);
  display: grid;
  gap: var(--spacing-lg);
  position: relative;
  z-index: 2;
}

.meal-type-option{
  display: flex;
  align-items: center;
  padding: var(--spacing-xl);
  background: var(--bg-tertiary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-secondary);
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.meal-type-option::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.05), 
    rgba(139, 92, 246, 0.05));
  opacity: 0;
  transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-option::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(99, 102, 241, 0.1), 
    transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-option:hover{
  background: var(--bg-card-hover);
  border-color: rgba(99, 102, 241, 0.4);
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}
.meal-type-option:hover::before {
  opacity: 1;
}
.meal-type-option:hover::after {
  left: 100%;
}
.meal-type-option:active{
  transform: translateY(-1px) scale(1.01);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-type-icon{
  font-size: 24px;
  margin-right: var(--spacing-lg);
  position: relative;
  z-index: 2;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}
.meal-type-name{
  font-size: 17px;
  font-weight: 600;
  color: var(--text-primary);
  position: relative;
  z-index: 2;
}

/* MEAL INPUT MODAL - УЛУЧШЕННОЕ МОДАЛЬНОЕ ОКНО ВВОДА */
.meal-input-modal{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(30px);
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.meal-input-modal.show{
  opacity: 1;
}
.meal-input-modal-content{
  background: var(--bg-secondary);
  backdrop-filter: blur(40px);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius-lg);
  margin: var(--spacing-xl);
  max-width: 520px;
  width: 100%;
  box-shadow: 
    0 20px 60px rgba(0, 0, 0, 0.4),
    0 1px 0 rgba(255, 255, 255, 0.1) inset;
  transform: scale(0.9) translateY(20px);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
  position: relative;
}
.meal-input-modal-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, 
    rgba(99, 102, 241, 0.05) 0%, 
    rgba(139, 92, 246, 0.05) 100%);
  pointer-events: none;
}
.meal-input-modal.show .meal-input-modal-content{
  transform: scale(1) translateY(0);
}
.meal-input-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-2xl);
  border-bottom: 1px solid var(--border-secondary);
  position: relative;
  z-index: 2;
}
.meal-input-header h3{
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}
.meal-input-close{
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.2);
  font-size: 20px;
  color: #ef4444;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.meal-input-close:hover{
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.4);
  color: #f87171;
  transform: scale(1.1);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}
.meal-input-form{
  padding: var(--spacing-2xl);
  position: relative;
  z-index: 2;
}
.meal-content-input{
  resize: vertical;
  min-height: 100px;
  font-family: inherit;
  line-height: 1.5;
}
.meal-input-buttons{
  display: flex;
  gap: var(--spacing-lg);
  padding: var(--spacing-2xl);
  border-top: 1px solid var(--border-secondary);
  position: relative;
  z-index: 2;
}
.btn-secondary{
  flex: 1;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  border: 1px solid var(--border-primary);
  border-radius: var(--border-radius);
  padding: var(--spacing-lg) var(--spacing-xl);
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(20px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}
.btn-secondary:hover{
  background: var(--bg-card-hover);
  border-color: var(--border-primary);
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}
.btn-primary{
  flex: 1;
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color: white;
  border: none;
  border-radius: var(--border-radius);
  padding: var(--spacing-lg) var(--spacing-xl);
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
  position: relative;
  overflow: hidden;
}
.btn-primary::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, 
    transparent, 
    rgba(255,255,255,0.3), 
    transparent);
  transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
.btn-primary:hover{
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
}
.btn-primary:hover::before {
  left: 100%;
}
.btn-primary:active{
  transform: translateY(-1px) scale(1.01);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* BOTTOM NAVIGATION */
.bottom-nav{
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-modal);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-soft);
  display: flex;
  padding: var(--spacing-sm) 0 calc(var(--spacing-sm) + env(safe-area-inset-bottom));
  z-index: 50;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
}
.nav-item{
  flex: 1;
  background: none;
  border: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-sm);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}
.nav-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--accent-primary);
  opacity: 0.1;
  border-radius: var(--spacing-md);
  margin: var(--spacing-xs);
  transform: scale(0);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.nav-item:hover::before {
  transform: scale(1);
}
.nav-item.active::before {
  transform: scale(1);
  background: var(--accent-primary);
  opacity: 0.15;
}
.nav-icon{
  font-size: 20px;
  margin-bottom: 2px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 1;
}
.nav-label{
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 1;
  letter-spacing: 0.2px;
}
.nav-item.active .nav-label{
  color: var(--accent-primary);
  font-weight: 600;
}
.nav-item:hover .nav-icon{
  transform: scale(1.1);
}
.nav-item:active{
  transform: scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* SCREENS */
.screen{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:var(--bg-primary);
  z-index:100;
  display:none;
  flex-direction:column;
  height:100vh;
  overflow:hidden;
  transform:translateX(100%);
  transition:all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  opacity:0;
}
.screen.show{
  display:flex;
  transform:translateX(0);
  opacity:1;
}
.screen.show .screen-content{
  animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
}

/* Улучшенные переходы для экранов */
.screen-header{
  padding:var(--spacing-md) var(--spacing-xl);
  background:var(--bg-modal);
  backdrop-filter: blur(30px);
  border-bottom:1px solid var(--border-soft);
  display:flex;
  align-items:center;
  justify-content:space-between;
  height:68px;
  flex-shrink:0;
  box-shadow: var(--shadow-soft);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.screen-content{
  flex:1;
  overflow-y:auto;
  padding:var(--spacing-xl);
  background: var(--bg-primary);
}
.screen-content::-webkit-scrollbar{display:none}

/* ROOM ITEMS */
.room-item{
  background:rgba(28,28,30,0.8);
  backdrop-filter: blur(20px);
  border:1px solid rgba(44,44,46,0.6);
  border-radius:var(--border-radius);
  padding:var(--spacing-lg);
  margin-bottom:var(--spacing-md);
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 4px 16px rgba(0,0,0,0.2);
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
  animation: fade-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1) both;
}
.room-item:nth-child(1) { animation-delay: 0.1s; }
.room-item:nth-child(2) { animation-delay: 0.15s; }
.room-item:nth-child(3) { animation-delay: 0.2s; }

.room-item:hover{
  transform: translateY(-2px);
  box-shadow:0 8px 32px rgba(0,0,0,0.3);
  border-color: rgba(99,102,241,0.3);
}
.room-item:active{
  opacity:0.9;
  transform:scale(0.98);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}
.room-name{
  font-size:var(--spacing-lg);
  font-weight:500;
  color:#ffffff;
  flex:1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.room-icon{
  font-size:18px;
  margin-right:var(--spacing-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
}
.delete-room{
  background:rgba(239,68,68,0.1);
  backdrop-filter: blur(10px);
  border:1px solid rgba(239,68,68,0.2);
  color:#ef4444;
  font-size:14px;
  cursor:pointer;
  padding:var(--spacing-xs);
  border-radius:var(--spacing-xs);
  font-weight:500;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.delete-room:hover{
  background:rgba(239,68,68,0.2);
  border-color:rgba(239,68,68,0.4);
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(239,68,68,0.3);
}
.delete-room:active{
  opacity:0.7;
  transform:scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.edit-room{
  background:rgba(99,102,241,0.1);
  backdrop-filter: blur(10px);
  border:1px solid rgba(99,102,241,0.2);
  color:#6366f1;
  font-size:14px;
  cursor:pointer;
  padding:var(--spacing-xs);
  border-radius:var(--spacing-xs);
  font-weight:500;
  margin-right:var(--spacing-xs);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transform: translateZ(0);
}
.edit-room:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  color:#8b5cf6;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(99,102,241,0.3);
}
.edit-room:active{
  opacity:0.7;
  transform:scale(0.95);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

.add-room-fab{
  position:fixed;
  bottom:var(--spacing-2xl);
  right:var(--spacing-2xl);
  width:56px;
  height:56px;
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border:none;
  border-radius:28px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:50;
  font-size:var(--spacing-xl);
  color:white;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow:0 8px 32px rgba(99,102,241,0.4);
  transform: translateZ(0);
  backdrop-filter: blur(20px);
}
.add-room-fab:hover{
  transform: scale(1.1) translateY(-2px);
  box-shadow:0 16px 48px rgba(99,102,241,0.5);
  animation: gentle-pulse 2s infinite;
}
.add-room-fab:active{
  opacity:0.9;
  transform:scale(1.05);
  transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
}

/* PROFILE */
.profile-section{
  background:#1c1c1e;
  border:1px solid #2c2c2e;
  margin-bottom:var(--spacing-lg);
  border-radius:var(--border-radius);
  padding:var(--spacing-xl);
  box-shadow:0 2px var(--spacing-sm) rgba(0,0,0,0.4);
}
.profile-avatar{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;
}
.avatar-circle{
  width:64px;
  height:64px;
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border-radius:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:var(--spacing-2xl);
  font-weight:600;
  margin-bottom:var(--spacing-md);
  box-shadow:0 var(--spacing-xs) var(--spacing-md) rgba(99,102,241,0.3);
}
.profile-name{
  font-size:18px;
  font-weight:600;
  color:#ffffff;
  margin-bottom:var(--spacing-sm);
}
.edit-name-btn{
  background:none;
  border:none;
  color:#6366f1;
  font-size:14px;
  cursor:pointer;
  padding:var(--spacing-xs) var(--spacing-md);
  border-radius:var(--spacing-xs);
  font-weight:500;
  transition:all 0.2s ease;
}
.edit-name-btn:active{opacity:0.6;background:rgba(99,102,241,0.2)}

.profile-menu{
  display:flex;
  flex-direction:column;
  gap:var(--spacing-md);
}
.profile-menu-btn{
  width:100%;
  background:#1c1c1e;
  border:1px solid #2c2c2e;
  border-radius:var(--border-radius);
  padding:var(--spacing-lg);
  display:flex;
  align-items:center;
  cursor:pointer;
  box-shadow:0 2px var(--spacing-sm) rgba(0,0,0,0.4);
  transition:all 0.2s ease;
  text-align:left;
}
.profile-menu-btn:active{opacity:0.8;transform:scale(0.98)}
.menu-btn-icon{
  font-size:var(--spacing-xl);
  margin-right:var(--spacing-md);
  width:28px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.menu-btn-text{flex:1}
.menu-btn-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:#ffffff;
  margin-bottom:2px;
}
.menu-btn-desc{
  font-size:var(--spacing-md);
  color:#8e8e93;
}
.menu-btn-arrow{
  font-size:var(--spacing-lg);
  color:#6b7280;
}

/* POPUP */
.popup{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.8);
  z-index:300;
  display:none;
  align-items:center;
  justify-content:center;
  opacity:0;
  transition:opacity 0.3s ease;
}
.popup.show{
  display:flex;
  opacity:1;
}
.popup-content{
  background:#1c1c1e;
  border:1px solid #2c2c2e;
  border-radius:var(--border-radius);
  padding:var(--spacing-xl);
  margin:var(--spacing-xl);
  max-width:280px;
  width:100%;
  box-shadow:0 var(--spacing-sm) var(--spacing-3xl) rgba(0,0,0,0.6);
  text-align:center;
}
.popup-title{
  font-size:var(--spacing-lg);
  font-weight:600;
  color:#ffffff;
  margin-bottom:var(--spacing-sm);
}
.popup-message{
  font-size:14px;
  color:#8e8e93;
  margin-bottom:var(--spacing-lg);
  line-height:1.4;
}
.popup-buttons{
  display:flex;
  gap:var(--spacing-sm);
}
.popup-btn{
  flex:1;
  border:none;
  border-radius:var(--spacing-sm);
  padding:var(--spacing-md);
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
}
.popup-btn:active{opacity:0.8;transform:scale(0.95)}
.popup-btn.cancel{
  background:#2c2c2e;
  color:#ffffff;
}
.popup-btn.confirm{
  background:#6366f1;
  color:white;
}
.popup-btn.danger{
  background:#ef4444;
  color:white;
}

/* ICON SELECTOR */
.icon-selector{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:var(--spacing-sm);
  margin:var(--spacing-lg) 0;
  max-height:200px;
  overflow-y:auto;
}
.icon-option{
  width:44px;
  height:44px;
  background:rgba(44,44,46,0.6);
  border:2px solid transparent;
  border-radius:var(--spacing-md);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  cursor:pointer;
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}
.icon-option:hover{
  background:rgba(99,102,241,0.2);
  border-color:rgba(99,102,241,0.4);
  transform:scale(1.05);
}
.icon-option.selected{
  background:linear-gradient(135deg, #6366f1, #8b5cf6);
  border-color:#6366f1;
  box-shadow:0 4px 16px rgba(99,102,241,0.4);
  transform:scale(1.1);
}
.icon-option:active{
  transform:scale(0.95);
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <button class="profile-btn" onclick="showProfile()">П</button>
    <div class="date-nav">
      <button class="nav-arrow" onclick="changeDay(-1)">‹</button>
      <div class="date-content" onclick="showDatePicker()">
        <div class="date-title" id="dayTitle">Сегодня</div>
        <div class="date-subtitle" id="daySubtitle">Пн, 27 янв.</div>
      </div>
      <button class="nav-arrow" onclick="changeDay(1)">›</button>
    </div>
    <button class="rooms-btn" onclick="showRooms()" id="roomsBtn">🏠</button>
  </div>
  
  <div class="content">
    <div class="progress-container" id="progressContainer">
      <div class="progress-info">
        <div class="progress-label" id="progressLabel">Прогресс дня</div>
        <div class="progress-stats" id="progressStats">0/0</div>
      </div>
      <div class="progress-circle-container">
        <div class="progress-circle" id="progressCircle">
          <div class="progress-circle-inner">
            <div class="progress-percentage" id="progressPercentage">0%</div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="empty" id="empty">
      <h2>Планов нет</h2>
      <p>Добавьте первую задачу</p>
      <button class="btn" onclick="showAdd()">Добавить задачу</button>
    </div>
    
    <div class="plans-container" id="plansContainer" style="display:none">
      <div class="plans" id="plans"></div>
    </div>
  </div>
</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav" id="bottomNav">
  <button class="nav-item active" onclick="switchTab('tasks')" data-tab="tasks">
    <div class="nav-icon" id="tasksIcon">📝</div>
    <div class="nav-label">Задачи</div>
  </button>
  <button class="nav-item" onclick="switchTab('nutrition')" data-tab="nutrition">
    <div class="nav-icon" id="nutritionIcon">🍽️</div>
    <div class="nav-label">Питание</div>
  </button>
  <button class="nav-item" onclick="switchTab('habits')" data-tab="habits">
    <div class="nav-icon" id="habitsIcon">🎯</div>
    <div class="nav-label">Привычки</div>
  </button>
</div>

<!-- ADD PLAN MODAL -->
<div class="modal" id="addModal">
  <div class="modal-header">
    <button class="header-btn" onclick="hideAdd()">Отмена</button>
    <div class="modal-title">Новая задача</div>
    <button class="header-btn-primary" onclick="savePlan()">Готово</button>
  </div>
  <div class="modal-content">
    <div class="form-group">
      <label class="label">Что планируете</label>
      <input class="input" id="planTitle" placeholder="Что вы планируете сделать?" autofocus>
    </div>
    <div class="form-group">
      <label class="label">Дата</label>
      <input type="date" class="input" id="planDate">
    </div>
    <div class="form-group">
      <label class="label">Время (необязательно)</label>
      <input type="time" class="input" id="planTime" placeholder="Выберите время">
    </div>
    <div class="form-group">
      <label class="label">Раздел</label>
      <div class="select-wrapper">
        <select class="select" id="planRoom">
          <option value="">Без раздела</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- CALENDAR -->
<div class="calendar" id="calendar" onclick="hideCalendar()">
  <div class="calendar-content" onclick="event.stopPropagation()">
    <div class="calendar-header">
      <button class="calendar-nav" onclick="changeCalendarMonth(-1)">‹</button>
      <div class="calendar-title" id="calendarTitle">Январь 2025</div>
      <button class="calendar-nav" onclick="changeCalendarMonth(1)">›</button>
    </div>
    <div class="weekdays">
      <div class="weekday">Пн</div>
      <div class="weekday">Вт</div>
      <div class="weekday">Ср</div>
      <div class="weekday">Чт</div>
      <div class="weekday">Пт</div>
      <div class="weekday">Сб</div>
      <div class="weekday">Вс</div>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
  </div>
</div>

<!-- EDIT PLAN SCREEN -->
<div class="screen" id="editPlanScreen">
  <div class="screen-header">
    <button class="header-btn" onclick="hideEditPlan()">Назад</button>
    <div class="modal-title">Изменить задачу</div>
    <div></div>
  </div>
  <div class="screen-content">
    <div class="form-group">
      <input class="input edit-plan-input" id="editPlanTitle" placeholder="Название задачи">
    </div>
    
    <div class="form-group">
      <label class="label">Дата</label>
      <div class="form-row" onclick="showEditDatePicker()">
        <span id="editPlanDate">26 янв. 2026г.</span>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">Уведомление</label>
      <div class="form-row">
        <span>Уведомление</span>
        <div class="toggle" id="notificationToggle" onclick="toggleNotification()">
          <div class="toggle-slider"></div>
        </div>
      </div>
    </div>
    
    <div class="form-group">
      <label class="label">Важная</label>
      <div class="form-row">
        <span>Важная</span>
        <div class="toggle" id="importantToggle" onclick="toggleImportant()">
          <div class="toggle-slider"></div>
        </div>
      </div>
    </div>
    
    <div class="premium-notice">
      <div class="premium-icon" id="premiumIcon">⭐</div>
      <span>Уведомления и пометка «Важная» доступны только с подпиской </span>
      <span class="premium-link">Премиум Трекер</span>
    </div>
    
    <button class="delete-btn" onclick="deletePlanFromEdit()">
      Удалить задачу
    </button>
  </div>
  
  <div class="screen-footer">
    <button class="save-btn" onclick="savePlanEdit()">Сохранить</button>
  </div>
</div>

<!-- MENU OVERLAY (simplified) -->
<div class="overlay" id="overlay" onclick="hideMenu()">
  <div class="menu" id="menu" onclick="event.stopPropagation()">
    <button class="menu-btn" onclick="editPlan()">Редактировать</button>
    <button class="menu-btn del" onclick="deletePlan()">Удалить</button>
  </div>
</div>


<!-- ROOMS SCREEN -->
<div class="screen" id="roomsScreen">
  <div class="screen-header">
    <button class="header-btn" onclick="hideRooms()">Назад</button>
    <div class="modal-title">Разделы</div>
    <button class="header-btn-primary" onclick="hideRooms()">Готово</button>
  </div>
  <div class="screen-content">
    <!-- Красивая кнопка управления рутинными разделами -->
    <div class="sections-manager-card" onclick="showSectionsManager()" style="
      background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.1) 0%, 
        rgba(139, 92, 246, 0.1) 50%,
        rgba(168, 85, 247, 0.1) 100%);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-2xl);
      margin-bottom: var(--spacing-2xl);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 8px 32px rgba(99, 102, 241, 0.15),
        0 1px 0 rgba(255, 255, 255, 0.1) inset;
    ">
      <!-- Анимированный фон -->
      <div style="
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
          transparent, 
          rgba(99, 102, 241, 0.1), 
          transparent);
        animation: sections-shimmer 4s infinite;
        pointer-events: none;
      "></div>
      
      <!-- Основной контент -->
      <div style="position: relative; z-index: 2;">
        <div style="display: flex; align-items: center; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
          <div style="
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
            animation: sections-icon-pulse 3s infinite ease-in-out;
          " id="sectionsIcon">⚙️</div>
          
          <div style="flex: 1;">
            <h3 style="
              margin: 0 0 4px 0;
              font-size: 18px;
              font-weight: 700;
              color: var(--text-primary);
              text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            ">Рутинные разделы</h3>
            <p style="
              margin: 0;
              font-size: 14px;
              color: var(--text-secondary);
              line-height: 1.4;
            ">Автоматические задачи по расписанию</p>
          </div>
          
          <div style="
            color: var(--accent-primary);
            font-size: 20px;
            font-weight: 300;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
          " class="sections-arrow">›</div>
        </div>
        
        <!-- Статистика разделов -->
        <div style="
          display: flex;
          gap: var(--spacing-lg);
          padding-top: var(--spacing-md);
          border-top: 1px solid rgba(99, 102, 241, 0.15);
        ">
          <div style="flex: 1; text-align: center;">
            <div style="
              font-size: 20px;
              font-weight: 700;
              color: var(--accent-primary);
              margin-bottom: 2px;
            " id="sectionsCount">0</div>
            <div style="
              font-size: 11px;
              color: var(--text-muted);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Разделов</div>
          </div>
          
          <div style="flex: 1; text-align: center;">
            <div style="
              font-size: 20px;
              font-weight: 700;
              color: var(--accent-secondary);
              margin-bottom: 2px;
            " id="activeSectionsToday">0</div>
            <div style="
              font-size: 11px;
              color: var(--text-muted);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Активно сегодня</div>
          </div>
          
          <div style="flex: 1; text-align: center;">
            <div style="
              font-size: 20px;
              font-weight: 700;
              color: var(--accent-soft);
              margin-bottom: 2px;
            " id="autoTasksToday">0</div>
            <div style="
              font-size: 11px;
              color: var(--text-muted);
              text-transform: uppercase;
              letter-spacing: 0.5px;
            ">Задач создано</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Обычные разделы -->
    <div style="margin-bottom: var(--spacing-lg);">
      <h3 style="
        color: var(--text-secondary); 
        font-size: 14px; 
        margin-bottom: var(--spacing-md); 
        text-transform: uppercase; 
        letter-spacing: 0.5px;
        font-weight: 600;
      ">Обычные разделы</h3>
      <div id="roomsList"></div>
    </div>
  </div>
  <button class="add-room-fab" onclick="showAddRoom()">+</button>
</div>

<!-- PROFILE SCREEN -->
<div class="screen" id="profileScreen">
  <div class="screen-header">
    <button class="header-btn" onclick="hideProfile()">Назад</button>
    <div class="modal-title">Профиль</div>
    <button class="header-btn-primary" onclick="hideProfile()">Готово</button>
  </div>
  <div class="screen-content">
    <div class="profile-section">
      <div class="profile-avatar">
        <div class="avatar-circle">П</div>
        <div class="profile-name" id="profileName">Пользователь</div>
        <button class="edit-name-btn" onclick="editName()">Изменить имя</button>
      </div>
    </div>
    
    <div class="profile-menu">
      <button class="profile-menu-btn" onclick="showAccount()">
        <div class="menu-btn-icon" id="profileIcon">👤</div>
        <div class="menu-btn-text">
          <div class="menu-btn-title">Аккаунт</div>
          <div class="menu-btn-desc">Личные данные и подписка</div>
        </div>
        <div class="menu-btn-arrow">›</div>
      </button>
      
      <button class="profile-menu-btn" onclick="showSettings()">
        <div class="menu-btn-icon" id="settingsIcon">⚙️</div>
        <div class="menu-btn-text">
          <div class="menu-btn-title">Настройки</div>
          <div class="menu-btn-desc">Уведомления и предпочтения</div>
        </div>
        <div class="menu-btn-arrow">›</div>
      </button>
      
      <button class="profile-menu-btn" onclick="showSupport()">
        <div class="menu-btn-icon" id="supportIcon">💬</div>
        <div class="menu-btn-text">
          <div class="menu-btn-title">Поддержка</div>
          <div class="menu-btn-desc">Помощь и обратная связь</div>
        </div>
        <div class="menu-btn-arrow">›</div>
      </button>
    </div>
  </div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content">
    <div class="popup-title" id="popupTitle">Заголовок</div>
    <div class="popup-message" id="popupMessage">Сообщение</div>
    <div class="popup-buttons" id="popupButtons"></div>
  </div>
</div>

<script>
'use strict';

// TELEGRAM WEB APP INIT
const tg = window.Telegram?.WebApp;
let currentModal = null;

if (tg) {
  tg.ready();
  tg.expand();
  tg.enableClosingConfirmation();
  
  // Настройка темы
  if (tg.themeParams) {
    document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#f2f2f7');
    document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
    document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#8e8e93');
    document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#007aff');
    document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#007aff');
    document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
  }
  
  // Обработка кнопки "Назад"
  tg.BackButton.onClick(() => {
    if (currentModal) {
      hideCurrentModal();
    } else {
      tg.close();
    }
  });
  
  console.log('Telegram WebApp инициализирован');
} else {
  console.log('Telegram WebApp API недоступен - работаем в браузере');
}

// ЕДИНАЯ СИСТЕМА ИКОНОК - ИСПОЛЬЗУЕТСЯ ВЕЗДЕ В ПРИЛОЖЕНИИ
const ICONS = {
  // Основные разделы и комнаты
  rooms: ['🏠', '🛏️', '🍳', '🛁', '💼', '🏃', '📚', '🎮', '🌿', '🔧'],
  
  // Дополнительные иконки для разделов
  activities: ['🎯', '🎨', '🎵', '🏋️', '🧘', '🍕', '☕', '🌟', '💡', '🔥'],
  
  // Специальные иконки
  special: ['🎪', '🎭', '🎬', '📱', '💻', '🎸', '🎹', '🎤', '�', '📷'],
  
  // Путешествия и природа
  travel: ['✈️', '🚗', '🏖️', '🏔️', '🌊', '🌙', '☀️', '🌈', '⚡', '❄️'],
  
  // Навигация и интерфейс
  navigation: {
    tasks: '📝',
    nutrition: '🍽️', 
    habits: '🎯',
    home: '🏠',
    profile: '👤',
    settings: '⚙️',
    support: '💬',
    premium: '⭐',
    sections: '⚙️'
  },
  
  // Приемы пищи
  meals: {
    breakfast: '🌅',
    lunch: '🍽️',
    dinner: '🌙',
    snack: '🍎'
  },
  
  // Получить все иконки для выбора
  getAllForSelection() {
    return [
      ...this.rooms,
      ...this.activities, 
      ...this.special,
      ...this.travel
    ];
  },
  
  // Получить иконки для разделов
  getSectionIcons() {
    return [
      '🏃', '🧘', '📚', '🍳', '🧹', '💼', '🎯', '🌱', 
      '💪', '🎨', '🎵', '🛁', '🚿', '🛏️', '🏠'
    ];
  }
};

// STATE
let currentDate = new Date();
let plans = [];
let rooms = []; // Теперь будет массив объектов {name: string, icon: string}
let sections = []; // НОВАЯ СИСТЕМА: разделы с правилами активности и шаблонными задачами
let selectedPlanId = null;
let calendarDate = new Date();
let selectedRoomIcon = ICONS.navigation.home; // Используем единую систему иконок
let currentTab = 'tasks'; // Текущая активная вкладка

// ИНИЦИАЛИЗАЦИЯ ИКОНОК - УСТАНАВЛИВАЕМ ИКОНКИ ЧЕРЕЗ JAVASCRIPT
function initializeIcons() {
  try {
    // Навигационные иконки
    const roomsBtn = document.getElementById('roomsBtn');
    if (roomsBtn) roomsBtn.textContent = ICONS.navigation.home;
    
    const tasksIcon = document.getElementById('tasksIcon');
    if (tasksIcon) tasksIcon.textContent = ICONS.navigation.tasks;
    
    const habitsIcon = document.getElementById('habitsIcon');
    if (habitsIcon) habitsIcon.textContent = ICONS.navigation.habits;
    
    const nutritionIcon = document.getElementById('nutritionIcon');
    if (nutritionIcon) nutritionIcon.textContent = ICONS.navigation.nutrition;
    
    const premiumIcon = document.getElementById('premiumIcon');
    if (premiumIcon) premiumIcon.textContent = ICONS.navigation.premium;
    
    const sectionsIcon = document.getElementById('sectionsIcon');
    if (sectionsIcon) sectionsIcon.textContent = ICONS.navigation.sections;
    
    // Иконки профиля
    const profileIcon = document.getElementById('profileIcon');
    if (profileIcon) profileIcon.textContent = ICONS.navigation.profile;
    
    const settingsIcon = document.getElementById('settingsIcon');
    if (settingsIcon) settingsIcon.textContent = ICONS.navigation.settings;
    
    const supportIcon = document.getElementById('supportIcon');
    if (supportIcon) supportIcon.textContent = ICONS.navigation.support;
    
    console.log('✅ Иконки успешно инициализированы');
  } catch (e) {
    console.error('❌ Ошибка при инициализации иконок:', e);
  }
}

// UTILS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(date) {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  if (date.toDateString() === today.toDateString()) return 'Сегодня';
  if (date.toDateString() === tomorrow.toDateString()) return 'Завтра';
  if (date.toDateString() === yesterday.toDateString()) return 'Вчера';
  
  return date.toLocaleDateString('ru-RU', { weekday: 'long' });
}

function formatDateSubtitle(date) {
  const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]}.`;
}

function getRoomIcon(roomName) {
  const room = rooms.find(room => {
    const name = typeof room === 'string' ? room : room.name;
    return name === roomName;
  });
  
  if (room && typeof room === 'object') {
    return room.icon;
  }
  
  // Если раздел не найден или в старом формате, возвращаем дефолтную иконку
  return ICONS.navigation.home;
}

function getPlansForDate(date) {
  console.log('getPlansForDate вызвана для даты:', date);
  console.log('Все планы в getPlansForDate:', plans);
  
  // Преобразуем Date в строку YYYY-MM-DD
  const dateStr = date instanceof Date ? date.toISOString().split('T')[0] : date;
  console.log('Строка даты для фильтрации (YYYY-MM-DD):', dateStr);
  
  const dayPlans = plans.filter(p => {
    // Сравниваем строки напрямую, без создания Date объектов
    const planDate = p.date; // Уже должна быть строка YYYY-MM-DD
    console.log(`Сравниваем план "${p.title}": ${planDate} === ${dateStr}?`, planDate === dateStr);
    return planDate === dateStr;
  });
  
  console.log('Отфильтрованные планы на день:', dayPlans);
  
  // Сортируем по времени: сначала задачи с временем (по времени), потом без времени
  const sortedPlans = dayPlans.sort((a, b) => {
    // Если у обеих задач есть время - сортируем по времени
    if (a.time && b.time) {
      return a.time.localeCompare(b.time);
    }
    // Задачи с временем идут первыми
    if (a.time && !b.time) return -1;
    if (!a.time && b.time) return 1;
    // Если у обеих нет времени - оставляем исходный порядок
    return 0;
  });
  
  console.log('Отсортированные планы на день:', sortedPlans);
  return sortedPlans;
}

// STORAGE
function loadData() {
  try {
    console.log('Загружаем данные приложения...');
    
    // Проверяем, что есть в localStorage
    const savedPlans = localStorage.getItem('planner_plans');
    const savedRooms = localStorage.getItem('planner_teams');
    console.log('Данные в localStorage - планы:', savedPlans);
    console.log('Данные в localStorage - разделы:', savedRooms);
    
    // Миграция старых данных
    const oldPlans = localStorage.getItem('plans');
    const oldTeams = localStorage.getItem('teams');
    const oldRooms = localStorage.getItem('planner_rooms');
    
    if (oldPlans && !localStorage.getItem('planner_plans')) {
      localStorage.setItem('planner_plans', oldPlans);
      localStorage.removeItem('plans');
      console.log('Мигрированы старые планы');
    }
    if (oldTeams && !localStorage.getItem('planner_teams')) {
      localStorage.setItem('planner_teams', oldTeams);
      localStorage.removeItem('teams');
      console.log('Мигрированы старые команды');
    }
    if (oldRooms && !localStorage.getItem('planner_teams')) {
      localStorage.setItem('planner_teams', oldRooms);
      localStorage.removeItem('planner_rooms');
      console.log('Мигрированы старые разделы');
    }

    plans = JSON.parse(localStorage.getItem('planner_plans') || '[]');
    rooms = JSON.parse(localStorage.getItem('planner_teams') || '[]');
    
    console.log(`Загружено планов: ${plans.length}, разделов: ${rooms.length}`);
    console.log('Загруженные планы:', plans);
    
    // КРИТИЧЕСКИ ВАЖНО: Миграция дат в правильный формат YYYY-MM-DD
    let needsSave = false;
    plans = plans.map(plan => {
      if (plan.date && typeof plan.date === 'string') {
        // Проверяем, не в формате ли уже YYYY-MM-DD
        if (!/^\d{4}-\d{2}-\d{2}$/.test(plan.date)) {
          // Конвертируем в правильный формат
          try {
            const dateObj = new Date(plan.date);
            const newDate = dateObj.toISOString().split('T')[0];
            console.log(`Мигрируем дату плана "${plan.title}": ${plan.date} → ${newDate}`);
            plan.date = newDate;
            needsSave = true;
          } catch (e) {
            console.error('Ошибка миграции даты для плана:', plan.title, e);
          }
        }
      }
      return plan;
    });
    
    // Сохраняем если были изменения
    if (needsSave) {
      console.log('Сохраняем мигрированные планы');
      savePlans();
    }
    
    // Миграция старых разделов (строки) в новый формат (объекты)
    if (rooms.length > 0 && typeof rooms[0] === 'string') {
      console.log('Мигрируем разделы в новый формат...');
      const defaultIcons = ICONS.rooms;
      rooms = rooms.map((roomName, index) => ({
        name: roomName,
        icon: defaultIcons[index % defaultIcons.length]
      }));
      saveRooms(); // Сохраняем в новом формате
      console.log('Миграция разделов завершена');
    }
    
    // 🍽️ АВТОМАТИЧЕСКИ ДОБАВЛЯЕМ РАЗДЕЛ "ПИТАНИЕ" ЕСЛИ ЕГО НЕТ
    const nutritionRoomExists = rooms.some(room => {
      const roomName = typeof room === 'string' ? room : room.name;
      return roomName === 'Питание';
    });
    
    if (!nutritionRoomExists) {
      console.log('Добавляем раздел "Питание"');
      rooms.push({
        name: 'Питание',
        icon: '🍽️'
      });
      saveRooms();
      console.log('Раздел "Питание" добавлен автоматически');
    }
  } catch (e) {
    console.error('Ошибка при загрузке данных:', e);
    // Инициализируем пустыми данными в случае ошибки
    plans = [];
    rooms = [];
    
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка загрузки', 'Не удалось загрузить сохраненные данные. Приложение запущено с пустыми данными.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

function savePlans() {
  try {
    console.log('Сохраняем планы:', plans);
    console.log('Количество планов для сохранения:', plans.length);
    
    const dataToSave = JSON.stringify(plans);
    console.log('JSON для сохранения:', dataToSave);
    
    localStorage.setItem('planner_plans', dataToSave);
    console.log('Планы успешно сохранены в localStorage');
    
    // Проверяем, что данные действительно сохранились
    const saved = localStorage.getItem('planner_plans');
    console.log('Проверка сохранения - данные в localStorage:', saved);
    
    // Дополнительная проверка - парсим обратно
    const parsedBack = JSON.parse(saved || '[]');
    console.log('Проверка парсинга - количество планов:', parsedBack.length);
    
    if (parsedBack.length !== plans.length) {
      console.error('КРИТИЧЕСКАЯ ОШИБКА: Количество сохраненных планов не совпадает!');
      console.error('Ожидалось:', plans.length, 'Сохранено:', parsedBack.length);
    }
  } catch (e) {
    console.error('Ошибка при сохранении планов:', e);
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка сохранения', 'Не удалось сохранить данные. Проверьте свободное место на устройстве.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

function saveRooms() {
  try {
    localStorage.setItem('planner_teams', JSON.stringify(rooms));
    console.log('Разделы успешно сохранены');
  } catch (e) {
    console.error('Ошибка при сохранении разделов:', e);
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка сохранения', 'Не удалось сохранить разделы. Проверьте свободное место на устройстве.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

// SECTIONS SYSTEM - СИСТЕМА РАЗДЕЛОВ С АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИЕЙ
function saveSections() {
  try {
    localStorage.setItem('planner_sections', JSON.stringify(sections));
    console.log('Разделы с правилами успешно сохранены');
  } catch (e) {
    console.error('Ошибка при сохранении разделов:', e);
  }
}

function loadSections() {
  try {
    const savedSections = localStorage.getItem('planner_sections');
    sections = savedSections ? JSON.parse(savedSections) : [];
    console.log(`Загружено разделов с правилами: ${sections.length}`);
  } catch (e) {
    console.error('Ошибка при загрузке разделов:', e);
    sections = [];
  }
}

// Проверяет, активен ли раздел в указанную дату
function isSectionActiveOnDate(section, date) {
  if (!section.activityRule) return false;
  
  const { type, value } = section.activityRule;
  const dayOfWeek = date.getDay(); // 0 = воскресенье, 1 = понедельник, ...
  
  switch (type) {
    case 'daily':
      return true;
    
    case 'every_other_day':
      // Используем количество дней с эпохи для определения четности
      const daysSinceEpoch = Math.floor(date.getTime() / (1000 * 60 * 60 * 24));
      return daysSinceEpoch % 2 === (value || 0);
    
    case 'weekdays':
      // value - массив дней недели [1,2,3,4,5] для пн-пт
      return Array.isArray(value) && value.includes(dayOfWeek);
    
    default:
      return false;
  }
}

// Синхронизирует разделы с планами на указанную дату
function syncSectionsToPlans(date) {
  console.log('Синхронизация разделов с планами для даты:', date);
  
  const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
  
  sections.forEach(section => {
    if (isSectionActiveOnDate(section, date)) {
      console.log(`Раздел "${section.name}" активен на ${dateStr}`);
      
      // Убеждаемся что раздел существует в rooms с правильной иконкой
      const existingRoom = rooms.find(room => {
        const roomName = typeof room === 'string' ? room : room.name;
        return roomName === section.name;
      });
      
      if (!existingRoom) {
        // Создаем раздел в rooms с иконкой из рутинного раздела
        rooms.push({
          name: section.name,
          icon: section.icon
        });
        saveRooms();
        console.log(`Создан раздел "${section.name}" с иконкой ${section.icon}`);
      } else if (typeof existingRoom === 'object' && existingRoom.icon !== section.icon) {
        // Синхронизируем иконку если она отличается
        existingRoom.icon = section.icon;
        saveRooms();
        console.log(`Синхронизирована иконка раздела "${section.name}" на ${section.icon}`);
      }
      
      // Проверяем каждую шаблонную задачу из раздела
      section.templateTasks.forEach(template => {
        // Проверяем, не существует ли уже такая задача
        const existingTask = plans.find(plan => 
          plan.date === dateStr && 
          plan.sectionId === section.id && 
          plan.templateId === template.id
        );
        
        if (!existingTask) {
          // Создаем новую задачу из шаблона
          const newTask = {
            id: Date.now() + Math.random(), // Уникальный ID
            title: template.title,
            time: template.time || '',
            room: section.name, // Связываем с разделом
            date: dateStr,
            completed: false,
            sectionId: section.id, // ID раздела
            templateId: template.id, // ID шаблона
            createdFromSection: true // Флаг что задача создана из раздела
          };
          
          plans.push(newTask);
          console.log(`Создана задача из раздела: "${newTask.title}" с разделом "${section.name}"`);
        }
      });
    } else {
      console.log(`Раздел "${section.name}" НЕ активен на ${dateStr}`);
      
      // Удаляем задачи этого раздела на эту дату (если они были созданы автоматически)
      const initialCount = plans.length;
      plans = plans.filter(plan => !(
        plan.date === dateStr && 
        plan.sectionId === section.id && 
        plan.createdFromSection
      ));
      
      const removedCount = initialCount - plans.length;
      if (removedCount > 0) {
        console.log(`Удалено ${removedCount} задач неактивного раздела "${section.name}"`);
      }
    }
  });
  
  // Сохраняем изменения
  savePlans();
  
  // Обновляем интерфейс если нужно
  if (typeof updateRoomsSelect === 'function') {
    updateRoomsSelect();
  }
}

// Инициализирует синхронизацию разделов при старте приложения
function initSectionsSync() {
  console.log('Инициализация синхронизации разделов...');
  
  // Загружаем разделы
  loadSections();
  
  // Создаем демонстрационные разделы если их нет
  if (sections.length === 0) {
    console.log('Создаем демонстрационные разделы...');
    
    // Утренняя зарядка - каждый день
    sections.push({
      id: Date.now() + 1,
      name: 'Утренняя зарядка',
      icon: ICONS.rooms[5], // 🏃
      activityRule: { type: 'daily' },
      templateTasks: [
        { id: 1, title: 'Разминка', time: '07:00' },
        { id: 2, title: 'Упражнения', time: '07:15' },
        { id: 3, title: 'Растяжка', time: '07:30' }
      ],
      createdAt: new Date().toISOString()
    });
    
    // Уборка - через день
    sections.push({
      id: Date.now() + 2,
      name: 'Уборка дома',
      icon: '🧹', // Можно оставить специальную иконку для уборки
      activityRule: { type: 'every_other_day', value: 0 },
      templateTasks: [
        { id: 4, title: 'Пропылесосить', time: '10:00' },
        { id: 5, title: 'Протереть пыль', time: '10:30' }
      ],
      createdAt: new Date().toISOString()
    });
    
    // Работа - только в будни
    sections.push({
      id: Date.now() + 3,
      name: 'Рабочие задачи',
      icon: ICONS.rooms[4], // 💼
      activityRule: { type: 'weekdays', value: [1, 2, 3, 4, 5] }, // Пн-Пт
      templateTasks: [
        { id: 6, title: 'Проверить почту', time: '09:00' },
        { id: 7, title: 'Планерка', time: '10:00' },
        { id: 8, title: 'Отчет за день', time: '18:00' }
      ],
      createdAt: new Date().toISOString()
    });
    
    saveSections();
    console.log('Демонстрационные разделы созданы');
  }
  
  // Синхронизируем на текущую дату
  syncSectionsToPlans(currentDate);
  
  console.log('Синхронизация разделов завершена');
}

// RENDER
function render() {
  try {
    // Проверяем, что мы на вкладке задач
    if (currentTab !== 'tasks') {
      return;
    }
    
    const todayPlans = getPlansForDate(currentDate);
    
    // Update date display
    const dayTitle = document.getElementById('dayTitle');
    const daySubtitle = document.getElementById('daySubtitle');
    if (dayTitle) dayTitle.textContent = formatDate(currentDate);
    if (daySubtitle) daySubtitle.textContent = formatDateSubtitle(currentDate);
    
    // Update progress
    updateProgress();
    
    // Show/hide elements
    const empty = document.getElementById('empty');
    const plansContainer = document.getElementById('plansContainer');
    
    if (!empty || !plansContainer) {
      return;
    }
    
    if (todayPlans.length === 0) {
      empty.style.display = 'flex';
      plansContainer.style.display = 'none';
    } else {
      empty.style.display = 'none';
      plansContainer.style.display = 'flex';
      console.log('Есть планы на сегодня, показываем список');
      empty.style.display = 'none';
      plansContainer.style.display = 'flex';
      
      // Render plans
      const plansEl = document.getElementById('plans');
      if (!plansEl) {
        console.log('Элемент plans не найден');
        return;
      }
      
      console.log('Начинаем рендеринг планов в элемент:', plansEl);
      
      let html = '';
      todayPlans.forEach(plan => {
        try {
          console.log('Рендерим план:', plan);
          html += `
            <div class="plan ${plan.completed ? 'completed' : ''}" onclick="showPlanMenu('${plan.id}', event)">
              <div class="checkbox ${plan.completed ? 'checked' : ''}" onclick="toggleComplete('${plan.id}', event)"></div>
              <div class="plan-content">
                <div class="plan-title">
                  ${plan.time ? `<span class="plan-time-inline">${plan.time}</span>` : ''}${escapeHtml(plan.title)}
                </div>
                ${plan.room ? `<div class="room">${getRoomIcon(plan.room)} ${escapeHtml(plan.room)}</div>` : ''}
              </div>
            </div>
          `;
        } catch (e) {
          console.error('Ошибка при рендеринге плана:', e);
        }
      });
      
      // Добавляем кнопку "Добавить задачу" в конец списка
      html += `
        <button class="add-task-btn" onclick="showAdd()">
          <span class="add-icon">+</span>
          Добавить задачу
        </button>
      `;
      
      console.log('Сгенерированный HTML:', html);
      plansEl.innerHTML = html;
      console.log('HTML установлен в элемент plans');
    }
  } catch (e) {
    console.error('Ошибка в функции render:', e);
  }
}

function updateRoomsSelect() {
  try {
    const select = document.getElementById('planRoom');
    if (!select) {
      console.log('Элемент planRoom не найден');
      return;
    }
    
    select.innerHTML = '<option value="">Без раздела</option>';
    rooms.forEach(room => {
      try {
        // Поддерживаем старый формат (строки) и новый (объекты)
        const roomName = typeof room === 'string' ? room : room.name;
        const roomIcon = typeof room === 'string' ? ICONS.navigation.home : room.icon;
        
        const option = document.createElement('option');
        option.value = roomName;
        option.textContent = `${roomIcon} ${roomName}`;
        select.appendChild(option);
      } catch (e) {
        console.error('Ошибка при добавлении раздела в селект:', e);
      }
    });
  } catch (e) {
    console.error('Ошибка в updateRoomsSelect:', e);
  }
}

function renderRooms() {
  try {
    const roomsList = document.getElementById('roomsList');
    if (!roomsList) {
      console.log('Элемент roomsList не найден');
      return;
    }
    
    let html = '';
    rooms.forEach((room) => {
      try {
        // Поддерживаем старый формат (строки) и новый (объекты)
        const roomName = typeof room === 'string' ? room : room.name;
        const roomIcon = typeof room === 'string' ? ICONS.navigation.home : room.icon;
        
        html += `
          <div class="room-item">
            <div class="room-icon">${roomIcon}</div>
            <div class="room-name">${escapeHtml(roomName)}</div>
            <button class="edit-room" onclick="editRoom('${escapeHtml(roomName)}')">Редактировать</button>
            <button class="delete-room" onclick="deleteRoom('${escapeHtml(roomName)}')">Удалить</button>
          </div>
        `;
      } catch (e) {
        console.error('Ошибка при рендеринге раздела:', e);
      }
    });
    roomsList.innerHTML = html;
  } catch (e) {
    console.error('Ошибка в renderRooms:', e);
  }
}

// NAVIGATION
function changeDay(direction) {
  if (currentTab === 'nutrition') {
    // Для вкладки питания используем отдельную дату
    currentNutritionDate.setDate(currentNutritionDate.getDate() + direction);
    renderNutritionDay();
    updateWaterTracker();
    updateNutritionDayTitle();
  } else {
    // Для вкладки задач
    currentDate.setDate(currentDate.getDate() + direction);
    
    // НОВАЯ СИСТЕМА: Синхронизируем разделы при смене даты
    syncSectionsToPlans(currentDate);
    
    render();
  }
}

// MODALS & SCREENS
function showAdd() {
  console.log('showAdd вызвана');
  const addModal = document.getElementById('addModal');
  console.log('addModal найден:', addModal);
  
  if (!addModal) {
    console.error('Элемент addModal не найден!');
    return;
  }
  
  addModal.classList.add('show');
  currentModal = 'add';
  if (tg) tg.BackButton.show();
  
  const planDate = document.getElementById('planDate');
  if (planDate) {
    planDate.value = currentDate.toISOString().split('T')[0];
  } else {
    console.error('Элемент planDate не найден');
  }
  updateRoomsSelect();
  setTimeout(() => {
    const planTitle = document.getElementById('planTitle');
    if (planTitle) {
      planTitle.focus();
    }
  }, 300);
}

function hideAdd() {
  const addModal = document.getElementById('addModal');
  if (addModal) {
    addModal.classList.remove('show');
  } else {
    console.error('Элемент addModal не найден');
  }
  currentModal = null;
  if (tg) tg.BackButton.hide();
  clearForm();
  selectedPlanId = null;
}

function showRooms() {
  console.log('🏠 Показываем экран разделов с улучшенной анимацией');
  
  const roomsScreen = document.getElementById('roomsScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!roomsScreen) {
    console.error('❌ Элемент roomsScreen не найден');
    return;
  }
  
  // Подготавливаем экран для показа
  roomsScreen.style.display = 'flex';
  roomsScreen.style.transform = 'translateX(100%)';
  roomsScreen.style.opacity = '0';
  
  // Плавно скрываем основные элементы
  if (header) {
    header.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    header.style.transform = 'translateY(-100%)';
    header.style.opacity = '0';
  }
  if (bottomNav) {
    bottomNav.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    bottomNav.style.transform = 'translateY(100%)';
    bottomNav.style.opacity = '0';
  }
  if (content) {
    content.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    content.style.transform = 'translateX(-30px)';
    content.style.opacity = '0';
  }
  
  // Анимированное появление экрана разделов
  setTimeout(() => {
    roomsScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    roomsScreen.style.transform = 'translateX(0)';
    roomsScreen.style.opacity = '1';
    roomsScreen.classList.add('show');
  }, 50);
  
  // Скрываем элементы после анимации
  setTimeout(() => {
    if (header) header.style.display = 'none';
    if (bottomNav) bottomNav.style.display = 'none';
  }, 400);
  
  currentModal = 'rooms';
  if (tg) tg.BackButton.show();
  
  // Рендерим содержимое и обновляем статистику
  setTimeout(() => {
    renderRooms();
    updateSectionsStats();
    console.log('✅ Экран разделов успешно показан');
  }, 200);
}

// Обновляет статистику разделов в интерфейсе
function updateSectionsStats() {
  try {
    const sectionsCountEl = document.getElementById('sectionsCount');
    const activeSectionsTodayEl = document.getElementById('activeSectionsToday');
    const autoTasksTodayEl = document.getElementById('autoTasksToday');
    
    if (!sectionsCountEl || !activeSectionsTodayEl || !autoTasksTodayEl) {
      return; // Элементы еще не созданы
    }
    
    // Общее количество разделов
    const totalSections = sections.length;
    
    // Активные разделы сегодня
    const activeSectionsToday = sections.filter(section => 
      isSectionActiveOnDate(section, currentDate)
    ).length;
    
    // Автоматически созданные задачи сегодня
    const dateStr = currentDate.toISOString().split('T')[0];
    const autoTasksToday = plans.filter(plan => 
      plan.date === dateStr && plan.createdFromSection
    ).length;
    
    // Анимированное обновление чисел
    animateNumber(sectionsCountEl, totalSections);
    animateNumber(activeSectionsTodayEl, activeSectionsToday);
    animateNumber(autoTasksTodayEl, autoTasksToday);
    
  } catch (e) {
    console.error('Ошибка при обновлении статистики разделов:', e);
  }
}

// Анимированное изменение числа
function animateNumber(element, targetNumber) {
  const currentNumber = parseInt(element.textContent) || 0;
  const duration = 800;
  const steps = 20;
  const stepValue = (targetNumber - currentNumber) / steps;
  let currentStep = 0;
  
  const interval = setInterval(() => {
    currentStep++;
    const newValue = Math.round(currentNumber + (stepValue * currentStep));
    element.textContent = newValue;
    
    if (currentStep >= steps) {
      element.textContent = targetNumber;
      clearInterval(interval);
    }
  }, duration / steps);
}

function hideRooms() {
  console.log('🏠 Скрываем экран разделов с улучшенной анимацией');
  
  const roomsScreen = document.getElementById('roomsScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!roomsScreen) {
    console.error('❌ Элемент roomsScreen не найден');
    return;
  }
  
  // Плавное скрытие экрана разделов
  roomsScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
  roomsScreen.style.transform = 'translateX(100%)';
  roomsScreen.style.opacity = '0';
  roomsScreen.classList.remove('show');
  
  // Показываем основные элементы с анимацией
  if (header) {
    header.style.display = 'flex';
    header.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      header.style.transform = 'translateY(0)';
      header.style.opacity = '1';
    }, 100);
  }
  
  if (bottomNav) {
    bottomNav.style.display = 'flex';
    bottomNav.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      bottomNav.style.transform = 'translateY(0)';
      bottomNav.style.opacity = '1';
    }, 150);
  }
  
  if (content) {
    content.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      content.style.transform = 'translateX(0)';
      content.style.opacity = '1';
    }, 200);
  }
  
  // Полностью скрываем экран после анимации
  setTimeout(() => {
    roomsScreen.style.display = 'none';
    // Сбрасываем трансформации
    roomsScreen.style.transform = '';
    roomsScreen.style.transition = '';
    console.log('✅ Экран разделов успешно скрыт');
  }, 600);
  
  currentModal = null;
  if (tg) tg.BackButton.hide();
}

function showProfile() {
  console.log('👤 Показываем экран профиля с улучшенной анимацией');
  
  const profileScreen = document.getElementById('profileScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!profileScreen) {
    console.error('❌ Элемент profileScreen не найден');
    return;
  }
  
  // Подготавливаем экран для показа
  profileScreen.style.display = 'flex';
  profileScreen.style.transform = 'translateX(-100%)';
  profileScreen.style.opacity = '0';
  
  // Плавно скрываем основные элементы
  if (header) {
    header.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    header.style.transform = 'translateY(-100%)';
    header.style.opacity = '0';
  }
  if (bottomNav) {
    bottomNav.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    bottomNav.style.transform = 'translateY(100%)';
    bottomNav.style.opacity = '0';
  }
  if (content) {
    content.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
    content.style.transform = 'translateX(30px)';
    content.style.opacity = '0';
  }
  
  // Анимированное появление экрана профиля
  setTimeout(() => {
    profileScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
    profileScreen.style.transform = 'translateX(0)';
    profileScreen.style.opacity = '1';
    profileScreen.classList.add('show');
  }, 50);
  
  // Скрываем элементы после анимации
  setTimeout(() => {
    if (header) header.style.display = 'none';
    if (bottomNav) bottomNav.style.display = 'none';
  }, 400);
  
  currentModal = 'profile';
  if (tg) tg.BackButton.show();
  
  // Загружаем данные профиля
  setTimeout(() => {
    loadProfileData();
    console.log('✅ Экран профиля успешно показан');
  }, 200);
}

function hideProfile() {
  console.log('👤 Скрываем экран профиля с улучшенной анимацией');
  
  const profileScreen = document.getElementById('profileScreen');
  const header = document.querySelector('.header');
  const bottomNav = document.getElementById('bottomNav');
  const content = document.querySelector('.content');
  
  if (!profileScreen) {
    console.error('❌ Элемент profileScreen не найден');
    return;
  }
  
  // Плавное скрытие экрана профиля
  profileScreen.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
  profileScreen.style.transform = 'translateX(-100%)';
  profileScreen.style.opacity = '0';
  profileScreen.classList.remove('show');
  
  // Показываем основные элементы с анимацией
  if (header) {
    header.style.display = 'flex';
    header.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      header.style.transform = 'translateY(0)';
      header.style.opacity = '1';
    }, 100);
  }
  
  if (bottomNav) {
    bottomNav.style.display = 'flex';
    bottomNav.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      bottomNav.style.transform = 'translateY(0)';
      bottomNav.style.opacity = '1';
    }, 150);
  }
  
  if (content) {
    content.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
    setTimeout(() => {
      content.style.transform = 'translateX(0)';
      content.style.opacity = '1';
    }, 200);
  }
  
  // Полностью скрываем экран после анимации
  setTimeout(() => {
    profileScreen.style.display = 'none';
    // Сбрасываем трансформации
    profileScreen.style.transform = '';
    profileScreen.style.transition = '';
    console.log('✅ Экран профиля успешно скрыт');
  }, 600);
  
  currentModal = null;
  if (tg) tg.BackButton.hide();
}

// MODAL MANAGEMENT
function hideCurrentModal() {
  switch(currentModal) {
    case 'add':
      hideAdd();
      break;
    case 'rooms':
      hideRooms();
      break;
    case 'profile':
      hideProfile();
      break;
    default:
      currentModal = null;
      if (tg) tg.BackButton.hide();
  }
}

// PLANS
function savePlan() {
  console.log('savePlan вызвана');
  
  const planTitleEl = document.getElementById('planTitle');
  if (!planTitleEl) {
    console.error('Элемент planTitle не найден');
    return;
  }
  
  const title = planTitleEl.value.trim();
  console.log('Заголовок задачи:', title);
  
  if (!title) {
    console.log('Заголовок пустой, выходим');
    return;
  }
  
  const planRoomEl = document.getElementById('planRoom');
  const planDateEl = document.getElementById('planDate');
  const planTimeEl = document.getElementById('planTime');
  
  const room = planRoomEl ? planRoomEl.value : '';
  const date = (planDateEl ? planDateEl.value : '') || currentDate.toISOString().split('T')[0];
  const time = planTimeEl ? planTimeEl.value : ''; // Получаем время
  
  console.log('Данные задачи:', { title, room, date, time });
  console.log('currentDate:', currentDate);
  console.log('currentDate в формате YYYY-MM-DD:', currentDate.toISOString().split('T')[0]);
  console.log('Дата задачи (date) - строка YYYY-MM-DD:', date);
  
  const plan = {
    id: selectedPlanId || Date.now().toString(),
    title: title,
    date: date,
    time: time || null, // Сохраняем время (может быть null)
    room: room || null,
    completed: false
  };
  
  console.log('Создана задача:', plan);
  
  if (selectedPlanId) {
    const index = plans.findIndex(p => p.id === selectedPlanId);
    if (index !== -1) {
      plans[index] = plan;
      console.log('Задача обновлена');
    }
  } else {
    plans.push(plan);
    console.log('Задача добавлена, всего задач:', plans.length);
  }
  
  savePlans();
  hideAdd();
  currentDate = new Date(date);
  render();
  console.log('savePlan завершена');
}

function clearForm() {
  const planTitle = document.getElementById('planTitle');
  const planDate = document.getElementById('planDate');
  const planTime = document.getElementById('planTime');
  const planRoom = document.getElementById('planRoom');
  
  if (planTitle) planTitle.value = '';
  if (planDate) planDate.value = '';
  if (planTime) planTime.value = '';
  if (planRoom) planRoom.value = '';
}

function showPlanMenu(id, event) {
  console.log('showPlanMenu вызвана для задачи:', id);
  console.log('Event target:', event ? event.target : 'нет события');
  console.log('Event type:', event ? event.type : 'нет события');
  
  // Останавливаем всплытие события
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  selectedPlanId = id;
  const overlay = document.getElementById('overlay');
  if (overlay) {
    overlay.classList.add('show');
    console.log('Меню задачи показано для ID:', id);
  } else {
    console.error('Элемент overlay не найден');
  }
}

function editPlan() {
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) return;
  
  // Fill edit form
  const editPlanTitle = document.getElementById('editPlanTitle');
  if (editPlanTitle) {
    editPlanTitle.value = plan.title;
  } else {
    console.error('Элемент editPlanTitle не найден');
  }
  
  // Format date
  const date = new Date(plan.date);
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  const formattedDate = `${date.getDate()} ${months[date.getMonth()]}. ${date.getFullYear()}г.`;
  
  const editPlanDate = document.getElementById('editPlanDate');
  if (editPlanDate) {
    editPlanDate.textContent = formattedDate;
  } else {
    console.error('Элемент editPlanDate не найден');
  }
  
  // Reset toggles (premium features disabled)
  const notificationToggle = document.getElementById('notificationToggle');
  const importantToggle = document.getElementById('importantToggle');
  
  if (notificationToggle) notificationToggle.classList.remove('active');
  if (importantToggle) importantToggle.classList.remove('active');
  
  hideMenu();
  showEditPlan();
}

function showEditPlan() {
  // Очищаем временную переменную даты
  window.editPlanNewDate = null;
  
  const editPlanScreen = document.getElementById('editPlanScreen');
  const header = document.querySelector('.header');
  
  if (editPlanScreen) {
    editPlanScreen.classList.add('show');
  } else {
    console.error('Элемент editPlanScreen не найден');
  }
  
  if (header) {
    header.style.display = 'none';
  }
}

function hideEditPlan() {
  const editPlanScreen = document.getElementById('editPlanScreen');
  const header = document.querySelector('.header');
  
  if (editPlanScreen) {
    editPlanScreen.classList.remove('show');
  } else {
    console.error('Элемент editPlanScreen не найден');
  }
  
  if (header) {
    header.style.display = 'flex';
  }
}

function toggleNotification() {
  // Premium feature - show popup
  showPopup(
    'Премиум функция',
    'Уведомления доступны только с подпиской Премиум Трекер',
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function toggleImportant() {
  // Premium feature - show popup
  showPopup(
    'Премиум функция', 
    'Пометка «Важная» доступна только с подпиской Премиум Трекер',
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function showEditDatePicker() {
  showPopup(
    'Изменить дату',
    'Выберите новую дату для задачи',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сегодня', type: 'confirm', action: () => setEditDate(0) },
      { text: 'Завтра', type: 'confirm', action: () => setEditDate(1) }
    ]
  );
}

function setEditDate(daysOffset) {
  const newDate = new Date();
  newDate.setDate(newDate.getDate() + daysOffset);
  
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  const formattedDate = `${newDate.getDate()} ${months[newDate.getMonth()]}. ${newDate.getFullYear()}г.`;
  
  const editPlanDate = document.getElementById('editPlanDate');
  if (editPlanDate) {
    editPlanDate.textContent = formattedDate;
  } else {
    console.error('Элемент editPlanDate не найден');
  }
  
  // Сохраняем новую дату в временную переменную
  window.editPlanNewDate = newDate.toISOString().split('T')[0];
  
  hidePopup();
}

function savePlanEdit() {
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) return;
  
  const editPlanTitle = document.getElementById('editPlanTitle');
  if (!editPlanTitle) {
    console.error('Элемент editPlanTitle не найден');
    return;
  }
  
  const newTitle = editPlanTitle.value.trim();
  if (!newTitle) return;
  
  // Обновляем только название, дату изменяем только если была выбрана новая
  plan.title = newTitle;
  
  // Если была выбрана новая дата через setEditDate
  if (window.editPlanNewDate) {
    plan.date = window.editPlanNewDate;
    window.editPlanNewDate = null; // Очищаем временную переменную
  }
  
  savePlans();
  render();
  hideEditPlan();
}

function deletePlanFromEdit() {
  if (!selectedPlanId) {
    console.error('Нет выбранной задачи для удаления');
    return;
  }
  
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) {
    console.error('Задача не найдена:', selectedPlanId);
    return;
  }
  
  showPopup(
    'Удалить задачу?',
    `Вы уверены, что хотите удалить задачу "${plan.title}"?`,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: confirmDeleteFromEdit }
    ]
  );
}

function confirmDeleteFromEdit() {
  if (!selectedPlanId) {
    console.error('Нет ID задачи для удаления');
    return;
  }
  
  console.log('Удаляем задачу с ID:', selectedPlanId);
  console.log('Планы до удаления:', plans.length);
  
  const initialLength = plans.length;
  plans = plans.filter(p => p.id !== selectedPlanId);
  
  console.log('Планы после удаления:', plans.length);
  
  if (plans.length === initialLength) {
    console.error('Задача не была удалена - не найдена в массиве');
    return;
  }
  
  savePlans();
  hidePopup();
  hideEditPlan();
  render();
  
  console.log('Задача успешно удалена');
}

function hideMenu() {
  const overlay = document.getElementById('overlay');
  if (overlay) {
    overlay.classList.remove('show');
  } else {
    console.error('Элемент overlay не найден');
  }
  selectedPlanId = null;
}

function deletePlan() {
  if (!selectedPlanId) {
    console.error('Нет выбранной задачи для удаления');
    return;
  }
  
  const plan = plans.find(p => p.id === selectedPlanId);
  if (!plan) {
    console.error('Задача не найдена:', selectedPlanId);
    return;
  }
  
  showPopup(
    'Удалить задачу?',
    `Вы уверены, что хотите удалить задачу "${plan.title}"?`,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: confirmDeletePlan }
    ]
  );
}

function confirmDeletePlan() {
  if (!selectedPlanId) {
    console.error('Нет ID задачи для удаления');
    return;
  }
  
  console.log('Удаляем задачу с ID:', selectedPlanId);
  console.log('Планы до удаления:', plans.length);
  
  const initialLength = plans.length;
  plans = plans.filter(p => p.id !== selectedPlanId);
  
  console.log('Планы после удаления:', plans.length);
  
  if (plans.length === initialLength) {
    console.error('Задача не была удалена - не найдена в массиве');
    return;
  }
  
  savePlans();
  hidePopup();
  hideMenu();
  render();
  
  console.log('Задача успешно удалена');
}

function toggleComplete(id, event) {
  // Останавливаем всплытие события
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }
  
  const plan = plans.find(p => p.id === id);
  if (!plan) {
    return;
  }
  
  const planElement = event ? event.target.closest('.plan') : null;
  const checkbox = event ? event.target : null;
  
  if (plan.completed) {
    // Убираем выполнение
    plan.completed = false;
    if (planElement) planElement.classList.remove('completed');
    if (checkbox) checkbox.classList.remove('checked');
    
    // 🍽️ СИНХРОНИЗАЦИЯ С ПИТАНИЕМ: убираем выполнение приема пищи
    if (plan.createdFromMeal && plan.mealId && plan.date) {
      if (!nutritionData.meals[plan.date]) {
        nutritionData.meals[plan.date] = {};
      }
      if (!nutritionData.meals[plan.date][plan.mealId]) {
        nutritionData.meals[plan.date][plan.mealId] = {};
      }
      nutritionData.meals[plan.date][plan.mealId].completed = false;
      saveNutritionData();
      
      // Обновляем отображение питания если мы на этой вкладке
      if (currentTab === 'nutrition') {
        renderNutritionDay();
      }
    }
  } else {
    // Отмечаем как выполненное
    plan.completed = true;
    
    // Сначала анимируем чекбокс
    if (checkbox) checkbox.classList.add('checked');
    
    // 🍽️ СИНХРОНИЗАЦИЯ С ПИТАНИЕМ: отмечаем прием пищи как выполненный
    if (plan.createdFromMeal && plan.mealId && plan.date) {
      if (!nutritionData.meals[plan.date]) {
        nutritionData.meals[plan.date] = {};
      }
      if (!nutritionData.meals[plan.date][plan.mealId]) {
        nutritionData.meals[plan.date][plan.mealId] = {};
      }
      nutritionData.meals[plan.date][plan.mealId].completed = true;
      saveNutritionData();
      
      // Обновляем отображение питания если мы на этой вкладке
      if (currentTab === 'nutrition') {
        renderNutritionDay();
      }
    }
    
    // Затем через небольшую задержку добавляем класс completed
    setTimeout(() => {
      if (planElement) planElement.classList.add('completed');
      
      // Добавляем небольшую вибрацию для тактильной обратной связи
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }, 150);
  }
  
  savePlans();
  updateProgress();
}

function updateProgress() {
  try {
    // Проверяем, что мы на вкладке задач
    if (currentTab !== 'tasks') return;
    
    const todayPlans = getPlansForDate(currentDate);
    const completedCount = todayPlans.filter(p => p.completed).length;
    const totalCount = todayPlans.length;
    const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
    
    // Обновляем круглый прогресс-бар
    const progressCircle = document.getElementById('progressCircle');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressContainer = document.getElementById('progressContainer');
    const progressLabel = document.getElementById('progressLabel');
    const progressStats = document.getElementById('progressStats');
    
    // Проверяем наличие элементов
    if (!progressCircle || !progressPercentage || !progressContainer || !progressLabel || !progressStats) {
      console.log('Не все элементы прогресса найдены');
      return;
    }
    
    // Анимируем заполнение круга
    animateCircleProgress(progressCircle, progressPercent);
    
    // Плавно обновляем процент только при изменении
    const currentPercent = parseInt(progressPercentage.textContent) || 0;
    const targetPercent = Math.round(progressPercent);
    
    if (currentPercent !== targetPercent) {
      animatePercentage(progressPercentage, currentPercent, targetPercent);
    }
    
    progressStats.textContent = `${completedCount}/${totalCount}`;
    
    // Update progress label and animations based on completion
    if (totalCount === 0) {
      progressLabel.textContent = 'Планов нет';
      removeCompletionAnimations();
    } else if (completedCount === totalCount && totalCount > 0) {
      progressLabel.textContent = 'День завершён! 🎉';
      addCompletionAnimations();
    } else {
      progressLabel.textContent = 'Прогресс дня';
      removeCompletionAnimations();
    }
  } catch (e) {
    console.error('Ошибка в функции updateProgress:', e);
  }
}

function animateCircleProgress(circleElement, targetPercent) {
  // Убираем класс анимации завершения если есть
  circleElement.classList.remove('completed');
  
  // Получаем текущий прогресс из элемента
  const currentAngle = parseFloat(circleElement.dataset.currentAngle || '0');
  const targetAngle = (targetPercent / 100) * 360;
  
  // Если значения одинаковые, не анимируем
  if (Math.abs(currentAngle - targetAngle) < 1) {
    return;
  }
  
  // Сохраняем целевой угол
  circleElement.dataset.currentAngle = targetAngle;
  
  // Анимируем плавно через JavaScript
  const duration = 1500; // 1.5 секунды
  const startTime = performance.now();
  const startAngle = currentAngle;
  const angleChange = targetAngle - startAngle;
  
  function updateProgress(currentTime) {
    const elapsed = currentTime - startTime;
    const progress = Math.min(elapsed / duration, 1);
    
    // Используем easing функцию cubic-bezier(0.4, 0, 0.2, 1)
    const easedProgress = progress < 0.5 
      ? 2 * progress * progress 
      : 1 - Math.pow(-2 * progress + 2, 2) / 2;
    
    const currentProgressAngle = startAngle + (angleChange * easedProgress);
    
    // Обновляем фон круга
    if (currentProgressAngle <= 0) {
      circleElement.style.background = `conic-gradient(
        from 0deg,
        rgba(0, 0, 0, 0.2) 0deg
      )`;
    } else {
      circleElement.style.background = `conic-gradient(
        from 0deg,
        var(--accent-primary) 0deg,
        var(--accent-secondary) ${currentProgressAngle * 0.33}deg,
        var(--accent-soft) ${currentProgressAngle * 0.66}deg,
        var(--accent-primary) ${currentProgressAngle}deg,
        rgba(0, 0, 0, 0.2) ${currentProgressAngle}deg
      )`;
    }
    
    // Продолжаем анимацию если не закончена
    if (progress < 1) {
      requestAnimationFrame(updateProgress);
    }
  }
  
  requestAnimationFrame(updateProgress);
}

function animatePercentage(element, from, to) {
  const duration = 1200; // Синхронизируем с анимацией круга
  const steps = Math.abs(to - from);
  if (steps === 0) return;
  
  const stepDuration = duration / steps;
  const increment = to > from ? 1 : -1;
  let current = from;
  
  // Добавляем небольшую задержку для синхронизации
  setTimeout(() => {
    const timer = setInterval(() => {
      current += increment;
      element.textContent = current + '%';
      
      if (current === to) {
        clearInterval(timer);
      }
    }, stepDuration);
  }, 200);
}

function addCompletionAnimations() {
  const progressContainer = document.getElementById('progressContainer');
  const progressCircle = document.getElementById('progressCircle');
  const progressPercentage = document.getElementById('progressPercentage');
  
  // Добавляем задержку для красивого эффекта
  setTimeout(() => {
    progressContainer.classList.add('completed');
    progressCircle.classList.add('completed');
    progressPercentage.classList.add('completed');
    
    // Добавляем конфетти эффект
    createConfetti();
  }, 500);
}

function removeCompletionAnimations() {
  const progressContainer = document.getElementById('progressContainer');
  const progressCircle = document.getElementById('progressCircle');
  const progressPercentage = document.getElementById('progressPercentage');
  
  progressContainer.classList.remove('completed');
  progressCircle.classList.remove('completed');
  progressPercentage.classList.remove('completed');
}

function createConfetti() {
  // Простой конфетти эффект
  const progressContainer = document.getElementById('progressContainer');
  
  for (let i = 0; i < 20; i++) {
    const confetti = document.createElement('div');
    confetti.style.cssText = `
      position: absolute;
      width: 6px;
      height: 6px;
      background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      animation: confetti-fall ${1 + Math.random()}s ease-out forwards;
    `;
    
    confetti.style.setProperty('--random-x', (Math.random() - 0.5) * 200 + 'px');
    confetti.style.setProperty('--random-y', (Math.random() - 0.5) * 200 + 'px');
    
    progressContainer.appendChild(confetti);
    
    // Удаляем конфетти через 2 секунды
    setTimeout(() => {
      if (confetti.parentNode) {
        confetti.parentNode.removeChild(confetti);
      }
    }, 2000);
  }
}

function celebrateCompletion() {
  // Эта функция теперь не нужна, так как анимация постоянная
}

// CALENDAR
function showDatePicker() {
  calendarDate = new Date(currentDate);
  renderCalendar();
  const calendar = document.getElementById('calendar');
  if (calendar) {
    calendar.classList.add('show');
  } else {
    console.error('Элемент calendar не найден');
  }
}

function hideCalendar() {
  const calendar = document.getElementById('calendar');
  if (calendar) {
    calendar.classList.remove('show');
  } else {
    console.error('Элемент calendar не найден');
  }
}

function changeCalendarMonth(direction) {
  calendarDate.setMonth(calendarDate.getMonth() + direction);
  renderCalendar();
}

function selectDate(selectedDate) {
  currentDate = new Date(selectedDate);
  
  // НОВАЯ СИСТЕМА: Синхронизируем разделы при выборе даты
  syncSectionsToPlans(currentDate);
  
  render();
  hideCalendar();
}

function renderCalendar() {
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth();
  
  const monthNames = [
    'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
    'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
  ];
  
  const calendarTitle = document.getElementById('calendarTitle');
  if (calendarTitle) {
    calendarTitle.textContent = `${monthNames[month]} ${year}`;
  } else {
    console.error('Элемент calendarTitle не найден');
  }
  
  const firstDay = new Date(year, month, 1);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - (firstDay.getDay() || 7) + 1);
  
  const grid = document.getElementById('calendarGrid');
  if (!grid) {
    console.error('Элемент calendarGrid не найден');
    return;
  }
  
  grid.innerHTML = '';
  
  const today = new Date();
  const selectedDate = new Date(currentDate);
  
  for (let i = 0; i < 42; i++) {
    const currentCalendarDate = new Date(startDate);
    currentCalendarDate.setDate(startDate.getDate() + i);
    
    const button = document.createElement('button');
    button.className = 'calendar-day';
    button.textContent = currentCalendarDate.getDate();
    button.onclick = () => selectDate(currentCalendarDate);
    
    if (currentCalendarDate.getMonth() !== month) {
      button.classList.add('other-month');
    }
    if (currentCalendarDate.toDateString() === today.toDateString()) {
      button.classList.add('today');
    }
    if (currentCalendarDate.toDateString() === selectedDate.toDateString()) {
      button.classList.add('selected');
    }
    
    grid.appendChild(button);
  }
}

// ROOMS
function showAddRoom() {
  selectedRoomIcon = ICONS.navigation.home; // Используем единую систему иконок
  showRoomIconSelector();
}

function showRoomIconSelector() {
  const roomIcons = ICONS.getAllForSelection();
  
  // Создаем HTML для селектора иконок
  let iconSelectorHTML = '<div class="icon-selector">';
  roomIcons.forEach(icon => {
    const selectedClass = icon === selectedRoomIcon ? 'selected' : '';
    iconSelectorHTML += `
      <div class="icon-option ${selectedClass}" onclick="selectRoomIcon('${icon}')">
        ${icon}
      </div>
    `;
  });
  iconSelectorHTML += '</div>';
  
  // Показываем попап с селектором иконок
  document.getElementById('popupTitle').textContent = 'Выберите иконку';
  document.getElementById('popupMessage').innerHTML = iconSelectorHTML;
  
  const buttonsContainer = document.getElementById('popupButtons');
  buttonsContainer.innerHTML = `
    <button class="popup-btn cancel" onclick="hidePopup()">Отмена</button>
    <button class="popup-btn confirm" onclick="showRoomNameInput()">Далее</button>
  `;
  
  document.getElementById('popup').classList.add('show');
}

function selectRoomIcon(icon) {
  selectedRoomIcon = icon;
  
  // Обновляем визуальное выделение
  document.querySelectorAll('.icon-option').forEach(el => {
    el.classList.remove('selected');
  });
  event.target.classList.add('selected');
}

function showRoomNameInput() {
  hidePopup();
  
  // Показываем попап с вводом названия
  setTimeout(() => {
    showPopup(
      `${selectedRoomIcon} Новый раздел`,
      '',
      [
        { text: 'Отмена', type: 'cancel', action: hidePopup },
        { text: 'Добавить', type: 'confirm', action: addRoom }
      ],
      true
    );
  }, 100);
}

function addRoom() {
  const input = document.querySelector('.popup-input');
  const roomName = input.value.trim();
  
  if (!roomName) return;
  
  // Проверяем существование раздела по имени
  const existingRoom = rooms.find(room => {
    const name = typeof room === 'string' ? room : room.name;
    return name === roomName;
  });
  
  if (existingRoom) {
    showPopup('Ошибка', 'Раздел с таким названием уже существует.', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  // Добавляем раздел как объект с иконкой
  rooms.push({
    name: roomName,
    icon: selectedRoomIcon
  });
  
  saveRooms();
  renderRooms();
  updateRoomsSelect();
  hidePopup();
}

function editRoom(roomName) {
  console.log('Редактируем раздел:', roomName);
  
  // Находим раздел
  const room = rooms.find(r => {
    const name = typeof r === 'string' ? r : r.name;
    return name === roomName;
  });
  
  if (!room) {
    console.error('Раздел не найден:', roomName);
    return;
  }
  
  const currentName = typeof room === 'string' ? room : room.name;
  const currentIcon = typeof room === 'string' ? ICONS.navigation.home : room.icon;
  
  // Устанавливаем текущую иконку для редактирования
  selectedRoomIcon = currentIcon;
  
  // Показываем селектор иконок с текущей иконкой
  const roomIcons = ICONS.getAllForSelection();
  
  // Создаем HTML для селектора иконок
  let iconSelectorHTML = '<div class="icon-selector">';
  roomIcons.forEach(icon => {
    const selectedClass = icon === selectedRoomIcon ? 'selected' : '';
    iconSelectorHTML += `
      <div class="icon-option ${selectedClass}" onclick="selectRoomIcon('${icon}')">
        ${icon}
      </div>
    `;
  });
  iconSelectorHTML += '</div>';
  
  // Показываем попап с редактированием
  document.getElementById('popupTitle').textContent = 'Редактировать раздел';
  document.getElementById('popupMessage').innerHTML = `
    <div style="margin-bottom: 16px;">
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary);">Название:</label>
      <input type="text" id="editRoomName" value="${escapeHtml(currentName)}" 
             style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 8px; background: var(--bg-card);">
    </div>
    <div>
      <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary);">Иконка:</label>
      ${iconSelectorHTML}
    </div>
  `;
  
  const buttonsContainer = document.getElementById('popupButtons');
  buttonsContainer.innerHTML = `
    <button class="popup-btn cancel" onclick="hidePopup()">Отмена</button>
    <button class="popup-btn confirm" onclick="saveEditedRoom('${escapeHtml(currentName)}')">Сохранить</button>
  `;
  
  document.getElementById('popup').classList.add('show');
}

function saveEditedRoom(oldName) {
  const newName = document.getElementById('editRoomName').value.trim();
  
  if (!newName) {
    alert('Введите название раздела');
    return;
  }
  
  // Проверяем, не существует ли уже раздел с таким именем (кроме текущего)
  const existingRoom = rooms.find(r => {
    const name = typeof r === 'string' ? r : r.name;
    return name === newName && name !== oldName;
  });
  
  if (existingRoom) {
    alert('Раздел с таким названием уже существует');
    return;
  }
  
  // Находим и обновляем раздел
  const roomIndex = rooms.findIndex(r => {
    const name = typeof r === 'string' ? r : r.name;
    return name === oldName;
  });
  
  if (roomIndex !== -1) {
    // Обновляем раздел
    rooms[roomIndex] = {
      name: newName,
      icon: selectedRoomIcon
    };
    
    // Обновляем все планы, которые используют этот раздел
    plans.forEach(plan => {
      if (plan.room === oldName) {
        plan.room = newName;
      }
    });
    
    // Сохраняем изменения
    saveRooms();
    savePlans();
    
    // Обновляем интерфейс
    renderRooms();
    updateRoomsSelect();
    renderPlans();
    
    console.log(`✅ Раздел "${oldName}" переименован в "${newName}" с иконкой ${selectedRoomIcon}`);
  }
  
  hidePopup();
}

function deleteRoom(roomName) {
  showPopup(
    'Удалить раздел?',
    `Раздел "${roomName}" будет удален.`,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: () => confirmDeleteRoom(roomName) }
    ]
  );
}

function confirmDeleteRoom(roomName) {
  rooms = rooms.filter(room => {
    const name = typeof room === 'string' ? room : room.name;
    return name !== roomName;
  });
  saveRooms();
  renderRooms();
  updateRoomsSelect();
  hidePopup();
}

// SECTIONS MANAGEMENT - УПРАВЛЕНИЕ РАЗДЕЛАМИ С ПРАВИЛАМИ
function showSectionsManager() {
  // Создаем модальное окно для управления разделами
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'sectionsModal';
  
  modal.innerHTML = `
    <div class="modal-header">
      <h2 class="modal-title">Управление разделами</h2>
      <button class="header-btn" onclick="hideSectionsManager()">Закрыть</button>
    </div>
    <div class="modal-content">
      <div class="sections-list" id="sectionsList">
        <!-- Список разделов будет здесь -->
      </div>
      <button class="btn" onclick="showAddSection()" style="margin-top: 20px;">
        + Добавить раздел
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  renderSectionsList();
}

function hideSectionsManager() {
  const modal = document.getElementById('sectionsModal');
  if (modal) {
    modal.remove();
  }
}

function renderSectionsList() {
  const container = document.getElementById('sectionsList');
  if (!container) return;
  
  let html = '';
  
  sections.forEach(section => {
    const activityText = getActivityRuleText(section.activityRule);
    const tasksCount = section.templateTasks ? section.templateTasks.length : 0;
    
    html += `
      <div class="section-item" style="
        background: var(--bg-card);
        border: 1px solid var(--border-soft);
        border-radius: var(--border-radius);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        cursor: pointer;
      " onclick="editSection('${section.id}')">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <h3 style="margin: 0 0 8px 0; color: var(--text-primary);">${section.icon} ${section.name}</h3>
            <p style="margin: 0 0 8px 0; color: var(--text-secondary); font-size: 14px;">${activityText}</p>
            <p style="margin: 0; color: var(--text-muted); font-size: 12px;">${tasksCount} задач(и)</p>
          </div>
          <button class="delete-meal-btn" onclick="deleteSection('${section.id}', event)" style="margin-left: 12px;">×</button>
        </div>
      </div>
    `;
  });
  
  if (sections.length === 0) {
    html = `
      <div style="text-align: center; padding: 40px; color: var(--text-muted);">
        <p>Пока нет разделов</p>
        <p style="font-size: 14px; margin-top: 8px;">Создайте раздел с рутинными задачами</p>
      </div>
    `;
  }
  
  container.innerHTML = html;
}

function getActivityRuleText(rule) {
  if (!rule) return 'Не активен';
  
  switch (rule.type) {
    case 'daily':
      return 'Каждый день';
    case 'every_other_day':
      return 'Через день';
    case 'weekdays':
      if (Array.isArray(rule.value)) {
        const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
        const selectedDays = rule.value.map(d => days[d]).join(', ');
        return `По дням: ${selectedDays}`;
      }
      return 'По дням недели';
    default:
      return 'Не активен';
  }
}

function showAddSection() {
  hideSectionsManager();
  
  // Создаем форму для добавления раздела
  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'addSectionModal';
  
  modal.innerHTML = `
    <div class="modal-header">
      <h2 class="modal-title">Новый раздел</h2>
      <button class="header-btn" onclick="hideAddSection()">Отмена</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="label">Название раздела</label>
        <input type="text" class="input" id="sectionName" placeholder="Например: Утренняя зарядка">
      </div>
      
      <div class="form-group">
        <label class="label">Иконка</label>
        <div id="sectionIconSelector" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;">
          <!-- Иконки будут здесь -->
        </div>
      </div>
      
      <div class="form-group">
        <label class="label">Правило активности</label>
        <select class="select" id="activityType" onchange="updateActivityOptions()">
          <option value="daily">Каждый день</option>
          <option value="every_other_day">Через день</option>
          <option value="weekdays">По дням недели</option>
        </select>
      </div>
      
      <div class="form-group" id="weekdaysSelector" style="display: none;">
        <label class="label">Выберите дни недели</label>
        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px;">
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="1"> Пн</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="2"> Вт</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="3"> Ср</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="4"> Чт</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="5"> Пт</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="6"> Сб</label>
          <label style="text-align: center; font-size: 12px;"><input type="checkbox" value="0"> Вс</label>
        </div>
      </div>
      
      <div class="form-group">
        <label class="label">Шаблонные задачи</label>
        <div id="templateTasks">
          <div class="template-task" style="display: flex; gap: 8px; margin-bottom: 8px;">
            <input type="text" class="input" placeholder="Название задачи" style="flex: 1;">
            <input type="time" class="input" style="width: 100px;">
            <button type="button" onclick="removeTemplateTask(this)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px;">×</button>
          </div>
        </div>
        <button type="button" onclick="addTemplateTask()" class="header-btn" style="margin-top: 8px;">+ Добавить задачу</button>
      </div>
      
      <button class="btn" onclick="saveNewSection()" style="margin-top: 20px; width: 100%;">
        Создать раздел
      </button>
    </div>
  `;
  
  document.body.appendChild(modal);
  renderSectionIcons();
}

function hideAddSection() {
  const modal = document.getElementById('addSectionModal');
  if (modal) {
    modal.remove();
  }
  showSectionsManager();
}

function renderSectionIcons() {
  const container = document.getElementById('sectionIconSelector');
  if (!container) return;
  
  const icons = ICONS.getSectionIcons();
  let selectedIcon = icons[0];
  
  let html = '';
  icons.forEach((icon, index) => {
    html += `
      <button type="button" onclick="selectSectionIcon('${icon}', this)" 
              class="section-icon-btn ${index === 0 ? 'selected' : ''}"
              style="
                background: ${index === 0 ? 'var(--accent-primary)' : 'var(--bg-tertiary)'};
                color: ${index === 0 ? 'white' : 'var(--text-primary)'};
                border: 1px solid var(--border-soft);
                border-radius: 8px;
                padding: 12px;
                font-size: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
              ">${icon}</button>
    `;
  });
  
  container.innerHTML = html;
  window.selectedSectionIcon = selectedIcon;
}

function selectSectionIcon(icon, button) {
  // Убираем выделение с других кнопок
  document.querySelectorAll('.section-icon-btn').forEach(btn => {
    btn.style.background = 'var(--bg-tertiary)';
    btn.style.color = 'var(--text-primary)';
    btn.classList.remove('selected');
  });
  
  // Выделяем выбранную кнопку
  button.style.background = 'var(--accent-primary)';
  button.style.color = 'white';
  button.classList.add('selected');
  
  window.selectedSectionIcon = icon;
}

function updateActivityOptions() {
  const activityType = document.getElementById('activityType').value;
  const weekdaysSelector = document.getElementById('weekdaysSelector');
  
  if (activityType === 'weekdays') {
    weekdaysSelector.style.display = 'block';
  } else {
    weekdaysSelector.style.display = 'none';
  }
}

function addTemplateTask() {
  const container = document.getElementById('templateTasks');
  const taskDiv = document.createElement('div');
  taskDiv.className = 'template-task';
  taskDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
  
  taskDiv.innerHTML = `
    <input type="text" class="input" placeholder="Название задачи" style="flex: 1;">
    <input type="time" class="input" style="width: 100px;">
    <button type="button" onclick="removeTemplateTask(this)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 8px;">×</button>
  `;
  
  container.appendChild(taskDiv);
}

function removeTemplateTask(button) {
  button.parentElement.remove();
}

function saveNewSection() {
  const name = document.getElementById('sectionName').value.trim();
  if (!name) {
    alert('Введите название раздела');
    return;
  }
  
  const activityType = document.getElementById('activityType').value;
  let activityRule = { type: activityType };
  
  if (activityType === 'weekdays') {
    const selectedDays = Array.from(document.querySelectorAll('#weekdaysSelector input:checked'))
      .map(cb => parseInt(cb.value));
    
    if (selectedDays.length === 0) {
      alert('Выберите хотя бы один день недели');
      return;
    }
    
    activityRule.value = selectedDays;
  }
  
  // Собираем шаблонные задачи
  const templateTasks = [];
  document.querySelectorAll('.template-task').forEach((taskDiv, index) => {
    const titleInput = taskDiv.querySelector('input[type="text"]');
    const timeInput = taskDiv.querySelector('input[type="time"]');
    
    const title = titleInput.value.trim();
    if (title) {
      templateTasks.push({
        id: Date.now() + index,
        title: title,
        time: timeInput.value || ''
      });
    }
  });
  
  if (templateTasks.length === 0) {
    alert('Добавьте хотя бы одну задачу');
    return;
  }
  
  // Создаем новый раздел
  const newSection = {
    id: Date.now(),
    name: name,
    icon: window.selectedSectionIcon || '🏃',
    activityRule: activityRule,
    templateTasks: templateTasks,
    createdAt: new Date().toISOString()
  };
  
  sections.push(newSection);
  saveSections();
  
  // Синхронизируем с планами
  syncSectionsToPlans(currentDate);
  
  // Обновляем отображение
  render();
  updateSectionsStats(); // Обновляем статистику
  
  hideAddSection();
  showSectionsManager();
}

function deleteSection(sectionId, event) {
  if (event) {
    event.stopPropagation();
  }
  
  const section = sections.find(s => s.id == sectionId);
  if (!section) return;
  
  if (confirm(`Удалить раздел "${section.name}"?\n\nВсе связанные задачи также будут удалены.`)) {
    // Удаляем все задачи, созданные из этого раздела
    const initialCount = plans.length;
    plans = plans.filter(plan => plan.sectionId != sectionId);
    const removedTasksCount = initialCount - plans.length;
    
    // Удаляем сам раздел
    sections = sections.filter(s => s.id != sectionId);
    
    saveSections();
    savePlans();
    
    console.log(`Удален раздел "${section.name}" и ${removedTasksCount} связанных задач`);
    
    renderSectionsList();
    render();
    updateSectionsStats(); // Обновляем статистику
  }
}

// PROFILE
function loadProfileData() {
  const userName = localStorage.getItem('planner_userName') || 'Пользователь';
  const firstLetter = userName.charAt(0).toUpperCase();
  
  // Безопасно обновляем элементы профиля
  const profileNameEl = document.getElementById('profileName');
  if (profileNameEl) {
    profileNameEl.textContent = userName;
  }
  
  const avatarCircle = document.querySelector('.avatar-circle');
  if (avatarCircle) {
    avatarCircle.textContent = firstLetter;
  }
  
  const profileBtn = document.querySelector('.profile-btn');
  if (profileBtn) {
    profileBtn.textContent = firstLetter;
  }
}

function editName() {
  const profileName = document.getElementById('profileName');
  const currentName = profileName ? profileName.textContent : 'Пользователь';
  
  showPopup(
    'Изменить имя',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: saveName }
    ],
    true,
    currentName
  );
}

function saveName() {
  const input = document.querySelector('.popup-input');
  if (!input) {
    console.error('Элемент popup-input не найден');
    return;
  }
  
  const newName = input.value.trim();
  
  if (newName) {
    localStorage.setItem('planner_userName', newName);
    loadProfileData();
  }
  
  hidePopup();
}

function showAccount() {
  showPopup(
    'Аккаунт',
    `Планов создано: ${plans.length}\nРазделов создано: ${rooms.length}\nДата регистрации: 27 января 2025\nПодписка: Бесплатный план`,
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function showSettings() {
  showPopup(
    'Настройки',
    'Уведомления: Включены\nЧасовой пояс: GMT+3 (Москва)\nЯзык: Русский\nТема: Системная',
    [{ text: 'OK', type: 'confirm', action: hidePopup }]
  );
}

function showSupport() {
  showPopup(
    'Поддержка',
    'Вы будете перенаправлены в Telegram для отправки сообщения.',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Написать', type: 'confirm', action: openSupport }
    ]
  );
}

function openSupport() {
  const message = 'Здравствуйте! У меня есть вопрос по приложению Планер v6.0.';
  const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(message)}`;
  window.open(telegramUrl, '_blank');
  hidePopup();
}

// POPUP SYSTEM
function showPopup(title, message, buttons, hasInput = false, inputValue = '') {
  const popupTitle = document.getElementById('popupTitle');
  const popupMessage = document.getElementById('popupMessage');
  const buttonsContainer = document.getElementById('popupButtons');
  const popup = document.getElementById('popup');
  
  if (!popupTitle || !popupMessage || !buttonsContainer || !popup) {
    console.error('Не найдены элементы попапа');
    return;
  }
  
  popupTitle.textContent = title;
  popupMessage.textContent = message;
  buttonsContainer.innerHTML = '';
  
  if (hasInput) {
    const input = document.createElement('input');
    input.className = 'input popup-input';
    input.placeholder = 'Введите текст...';
    input.value = inputValue;
    input.style.marginBottom = '16px';
    
    const popupContent = document.querySelector('.popup-content');
    if (popupContent) {
      popupContent.insertBefore(input, buttonsContainer);
      setTimeout(() => input.focus(), 100);
    }
  }
  
  buttons.forEach(btn => {
    const button = document.createElement('button');
    button.className = `popup-btn ${btn.type}`;
    button.textContent = btn.text;
    button.onclick = btn.action;
    buttonsContainer.appendChild(button);
  });
  
  popup.classList.add('show');
}

function hidePopup() {
  const popup = document.getElementById('popup');
  if (popup) {
    popup.classList.remove('show');
  } else {
    console.error('Элемент popup не найден');
  }
  
  // Remove input if exists
  const existingInput = document.querySelector('.popup-input');
  if (existingInput) {
    existingInput.remove();
  }
}

// TELEGRAM INTEGRATION
if (tg) {
  tg.onEvent('backButtonClicked', () => {
    const editPlanScreen = document.getElementById('editPlanScreen');
    const roomsScreen = document.getElementById('roomsScreen');
    const profileScreen = document.getElementById('profileScreen');
    const addModal = document.getElementById('addModal');
    const overlay = document.getElementById('overlay');
    const calendar = document.getElementById('calendar');
    const popup = document.getElementById('popup');
    
    if (editPlanScreen && editPlanScreen.classList.contains('show')) {
      hideEditPlan();
    } else if (roomsScreen && roomsScreen.classList.contains('show')) {
      hideRooms();
    } else if (profileScreen && profileScreen.classList.contains('show')) {
      hideProfile();
    } else if (addModal && addModal.classList.contains('show')) {
      hideAdd();
    } else if (overlay && overlay.classList.contains('show')) {
      hideMenu();
    } else if (calendar && calendar.classList.contains('show')) {
      hideCalendar();
    } else if (popup && popup.classList.contains('show')) {
      hidePopup();
    } else {
      tg.close();
    }
  });
}

// KEYBOARD EVENTS
document.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const activeElement = document.activeElement;
    if (activeElement && activeElement.classList.contains('popup-input')) {
      e.preventDefault();
      const confirmBtn = document.querySelector('.popup-btn.confirm');
      if (confirmBtn) confirmBtn.click();
    }
  }
  
  if (e.key === 'Escape') {
    const popup = document.getElementById('popup');
    const calendar = document.getElementById('calendar');
    const overlay = document.getElementById('overlay');
    
    if (popup && popup.classList.contains('show')) {
      hidePopup();
    } else if (calendar && calendar.classList.contains('show')) {
      hideCalendar();
    } else if (overlay && overlay.classList.contains('show')) {
      hideMenu();
    }
  }
});

// BOTTOM NAVIGATION
function switchTab(tabName) {
  // Убираем активный класс со всех кнопок
  const navItems = document.querySelectorAll('.nav-item');
  navItems.forEach(item => {
    item.classList.remove('active');
  });
  
  // Добавляем активный класс к выбранной кнопке
  const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
  if (selectedTab) {
    selectedTab.classList.add('active');
  } else {
    console.error(`Вкладка с data-tab="${tabName}" не найдена`);
  }
  
  // Обновляем текущую вкладку
  currentTab = tabName;
  
  // Показываем соответствующий контент
  showTabContent(tabName);
  
  // ПРИНУДИТЕЛЬНЫЙ РЕНДЕРИНГ для вкладки задач
  if (tabName === 'tasks') {
    setTimeout(() => {
      render();
    }, 100);
    setTimeout(() => {
      render();
    }, 500);
  }
  
  // Обновляем заголовок дня для питания
  if (tabName === 'nutrition') {
    updateNutritionDayTitle();
  }
}

function showTabContent(tabName) {
  const content = document.querySelector('.content');
  
  if (!content) {
    console.error('Элемент .content не найден');
    return;
  }
  
  switch(tabName) {
    case 'tasks':
      console.log('Переключаемся на вкладку задач');
      console.log('Планы перед переключением:', plans);
      console.log('Количество планов перед переключением:', plans.length);
      
      // Восстанавливаем оригинальную структуру задач
      content.innerHTML = `
        <div class="progress-container" id="progressContainer">
          <div class="progress-info">
            <div class="progress-label" id="progressLabel">Прогресс дня</div>
            <div class="progress-stats" id="progressStats">0/0</div>
          </div>
          <div class="progress-circle-container">
            <div class="progress-circle" id="progressCircle">
              <div class="progress-circle-inner">
                <div class="progress-percentage" id="progressPercentage">0%</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="empty" id="empty">
          <h2>Планов нет</h2>
          <p>Добавьте первую задачу</p>
          <button class="btn" onclick="showAdd()">Добавить задачу</button>
        </div>
        
        <div class="plans-container" id="plansContainer" style="display:none">
          <div class="plans" id="plans"></div>
        </div>
      `;
      
      // Восстанавливаем правильные стили для content
      content.style.overflow = 'hidden';
      content.style.height = '';
      content.style.display = 'flex';
      content.style.flexDirection = 'column';
      
      // Инициализируем прогресс-бар заново
      const progressCircle = document.getElementById('progressCircle');
      if (progressCircle) {
        progressCircle.dataset.currentAngle = '0';
      }
      
      console.log('Перед render в showTabContent - планы:', plans);
      console.log('Перед render в showTabContent - количество планов:', plans.length);
      
      // Перерендериваем задачи
      render();
      
      console.log('После render в showTabContent');
      break;
      
    case 'nutrition':
      // Показываем интерфейс питания (пока заглушка)
      showNutritionTab();
      break;
      
    case 'habits':
      // Показываем интерфейс привычек (пока заглушка)
      showHabitsTab();
      break;
  }
}

function showNutritionTab() {
  const content = document.querySelector('.content');
  content.innerHTML = `
    <!-- NUTRITION CONTAINER WITH PROPER SCROLL -->
    <div class="nutrition-container">
      <!-- WATER TRACKER - FIXED AT TOP -->
      <div class="water-tracker">
        <div class="water-header">
          <div class="water-info">
            <div class="water-label">💧 Вода сегодня</div>
            <div class="water-stats" id="waterStats">0/8 стаканов</div>
          </div>
          <button class="water-settings-btn" onclick="showWaterSettings()">⚙️</button>
        </div>
        <div class="water-progress">
          <div class="water-progress-bar">
            <div class="water-progress-fill" id="waterProgressFill" style="width: 0%"></div>
          </div>
          <div class="water-controls">
            <button class="water-btn minus" onclick="changeWater(-1)">−</button>
            <span class="water-current" id="waterCurrent" onclick="editWaterAmount()">0</span>
            <button class="water-btn plus" onclick="changeWater(1)">+</button>
          </div>
        </div>
      </div>

      <!-- SCROLLABLE MEALS SECTION -->
      <div class="meals-scroll-container">
        <!-- SINGLE DAY MEALS -->
        <div class="single-day-container">
          <div class="day-card today" id="nutritionDayCard">
            <div class="meals" id="nutritionMeals">
              <!-- Приемы пищи будут добавлены динамически -->
            </div>
          </div>
          
          <!-- ADD MEAL BUTTON - ВЫНЕСЕНА ИЗ КАРТОЧКИ -->
          <div class="add-meal-container">
            <div class="meal add-meal" onclick="addNewMealType()">
              <div class="meal-label">➕ Добавить прием пищи</div>
              <div class="meal-content">Создать новый прием пищи</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Убеждаемся что контент имеет правильную структуру
  content.style.overflow = 'hidden';
  content.style.height = '100%';
  content.style.display = 'flex';
  content.style.flexDirection = 'column';
  
  // Добавляем анимации появления с задержками
  setTimeout(() => {
    const waterTracker = document.querySelector('.water-tracker');
    const dayContainer = document.querySelector('.single-day-container');
    
    if (waterTracker) waterTracker.classList.add('animate-slide-right');
    if (dayContainer) dayContainer.classList.add('animate-in');
  }, 50);
  
  // Инициализируем питание
  initNutrition();
}

function initNutrition() {
  // Загружаем данные питания
  loadNutritionData();
  
  // Рендерим текущий день
  renderNutritionDay();
  
  // Обновляем трекер воды
  updateWaterTracker();
  
  // Обновляем заголовок дня
  updateNutritionDayTitle();
}

// Данные питания
let nutritionData = {
  water: {
    target: 8,
    daily: {} // Изменяем структуру: {date: amount}
  },
  meals: {}, // {date: {mealId: {content: '', time: ''}}}
  mealTypes: { // Типы приемов пищи по дням
    // date: [{id: 'breakfast', name: '🌅 Завтрак', icon: '🌅', time: '08:00'}]
  }
};

let currentNutritionDate = new Date(); // Текущий день для питания

let currentWeekStart = getWeekStart(new Date());

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Понедельник как начало недели
  return new Date(d.setDate(diff));
}

function loadNutritionData() {
  try {
    console.log('Загружаем данные питания...');
    
    const saved = localStorage.getItem('planner_nutrition');
    if (saved) {
      const loadedData = JSON.parse(saved);
      
      // Миграция старой структуры воды
      if (loadedData.water && typeof loadedData.water.current !== 'undefined') {
        console.log('Мигрируем старую структуру воды...');
        // Старая структура - мигрируем
        const oldDate = loadedData.water.date || new Date().toDateString();
        const oldAmount = loadedData.water.current || 0;
        
        nutritionData.water.target = loadedData.water.target || 8;
        nutritionData.water.daily = {};
        nutritionData.water.daily[oldDate] = oldAmount;
        console.log('Миграция воды завершена');
      } else if (loadedData.water && loadedData.water.daily) {
        // Новая структура
        nutritionData.water = loadedData.water;
      }
      
      // Миграция старых данных приемов пищи
      if (loadedData.meals) {
        for (const dateStr in loadedData.meals) {
          const dayMeals = loadedData.meals[dateStr];
          if (typeof dayMeals === 'object' && dayMeals !== null) {
            // Проверяем, есть ли старые ключи (breakfast, lunch, etc.)
            if (dayMeals.breakfast !== undefined || dayMeals.lunch !== undefined) {
              // Это старый формат, оставляем как есть
              continue;
            }
          }
        }
        nutritionData.meals = loadedData.meals;
      }
      
      // Инициализируем mealTypes если его нет
      if (loadedData.mealTypes) {
        nutritionData.mealTypes = loadedData.mealTypes;
      }
      
      console.log('Данные питания успешно загружены');
    } else {
      console.log('Сохраненных данных питания не найдено, используем значения по умолчанию');
    }
    
    // Инициализируем daily если его нет
    if (!nutritionData.water.daily) {
      nutritionData.water.daily = {};
    }
  } catch (e) {
    console.error('Ошибка при загрузке данных питания:', e);
    
    // Инициализируем значениями по умолчанию в случае ошибки
    nutritionData = {
      water: {
        target: 8,
        daily: {}
      },
      meals: {},
      mealTypes: {}
    };
    
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка загрузки', 'Не удалось загрузить данные питания. Используются настройки по умолчанию.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

function saveNutritionData() {
  try {
    localStorage.setItem('planner_nutrition', JSON.stringify(nutritionData));
    console.log('Данные питания успешно сохранены');
  } catch (e) {
    console.error('Ошибка при сохранении данных питания:', e);
    // Показываем уведомление пользователю
    if (typeof showPopup === 'function') {
      showPopup('Ошибка сохранения', 'Не удалось сохранить данные питания. Проверьте свободное место на устройстве.', [
        { text: 'OK', type: 'confirm', action: hidePopup }
      ]);
    }
  }
}

// Навигация по дням питания теперь использует общую функцию changeDay

function renderNutritionDay() {
  try {
    const mealsContainer = document.getElementById('nutritionMeals');
    
    if (!mealsContainer) {
      console.log('Контейнер приемов пищи не найден');
      return;
    }
    
    // ИСПРАВЛЕНО: используем правильный формат даты YYYY-MM-DD
    const dateStr = currentNutritionDate.toISOString().split('T')[0];
    console.log('renderNutritionDay dateStr:', dateStr);
    
    // Получаем приемы пищи для этого дня
    const dayMealTypes = nutritionData.mealTypes[dateStr] || [];
    const dayMeals = nutritionData.meals[dateStr] || {};
    
    // Анимация исчезновения старого контента
    mealsContainer.style.opacity = '0';
    mealsContainer.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
      try {
        let html = '';
        
        // Рендерим существующие приемы пищи
        dayMealTypes.forEach((mealType, index) => {
          try {
            const mealData = dayMeals[mealType.id] || {};
            const mealContent = mealData.content || 'Не запланировано';
            const mealTime = mealData.time || mealType.time || '';
            const isCompleted = mealData.completed || false;
            
            html += `
              <div class="meal animate-in ${isCompleted ? 'completed' : ''}" style="animation-delay: ${index * 0.1}s">
                <div class="meal-with-checkbox">
                  <div class="meal-checkbox ${isCompleted ? 'checked' : ''}" onclick="toggleMealComplete('${dateStr}', '${mealType.id}', event)"></div>
                  <div class="meal-main-content" onclick="editMeal('${dateStr}', '${mealType.id}')">
                    <div class="meal-header">
                      <div class="meal-label">
                        ${mealType.icon} ${mealType.name}
                        ${mealTime ? `<span class="meal-time-badge">${mealTime}</span>` : ''}
                      </div>
                      <button class="delete-meal-btn" onclick="event.stopPropagation(); deleteMealType('${dateStr}', '${mealType.id}')">×</button>
                    </div>
              <div class="meal-content">${mealContent}</div>
            </div>
          </div>
        </div>
      `;
          } catch (e) {
            console.error('Ошибка при рендеринге приема пищи:', e);
          }
        });
    
        mealsContainer.innerHTML = html;
        // Анимация появления нового контента
        mealsContainer.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
        mealsContainer.style.opacity = '1';
        mealsContainer.style.transform = 'translateY(0)';
        
        // Добавляем анимации для новых элементов
        setTimeout(() => {
          const meals = mealsContainer.querySelectorAll('.meal');
          meals.forEach((meal, index) => {
            meal.style.animationDelay = `${index * 0.1}s`;
            meal.classList.add('animate-in');
            
            // Устанавливаем ширину текста для уже выполненных приемов пищи
            if (meal.classList.contains('completed')) {
              const mealLabel = meal.querySelector('.meal-label');
              const mealContent = meal.querySelector('.meal-content');
              
              if (mealLabel) {
                try {
                  // Создаем временный элемент для измерения только текста
                  const tempLabel = document.createElement('span');
                  tempLabel.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    white-space: nowrap;
                    font-family: ${window.getComputedStyle(mealLabel).fontFamily};
                    font-size: ${window.getComputedStyle(mealLabel).fontSize};
                    font-weight: ${window.getComputedStyle(mealLabel).fontWeight};
                  `;
                  
                  // Получаем только текст без HTML тегов и значков времени
                  const labelTextOnly = mealLabel.textContent.replace(/\s*\d{2}:\d{2}\s*$/, '').trim();
                  tempLabel.textContent = labelTextOnly;
                  
                  document.body.appendChild(tempLabel);
                  const labelWidth = tempLabel.offsetWidth;
                  document.body.removeChild(tempLabel);
                  
                  mealLabel.style.setProperty('--text-width', labelWidth + 'px');
                } catch (e) {
                  console.log('Ошибка при измерении ширины текста метки:', e);
                }
              }
              
              if (mealContent) {
                try {
                  // Создаем временный элемент для измерения текста контента
                  const tempContent = document.createElement('span');
                  tempContent.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    white-space: nowrap;
                    font-family: ${window.getComputedStyle(mealContent).fontFamily};
                    font-size: ${window.getComputedStyle(mealContent).fontSize};
                    font-weight: ${window.getComputedStyle(mealContent).fontWeight};
                  `;
                  tempContent.textContent = mealContent.textContent;
                  
                  document.body.appendChild(tempContent);
                  const contentWidth = tempContent.offsetWidth;
                  document.body.removeChild(tempContent);
                  
                  mealContent.style.setProperty('--text-width', contentWidth + 'px');
                } catch (e) {
                  console.log('Ошибка при измерении ширины текста контента:', e);
                }
              }
            }
          });
        }, 100);
        
      } catch (e) {
        console.error('Ошибка при рендеринге дня питания в setTimeout:', e);
      }
    }, 200);
  } catch (e) {
    console.error('Ошибка в функции renderNutritionDay:', e);
  }
}

// Функция обновления заголовка дня для питания
function updateNutritionDayTitle() {
  try {
    const dayTitle = document.getElementById('dayTitle');
    const daySubtitle = document.getElementById('daySubtitle');
    
    if (dayTitle && daySubtitle && currentTab === 'nutrition') {
      dayTitle.textContent = formatDate(currentNutritionDate);
      daySubtitle.textContent = formatDateSubtitle(currentNutritionDate);
    } else if (currentTab === 'nutrition') {
      console.log('Элементы заголовка дня не найдены для питания');
    }
  } catch (e) {
    console.error('Ошибка в функции updateNutritionDayTitle:', e);
  }
}

function formatNutritionDate(date) {
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);

  const dayNames = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
  const months = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'];
  
  const dayName = dayNames[date.getDay()];
  const dateStr = `${date.getDate()} ${months[date.getMonth()]}`;

  if (date.toDateString() === today.toDateString()) {
    return `Сегодня, ${dateStr}`;
  }
  if (date.toDateString() === tomorrow.toDateString()) {
    return `Завтра, ${dateStr}`;
  }
  if (date.toDateString() === yesterday.toDateString()) {
    return `Вчера, ${dateStr}`;
  }
  
  return `${dayName}, ${dateStr}`;
}

// Трекер воды
function changeWater(delta) {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  
  // Получаем текущее количество воды для этого дня
  const currentAmount = nutritionData.water.daily[dateStr] || 0;
  
  // Обновляем количество
  nutritionData.water.daily[dateStr] = Math.max(0, currentAmount + delta);
  
  saveNutritionData();
  updateWaterTracker();
}

function editWaterAmount() {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  const currentAmount = nutritionData.water.daily[dateStr] || 0;
  
  showPopup(
    '💧 Количество воды',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: saveWaterAmount }
    ],
    true,
    currentAmount.toString()
  );
  
  setTimeout(() => {
    const input = document.querySelector('.popup-input');
    if (input) {
      input.type = 'number';
      input.min = '0';
      input.placeholder = 'Сколько стаканов выпили?';
      input.select(); // Выделяем текст для быстрого редактирования
    }
  }, 100);
}

function saveWaterAmount() {
  const input = document.querySelector('.popup-input');
  const newAmount = parseInt(input.value.trim());
  
  if (isNaN(newAmount) || newAmount < 0) {
    showPopup('Ошибка', 'Введите корректное количество стаканов (0 или больше)', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  nutritionData.water.daily[dateStr] = newAmount;
  
  saveNutritionData();
  updateWaterTracker();
  hidePopup();
}

function updateWaterTracker() {
  try {
    const waterStats = document.getElementById('waterStats');
    const waterProgressFill = document.getElementById('waterProgressFill');
    const waterCurrent = document.getElementById('waterCurrent');
    
    if (!waterStats || !waterProgressFill || !waterCurrent) {
      console.log('Элементы трекера воды не найдены, пропускаем обновление');
      return;
    }
    
    // Получаем воду для текущего дня питания
    const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
    const current = nutritionData.water.daily[dateStr] || 0;
    const target = nutritionData.water.target;
    const percentage = (current / target) * 100;
    
    // Плавное обновление статистики
    const currentStats = waterStats.textContent;
    const newStats = `${current}/${target} стаканов`;
    
    if (currentStats !== newStats) {
      waterStats.style.opacity = '0.7';
      waterStats.style.transform = 'scale(0.95)';
      
      setTimeout(() => {
        waterStats.textContent = newStats;
        waterStats.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        waterStats.style.opacity = '1';
        waterStats.style.transform = 'scale(1)';
      }, 150);
    }
    
    // Плавное обновление прогресс-бара
    waterProgressFill.style.transition = 'width 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
    waterProgressFill.style.width = `${Math.min(100, percentage)}%`;
    
    // Плавное обновление текущего значения
    const currentValue = parseInt(waterCurrent.textContent) || 0;
    if (currentValue !== current) {
      animateWaterValue(waterCurrent, currentValue, current);
    }
    
    // Добавляем класс completed если цель достигнута
    const waterTracker = document.querySelector('.water-tracker');
    if (waterTracker) {
      if (current >= target) {
        if (!waterTracker.classList.contains('completed')) {
          waterTracker.classList.add('completed');
          // Добавляем небольшую вибрацию при достижении цели
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
          }
          // Показываем уведомление о достижении цели
          showWaterCompletionEffect();
        }
      } else {
        waterTracker.classList.remove('completed');
      }
    }
  } catch (e) {
    console.error('Ошибка в функции updateWaterTracker:', e);
  }
}

function animateWaterValue(element, from, to) {
  const duration = 600;
  const steps = Math.abs(to - from);
  if (steps === 0) return;
  
  const stepDuration = duration / steps;
  const increment = to > from ? 1 : -1;
  let current = from;
  
  element.style.transform = 'scale(1.1)';
  element.style.color = '#3b82f6';
  
  const timer = setInterval(() => {
    current += increment;
    element.textContent = current;
    
    if (current === to) {
      clearInterval(timer);
      // Возвращаем к нормальному состоянию
      setTimeout(() => {
        element.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
        element.style.transform = 'scale(1)';
        element.style.color = '';
      }, 100);
    }
  }, stepDuration);
}

function showWaterCompletionEffect() {
  // Создаем эффект капель воды при достижении цели
  const waterTracker = document.querySelector('.water-tracker');
  if (!waterTracker) return;
  
  for (let i = 0; i < 8; i++) {
    const drop = document.createElement('div');
    drop.style.cssText = `
      position: absolute;
      width: 8px;
      height: 8px;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10;
      left: ${50 + (Math.random() - 0.5) * 60}%;
      top: ${30 + (Math.random() - 0.5) * 40}%;
      animation: water-drop-fall ${1 + Math.random() * 0.5}s ease-out forwards;
    `;
    
    drop.style.setProperty('--random-x', (Math.random() - 0.5) * 100 + 'px');
    drop.style.setProperty('--random-y', (Math.random() + 1) * 50 + 'px');
    
    waterTracker.appendChild(drop);
    
    // Удаляем каплю через 2 секунды
    setTimeout(() => {
      if (drop.parentNode) {
        drop.parentNode.removeChild(drop);
      }
    }, 2000);
  }
}

function showWaterSettings() {
  showPopup(
    '💧 Настройки воды',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: saveWaterSettings }
    ],
    true,
    nutritionData.water.target.toString()
  );
  
  // Меняем placeholder для ввода числа
  setTimeout(() => {
    const input = document.querySelector('.popup-input');
    if (input) {
      input.type = 'number';
      input.min = '1';
      input.placeholder = 'Сколько стаканов в день?';
    }
  }, 100);
}

function saveWaterSettings() {
  const input = document.querySelector('.popup-input');
  const newTarget = parseInt(input.value.trim());
  
  if (!newTarget || newTarget < 1) {
    showPopup('Ошибка', 'Введите число больше 0', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  nutritionData.water.target = newTarget;
  saveNutritionData();
  updateWaterTracker();
  hidePopup();
}

// Добавление нового типа приема пищи
function addNewMealType() {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  
  // Показываем специальный селектор типов приемов пищи
  showMealTypeSelector(dateStr);
}

function showMealTypeSelector(dateStr) {
  // Создаем модальное окно для выбора типа приема пищи
  const modal = document.createElement('div');
  modal.className = 'meal-type-modal';
  modal.innerHTML = `
    <div class="meal-type-modal-content">
      <div class="meal-type-header">
        <h3>🍽️ Выберите тип приема пищи</h3>
        <button class="meal-type-close" onclick="closeMealTypeSelector()">×</button>
      </div>
      <div class="meal-type-options">
        <div class="meal-type-option" onclick="selectMealType('breakfast', 'Завтрак', '🌅', '08:00')">
          <span class="meal-type-icon">🌅</span>
          <span class="meal-type-name">Завтрак</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('lunch', 'Обед', '☀️', '13:00')">
          <span class="meal-type-icon">☀️</span>
          <span class="meal-type-name">Обед</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('dinner', 'Ужин', '🌙', '19:00')">
          <span class="meal-type-icon">🌙</span>
          <span class="meal-type-name">Ужин</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('snack', 'Перекус', '🍎', '')">
          <span class="meal-type-icon">🍎</span>
          <span class="meal-type-name">Перекус</span>
        </div>
        <div class="meal-type-option" onclick="selectMealType('custom', 'Свой вариант', '🍽️', '')">
          <span class="meal-type-icon">🍽️</span>
          <span class="meal-type-name">Свой вариант</span>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Показываем модальное окно с анимацией
  setTimeout(() => {
    modal.classList.add('show');
  }, 10);
}

function closeMealTypeSelector() {
  const modal = document.querySelector('.meal-type-modal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(modal);
    }, 300);
  }
}

function selectMealType(typeId, typeName, typeIcon, defaultTime) {
  const dateStr = currentNutritionDate.toISOString().split('T')[0]; // ИСПРАВЛЕНО: правильный формат даты
  
  // Закрываем селектор типов
  closeMealTypeSelector();
  
  if (typeId === 'custom') {
    // Для кастомного типа показываем ввод названия
    setTimeout(() => {
      showCustomMealTypeInput(dateStr);
    }, 300);
  } else {
    // Для предустановленных типов генерируем уникальный ID
    const uniqueId = typeId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    setTimeout(() => {
      showMealTimeInput(dateStr, uniqueId, typeName, typeIcon, defaultTime);
    }, 300);
  }
}

function showCustomMealTypeInput(dateStr) {
  showPopup(
    '🍽️ Свой прием пищи',
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Далее', type: 'confirm', action: () => saveCustomMealType(dateStr) }
    ],
    true,
    ''
  );
  
  setTimeout(() => {
    const input = document.querySelector('.popup-input');
    if (input) {
      input.placeholder = 'Название приема пищи';
    }
  }, 100);
}

function saveCustomMealType(dateStr) {
  const input = document.querySelector('.popup-input');
  const mealName = input.value.trim();
  
  if (!mealName) {
    showPopup('Ошибка', 'Введите название приема пищи', [
      { text: 'OK', type: 'confirm', action: hidePopup }
    ]);
    return;
  }
  
  hidePopup();
  
  // Генерируем уникальный ID для кастомного приема пищи
  const uniqueId = 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  setTimeout(() => {
    showMealTimeInput(dateStr, uniqueId, mealName, '🍽️', '');
  }, 100);
}

function showMealTimeInput(dateStr, mealId, mealName, mealIcon, defaultTime) {
  // Создаем специальное модальное окно для полного ввода данных о приеме пищи
  const modal = document.createElement('div');
  modal.className = 'meal-input-modal';
  modal.innerHTML = `
    <div class="meal-input-modal-content">
      <div class="meal-input-header">
        <h3>${mealIcon} ${mealName}</h3>
        <button class="meal-input-close" onclick="closeMealInputModal()">×</button>
      </div>
      <div class="meal-input-form">
        <div class="form-group">
          <label class="label">Время (необязательно)</label>
          <input type="time" class="input" id="mealTimeInput" value="${defaultTime}" placeholder="Время приема пищи">
        </div>
        <div class="form-group">
          <label class="label">Что планируете съесть</label>
          <textarea class="input meal-content-input" id="mealContentInput" placeholder="Опишите прием пищи (например: овсянка с фруктами, кофе)" rows="3"></textarea>
        </div>
      </div>
      <div class="meal-input-buttons">
        <button class="btn-secondary" onclick="closeMealInputModal()">Отмена</button>
        <button class="btn-primary" onclick="saveMealWithAllData('${dateStr}', '${mealId}', '${mealName}', '${mealIcon}')">Добавить</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Показываем модальное окно с анимацией
  setTimeout(() => {
    modal.classList.add('show');
    // Фокусируемся на поле содержимого
    const contentInput = document.getElementById('mealContentInput');
    if (contentInput) {
      contentInput.focus();
    }
  }, 10);
}

function closeMealInputModal() {
  const modal = document.querySelector('.meal-input-modal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.body.removeChild(modal);
    }, 300);
  }
}

function saveMealWithAllData(dateStr, mealId, mealName, mealIcon) {
  const timeInput = document.getElementById('mealTimeInput');
  const contentInput = document.getElementById('mealContentInput');
  
  const mealTime = timeInput.value.trim();
  const mealContent = contentInput.value.trim();
  
  if (!mealContent) {
    // Подсвечиваем поле, если оно пустое
    contentInput.style.borderColor = '#ef4444';
    contentInput.focus();
    return;
  }
  
  console.log('Сохраняем прием пищи:', { dateStr, mealId, mealName, mealIcon, mealTime, mealContent });
  
  // Создаем новый тип приема пищи
  const newMealType = {
    id: mealId,
    name: mealName,
    icon: mealIcon,
    time: mealTime
  };
  
  // Добавляем к типам приемов пищи для этого дня
  if (!nutritionData.mealTypes[dateStr]) {
    nutritionData.mealTypes[dateStr] = [];
  }
  nutritionData.mealTypes[dateStr].push(newMealType);
  
  // Сортируем по времени
  nutritionData.mealTypes[dateStr].sort((a, b) => {
    if (!a.time && !b.time) return 0;
    if (!a.time) return 1;
    if (!b.time) return -1;
    return a.time.localeCompare(b.time);
  });
  
  // Сохраняем содержимое приема пищи
  if (!nutritionData.meals[dateStr]) {
    nutritionData.meals[dateStr] = {};
  }
  nutritionData.meals[dateStr][mealId] = {
    content: mealContent,
    time: mealTime,
    completed: false // Новые приемы пищи по умолчанию не выполнены
  };
  
  // 🍽️ АВТОМАТИЧЕСКИ СОЗДАЕМ ЗАДАЧУ В ПЛАНАХ
  const taskTitle = `${mealIcon} ${mealName}: ${mealContent}`;
  const taskTime = mealTime || null;
  
  // Создаем новую задачу
  const newTask = {
    id: Date.now().toString() + '_meal_' + mealId,
    title: taskTitle,
    date: dateStr,
    time: taskTime,
    room: 'Питание',
    completed: false,
    createdFromMeal: true, // Помечаем что задача создана из приема пищи
    mealId: mealId // Связываем с приемом пищи
  };
  
  // Добавляем задачу в планы
  plans.push(newTask);
  savePlans();
  
  console.log('Автоматически создана задача из приема пищи:', newTask);
  
  console.log('Текущие типы приемов пищи для дня:', nutritionData.mealTypes[dateStr]);
  console.log('Текущие данные приемов пищи для дня:', nutritionData.meals[dateStr]);
  
  saveNutritionData();
  renderNutritionDay();
  
  // Если мы на вкладке задач, обновляем их отображение
  if (currentTab === 'tasks') {
    render();
  }
  
  closeMealInputModal();
}

// Удаление типа приема пищи
function deleteMealType(dateStr, mealTypeId) {
  // Получаем название приема пищи для подтверждения
  const dayMealTypes = nutritionData.mealTypes[dateStr] || [];
  const mealType = dayMealTypes.find(m => m.id === mealTypeId);
  const mealName = mealType ? mealType.name : 'Прием пищи';
  const mealTime = mealType && mealType.time ? ` в ${mealType.time}` : '';
  
  // Получаем содержимое приема пищи
  const mealData = nutritionData.meals[dateStr] && nutritionData.meals[dateStr][mealTypeId];
  const mealContent = mealData && mealData.content ? mealData.content : '';
  const contentPreview = mealContent.length > 30 ? mealContent.substring(0, 30) + '...' : mealContent;
  
  const confirmMessage = contentPreview 
    ? `Прием пищи "${mealName}${mealTime}" с содержимым "${contentPreview}" будет удален.`
    : `Прием пищи "${mealName}${mealTime}" будет удален.`;
  
  showPopup(
    'Удалить прием пищи?',
    confirmMessage,
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Удалить', type: 'danger', action: () => confirmDeleteMealType(dateStr, mealTypeId) }
    ]
  );
}

function confirmDeleteMealType(dateStr, mealTypeId) {
  console.log('Удаляем прием пищи:', { dateStr, mealTypeId });
  console.log('Типы приемов пищи до удаления:', nutritionData.mealTypes[dateStr]);
  console.log('Данные приемов пищи до удаления:', nutritionData.meals[dateStr]);
  
  // 🗑️ УДАЛЯЕМ СВЯЗАННУЮ ЗАДАЧУ ИЗ ПЛАНОВ
  const initialPlansCount = plans.length;
  plans = plans.filter(plan => !(plan.createdFromMeal && plan.mealId === mealTypeId && plan.date === dateStr));
  const deletedTasksCount = initialPlansCount - plans.length;
  
  if (deletedTasksCount > 0) {
    console.log(`Удалено связанных задач: ${deletedTasksCount}`);
    savePlans();
  }
  
  // Удаляем тип приема пищи
  if (nutritionData.mealTypes[dateStr]) {
    const beforeCount = nutritionData.mealTypes[dateStr].length;
    nutritionData.mealTypes[dateStr] = nutritionData.mealTypes[dateStr].filter(m => m.id !== mealTypeId);
    const afterCount = nutritionData.mealTypes[dateStr].length;
    console.log(`Удалено типов приемов пищи: ${beforeCount - afterCount}`);
  }
  
  // Удаляем данные о еде для этого типа
  if (nutritionData.meals[dateStr] && nutritionData.meals[dateStr][mealTypeId]) {
    delete nutritionData.meals[dateStr][mealTypeId];
    console.log('Удалены данные приема пищи с ID:', mealTypeId);
  }
  
  console.log('Типы приемов пищи после удаления:', nutritionData.mealTypes[dateStr]);
  console.log('Данные приемов пищи после удаления:', nutritionData.meals[dateStr]);
  
  saveNutritionData();
  renderNutritionDay();
  
  // Если мы на вкладке задач, обновляем их отображение
  if (currentTab === 'tasks') {
    render();
  }
  
  hidePopup();
}

// Редактирование приемов пищи
function editMeal(dateStr, mealType) {
  // Получаем название приема пищи
  const dayMealTypes = nutritionData.mealTypes[dateStr] || [];
  const mealTypeObj = dayMealTypes.find(m => m.id === mealType);
  const mealName = mealTypeObj ? mealTypeObj.name : 'Прием пищи';
  
  const currentMealData = nutritionData.meals[dateStr]?.[mealType] || {};
  const currentMeal = currentMealData.content || '';
  
  showPopup(
    `🍽️ ${mealName}`,
    '',
    [
      { text: 'Отмена', type: 'cancel', action: hidePopup },
      { text: 'Сохранить', type: 'confirm', action: () => saveMeal(dateStr, mealType) }
    ],
    true,
    currentMeal
  );
}

function saveMeal(dateStr, mealType) {
  console.log('=== НАЧАЛО saveMeal ===');
  console.log('dateStr:', dateStr);
  console.log('mealType:', mealType);
  
  const input = document.querySelector('.popup-input');
  const mealContent = input.value.trim();
  
  console.log('mealContent:', mealContent);
  console.log('plans до изменений:', plans.length);
  
  if (!nutritionData.meals[dateStr]) {
    nutritionData.meals[dateStr] = {};
  }
  
  if (mealContent) {
    // Сохраняем как объект с контентом
    if (!nutritionData.meals[dateStr][mealType]) {
      nutritionData.meals[dateStr][mealType] = {};
    }
    nutritionData.meals[dateStr][mealType].content = mealContent;
    
    console.log('Сохранили прием пищи, теперь создаем задачу...');
    
    // 🍽️ АВТОМАТИЧЕСКИ СОЗДАЕМ ЗАДАЧУ В ПЛАНАХ
    // Получаем информацию о типе приема пищи
    const mealTypes = {
      'breakfast': { name: 'Завтрак', icon: '�' },
      'lunch': { name: 'Обед', icon: '🍽️' },
      'dinner': { name: 'Ужин', icon: '🌙' },
      'snack': { name: 'Перекус', icon: '🍎' }
    };
    
    const mealInfo = mealTypes[mealType] || { name: 'Прием пищи', icon: '🍽️' };
    const taskTitle = `${mealInfo.icon} ${mealInfo.name}: ${mealContent}`;
    
    console.log('mealInfo:', mealInfo);
    console.log('taskTitle:', taskTitle);
    
    // Создаем новую задачу
    const newTask = {
      id: Date.now().toString() + '_meal_' + mealType,
      title: taskTitle,
      date: dateStr,
      time: null, // Стандартные приемы пищи без времени
      room: 'Питание',
      completed: false,
      createdFromMeal: true, // Помечаем что задача создана из приема пищи
      mealId: mealType // Связываем с приемом пищи
    };
    
    console.log('Создали новую задачу:', newTask);
    
    // Проверяем, не существует ли уже такая задача
    const existingTask = plans.find(plan => 
      plan.createdFromMeal && 
      plan.mealId === mealType && 
      plan.date === dateStr
    );
    
    console.log('Существующая задача:', existingTask);
    
    if (existingTask) {
      // Обновляем существующую задачу
      existingTask.title = taskTitle;
      console.log('Обновлена существующая задача из приема пищи:', existingTask);
    } else {
      // Добавляем новую задачу
      plans.push(newTask);
      console.log('Добавили новую задачу в plans. Теперь plans.length:', plans.length);
      console.log('Автоматически создана задача из приема пищи:', newTask);
    }
    
    console.log('Сохраняем планы...');
    savePlans();
    console.log('Планы сохранены');
  } else {
    // Если содержимое пустое, удаляем прием пищи и связанную задачу
    delete nutritionData.meals[dateStr][mealType];
    
    // Удаляем связанную задачу
    const initialPlansCount = plans.length;
    plans = plans.filter(plan => !(plan.createdFromMeal && plan.mealId === mealType && plan.date === dateStr));
    const deletedTasksCount = initialPlansCount - plans.length;
    
    if (deletedTasksCount > 0) {
      console.log(`Удалено связанных задач: ${deletedTasksCount}`);
      savePlans();
    }
  }
  
  saveNutritionData();
  renderNutritionDay();
  
  console.log('currentTab:', currentTab);
  // Если мы на вкладке задач, обновляем их отображение
  if (currentTab === 'tasks') {
    console.log('Обновляем отображение задач...');
    render();
  }
  
  hidePopup();
  console.log('=== КОНЕЦ saveMeal ===');
}

// Переключение состояния выполнения приема пищи
function toggleMealComplete(dateStr, mealTypeId, event) {
  event.stopPropagation();
  
  try {
    if (!nutritionData.meals[dateStr]) {
      nutritionData.meals[dateStr] = {};
    }
    
    if (!nutritionData.meals[dateStr][mealTypeId]) {
      nutritionData.meals[dateStr][mealTypeId] = {};
    }
    
    const mealData = nutritionData.meals[dateStr][mealTypeId];
    const wasCompleted = mealData.completed || false;
    
    // Переключаем состояние
    mealData.completed = !wasCompleted;
    
    // Находим элементы для анимации
    const checkbox = event.target;
    const mealElement = checkbox.closest('.meal');
    const mealLabel = mealElement.querySelector('.meal-label');
    const mealContent = mealElement.querySelector('.meal-content');
    
    if (mealData.completed) {
      // Отмечаем как выполненное - с анимацией
      checkbox.classList.add('checked');
      
      // 📋 СИНХРОНИЗАЦИЯ С ЗАДАЧАМИ: отмечаем связанную задачу как выполненную
      const relatedTask = plans.find(plan => 
        plan.createdFromMeal && 
        plan.mealId === mealTypeId && 
        plan.date === dateStr
      );
      
      if (relatedTask) {
        console.log('Отмечаем связанную задачу как выполненную:', relatedTask.title);
        relatedTask.completed = true;
        savePlans();
        
        // Обновляем отображение задач если мы на этой вкладке
        if (currentTab === 'tasks') {
          render();
        }
      }
      
      // Измеряем точную ширину текста для красивого зачеркивания
      if (mealLabel) {
        try {
          // Создаем временный элемент для измерения только текста (без значков времени)
          const tempLabel = document.createElement('span');
          tempLabel.style.cssText = `
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: ${window.getComputedStyle(mealLabel).fontFamily};
            font-size: ${window.getComputedStyle(mealLabel).fontSize};
            font-weight: ${window.getComputedStyle(mealLabel).fontWeight};
          `;
          
          // Получаем только текст без HTML тегов
          const labelTextOnly = mealLabel.textContent.replace(/\s*\d{2}:\d{2}\s*$/, '').trim();
          tempLabel.textContent = labelTextOnly;
          
          document.body.appendChild(tempLabel);
          const labelWidth = tempLabel.offsetWidth;
          document.body.removeChild(tempLabel);
          
          mealLabel.style.setProperty('--text-width', labelWidth + 'px');
        } catch (e) {
          console.log('Ошибка при измерении ширины метки:', e);
        }
      }
      
      if (mealContent) {
        try {
          // Создаем временный элемент для измерения текста контента
          const tempContent = document.createElement('span');
          tempContent.style.cssText = `
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: ${window.getComputedStyle(mealContent).fontFamily};
            font-size: ${window.getComputedStyle(mealContent).fontSize};
            font-weight: ${window.getComputedStyle(mealContent).fontWeight};
          `;
          tempContent.textContent = mealContent.textContent;
          
          document.body.appendChild(tempContent);
          const contentWidth = tempContent.offsetWidth;
          document.body.removeChild(tempContent);
          
          mealContent.style.setProperty('--text-width', contentWidth + 'px');
        } catch (e) {
          console.log('Ошибка при измерении ширины контента:', e);
        }
      }
      
      // Через небольшую задержку добавляем анимацию зачеркивания
      setTimeout(() => {
        mealElement.classList.add('completed');
        
        // Добавляем небольшую вибрацию для тактильной обратной связи
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      }, 150);
    } else {
      // Убираем выполнение - мгновенно
      mealData.completed = false;
      mealElement.classList.remove('completed');
      checkbox.classList.remove('checked');
      
      // 📋 СИНХРОНИЗАЦИЯ С ЗАДАЧАМИ: убираем выполнение связанной задачи
      const relatedTask = plans.find(plan => 
        plan.createdFromMeal && 
        plan.mealId === mealTypeId && 
        plan.date === dateStr
      );
      
      if (relatedTask) {
        console.log('Убираем выполнение связанной задачи:', relatedTask.title);
        relatedTask.completed = false;
        savePlans();
        
        // Обновляем отображение задач если мы на этой вкладке
        if (currentTab === 'tasks') {
          render();
        }
      }
    }
    
    saveNutritionData();
  } catch (e) {
    console.error('Ошибка при переключении состояния приема пищи:', e);
  }
}

function showHabitsTab() {
  const content = document.querySelector('.content');
  content.innerHTML = `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 40px 20px; text-align: center;">
      <div style="font-size: 48px; margin-bottom: 20px;">🎯</div>
      <h2 style="color: var(--text-primary); margin-bottom: 12px; font-size: 24px;">Привычки</h2>
      <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5;">Трекинг привычек и целей скоро будет доступен</p>
      <div style="background: var(--bg-card); padding: 16px; border-radius: 12px; border: 1px solid var(--border-primary);">
        <p style="color: var(--text-muted); font-size: 14px;">🚀 В разработке</p>
      </div>
    </div>
  `;
}

// INIT

// INIT

// INIT
document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('DOMContentLoaded - начинаем инициализацию приложения');
    
    // КРИТИЧЕСКИ ВАЖНО: Сначала инициализируем иконки
    initializeIcons();
    
    // КРИТИЧЕСКИ ВАЖНО: Сначала загружаем данные
    loadData();
    console.log('После loadData - планы:', plans);
    console.log('После loadData - количество планов:', plans.length);
    
    // НОВАЯ СИСТЕМА: Инициализируем синхронизацию разделов
    initSectionsSync();
    
    loadProfileData();
    
    // Убеждаемся что мы на вкладке задач
    currentTab = 'tasks';
    
    // Устанавливаем активную вкладку в навигации
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
      item.classList.remove('active');
    });
    
    const tasksTab = document.querySelector('[data-tab="tasks"]');
    if (tasksTab) {
      tasksTab.classList.add('active');
    }
    
    // КРИТИЧЕСКИ ВАЖНО: Ждем пока DOM полностью готов, ЗАТЕМ рендерим
    setTimeout(() => {
      console.log('DOM готов, начинаем рендеринг с данными:', plans.length, 'планов');
      
      // Инициализируем прогресс-бар
      const progressCircle = document.getElementById('progressCircle');
      if (progressCircle) {
        progressCircle.dataset.currentAngle = '0';
      }
      
      // Теперь рендерим с уже загруженными данными
      render();
      
      console.log('Инициализация завершена успешно');
    }, 100); // Даем DOM время инициализироваться
    
  } catch (e) {
    console.error('Ошибка при инициализации приложения:', e);
  }
  
  // Добавляем CSS для конфетти и капель воды
  const confettiStyle = document.createElement('style');
  confettiStyle.textContent = `
    @keyframes confetti-fall {
      0% {
        transform: translate(-50%, -50%) scale(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translate(calc(-50% + var(--random-x)), calc(-50% + var(--random-y))) scale(1) rotate(360deg);
        opacity: 0;
      }
    }
    
    @keyframes water-drop-fall {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
      }
      50% {
        transform: translate(calc(-50% + var(--random-x) * 0.5), calc(-50% + var(--random-y) * 0.3)) scale(1.2);
        opacity: 1;
      }
      100% {
        transform: translate(calc(-50% + var(--random-x)), calc(-50% + var(--random-y))) scale(0.8);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(confettiStyle);
  
  console.log('🚀 Планер v6.17 Nutrition Tab загружен');
});
</script>
</body>
</html>