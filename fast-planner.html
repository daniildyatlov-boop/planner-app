<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Планер</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);line-height:1.4;overflow-x:hidden;min-height:100vh}
.app{min-height:100vh;display:flex;flex-direction:column}
.header{padding:60px 20px 20px;background:var(--tg-theme-bg-color,#fff);border-bottom:0.5px solid var(--tg-theme-hint-color,rgba(0,0,0,0.1));display:flex;align-items:center;justify-content:space-between}
.nav{background:none;border:none;font-size:17px;color:var(--tg-theme-link-color,#007aff);cursor:pointer;padding:8px 12px;border-radius:6px;min-width:44px;height:44px;display:flex;align-items:center;justify-content:center}
.nav:active{opacity:0.6}
.title{font-size:17px;font-weight:600;flex:1;text-align:center}
.content{flex:1;padding:20px;display:flex;flex-direction:column;padding-bottom:80px}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:60px 20px}
.empty h2{font-size:20px;font-weight:500;margin-bottom:8px}
.empty p{font-size:15px;color:var(--tg-theme-hint-color,#8e8e93);margin-bottom:32px}
.btn{background:var(--tg-theme-button-color,#007aff);color:var(--tg-theme-button-text-color,#fff);border:none;border-radius:8px;padding:12px 24px;font-size:17px;font-weight:500;cursor:pointer}
.btn:active{opacity:0.8}
.plans{flex:1}
.group{margin-bottom:24px}
.group-title{font-size:13px;color:var(--tg-theme-hint-color,#8e8e93);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px;padding:0 4px}
.plan{background:var(--tg-theme-secondary-bg-color,#f8f9fa);border-radius:8px;padding:16px;margin-bottom:8px;display:flex;align-items:center;cursor:pointer}
.plan:active{opacity:0.8}
.time{font-size:15px;color:var(--tg-theme-link-color,#007aff);font-weight:500;min-width:50px;margin-right:12px}
.plan-content{flex:1}
.plan-title{font-size:17px;margin-bottom:2px}
.room{font-size:13px;color:var(--tg-theme-hint-color,#8e8e93)}
.add{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--tg-theme-bg-color,#fff);z-index:100;display:none;flex-direction:column}
.add.show{display:flex}
.add-header{padding:60px 20px 20px;background:var(--tg-theme-bg-color,#fff);border-bottom:0.5px solid var(--tg-theme-hint-color,rgba(0,0,0,0.1));display:flex;align-items:center;justify-content:space-between}
.header-btn{background:none;border:none;font-size:17px;color:var(--tg-theme-link-color,#007aff);cursor:pointer;padding:8px}
.header-btn:active{opacity:0.6}
.add-content{flex:1;padding:20px}
.form-group{margin-bottom:20px}
.label{font-size:13px;color:var(--tg-theme-hint-color,#8e8e93);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px;display:block}
.input{width:100%;background:var(--tg-theme-secondary-bg-color,#f8f9fa);border:none;border-radius:8px;padding:16px;font-size:17px;font-family:inherit;color:var(--tg-theme-text-color,#000)}
.input:focus{outline:none;background:rgba(0,122,255,0.1)}
.input::placeholder{color:var(--tg-theme-hint-color,#8e8e93)}
.row{display:flex;gap:12px}
.row .form-group{flex:1}
.menu{position:fixed;bottom:0;left:0;right:0;background:var(--tg-theme-bg-color,#fff);border-top:0.5px solid var(--tg-theme-hint-color,rgba(0,0,0,0.1));padding:20px;z-index:200;display:none}
.menu.show{display:block}
.menu-btn{width:100%;background:none;border:none;padding:16px;font-size:17px;text-align:left;cursor:pointer;border-radius:8px;margin-bottom:8px}
.menu-btn:active{background:var(--tg-theme-secondary-bg-color,#f8f9fa)}
.menu-btn.del{color:var(--tg-theme-destructive-text-color,#ff3b30)}
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:150;display:none}
.overlay.show{display:block}
.add-btn-fixed{position:fixed;bottom:20px;left:20px;right:20px;background:var(--tg-theme-button-color,#007aff);color:var(--tg-theme-button-text-color,#fff);border:none;border-radius:8px;padding:16px;font-size:17px;font-weight:600;cursor:pointer;z-index:50;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
.add-btn-fixed:active{opacity:0.8}
</style>
</head>
<body>
<div class="app">
<div class="header">
<button class="nav" onclick="changeDay(-1)">‹</button>
<div class="title" id="dayTitle">Сегодня</div>
<button class="nav" onclick="changeDay(1)">›</button>
</div>
<div class="content" id="content">
<div class="empty" id="empty">
<h2>Планов нет</h2>
<p>Добавьте первый план</p>
<button class="btn" onclick="showAdd()">Добавить план</button>
</div>
<div class="plans" id="plans" style="display:none"></div>
</div>
</div>

<div class="add" id="add">
<div class="add-header">
<button class="header-btn" onclick="hideAdd()">Отмена</button>
<div class="title">Новый план</div>
<button class="header-btn" onclick="save()">Готово</button>
</div>
<div class="add-content">
<div class="form-group">
<label class="label">Что планируете</label>
<input class="input" id="title" placeholder="Что вы планируете сделать?" autofocus>
</div>
<div class="row">
<div class="form-group">
<label class="label">Дата</label>
<input type="date" class="input" id="date">
</div>
<div class="form-group">
<label class="label">Время</label>
<input type="time" class="input" id="time">
</div>
</div>
<div class="form-group">
<label class="label">Комната</label>
<input class="input" id="room" placeholder="Где будете">
</div>
</div>
</div>

<div class="overlay" id="overlay" onclick="hideMenu()"></div>
<div class="menu" id="menu">
<button class="menu-btn" onclick="edit()">Редактировать</button>
<button class="menu-btn del" onclick="del()">Удалить</button>
</div>

<button class="add-btn-fixed" onclick="showAdd()">Добавить план</button>

<script>
const tg=window.Telegram.WebApp;
tg.expand();
tg.ready();

let date=new Date();
let plans=[];
let selected=null;

// Быстрая загрузка данных
function loadPlans(){
try{
plans=JSON.parse(localStorage.getItem('plans')||'[]');
}catch(e){
plans=[];
}
render();
}

// Мгновенный рендер
function render(){
const today=getPlansForDate(date);
document.getElementById('dayTitle').textContent=formatDate(date);

const empty=document.getElementById('empty');
const plansEl=document.getElementById('plans');

if(today.length===0){
empty.style.display='flex';
plansEl.style.display='none';
return;
}

empty.style.display='none';
plansEl.style.display='block';

const withTime=today.filter(p=>p.time).sort((a,b)=>a.time.localeCompare(b.time));
const withoutTime=today.filter(p=>!p.time);

let html='';

if(withTime.length>0){
html+='<div class="group"><div class="group-title">С временем</div>';
withTime.forEach(p=>{
html+=`<div class="plan" onclick="showMenu('${p.id}')">
<div class="time">${p.time}</div>
<div class="plan-content">
<div class="plan-title">${p.title}</div>
${p.room?`<div class="room">${p.room}</div>`:''}
</div>
</div>`;
});
html+='</div>';
}

if(withoutTime.length>0){
html+='<div class="group"><div class="group-title">Без времени</div>';
withoutTime.forEach(p=>{
html+=`<div class="plan" onclick="showMenu('${p.id}')">
<div class="plan-content">
<div class="plan-title">${p.title}</div>
${p.room?`<div class="room">${p.room}</div>`:''}
</div>
</div>`;
});
html+='</div>';
}

plansEl.innerHTML=html;
}

function formatDate(d){
const today=new Date();
const tomorrow=new Date(today);
tomorrow.setDate(tomorrow.getDate()+1);
const yesterday=new Date(today);
yesterday.setDate(yesterday.getDate()-1);

if(d.toDateString()===today.toDateString())return 'Сегодня';
if(d.toDateString()===tomorrow.toDateString())return 'Завтра';
if(d.toDateString()===yesterday.toDateString())return 'Вчера';
return d.toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'});
}

function getPlansForDate(d){
const dateStr=d.toDateString();
return plans.filter(p=>new Date(p.date).toDateString()===dateStr);
}

function changeDay(dir){
date.setDate(date.getDate()+dir);
render();
}

function showAdd(){
document.getElementById('add').classList.add('show');
document.getElementById('date').value=date.toISOString().split('T')[0];
setTimeout(()=>document.getElementById('title').focus(),50);
}

function hideAdd(){
document.getElementById('add').classList.remove('show');
clearForm();
}

function clearForm(){
document.getElementById('title').value='';
document.getElementById('date').value='';
document.getElementById('time').value='';
document.getElementById('room').value='';
}

function save(){
const title=document.getElementById('title').value.trim();
if(!title)return;

const plan={
id:Date.now().toString(),
title:title,
date:document.getElementById('date').value||date.toISOString().split('T')[0],
time:document.getElementById('time').value||null,
room:document.getElementById('room').value.trim()||null
};

if(selected){
const index=plans.findIndex(p=>p.id===selected);
if(index!==-1)plans[index]={...plan,id:selected};
selected=null;
}else{
plans.push(plan);
}

localStorage.setItem('plans',JSON.stringify(plans));
hideAdd();
date=new Date(plan.date);
render();
}

function showMenu(id){
selected=id;
document.getElementById('overlay').classList.add('show');
document.getElementById('menu').classList.add('show');
}

function hideMenu(){
document.getElementById('overlay').classList.remove('show');
document.getElementById('menu').classList.remove('show');
selected=null;
}

function edit(){
const plan=plans.find(p=>p.id===selected);
if(!plan)return;

document.getElementById('title').value=plan.title;
document.getElementById('date').value=plan.date;
document.getElementById('time').value=plan.time||'';
document.getElementById('room').value=plan.room||'';

hideMenu();
showAdd();
}

function del(){
plans=plans.filter(p=>p.id!==selected);
localStorage.setItem('plans',JSON.stringify(plans));
hideMenu();
render();
}

// Pull to refresh
let startY=0;
document.addEventListener('touchstart',e=>startY=e.touches[0].clientY);
document.addEventListener('touchend',e=>{
if(e.changedTouches[0].clientY-startY>80&&window.scrollY===0)showAdd();
});

// Telegram back button
tg.onEvent('backButtonClicked',()=>{
if(document.getElementById('add').classList.contains('show'))hideAdd();
else if(document.getElementById('menu').classList.contains('show'))hideMenu();
else tg.close();
});

// Мгновенный старт
loadPlans();
</script>
</body>
</html>