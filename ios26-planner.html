<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<title>Планы</title>
<script src="https://telegram.org/js/telegram-web-app.js?v=5"></script>
<style>
/* iOS 26 System-Level Design */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;position:fixed;width:100%}
body{
font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;
background:#F7F8FA;
color:#0A0A0A;
line-height:1.4;
overflow:hidden;
-webkit-font-smoothing:antialiased;
-moz-osx-font-smoothing:grayscale
}

/* 8pt Grid System */
.app{height:100vh;display:flex;flex-direction:column}

/* Header - System Level */
.header{
padding:16px 24px 8px;
background:#F7F8FA;
display:flex;
align-items:center;
justify-content:center;
position:relative;
height:64px;
border-bottom:none
}
.header-title{
font-size:32px;
font-weight:700;
color:#0A0A0A;
letter-spacing:-0.02em;
line-height:1.1
}
.header-btn{
position:absolute;
background:none;
border:none;
font-size:17px;
color:#007AFF;
cursor:pointer;
padding:8px;
border-radius:8px;
font-weight:400;
transition:opacity 120ms ease-in-out;
min-height:32px;
display:flex;
align-items:center
}
.header-btn:active{opacity:0.6}
.header-btn.left{left:16px}
.header-btn.right{right:16px}

/* Content Area */
.content{
flex:1;
display:flex;
flex-direction:column;
overflow:hidden;
padding:0 24px 24px
}

/* Date Navigation - Minimal */
.date-nav{
display:flex;
align-items:center;
justify-content:center;
margin:16px 0 24px;
gap:24px
}
.date-btn{
background:none;
border:none;
font-size:17px;
color:#007AFF;
cursor:pointer;
padding:8px;
border-radius:8px;
transition:opacity 120ms ease-in-out;
min-width:32px;
display:flex;
align-items:center;
justify-content:center
}
.date-btn:active{opacity:0.6}
.date-display{
font-size:17px;
font-weight:600;
color:#0A0A0A;
min-width:120px;
text-align:center;
cursor:pointer;
padding:8px;
border-radius:8px;
transition:opacity 120ms ease-in-out
}
.date-display:active{opacity:0.6}

/* Plans List */
.plans-container{
flex:1;
overflow-y:auto;
-webkit-overflow-scrolling:touch
}
.plans-container::-webkit-scrollbar{display:none}

.empty-state{
display:flex;
flex-direction:column;
align-items:center;
justify-content:center;
text-align:center;
padding:64px 32px;
flex:1
}
.empty-title{
font-size:17px;
font-weight:600;
color:#6B6F76;
margin-bottom:8px
}
.empty-subtitle{
font-size:14px;
color:#6B6F76;
margin-bottom:32px
}

.plan-item{
background:#FFFFFF;
border-radius:16px;
padding:16px;
margin-bottom:8px;
display:flex;
align-items:center;
cursor:pointer;
transition:opacity 120ms ease-in-out;
box-shadow:0 4px 24px rgba(0,0,0,0.08);
min-height:64px
}
.plan-item:active{opacity:0.6}
.plan-item.completed{opacity:0.5}

.plan-checkbox{
width:24px;
height:24px;
border:2px solid #C7C7CC;
border-radius:12px;
margin-right:16px;
display:flex;
align-items:center;
justify-content:center;
cursor:pointer;
flex-shrink:0;
transition:all 180ms ease-in-out
}
.plan-checkbox.checked{
background:#007AFF;
border-color:#007AFF
}
.plan-checkbox.checked::after{
content:'✓';
color:#FFFFFF;
font-size:12px;
font-weight:600
}

.plan-content{
flex:1;
display:flex;
flex-direction:column;
justify-content:center
}
.plan-title{
font-size:17px;
font-weight:400;
color:#0A0A0A;
line-height:1.3;
margin-bottom:2px
}
.plan-title.completed{
text-decoration:line-through;
color:#6B6F76
}
.plan-room{
font-size:14px;
color:#6B6F76;
font-weight:400
}

/* Add Button - System Level */
.add-btn{
position:fixed;
bottom:32px;
left:24px;
right:24px;
background:#007AFF;
border:none;
border-radius:16px;
padding:16px;
font-size:17px;
font-weight:600;
color:#FFFFFF;
cursor:pointer;
box-shadow:0 6px 32px rgba(0,122,255,0.24);
transition:opacity 120ms ease-in-out;
min-height:56px;
display:flex;
align-items:center;
justify-content:center
}
.add-btn:active{opacity:0.6}

/* Modal Screens */
.modal-screen{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:#F7F8FA;
z-index:100;
display:none;
flex-direction:column;
opacity:0;
transform:translateY(8px);
transition:all 200ms ease-in-out
}
.modal-screen.show{
display:flex;
opacity:1;
transform:translateY(0)
}

/* Form Elements */
.form-section{
padding:24px;
flex:1;
overflow-y:auto
}
.form-group{
margin-bottom:24px
}
.form-label{
font-size:14px;
color:#6B6F76;
font-weight:400;
margin-bottom:8px;
display:block
}
.form-input{
width:100%;
background:#FFFFFF;
border:none;
border-radius:12px;
padding:16px;
font-size:17px;
font-family:inherit;
color:#0A0A0A;
box-shadow:0 2px 16px rgba(0,0,0,0.06);
transition:box-shadow 180ms ease-in-out;
min-height:48px
}
.form-input:focus{
outline:none;
box-shadow:0 4px 24px rgba(0,122,255,0.12)
}
.form-input::placeholder{
color:#C7C7CC
}

.form-select{
width:100%;
background:#FFFFFF;
border:none;
border-radius:12px;
padding:16px;
font-size:17px;
font-family:inherit;
color:#0A0A0A;
box-shadow:0 2px 16px rgba(0,0,0,0.06);
-webkit-appearance:none;
appearance:none;
cursor:pointer;
min-height:48px;
background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23C7C7CC' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
background-position:right 12px center;
background-repeat:no-repeat;
background-size:16px
}

/* Progress Indicator */
.progress-container{
margin:0 0 24px;
height:4px;
background:rgba(199,199,204,0.3);
border-radius:2px;
overflow:hidden
}
.progress-fill{
height:100%;
background:#007AFF;
border-radius:2px;
transition:width 300ms ease-in-out;
width:0%
}

/* Menu System */
.menu-overlay{
position:fixed;
top:0;
left:0;
right:0;
bottom:0;
background:rgba(0,0,0,0.4);
z-index:200;
display:none;
opacity:0;
transition:opacity 160ms ease-in-out
}
.menu-overlay.show{
display:flex;
opacity:1;
align-items:center;
justify-content:center
}
.menu-content{
background:#FFFFFF;
border-radius:16px;
margin:24px;
min-width:280px;
box-shadow:0 8px 32px rgba(0,0,0,0.12);
overflow:hidden;
transform:scale(0.95);
transition:transform 200ms ease-in-out
}
.menu-overlay.show .menu-content{
transform:scale(1)
}
.menu-item{
width:100%;
background:none;
border:none;
padding:16px 20px;
font-size:17px;
text-align:center;
cursor:pointer;
color:#007AFF;
font-weight:400;
transition:background 120ms ease-in-out;
border-bottom:0.5px solid rgba(199,199,204,0.3)
}
.menu-item:last-child{border-bottom:none}
.menu-item:active{background:rgba(0,0,0,0.04)}
.menu-item.destructive{color:#FF3B30}

/* Rooms Screen */
.rooms-list{
flex:1;
overflow-y:auto;
padding:0 0 100px
}
.room-item{
background:#FFFFFF;
border-radius:12px;
padding:16px;
margin-bottom:8px;
display:flex;
align-items:center;
justify-content:space-between;
cursor:pointer;
transition:opacity 120ms ease-in-out;
box-shadow:0 2px 16px rgba(0,0,0,0.06);
min-height:56px
}
.room-item:active{opacity:0.6}
.room-name{
font-size:17px;
font-weight:400;
color:#0A0A0A;
flex:1
}
.room-delete{
background:none;
border:none;
font-size:14px;
color:#FF3B30;
cursor:pointer;
padding:8px;
border-radius:8px;
transition:opacity 120ms ease-in-out
}
.room-delete:active{opacity:0.6}

/* Responsive Adjustments */
@media (max-height: 600px) {
.empty-state{padding:32px 24px}
.form-section{padding:16px}
}
</style>
</head>
<body>
<div class="app">
<!-- Main Screen -->
<div class="header">
<button class="header-btn left" onclick="showRooms()" style="display:none" id="roomsBtn">Комнаты</button>
<div class="header-title">Планы</div>
<button class="header-btn right" onclick="showAdd()" id="addBtn">Добавить</button>
</div>

<div class="content">
<div class="date-nav">
<button class="date-btn" onclick="changeDay(-1)">‹</button>
<div class="date-display" onclick="showDatePicker()" id="dateDisplay">Сегодня</div>
<button class="date-btn" onclick="changeDay(1)">›</button>
</div>

<div class="progress-container" id="progressContainer" style="display:none">
<div class="progress-fill" id="progressFill"></div>
</div>

<div class="plans-container" id="plansContainer">
<div class="empty-state" id="emptyState">
<div class="empty-title">Планов нет</div>
<div class="empty-subtitle">Добавьте первый план</div>
</div>
<div id="plansList"></div>
</div>
</div>

<button class="add-btn" onclick="showAdd()" id="addBtnFixed" style="display:none">Добавить план</button>
</div>

<!-- Add Plan Screen -->
<div class="modal-screen" id="addScreen">
<div class="header">
<button class="header-btn left" onclick="hideAdd()">Отмена</button>
<div class="header-title">Новый план</div>
<button class="header-btn right" onclick="savePlan()">Готово</button>
</div>
<div class="form-section">
<div class="form-group">
<label class="form-label">Название</label>
<input class="form-input" id="planTitle" placeholder="Что планируете?" autofocus>
</div>
<div class="form-group">
<label class="form-label">Дата</label>
<input type="date" class="form-input" id="planDate">
</div>
<div class="form-group">
<label class="form-label">Комната</label>
<select class="form-select" id="planRoom">
<option value="">Без комнаты</option>
</select>
</div>
</div>
</div>

<!-- Rooms Screen -->
<div class="modal-screen" id="roomsScreen">
<div class="header">
<button class="header-btn left" onclick="hideRooms()">Назад</button>
<div class="header-title">Комнаты</div>
<button class="header-btn right" onclick="showAddRoom()">Добавить</button>
</div>
<div class="content">
<div class="rooms-list" id="roomsList"></div>
</div>
</div>

<!-- Menu Overlay -->
<div class="menu-overlay" id="menuOverlay" onclick="hideMenu()">
<div class="menu-content" onclick="event.stopPropagation()">
<button class="menu-item" onclick="editPlan()">Редактировать</button>
<button class="menu-item destructive" onclick="deletePlan()">Удалить</button>
</div>
</div>

<script>
// Telegram WebApp initialization
const tg = window.Telegram.WebApp;
tg.expand();
tg.ready();

// App state
let currentDate = new Date();
let plans = [];
let rooms = [];
let selectedPlan = null;
let editingPlan = false;

// Load data
function loadData() {
try {
plans = JSON.parse(localStorage.getItem('plans') || '[]');
rooms = JSON.parse(localStorage.getItem('rooms') || '[]');
} catch (e) {
plans = [];
rooms = [];
}
render();
}

// Save data
function saveData() {
localStorage.setItem('plans', JSON.stringify(plans));
localStorage.setItem('rooms', JSON.stringify(rooms));
}

// Render main screen
function render() {
updateDateDisplay();
updateProgress();
renderPlans();
updateRoomsSelect();
updateButtons();
}

function updateDateDisplay() {
const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);
const yesterday = new Date(today);
yesterday.setDate(yesterday.getDate() - 1);

let displayText = 'Сегодня';
if (currentDate.toDateString() === tomorrow.toDateString()) {
displayText = 'Завтра';
} else if (currentDate.toDateString() === yesterday.toDateString()) {
displayText = 'Вчера';
} else if (currentDate.toDateString() !== today.toDateString()) {
displayText = currentDate.toLocaleDateString('ru-RU', { 
weekday: 'long', 
day: 'numeric', 
month: 'long' 
});
}
document.getElementById('dateDisplay').textContent = displayText;
}

function updateProgress() {
const todayPlans = getPlansForDate(currentDate);
const completed = todayPlans.filter(p => p.completed).length;
const total = todayPlans.length;
const progressContainer = document.getElementById('progressContainer');
const progressFill = document.getElementById('progressFill');

if (total > 0) {
progressContainer.style.display = 'block';
progressFill.style.width = `${(completed / total) * 100}%`;
} else {
progressContainer.style.display = 'none';
}
}

function renderPlans() {
const todayPlans = getPlansForDate(currentDate);
const emptyState = document.getElementById('emptyState');
const plansList = document.getElementById('plansList');

if (todayPlans.length === 0) {
emptyState.style.display = 'flex';
plansList.innerHTML = '';
return;
}

emptyState.style.display = 'none';
plansList.innerHTML = todayPlans.map(plan => `
<div class="plan-item ${plan.completed ? 'completed' : ''}" onclick="showPlanMenu('${plan.id}')">
<div class="plan-checkbox ${plan.completed ? 'checked' : ''}" onclick="togglePlan('${plan.id}', event)"></div>
<div class="plan-content">
<div class="plan-title ${plan.completed ? 'completed' : ''}">${escapeHtml(plan.title)}</div>
${plan.room ? `<div class="plan-room">${escapeHtml(plan.room)}</div>` : ''}
</div>
</div>
`).join('');
}

function updateButtons() {
const todayPlans = getPlansForDate(currentDate);
const addBtn = document.getElementById('addBtn');
const addBtnFixed = document.getElementById('addBtnFixed');
const roomsBtn = document.getElementById('roomsBtn');

if (todayPlans.length > 0) {
addBtn.style.display = 'none';
addBtnFixed.style.display = 'flex';
} else {
addBtn.style.display = 'block';
addBtnFixed.style.display = 'none';
}

roomsBtn.style.display = rooms.length > 0 ? 'block' : 'none';
}

function getPlansForDate(date) {
const dateStr = date.toDateString();
return plans.filter(p => new Date(p.date).toDateString() === dateStr);
}

function escapeHtml(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

// Date navigation
function changeDay(direction) {
currentDate.setDate(currentDate.getDate() + direction);
render();
}

// Plan management
function showAdd() {
editingPlan = false;
selectedPlan = null;
document.getElementById('planTitle').value = '';
document.getElementById('planDate').value = currentDate.toISOString().split('T')[0];
document.getElementById('planRoom').value = '';
document.getElementById('addScreen').classList.add('show');
setTimeout(() => document.getElementById('planTitle').focus(), 200);
}

function hideAdd() {
document.getElementById('addScreen').classList.remove('show');
}

function savePlan() {
const title = document.getElementById('planTitle').value.trim();
if (!title) return;

const planData = {
title: title,
date: document.getElementById('planDate').value || currentDate.toISOString().split('T')[0],
room: document.getElementById('planRoom').value || null,
completed: false
};

if (editingPlan && selectedPlan) {
const index = plans.findIndex(p => p.id === selectedPlan);
if (index !== -1) {
plans[index] = { ...planData, id: selectedPlan };
}
} else {
planData.id = Date.now().toString();
plans.push(planData);
}

saveData();
hideAdd();
currentDate = new Date(planData.date);
render();
}

function togglePlan(id, event) {
event.stopPropagation();
const plan = plans.find(p => p.id === id);
if (plan) {
plan.completed = !plan.completed;
saveData();
render();
}
}

function showPlanMenu(id) {
selectedPlan = id;
document.getElementById('menuOverlay').classList.add('show');
}

function hideMenu() {
document.getElementById('menuOverlay').classList.remove('show');
selectedPlan = null;
}

function editPlan() {
const plan = plans.find(p => p.id === selectedPlan);
if (!plan) return;

editingPlan = true;
document.getElementById('planTitle').value = plan.title;
document.getElementById('planDate').value = plan.date;
document.getElementById('planRoom').value = plan.room || '';
hideMenu();
document.getElementById('addScreen').classList.add('show');
setTimeout(() => document.getElementById('planTitle').focus(), 200);
}

function deletePlan() {
plans = plans.filter(p => p.id !== selectedPlan);
saveData();
hideMenu();
render();
}

// Rooms management
function showRooms() {
renderRooms();
document.getElementById('roomsScreen').classList.add('show');
}

function hideRooms() {
document.getElementById('roomsScreen').classList.remove('show');
}

function renderRooms() {
const roomsList = document.getElementById('roomsList');
roomsList.innerHTML = rooms.map(room => `
<div class="room-item">
<div class="room-name">${escapeHtml(room)}</div>
<button class="room-delete" onclick="deleteRoom('${escapeHtml(room)}')">Удалить</button>
</div>
`).join('');
}

function showAddRoom() {
const name = prompt('Название комнаты:');
if (name && name.trim() && !rooms.includes(name.trim())) {
rooms.push(name.trim());
saveData();
renderRooms();
render();
}
}

function deleteRoom(roomName) {
rooms = rooms.filter(r => r !== roomName);
saveData();
renderRooms();
render();
}

function updateRoomsSelect() {
const select = document.getElementById('planRoom');
select.innerHTML = '<option value="">Без комнаты</option>';
rooms.forEach(room => {
const option = document.createElement('option');
option.value = room;
option.textContent = room;
select.appendChild(option);
});
}

// Initialize app
loadData();

// Telegram WebApp back button handling
tg.onEvent('backButtonClicked', () => {
if (document.getElementById('addScreen').classList.contains('show')) {
hideAdd();
} else if (document.getElementById('roomsScreen').classList.contains('show')) {
hideRooms();
} else if (document.getElementById('menuOverlay').classList.contains('show')) {
hideMenu();
} else {
tg.close();
}
});
</script>
</body>
</html>