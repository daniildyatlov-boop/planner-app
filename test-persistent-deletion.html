<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á</h1>
    
    <div class="test-section info">
        <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</h3>
        <ol>
            <li>–°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É</li>
            <li>–£–¥–∞–ª–∏—Ç–µ –µ—ë</li>
            <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ù–ï –≤–µ—Ä–Ω—É–ª–∞—Å—å</li>
            <li>–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –¥–∞—Ç—É –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å</li>
            <li>–ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è —É–¥–∞–ª–µ–Ω–Ω–æ–π</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>–¢–µ—Å—Ç–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
        <button onclick="createTestTask()">1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É</button>
        <button onclick="createSectionTask()">2. –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –∏–∑ —Ä–∞–∑–¥–µ–ª–∞</button>
        <button onclick="checkDeletedTasks()">3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</button>
        <button onclick="clearDeletedTasks()">4. –û—á–∏—Å—Ç–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</button>
        <button onclick="simulateReload()">5. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É</button>
    </div>

    <div class="test-section">
        <h3>–õ–æ–≥ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div id="testLog" class="log"></div>
    </div>

    <script>
        // –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        function log(message, type = 'info') {
            const logEl = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEl.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function createTestTask() {
            const testTask = {
                id: 'test_' + Date.now(),
                title: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è',
                date: new Date().toISOString().split('T')[0],
                time: '12:00',
                room: '–¢–µ—Å—Ç',
                completed: false
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ localStorage
            const plans = JSON.parse(localStorage.getItem('planner_plans') || '[]');
            plans.push(testTask);
            localStorage.setItem('planner_plans', JSON.stringify(plans));
            
            log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞: ${testTask.title} (ID: ${testTask.id})`, 'success');
        }

        function createSectionTask() {
            const sectionTask = {
                id: 'section_test_' + Date.now(),
                title: '–ó–∞–¥–∞—á–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
                date: new Date().toISOString().split('T')[0],
                time: '14:00',
                room: '–£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞',
                completed: false,
                sectionId: 123,
                templateId: 456,
                createdFromSection: true
            };

            const plans = JSON.parse(localStorage.getItem('planner_plans') || '[]');
            plans.push(sectionTask);
            localStorage.setItem('planner_plans', JSON.stringify(plans));
            
            log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –∑–∞–¥–∞—á–∞ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞: ${sectionTask.title} (ID: ${sectionTask.id})`, 'success');
        }

        function checkDeletedTasks() {
            const deletedTasks = JSON.parse(localStorage.getItem('planner_deleted_tasks') || '{}');
            const plans = JSON.parse(localStorage.getItem('planner_plans') || '[]');
            
            log(`üìä –í—Å–µ–≥–æ –∑–∞–¥–∞—á –≤ –ø–ª–∞–Ω–∞—Ö: ${plans.length}`);
            log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ –¥–∞—Ç–∞–º: ${Object.keys(deletedTasks).length}`);
            
            Object.keys(deletedTasks).forEach(date => {
                const deletedOnDate = Object.keys(deletedTasks[date]).length;
                log(`   ${date}: ${deletedOnDate} —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á`);
                
                Object.keys(deletedTasks[date]).forEach(sourceKey => {
                    log(`     - ${sourceKey}: —É–¥–∞–ª–µ–Ω–∞`);
                });
            });
        }

        function clearDeletedTasks() {
            localStorage.removeItem('planner_deleted_tasks');
            log('üßπ –û—á–∏—â–µ–Ω—ã –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ–± —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö', 'success');
        }

        function simulateReload() {
            log('üîÑ –°–∏–º—É–ª—è—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–¥–∞—á–∏ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
            const plans = JSON.parse(localStorage.getItem('planner_plans') || '[]');
            const deletedTasks = JSON.parse(localStorage.getItem('planner_deleted_tasks') || '{}');
            
            const today = new Date().toISOString().split('T')[0];
            const todayPlans = plans.filter(p => p.date === today);
            const todayDeleted = deletedTasks[today] || {};
            
            log(`üìÖ –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${todayPlans.length}`);
            log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–Ω—ã—Ö –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${Object.keys(todayDeleted).length}`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ
            todayPlans.forEach(plan => {
                let source;
                if (plan.createdFromSection && plan.sectionId && plan.templateId) {
                    source = `section_${plan.sectionId}_${plan.templateId}`;
                } else if (plan.createdFromMeal && plan.mealId) {
                    source = `meal_${plan.mealId}`;
                } else {
                    source = 'manual';
                }
                
                if (todayDeleted[source]) {
                    log(`‚ùå –û–®–ò–ë–ö–ê: –ó–∞–¥–∞—á–∞ "${plan.title}" –¥–æ–ª–∂–Ω–∞ –±—ã–ª–∞ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–∞!`, 'error');
                } else {
                    log(`‚úÖ –ó–∞–¥–∞—á–∞ "${plan.title}" –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç`, 'success');
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        log('üöÄ –¢–µ—Å—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á –∑–∞–ø—É—â–µ–Ω');
        log('üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏');
    </script>
</body>
</html>